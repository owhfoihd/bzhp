<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Travel Journal</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
body { background:#9AA581; min-height:100vh; font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display","SF Pro Text","Helvetica Neue",sans-serif; }
.photo-preview { width:80px; height:80px; object-fit:cover; border-radius:8px; cursor:pointer; }
.modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.85); }
.modal.active { display:flex; align-items:center; justify-content:center; }
.modal img { max-width:90%; max-height:90%; }
.nav-btn { padding:8px 14px; border-radius:8px; font-weight:600; cursor:pointer; font-size:0.85rem; border:none; background:rgba(255,255,255,0.2); color:white; transition:all 0.2s; }
.nav-btn.active { background:white; color:#9AA581; }
.nav-btn:hover:not(.active) { background:rgba(255,255,255,0.35); }
.star-btn { font-size:1.6rem; cursor:pointer; transition:opacity 0.1s; line-height:1; }
.sub-star { font-size:1.4rem; cursor:pointer; transition:opacity 0.1s; }
.zepeda-btn { padding:6px 14px; border:2px solid #9AA581; border-radius:8px; background:white; cursor:pointer; font-weight:600; font-size:0.9rem; transition:all 0.2s; }
.zepeda-btn.active { background:#9AA581; color:white; }
.section-header { cursor:pointer; user-select:none; }
.collapse-arrow { transition:transform 0.3s; display:inline-block; }
.collapse-arrow.collapsed { transform:rotate(-90deg); }
.tag-suggestions { position:absolute; background:white; border:1px solid #d1d5db; border-radius:8px; box-shadow:0 4px 6px rgba(0,0,0,0.1); max-height:180px; overflow-y:auto; z-index:100; display:none; width:100%; }
.tag-suggestions.active { display:block; }
.tag-suggestion-item { padding:8px 12px; cursor:pointer; border-bottom:1px solid #f3f4f6; font-size:0.9rem; }
.tag-suggestion-item:hover { background:#e8ebe4; }
.sort-chip { display:inline-flex; align-items:center; gap:4px; padding:4px 10px; border-radius:20px; font-size:0.75rem; font-weight:600; cursor:pointer; user-select:none; border:2px solid #9AA581; color:#9AA581; background:white; }
.sort-chip.active { background:#9AA581; color:white; }
.sort-option { display:inline-flex; align-items:center; padding:4px 10px; border-radius:20px; font-size:0.75rem; font-weight:600; cursor:pointer; border:2px solid #d1d5db; color:#6b7280; background:white; }
.sort-option:hover { border-color:#9AA581; color:#9AA581; }
.filter-chip { display:inline-flex; align-items:center; gap:4px; padding:4px 10px; border-radius:20px; font-size:0.75rem; font-weight:600; cursor:pointer; border:2px solid #d1d5db; color:#6b7280; background:white; }
.filter-chip:hover { border-color:#859EAC; color:#859EAC; }
.filter-chip.active { background:#859EAC; color:white; border-color:#859EAC; }
.detail-photo-header { width:100%; height:220px; object-fit:cover; display:block; }
.detail-photo-placeholder { width:100%; height:130px; background:linear-gradient(135deg,#9AA581,#859EAC); }
.detail-back-btn { position:absolute; top:12px; left:12px; background:rgba(0,0,0,0.45); color:white; border:none; border-radius:20px; padding:5px 14px; font-size:0.8rem; font-weight:600; cursor:pointer; }
.cal-cell { background:white; min-height:56px; padding:4px; display:flex; flex-direction:column; align-items:center; cursor:pointer; transition:background 0.15s; }
.cal-cell:hover { background:#f8faf6; }
.cal-cell.today .cal-day-num { background:#9AA581; color:white; border-radius:50%; }
.cal-cell.selected { background:#f0f4ec !important; }
.cal-cell.other-month .cal-day-num { color:#d1d5db; }
.cal-day-num { font-size:0.8rem; font-weight:600; color:#374151; width:24px; height:24px; display:flex; align-items:center; justify-content:center; }
.cal-dot-row { display:flex; gap:2px; flex-wrap:wrap; justify-content:center; margin-top:2px; }
.cal-dot { width:6px; height:6px; border-radius:50%; background:#9AA581; flex-shrink:0; }
.cal-dot.blue { background:#859EAC; }
#successToast { position:fixed; bottom:28px; left:50%; transform:translateX(-50%) translateY(20px); background:#2d6a4f; color:white; padding:12px 24px; border-radius:999px; font-size:0.9rem; font-weight:600; box-shadow:0 4px 20px rgba(0,0,0,0.2); opacity:0; transition:opacity 0.3s,transform 0.3s; pointer-events:none; z-index:9998; }
#successToast.show { opacity:1; transform:translateX(-50%) translateY(0); }
@media print { .no-print { display:none !important; } }
input[type="range"] { -webkit-appearance:none; appearance:none; background:transparent; cursor:pointer; }
input[type="range"]::-webkit-slider-track { background:#e5e7eb; height:6px; border-radius:3px; }
input[type="range"]::-webkit-slider-thumb { -webkit-appearance:none; background:#9AA581; height:18px; width:18px; border-radius:50%; margin-top:-6px; }
</style>
</head>
<body class="p-3">

<div class="max-w-3xl mx-auto">
<div class="bg-white rounded-xl shadow-2xl overflow-hidden">

  <!-- HEADER -->
  <div class="p-5 text-white no-print" style="background:#9AA581;">
    <h1 class="text-2xl font-bold mb-1">My Travel Journal</h1>
    <p class="text-sm opacity-80 mb-3" id="placeCount">0 places visited</p>
    <div class="flex flex-wrap gap-2">
      <button onclick="setView('list')" id="navList" class="nav-btn active">List</button>
      <button onclick="setView('map')" id="navMap" class="nav-btn">Map</button>
      <button onclick="setView('stats')" id="navStats" class="nav-btn">Stats</button>
      <button onclick="setView('calendar')" id="navCalendar" class="nav-btn">Calendar</button>
      <button onclick="showForm()" class="nav-btn" style="background:white;color:#859EAC;">+ Add Place</button>
    </div>
  </div>

  <!-- FILTER BAR -->
  <div id="filterBar" class="p-4 bg-gray-50 border-b no-print">
    <div class="flex flex-col gap-2">
      <input type="text" id="searchInput" placeholder="Search places..." class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" autocomplete="off"/>
      <div class="flex gap-2">
        <button onclick="toggleFilterPanel()" id="filterToggleBtn" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm bg-white text-gray-700 font-medium">Filter ▾</button>
        <button onclick="toggleSortPanel()" id="sortToggleBtn" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm bg-white text-gray-700 font-medium">Sort ▾</button>
      </div>
      <div id="activeFilterDisplay" class="hidden flex-wrap gap-1" style="display:none;"></div>
      <div id="activeSortDisplay" class="hidden flex-wrap gap-1" style="display:none;"></div>

      <div id="filterPanel" class="hidden border border-gray-200 rounded-lg bg-white p-3 space-y-3">
        <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Filter by Trip</div>
        <div id="filterTripOptions" class="flex flex-wrap gap-2"></div>
        <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Filter by Rating</div>
        <div class="flex flex-wrap gap-2">
          <span class="filter-chip" data-type="rating" data-value="5" onclick="toggleFilterChip(this)">★★★★★ 5</span>
          <span class="filter-chip" data-type="rating" data-value="4.5" onclick="toggleFilterChip(this)">4.5+</span>
          <span class="filter-chip" data-type="rating" data-value="4" onclick="toggleFilterChip(this)">4+</span>
          <span class="filter-chip" data-type="rating" data-value="3" onclick="toggleFilterChip(this)">3+</span>
        </div>
        <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Filter by Type</div>
        <div id="filterTagOptions" class="flex flex-wrap gap-2"></div>
        <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Filter by Visited With</div>
        <div id="filterPeopleOptions" class="flex flex-wrap gap-2"></div>
        <button onclick="clearAllFilters()" class="text-xs text-red-400 hover:text-red-600">Clear all filters</button>
      </div>

      <div id="sortPanel" class="hidden border border-gray-200 rounded-lg bg-white p-3">
        <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Active sorts</div>
        <div id="sortChips" class="flex flex-wrap gap-2 mb-3"></div>
        <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Add sort</div>
        <div id="sortOptions" class="flex flex-wrap gap-2"></div>
      </div>
    </div>
  </div>

  <!-- ADD/EDIT FORM -->
  <form id="placeForm" class="p-4 bg-gray-50 border-b hidden">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold text-gray-800" id="formTitle">Add New Place</h2>
    </div>
    <div class="space-y-3">

      <div>
        <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">Place Name *</label>
        <input type="text" id="placeName" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="e.g., Eiffel Tower"/>
      </div>

      <div class="grid grid-cols-3 gap-2">
        <div class="relative">
          <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">City *</label>
          <input type="text" id="placeCity" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="Paris" autocomplete="off"/>
          <div id="citySuggestions" class="tag-suggestions"></div>
        </div>
        <div class="relative">
          <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">State</label>
          <input type="text" id="placeState" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="CA" autocomplete="off"/>
          <div id="stateSuggestions" class="tag-suggestions"></div>
        </div>
        <div class="relative">
          <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">Country *</label>
          <input type="text" id="placeCountry" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="France" autocomplete="off"/>
          <div id="countrySuggestions" class="tag-suggestions"></div>
        </div>
      </div>

      <div class="relative">
        <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">Trip Group (optional)</label>
        <input type="text" id="placeTrip" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="e.g., Europe 2024" autocomplete="off"/>
        <div id="tripSuggestions" class="tag-suggestions"></div>
      </div>

      <div>
        <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">Apple Maps Link (optional)</label>
        <input type="text" id="placeMapLink" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="https://maps.apple.com/..."/>
      </div>

      <div>
        <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">Visit Dates (optional)</label>
        <div id="datesContainer" class="space-y-2"></div>
        <button type="button" onclick="addDateField()" class="mt-2 text-sm px-3 py-1 border rounded-lg" style="border-color:#9AA581;color:#9AA581;">+ Add Date</button>
      </div>

      <div>
        <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">Overall Rating: <span id="ratingValue">5</span>/5</label>
        <div class="flex gap-1" id="mainStars">
          <span class="star-btn" onclick="setRating(1)" style="color:#9AA581;">★</span>
          <span class="star-btn" onclick="setRating(2)" style="color:#9AA581;">★</span>
          <span class="star-btn" onclick="setRating(3)" style="color:#9AA581;">★</span>
          <span class="star-btn" onclick="setRating(4)" style="color:#9AA581;">★</span>
          <span class="star-btn" onclick="setRating(5)" style="color:#9AA581;">★</span>
        </div>
        <input type="hidden" id="placeRating" value="5">
      </div>

      <div>
        <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">Zepeda Stars (optional)</label>
        <div class="flex gap-2">
          <button type="button" class="zepeda-btn" data-value="1" onclick="selectZepeda(1)">!</button>
          <button type="button" class="zepeda-btn" data-value="2" onclick="selectZepeda(2)">!!</button>
          <button type="button" class="zepeda-btn" data-value="3" onclick="selectZepeda(3)">!!!</button>
        </div>
        <input type="hidden" id="placeZepeda" value="0">
      </div>

      <div class="border-t pt-3">
        <label class="block text-xs font-semibold text-gray-600 mb-2 uppercase tracking-wide">Sub-Ratings (optional)</label>
        <div id="subRatingsContainer" class="space-y-2"></div>
        <button type="button" onclick="addSubRating()" class="mt-2 text-sm px-3 py-1 border rounded-lg" style="border-color:#9AA581;color:#9AA581;">+ Add Sub-Rating</button>
      </div>

      <div class="grid grid-cols-2 gap-2">
        <div class="relative">
          <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">Type of Place</label>
          <input type="text" id="placeTypeTags" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="restaurant, museum..." autocomplete="off"/>
          <div id="typeTagSuggestions" class="tag-suggestions"></div>
        </div>
        <div class="relative">
          <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">Visited With</label>
          <input type="text" id="placePeopleTags" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="family, friends..." autocomplete="off"/>
          <div id="peopleTagSuggestions" class="tag-suggestions"></div>
        </div>
      </div>

      <div>
        <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">Photos</label>
        <input type="file" id="placePhotos" accept="image/*" multiple class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"/>
        <div id="photoPreviewContainer" class="mt-2 flex flex-wrap gap-2"></div>
      </div>

      <div>
        <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">Notes</label>
        <textarea id="placeNotes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="Memories, tips, thoughts..."></textarea>
      </div>
    </div>

    <div class="flex gap-2 mt-4">
      <button type="submit" class="flex-1 text-white py-3 rounded-lg font-semibold text-sm" style="background:#9AA581;">Save Place</button>
      <button type="button" onclick="cancelForm()" class="px-5 py-3 border border-gray-300 text-gray-600 rounded-lg text-sm font-semibold">Cancel</button>
    </div>
  </form>

  <!-- LIST VIEW -->
  <div id="listView" class="p-4">
    <div id="placesList"></div>
  </div>

  <!-- MAP VIEW -->
  <div id="mapView" class="p-4 hidden">
    <div id="mapContent"></div>
  </div>

  <!-- STATS VIEW -->
  <div id="statsView" class="p-4 hidden">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold text-gray-800">Statistics</h2>
      <div class="flex gap-2">
        <select id="yearReviewSelect" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
          <option value="">Year in Review...</option>
        </select>
        <button onclick="exportPDF()" class="px-4 py-2 text-white rounded-lg text-sm font-semibold" style="background:#859EAC;">Export PDF</button>
      </div>
    </div>
    <div id="statsContent"></div>
    <div id="yearReviewContent" class="mt-4"></div>
  </div>

  <!-- CALENDAR VIEW -->
  <div id="calendarView" class="p-4 hidden">
    <div class="flex items-center justify-between mb-4">
      <button onclick="calPrev()" class="w-9 h-9 rounded-full flex items-center justify-center text-xl font-bold hover:bg-gray-100" style="color:#9AA581;border:none;background:none;cursor:pointer;">‹</button>
      <div class="text-center">
        <div class="font-bold text-gray-800 text-lg" id="calMonthLabel"></div>
        <div class="text-xs text-gray-400" id="calYearLabel"></div>
      </div>
      <button onclick="calNext()" class="w-9 h-9 rounded-full flex items-center justify-center text-xl font-bold hover:bg-gray-100" style="color:#9AA581;border:none;background:none;cursor:pointer;">›</button>
    </div>
    <div class="grid grid-cols-7 mb-1">
      <div class="text-center text-xs font-semibold text-gray-400 py-1">Sun</div>
      <div class="text-center text-xs font-semibold text-gray-400 py-1">Mon</div>
      <div class="text-center text-xs font-semibold text-gray-400 py-1">Tue</div>
      <div class="text-center text-xs font-semibold text-gray-400 py-1">Wed</div>
      <div class="text-center text-xs font-semibold text-gray-400 py-1">Thu</div>
      <div class="text-center text-xs font-semibold text-gray-400 py-1">Fri</div>
      <div class="text-center text-xs font-semibold text-gray-400 py-1">Sat</div>
    </div>
    <div id="calGrid" class="grid grid-cols-7 gap-px bg-gray-200 rounded-xl overflow-hidden border border-gray-200"></div>
    <div id="calDayDetail" class="mt-4 space-y-2"></div>
  </div>

  <!-- DETAIL VIEW -->
  <div id="detailView" class="hidden overflow-hidden">
    <div class="relative" id="detailHeaderWrap"></div>
    <div class="p-4 space-y-4" id="detailBody"></div>
    <div class="p-4 pt-0 flex gap-2">
      <button onclick="detailEdit()" class="flex-1 py-3 rounded-lg font-semibold text-sm text-white" style="background:#9AA581;">Edit</button>
      <button onclick="detailAddVisit()" class="flex-1 py-3 rounded-lg font-semibold text-sm text-white" style="background:#859EAC;">+ Add New Visit</button>
    </div>
  </div>

  <!-- PHOTO MODAL -->
  <div id="photoModal" class="modal">
    <span onclick="document.getElementById('photoModal').classList.remove('active')" class="absolute top-4 right-6 text-white text-4xl cursor-pointer">&times;</span>
    <img id="modalImg" src="" alt="Photo">
  </div>

</div><!-- bg-white -->
</div><!-- max-w-3xl -->

<div class="text-center mt-4 text-white text-xs opacity-70 pb-2 no-print">Data saved locally in your browser</div>
<div id="pdfContent" style="display:none;"></div>
<div id="successToast"></div>

<script>
// ================================================================
// STATE
// ================================================================
let places = [];
let editingId = null;
let currentPhotos = [];
let subRatingCounter = 0;
let subRatingClicks = {};
let currentRating = 5;
let currentView = 'list';
let activeSorts = [];
let activeFilters = [];
let calYear = new Date().getFullYear();
let calMonth = new Date().getMonth();
let calSelectedDay = null;
let detailPlaceId = null;

let allTypeTags = new Set(), allPeopleTags = new Set();
let allCities = new Set(), allStates = new Set(), allCountries = new Set(), allTrips = new Set();

// ================================================================
// INIT
// ================================================================
document.addEventListener('DOMContentLoaded', function() {
  loadPlaces();
  document.getElementById('placeForm').addEventListener('submit', handleSubmit);
  setupAutocomplete('placeCity', 'citySuggestions', allCities);
  setupAutocomplete('placeState', 'stateSuggestions', allStates);
  setupAutocomplete('placeCountry', 'countrySuggestions', allCountries);
  setupAutocomplete('placeTrip', 'tripSuggestions', allTrips);
  setupTagAutocomplete('placeTypeTags', 'typeTagSuggestions', allTypeTags);
  setupTagAutocomplete('placePeopleTags', 'peopleTagSuggestions', allPeopleTags);
  document.getElementById('yearReviewSelect').addEventListener('change', renderYearReview);
  document.getElementById('placePhotos').addEventListener('change', handlePhotoUpload);
  document.getElementById('searchInput').addEventListener('input', renderCurrentView);
  renderCurrentView();
});

// ================================================================
// STORAGE
// ================================================================
function loadPlaces() {
  places = [];
  try {
    for (let i = 0; i < localStorage.length; i++) {
      const k = localStorage.key(i);
      if (k && k.startsWith('tj_place_')) {
        try { const v = localStorage.getItem(k); if (v) places.push(JSON.parse(v)); } catch(e) {}
      }
    }
  } catch(e) { places = []; }
  rebuildSets();
  refreshYearSelect();
}

function saveToStorage(place) {
  try { localStorage.setItem('tj_place_' + place.id, JSON.stringify(place)); } catch(e) {}
}

function deleteFromStorage(id) {
  try { localStorage.removeItem('tj_place_' + id); } catch(e) {}
}

// ================================================================
// NAVIGATION
// ================================================================
function setView(view) {
  currentView = view;
  ['list','map','stats','calendar','detail'].forEach(function(v) {
    var el = document.getElementById(v + 'View');
    if (el) el.classList.add('hidden');
    var btn = document.getElementById('nav' + v.charAt(0).toUpperCase() + v.slice(1));
    if (btn) { btn.classList.remove('active'); }
  });
  document.getElementById(view + 'View').classList.remove('hidden');
  var activeBtn = document.getElementById('nav' + view.charAt(0).toUpperCase() + view.slice(1));
  if (activeBtn) activeBtn.classList.add('active');
  var hideFilter = (view === 'stats' || view === 'detail' || view === 'calendar');
  document.getElementById('filterBar').classList.toggle('hidden', hideFilter);
  document.getElementById('placeForm').classList.add('hidden');
  renderCurrentView();
}

function renderCurrentView() {
  if (currentView === 'list') renderList();
  else if (currentView === 'map') renderMap();
  else if (currentView === 'stats') renderStats();
  else if (currentView === 'calendar') renderCalendar();
}

// ================================================================
// FORM
// ================================================================
function showForm() {
  ['listView','mapView','statsView','calendarView','detailView'].forEach(function(id) {
    var el = document.getElementById(id);
    if (el) el.classList.add('hidden');
  });
  document.getElementById('filterBar').classList.add('hidden');
  document.getElementById('placeForm').classList.remove('hidden');
  document.getElementById('formTitle').textContent = editingId ? 'Edit Place' : 'Add New Place';
}

function cancelForm() {
  editingId = null;
  currentPhotos = [];
  subRatingCounter = 0;
  subRatingClicks = {};
  currentRating = 5;
  document.getElementById('placeForm').reset();
  document.getElementById('placeForm').classList.add('hidden');
  document.getElementById('placeRating').value = '5';
  document.getElementById('ratingValue').textContent = '5';
  document.getElementById('placeZepeda').value = '0';
  document.getElementById('photoPreviewContainer').innerHTML = '';
  document.getElementById('subRatingsContainer').innerHTML = '';
  document.getElementById('datesContainer').innerHTML = '';
  updateMainStars(5);
  document.querySelectorAll('.zepeda-btn').forEach(function(b) { b.classList.remove('active'); });
  setView('list');
}

function handleSubmit(e) {
  e.preventDefault();
  var name = document.getElementById('placeName').value.trim();
  var city = document.getElementById('placeCity').value.trim();
  var country = document.getElementById('placeCountry').value.trim();
  if (!name || !city || !country) {
    alert('Please fill in Place Name, City, and Country.');
    return;
  }
  var state = document.getElementById('placeState').value.trim();
  var rawTypeTags = document.getElementById('placeTypeTags').value;
  var rawPeopleTags = document.getElementById('placePeopleTags').value;
  var typeTags = rawTypeTags.split(',').map(function(t){ return t.trim(); }).filter(Boolean);
  var peopleTags = rawPeopleTags.split(',').map(function(t){ return t.trim(); }).filter(Boolean);
  var wasEditing = !!editingId;
  var existingPlace = wasEditing ? places.find(function(p){ return p.id === editingId; }) : null;

  var place = {
    id: editingId || String(Date.now()),
    name: name,
    city: city,
    state: state,
    country: country,
    location: state ? city + ', ' + state + ', ' + country : city + ', ' + country,
    trip: document.getElementById('placeTrip').value.trim(),
    mapLink: document.getElementById('placeMapLink').value.trim(),
    dates: getVisitDates(),
    rating: parseFloat(document.getElementById('placeRating').value) || 5,
    zepedaStars: parseInt(document.getElementById('placeZepeda').value) || 0,
    subRatings: getSubRatings(),
    typeTags: typeTags,
    peopleTags: peopleTags,
    tags: typeTags.concat(peopleTags),
    notes: document.getElementById('placeNotes').value.trim(),
    photos: currentPhotos.slice(),
    isWishlist: false,
    createdAt: existingPlace ? existingPlace.createdAt : new Date().toISOString()
  };

  if (wasEditing) {
    var idx = places.findIndex(function(p){ return p.id === place.id; });
    if (idx >= 0) places[idx] = place; else places.push(place);
  } else {
    places.push(place);
  }

  saveToStorage(place);
  rebuildSets();
  refreshYearSelect();
  cancelForm();
  showToast(wasEditing ? '✓ Place updated!' : '✓ Place saved!');
}

// ================================================================
// DATES
// ================================================================
function addDateField(val) {
  val = val || '';
  var div = document.createElement('div');
  div.className = 'flex gap-2';
  var input = document.createElement('input');
  input.type = 'date';
  input.value = val;
  input.className = 'visit-date flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm';
  var btn = document.createElement('button');
  btn.type = 'button';
  btn.textContent = 'Remove';
  btn.className = 'text-red-500 text-sm px-2';
  btn.onclick = function() { div.remove(); };
  div.appendChild(input);
  div.appendChild(btn);
  document.getElementById('datesContainer').appendChild(div);
}

function getVisitDates() {
  return Array.from(document.querySelectorAll('.visit-date')).map(function(i){ return i.value; }).filter(Boolean).sort();
}

// ================================================================
// RATINGS
// ================================================================
function setRating(n) {
  // Double-click same star = half star
  var cur = parseFloat(document.getElementById('placeRating').value);
  var newVal = (cur === n) ? n - 0.5 : n;
  if (newVal < 0.5) newVal = 0.5;
  document.getElementById('placeRating').value = newVal;
  document.getElementById('ratingValue').textContent = newVal;
  currentRating = newVal;
  updateMainStars(newVal);
}

function updateMainStars(r) {
  var stars = document.querySelectorAll('#mainStars .star-btn');
  var full = Math.floor(r), half = (r % 1 !== 0);
  stars.forEach(function(s, i) {
    if (i < full) { s.textContent = '★'; s.style.color = '#9AA581'; }
    else if (i === full && half) { s.textContent = '½'; s.style.color = '#9AA581'; }
    else { s.textContent = '★'; s.style.color = '#d1d5db'; }
  });
}

function getStarText(r) {
  if (!r) return '☆';
  var full = Math.floor(r), half = (r % 1 !== 0);
  return '★'.repeat(full) + (half ? '½' : '') + '☆'.repeat(5 - full - (half ? 1 : 0));
}

function selectZepeda(v) {
  var cur = parseInt(document.getElementById('placeZepeda').value) || 0;
  var newVal = (cur === v) ? 0 : v;
  document.getElementById('placeZepeda').value = newVal;
  document.querySelectorAll('.zepeda-btn').forEach(function(b) {
    b.classList.toggle('active', parseInt(b.dataset.value) === newVal);
  });
}

// ================================================================
// SUB-RATINGS
// ================================================================
function addSubRating(cat, rating) {
  cat = cat || ''; rating = rating || 5;
  var id = subRatingCounter++;
  subRatingClicks[id] = { last: 0, count: 0 };
  var div = document.createElement('div');
  div.className = 'border border-gray-200 rounded-lg p-2 bg-white';
  div.innerHTML =
    '<div class="flex gap-2 mb-1">' +
    '<input type="text" class="sub-rating-category flex-1 px-2 py-1 border border-gray-200 rounded text-sm" placeholder="e.g., Food" value="' + esc(cat) + '"/>' +
    '<button type="button" onclick="this.closest(\'.border\').remove()" class="text-red-500 text-sm">Remove</button>' +
    '</div>' +
    '<div class="flex gap-1" data-sub-id="' + id + '">' +
    [1,2,3,4,5].map(function(n){ return '<span class="sub-star" style="color:#859EAC;cursor:pointer;" onclick="setSubRating(this,' + n + ',' + id + ')">★</span>'; }).join('') +
    '</div>' +
    '<input type="hidden" class="sub-rating-value" value="' + rating + '">';
  document.getElementById('subRatingsContainer').appendChild(div);
  updateSubStars(div.querySelectorAll('.sub-star'), rating);
}

function setSubRating(el, n, id) {
  var div = el.closest('.border');
  var stars = div.querySelectorAll('.sub-star');
  var input = div.querySelector('.sub-rating-value');
  var d = subRatingClicks[id] || { last: 0, count: 0 };
  if (d.last === n) {
    d.count++;
    if (d.count === 2) { input.value = n - 0.5; updateSubStars(stars, n - 0.5); }
    else { d.count = 1; input.value = n; updateSubStars(stars, n); }
  } else {
    d.last = n; d.count = 1; input.value = n; updateSubStars(stars, n);
  }
  subRatingClicks[id] = d;
}

function updateSubStars(stars, r) {
  var full = Math.floor(r), half = (r % 1 !== 0);
  stars.forEach(function(s, i) {
    if (i < full) { s.textContent = '★'; s.style.color = '#859EAC'; }
    else if (i === full && half) { s.textContent = '½'; s.style.color = '#859EAC'; }
    else { s.textContent = '★'; s.style.color = '#d1d5db'; }
  });
}

function getSubRatings() {
  var obj = {};
  document.querySelectorAll('#subRatingsContainer .border').forEach(function(div) {
    var cat = div.querySelector('.sub-rating-category').value.trim();
    var val = parseFloat(div.querySelector('.sub-rating-value').value);
    if (cat) obj[cat] = val;
  });
  return obj;
}

// ================================================================
// PHOTOS
// ================================================================
function handlePhotoUpload(e) {
  Array.from(e.target.files).forEach(function(file) {
    var r = new FileReader();
    r.onload = function(ev) { currentPhotos.push(ev.target.result); renderPhotoPreview(); };
    r.readAsDataURL(file);
  });
}

function renderPhotoPreview() {
  var c = document.getElementById('photoPreviewContainer');
  c.innerHTML = '';
  currentPhotos.forEach(function(ph, i) {
    var wrap = document.createElement('div');
    wrap.className = 'relative';
    var img = document.createElement('img');
    img.className = 'photo-preview';
    img.src = ph;
    img.onclick = function() { openPhoto(ph); };
    var btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center';
    btn.textContent = '×';
    btn.onclick = function() { currentPhotos.splice(i, 1); renderPhotoPreview(); };
    wrap.appendChild(img);
    wrap.appendChild(btn);
    c.appendChild(wrap);
  });
}

function openPhoto(src) {
  document.getElementById('modalImg').src = src;
  document.getElementById('photoModal').classList.add('active');
}

// ================================================================
// LIST VIEW
// ================================================================
function renderList() {
  var visited = places.filter(function(p){ return !p.isWishlist; });
  var count = visited.length;
  document.getElementById('placeCount').textContent = count + ' place' + (count !== 1 ? 's' : '') + ' visited';

  var el = document.getElementById('placesList');
  var filtered = getFilteredSorted();
  if (!filtered.length) {
    el.innerHTML = count === 0
      ? '<div class="text-center py-12 text-gray-400"><p class="text-lg font-medium">No places yet</p><p class="text-sm mt-1">Tap + Add Place to get started</p></div>'
      : '<div class="text-center py-10 text-gray-400"><p class="font-medium">No places match your filters</p></div>';
    return;
  }

  // Build country → state → city hierarchy
  var hier = {};
  filtered.forEach(function(p) {
    var co = p.country || 'Unknown';
    var st = p.state || '_none';
    var ci = p.city || 'Unknown';
    if (!hier[co]) hier[co] = {};
    if (!hier[co][st]) hier[co][st] = {};
    if (!hier[co][st][ci]) hier[co][st][ci] = [];
    hier[co][st][ci].push(p);
  });

  var html = '';
  Object.keys(hier).sort().forEach(function(co) {
    var coId = 'co-' + co.replace(/[^a-zA-Z0-9]/g, '-');
    html += '<div class="mb-3">';
    html += '<div class="section-header flex justify-between items-center p-3 rounded-lg font-bold text-base" style="background:#e8ebe4;" onclick="toggleSection(\'' + coId + '\')">';
    html += '<span style="color:#9AA581;">' + esc(co) + '</span>';
    html += '<span id="' + coId + '-arrow" class="collapse-arrow text-gray-500 text-sm">▼</span></div>';
    html += '<div id="' + coId + '" class="mt-1 ml-2">';

    Object.keys(hier[co]).sort().forEach(function(st) {
      var cities = hier[co][st];
      if (st !== '_none') {
        var stId = coId + '-' + st.replace(/[^a-zA-Z0-9]/g, '-');
        html += '<div class="mb-2">';
        html += '<div class="section-header flex justify-between items-center p-2 px-3 rounded-lg font-semibold text-sm" style="background:#e3eef3;" onclick="toggleSection(\'' + stId + '\')">';
        html += '<span style="color:#859EAC;">' + esc(st) + '</span>';
        html += '<span id="' + stId + '-arrow" class="collapse-arrow text-gray-400 text-xs">▼</span></div>';
        html += '<div id="' + stId + '" class="mt-1 ml-2">';
        Object.keys(cities).sort().forEach(function(ci) {
          html += buildCitySection(stId + '-' + ci.replace(/[^a-zA-Z0-9]/g, '-'), ci, cities[ci]);
        });
        html += '</div></div>';
      } else {
        Object.keys(cities).sort().forEach(function(ci) {
          html += buildCitySection(coId + '-' + ci.replace(/[^a-zA-Z0-9]/g, '-'), ci, cities[ci]);
        });
      }
    });
    html += '</div></div>';
  });

  el.innerHTML = html;
}

function buildCitySection(id, city, arr) {
  var html = '<div class="mb-2">';
  html += '<div class="section-header flex justify-between items-center p-2 px-3 rounded-lg font-medium text-sm bg-gray-100" onclick="toggleSection(\'' + id + '\')">';
  html += '<span class="text-gray-700">' + esc(city) + '</span>';
  html += '<span id="' + id + '-arrow" class="collapse-arrow text-gray-400 text-xs">▼</span></div>';
  html += '<div id="' + id + '" class="mt-1 ml-2 space-y-2">';
  arr.forEach(function(p) { html += renderCard(p); });
  html += '</div></div>';
  return html;
}

function renderCard(p) {
  var dates = (p.dates && p.dates.filter(Boolean).length) ? p.dates.filter(Boolean) : (p.date ? [p.date] : []);
  var latestDate = dates.length ? new Date(dates[dates.length-1]).toLocaleDateString('en-US',{year:'numeric',month:'short',day:'numeric'}) : '';
  var visitsLabel = dates.length > 1 ? dates.length + ' visits' : latestDate;
  var thumb = p.photos && p.photos[0];
  var safeId = p.id;

  var html = '<div class="bg-white border border-gray-200 rounded-lg overflow-hidden cursor-pointer hover:shadow-md" style="transition:box-shadow 0.2s;" onclick="openDetailById(\'' + safeId + '\')">';
  html += '<div class="flex items-stretch">';
  if (thumb) {
    html += '<div class="w-20 flex-shrink-0" style="min-height:72px;overflow:hidden;"><img style="width:100%;height:100%;object-fit:cover;min-height:72px;" src="' + thumb + '"></div>';
  } else {
    html += '<div class="w-2 flex-shrink-0" style="background:#9AA581;border-radius:8px 0 0 8px;"></div>';
  }
  html += '<div class="flex-1 p-3 min-w-0">';
  html += '<div class="flex justify-between items-start gap-2">';
  html += '<div class="font-bold text-gray-800 text-sm leading-tight" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + esc(p.name) + '</div>';
  html += '<div class="flex-shrink-0 text-xs font-bold" style="color:#9AA581;">' + getStarText(p.rating) + '</div>';
  html += '</div>';
  html += '<div class="text-xs text-gray-400 mt-0.5">' + (visitsLabel || 'No date') + '</div>';
  html += '<div class="flex flex-wrap gap-1 mt-1">';
  if (p.trip) html += '<span class="px-1.5 py-0.5 rounded-full text-xs font-medium" style="background:#f0f4ec;color:#9AA581;">' + esc(p.trip) + '</span>';
  (p.typeTags||[]).slice(0,2).forEach(function(t){ html += '<span class="px-1.5 py-0.5 rounded-full text-xs" style="background:#e8ebe4;color:#9AA581;">' + esc(t) + '</span>'; });
  (p.peopleTags||[]).slice(0,2).forEach(function(t){ html += '<span class="px-1.5 py-0.5 rounded-full text-xs" style="background:#e3eef3;color:#859EAC;">' + esc(t) + '</span>'; });
  if (p.zepedaStars > 0) html += '<span class="px-1.5 py-0.5 rounded-full text-xs font-bold" style="background:#e3eef3;color:#859EAC;">' + '!'.repeat(p.zepedaStars) + '</span>';
  html += '</div></div></div></div>';
  return html;
}

function toggleSection(id) {
  var el = document.getElementById(id);
  var arrow = document.getElementById(id + '-arrow');
  if (el) el.classList.toggle('hidden');
  if (arrow) arrow.classList.toggle('collapsed');
}

// ================================================================
// FILTER & SORT
// ================================================================
function getFilteredSorted(wishlistOnly) {
  var search = document.getElementById('searchInput').value.toLowerCase();
  var tripFilters = activeFilters.filter(function(f){ return f.type==='trip'; }).map(function(f){ return f.value; });
  var typeTagFilters = activeFilters.filter(function(f){ return f.type==='typeTag'; }).map(function(f){ return f.value; });
  var peopleFilters = activeFilters.filter(function(f){ return f.type==='people'; }).map(function(f){ return f.value; });
  var ratingFilter = activeFilters.find(function(f){ return f.type==='rating'; });
  var minRating = ratingFilter ? parseFloat(ratingFilter.value) : null;

  var result = places.filter(function(p) {
    if (wishlistOnly) return !!p.isWishlist;
    if (p.isWishlist) return false;
    if (search) {
      var hay = (p.name+' '+(p.location||'')+' '+(p.notes||'')+' '+(p.trip||'')).toLowerCase();
      if (hay.indexOf(search) === -1) return false;
    }
    if (tripFilters.length && tripFilters.indexOf(p.trip) === -1) return false;
    if (typeTagFilters.length && !typeTagFilters.every(function(t){ return (p.typeTags||[]).indexOf(t) >= 0; })) return false;
    if (peopleFilters.length && !peopleFilters.every(function(t){ return (p.peopleTags||[]).indexOf(t) >= 0; })) return false;
    if (minRating !== null && (p.rating||0) < minRating) return false;
    return true;
  });

  if (activeSorts.length === 0) {
    result = sortBy(result, 'date-desc');
  } else {
    var sorts = activeSorts.slice().reverse();
    sorts.forEach(function(key) { result = sortBy(result, key); });
  }
  return result;
}

function sortBy(arr, key) {
  var a = arr.slice();
  a.sort(function(x, y) {
    switch(key) {
      case 'date-desc':   return getLastDate(y) - getLastDate(x);
      case 'date-asc':    return getLastDate(x) - getLastDate(y);
      case 'rating-desc': return (y.rating||0) - (x.rating||0);
      case 'rating-asc':  return (x.rating||0) - (y.rating||0);
      case 'zepeda-desc': return (y.zepedaStars||0) - (x.zepedaStars||0);
      case 'name-asc':    return (x.name||'').localeCompare(y.name||'');
      case 'name-desc':   return (y.name||'').localeCompare(x.name||'');
      case 'visits-desc': return (y.dates||[]).length - (x.dates||[]).length;
      case 'country-asc': return (x.country||'').localeCompare(y.country||'');
      case 'city-asc':    return (x.city||'').localeCompare(y.city||'');
      case 'trip-asc':    return (x.trip||'').localeCompare(y.trip||'');
      default: return 0;
    }
  });
  return a;
}

function getLastDate(p) {
  var d = (p.dates && p.dates.length) ? p.dates : (p.date ? [p.date] : []);
  return d.length ? new Date(d[d.length-1]).getTime() : 0;
}

// Sort panel
var SORT_OPTIONS = [
  {value:'date-desc',label:'Newest First'},{value:'date-asc',label:'Oldest First'},
  {value:'rating-desc',label:'Top Rated'},{value:'rating-asc',label:'Lowest Rated'},
  {value:'zepeda-desc',label:'Most Zepeda'},{value:'name-asc',label:'Name A-Z'},
  {value:'name-desc',label:'Name Z-A'},{value:'visits-desc',label:'Most Visited'},
  {value:'country-asc',label:'Country A-Z'},{value:'city-asc',label:'City A-Z'},
  {value:'trip-asc',label:'Trip A-Z'}
];

function toggleSortPanel() {
  document.getElementById('sortPanel').classList.toggle('hidden');
  renderSortPanel();
}

function renderSortPanel() {
  var chips = document.getElementById('sortChips');
  var opts = document.getElementById('sortOptions');
  chips.innerHTML = activeSorts.map(function(v, i) {
    var label = (SORT_OPTIONS.find(function(o){ return o.value===v; })||{}).label||v;
    return '<span class="sort-chip active">' + label +
      (i > 0 ? '<span onclick="moveSortUp(' + i + ')" style="cursor:pointer;margin-left:2px;">↑</span>' : '') +
      '<span onclick="removeSort(\'' + v + '\')" style="cursor:pointer;margin-left:4px;opacity:0.7;">×</span></span>';
  }).join('');
  var active = activeSorts;
  opts.innerHTML = SORT_OPTIONS.filter(function(o){ return active.indexOf(o.value) === -1; })
    .map(function(o){ return '<span class="sort-option" onclick="addSort(\'' + o.value + '\')">' + o.label + '</span>'; }).join('');
  var btn = document.getElementById('sortToggleBtn');
  btn.textContent = activeSorts.length ? 'Sort (' + activeSorts.length + ') ▾' : 'Sort ▾';
  btn.style.color = activeSorts.length ? '#9AA581' : '';
}

function addSort(v) { if (activeSorts.indexOf(v) === -1) activeSorts.push(v); renderSortPanel(); renderCurrentView(); }
function removeSort(v) { activeSorts = activeSorts.filter(function(x){ return x !== v; }); renderSortPanel(); renderCurrentView(); }
function moveSortUp(i) { var t = activeSorts[i-1]; activeSorts[i-1] = activeSorts[i]; activeSorts[i] = t; renderSortPanel(); renderCurrentView(); }

// Filter panel
function toggleFilterPanel() {
  document.getElementById('filterPanel').classList.toggle('hidden');
  if (!document.getElementById('filterPanel').classList.contains('hidden')) renderFilterPanel();
}

function renderFilterPanel() {
  var trips = Array.from(new Set(places.filter(function(p){ return !p.isWishlist && p.trip; }).map(function(p){ return p.trip; }))).sort();
  document.getElementById('filterTripOptions').innerHTML = trips.map(function(t) {
    var active = activeFilters.some(function(f){ return f.type==='trip' && f.value===t; });
    return '<span class="filter-chip' + (active?' active':'') + '" data-type="trip" data-value="' + esc(t) + '" data-label="Trip: ' + esc(t) + '" onclick="toggleFilterChip(this)">' + esc(t) + '</span>';
  }).join('') || '<span class="text-xs text-gray-400 italic">No trips yet</span>';

  var typeTags = Array.from(new Set(places.flatMap(function(p){ return p.typeTags||[]; }))).sort();
  document.getElementById('filterTagOptions').innerHTML = typeTags.map(function(t) {
    var active = activeFilters.some(function(f){ return f.type==='typeTag' && f.value===t; });
    return '<span class="filter-chip' + (active?' active':'') + '" data-type="typeTag" data-value="' + esc(t) + '" data-label="Type: ' + esc(t) + '" onclick="toggleFilterChip(this)">' + esc(t) + '</span>';
  }).join('') || '<span class="text-xs text-gray-400 italic">No types yet</span>';

  var people = Array.from(new Set(places.flatMap(function(p){ return p.peopleTags||[]; }))).sort();
  document.getElementById('filterPeopleOptions').innerHTML = people.map(function(t) {
    var active = activeFilters.some(function(f){ return f.type==='people' && f.value===t; });
    return '<span class="filter-chip' + (active?' active':'') + '" data-type="people" data-value="' + esc(t) + '" data-label="With: ' + esc(t) + '" onclick="toggleFilterChip(this)">' + esc(t) + '</span>';
  }).join('') || '<span class="text-xs text-gray-400 italic">No people yet</span>';

  document.querySelectorAll('#filterPanel [data-type="rating"]').forEach(function(chip) {
    chip.classList.toggle('active', activeFilters.some(function(f){ return f.type==='rating' && f.value===chip.dataset.value; }));
    chip.dataset.label = 'Rating: ' + chip.dataset.value + '+';
  });
}

function toggleFilterChip(el) {
  var type = el.dataset.type, value = el.dataset.value, label = el.dataset.label || (type + ': ' + value);
  var idx = activeFilters.findIndex(function(f){ return f.type===type && f.value===value; });
  if (idx >= 0) { activeFilters.splice(idx,1); el.classList.remove('active'); }
  else {
    if (type === 'rating') activeFilters = activeFilters.filter(function(f){ return f.type!=='rating'; });
    activeFilters.push({type:type, value:value, label:label});
    el.classList.add('active');
  }
  updateActiveFilterDisplay();
  renderCurrentView();
}

function removeFilter(type, value) {
  activeFilters = activeFilters.filter(function(f){ return !(f.type===type && f.value===value); });
  updateActiveFilterDisplay();
  renderFilterPanel();
  renderCurrentView();
}

function clearAllFilters() {
  activeFilters = [];
  updateActiveFilterDisplay();
  renderFilterPanel();
  renderCurrentView();
}

function updateActiveFilterDisplay() {
  var el = document.getElementById('activeFilterDisplay');
  var btn = document.getElementById('filterToggleBtn');
  if (!activeFilters.length) {
    el.style.display = 'none';
    btn.textContent = 'Filter ▾';
    btn.style.color = '';
  } else {
    el.style.display = 'flex';
    el.innerHTML = activeFilters.map(function(f) {
      return '<span class="filter-chip active" style="font-size:0.7rem;padding:2px 8px;">' + esc(f.label) +
        '<span onclick="removeFilter(\'' + esc(f.type) + '\',\'' + esc(f.value) + '\')" style="cursor:pointer;margin-left:4px;"> ×</span></span>';
    }).join('');
    btn.textContent = 'Filter (' + activeFilters.length + ') ▾';
    btn.style.color = '#859EAC';
  }
}

// ================================================================
// DETAIL VIEW
// ================================================================
function openDetailById(id) {
  var p = places.find(function(x){ return x.id === id; });
  if (p) openDetail(p);
}

function openDetail(p) {
  detailPlaceId = p.id;
  var prevView = currentView;
  ['listView','mapView','statsView','calendarView'].forEach(function(id) {
    var el = document.getElementById(id); if (el) el.classList.add('hidden');
  });
  document.getElementById('filterBar').classList.add('hidden');
  document.getElementById('detailView').classList.remove('hidden');

  var photos = p.photos || [];
  var wrap = document.getElementById('detailHeaderWrap');
  wrap.innerHTML = '';
  if (photos.length) {
    var img = document.createElement('img');
    img.className = 'detail-photo-header';
    img.style.cursor = 'pointer';
    img.src = photos[0];
    img.onclick = function() { openPhoto(photos[0]); };
    wrap.appendChild(img);
  } else {
    var ph = document.createElement('div');
    ph.className = 'detail-photo-placeholder';
    wrap.appendChild(ph);
  }
  var backBtn = document.createElement('button');
  backBtn.className = 'detail-back-btn';
  backBtn.innerHTML = '&#8592; Back';
  backBtn.onclick = function() { closeDetail(prevView); };
  wrap.appendChild(backBtn);
  if (photos.length > 1) {
    var badge = document.createElement('div');
    badge.className = 'absolute bottom-2 right-3 text-white text-xs rounded-full px-2 py-0.5';
    badge.style.background = 'rgba(0,0,0,0.4)';
    badge.textContent = photos.length + ' photos';
    wrap.appendChild(badge);
  }

  var dates = (p.dates||[p.date]).filter(Boolean);
  var dateList = dates.length
    ? dates.map(function(d){ return new Date(d+'T12:00:00').toLocaleDateString('en-US',{weekday:'short',year:'numeric',month:'long',day:'numeric'}); }).join('<br>')
    : '<span class="text-gray-400 italic">No dates recorded</span>';

  var subHtml = '';
  if (Object.keys(p.subRatings||{}).length) {
    subHtml = '<div class="bg-white border border-gray-100 rounded-xl p-3"><div class="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-2">Sub-Ratings</div>';
    Object.entries(p.subRatings).forEach(function(kv) {
      subHtml += '<div class="flex justify-between py-1 border-b border-gray-50"><span class="text-sm text-gray-500">' + esc(kv[0]) + '</span><span class="text-sm" style="color:#859EAC;">' + getStarText(kv[1]) + '</span></div>';
    });
    subHtml += '</div>';
  }

  var body = document.getElementById('detailBody');
  body.innerHTML =
    '<div><h2 class="text-2xl font-bold text-gray-900">' + esc(p.name) + '</h2>' +
    '<p class="text-gray-500 text-sm mt-0.5">' + esc(p.location||'') + '</p>' +
    (p.mapLink ? '<a href="' + esc(p.mapLink) + '" target="_blank" class="text-sm font-medium hover:underline mt-1 inline-block" style="color:#9AA581;">View on Apple Maps ↗</a>' : '') + '</div>' +

    '<div class="bg-gray-50 rounded-xl p-3 flex gap-4 items-center">' +
    '<div class="text-center"><div class="text-2xl" style="color:#9AA581;">' + getStarText(p.rating) + '</div><div class="text-xs text-gray-400 mt-0.5">Rating (' + (p.rating||0) + '/5)</div></div>' +
    (p.zepedaStars > 0 ? '<div class="text-center border-l border-gray-200 pl-4"><div class="text-2xl font-bold" style="color:#859EAC;">' + '!'.repeat(p.zepedaStars) + '</div><div class="text-xs text-gray-400 mt-0.5">Zepeda Stars</div></div>' : '') +
    '</div>' +

    subHtml +

    '<div class="bg-white border border-gray-100 rounded-xl p-3"><div class="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-2">' + (dates.length > 1 ? dates.length + ' Visits' : 'Visit Date') + '</div><div class="text-sm text-gray-700 leading-relaxed">' + dateList + '</div></div>' +

    (p.trip ? '<div class="flex items-center gap-2"><span class="text-xs font-semibold text-gray-400 uppercase">Trip</span><span class="px-3 py-1 rounded-full text-sm font-medium" style="background:#f0f4ec;color:#9AA581;">' + esc(p.trip) + '</span></div>' : '') +

    ((p.typeTags||[]).length || (p.peopleTags||[]).length ? '<div class="space-y-2">' +
      ((p.typeTags||[]).length ? '<div><div class="text-xs font-semibold text-gray-400 uppercase mb-1">Type of Place</div><div class="flex flex-wrap gap-1">' + (p.typeTags||[]).map(function(t){ return '<span class="px-2 py-1 rounded-full text-xs font-medium" style="background:#e8ebe4;color:#9AA581;">' + esc(t) + '</span>'; }).join('') + '</div></div>' : '') +
      ((p.peopleTags||[]).length ? '<div><div class="text-xs font-semibold text-gray-400 uppercase mb-1">Visited With</div><div class="flex flex-wrap gap-1">' + (p.peopleTags||[]).map(function(t){ return '<span class="px-2 py-1 rounded-full text-xs font-medium" style="background:#e3eef3;color:#859EAC;">' + esc(t) + '</span>'; }).join('') + '</div></div>' : '') +
    '</div>' : '') +

    (p.notes ? '<div class="bg-white border border-gray-100 rounded-xl p-3"><div class="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-2">Notes</div><p class="text-sm text-gray-700 leading-relaxed" style="white-space:pre-line;">' + esc(p.notes) + '</p></div>' : '') +

    (photos.length > 1 ? '<div><div class="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-2">All Photos</div><div id="detailPhotoStrip" class="flex gap-2 flex-wrap"></div></div>' : '');

  if (photos.length > 1) {
    var strip = document.getElementById('detailPhotoStrip');
    photos.forEach(function(ph) {
      var img2 = document.createElement('img');
      img2.className = 'photo-preview';
      img2.src = ph;
      img2.onclick = (function(src){ return function(){ openPhoto(src); }; })(ph);
      strip.appendChild(img2);
    });
  }
}

function closeDetail(prev) {
  document.getElementById('detailView').classList.add('hidden');
  document.getElementById('filterBar').classList.remove('hidden');
  setView(prev || 'list');
}

function detailEdit() {
  var p = places.find(function(x){ return x.id === detailPlaceId; });
  if (p) {
    document.getElementById('detailView').classList.add('hidden');
    editPlace(p);
  }
}

function detailAddVisit() {
  var p = places.find(function(x){ return x.id === detailPlaceId; });
  if (!p) return;
  editPlace(p);
  setTimeout(function() {
    var c = document.getElementById('datesContainer');
    var div = document.createElement('div');
    div.className = 'flex gap-2';
    var inp = document.createElement('input');
    inp.type = 'date';
    inp.className = 'visit-date flex-1 px-3 py-2 border-2 rounded-lg text-sm';
    inp.style.borderColor = '#859EAC';
    var btn = document.createElement('button');
    btn.type = 'button';
    btn.textContent = 'Remove';
    btn.className = 'text-red-500 text-sm px-2';
    btn.onclick = function() { div.remove(); };
    div.appendChild(inp);
    div.appendChild(btn);
    c.insertBefore(div, c.firstChild);
    inp.focus();
  }, 50);
}

function editPlace(p) {
  editingId = p.id;
  currentPhotos = (p.photos||[]).slice();
  showForm();
  document.getElementById('placeName').value = p.name || '';
  document.getElementById('placeCity').value = p.city || '';
  document.getElementById('placeState').value = p.state || '';
  document.getElementById('placeCountry').value = p.country || '';
  document.getElementById('placeTrip').value = p.trip || '';
  document.getElementById('placeMapLink').value = p.mapLink || '';
  document.getElementById('placeRating').value = p.rating || 5;
  document.getElementById('ratingValue').textContent = p.rating || 5;
  document.getElementById('placeZepeda').value = p.zepedaStars || 0;
  document.getElementById('placeTypeTags').value = (p.typeTags||[]).join(', ');
  document.getElementById('placePeopleTags').value = (p.peopleTags||[]).join(', ');
  document.getElementById('placeNotes').value = p.notes || '';
  updateMainStars(p.rating || 5);
  document.querySelectorAll('.zepeda-btn').forEach(function(b) {
    b.classList.toggle('active', parseInt(b.dataset.value) === (p.zepedaStars||0));
  });
  document.getElementById('datesContainer').innerHTML = '';
  (p.dates||[]).forEach(function(d){ addDateField(d); });
  document.getElementById('subRatingsContainer').innerHTML = '';
  subRatingCounter = 0; subRatingClicks = {};
  Object.entries(p.subRatings||{}).forEach(function(kv){ addSubRating(kv[0], kv[1]); });
  renderPhotoPreview();
}

function deletePlace(id) {
  if (!confirm('Delete this place?')) return;
  places = places.filter(function(p){ return p.id !== id; });
  deleteFromStorage(id);
  rebuildSets();
  refreshYearSelect();
  renderCurrentView();
}

// ================================================================
// MAP VIEW
// ================================================================
function renderMap() {
  var withLinks = places.filter(function(p){ return p.mapLink && !p.isWishlist; });
  var el = document.getElementById('mapContent');
  if (!withLinks.length) {
    el.innerHTML = '<div class="text-center py-10 text-gray-400"><p class="font-medium">No map links yet</p><p class="text-sm mt-1">Add Apple Maps links to your places</p></div>';
    return;
  }
  el.innerHTML = withLinks.map(function(p) {
    return '<div class="border border-gray-200 rounded-lg p-3 mb-3 flex justify-between items-center">' +
      '<div><div class="font-bold text-sm text-gray-800">' + esc(p.name) + '</div>' +
      '<div class="text-xs text-gray-500">' + esc(p.location||'') + '</div>' +
      '<div class="text-sm mt-1" style="color:#9AA581;">' + getStarText(p.rating) + '</div></div>' +
      '<a href="' + esc(p.mapLink) + '" target="_blank" class="px-3 py-2 text-white rounded-lg text-sm font-medium" style="background:#9AA581;">Open Map</a>' +
      '</div>';
  }).join('');
}

// ================================================================
// CALENDAR VIEW
// ================================================================
function renderCalendar() {
  var MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  document.getElementById('calMonthLabel').textContent = MONTHS[calMonth];
  document.getElementById('calYearLabel').textContent = calYear;

  var dateMap = {};
  places.filter(function(p){ return !p.isWishlist; }).forEach(function(p) {
    var dates = (p.dates||[]).concat(p.date ? [p.date] : []).filter(Boolean);
    dates.forEach(function(d) {
      var k = d.slice(0,10);
      if (!dateMap[k]) dateMap[k] = [];
      dateMap[k].push(p);
    });
  });

  var todayKey = new Date().toISOString().slice(0,10);
  var firstDay = new Date(calYear, calMonth, 1).getDay();
  var daysInMonth = new Date(calYear, calMonth+1, 0).getDate();
  var daysInPrev = new Date(calYear, calMonth, 0).getDate();
  var totalCells = Math.ceil((firstDay + daysInMonth) / 7) * 7;
  var grid = document.getElementById('calGrid');
  grid.innerHTML = '';

  for (var i = 0; i < totalCells; i++) {
    var day, offset = 0;
    if (i < firstDay) { day = daysInPrev - firstDay + 1 + i; offset = -1; }
    else if (i >= firstDay + daysInMonth) { day = i - firstDay - daysInMonth + 1; offset = 1; }
    else { day = i - firstDay + 1; }

    var cellDate = new Date(calYear, calMonth + offset, day);
    var key = cellDate.toISOString().slice(0,10);
    var cellPlaces = dateMap[key] || [];

    var cell = document.createElement('div');
    cell.className = 'cal-cell' +
      (offset !== 0 ? ' other-month' : '') +
      (key === todayKey ? ' today' : '') +
      (key === calSelectedDay ? ' selected' : '');

    var dayNum = document.createElement('div');
    dayNum.className = 'cal-day-num';
    dayNum.textContent = day;
    cell.appendChild(dayNum);

    if (cellPlaces.length) {
      var dotRow = document.createElement('div');
      dotRow.className = 'cal-dot-row';
      cellPlaces.slice(0,4).forEach(function(_, idx) {
        var dot = document.createElement('div');
        dot.className = 'cal-dot' + (idx > 0 ? ' blue' : '');
        dotRow.appendChild(dot);
      });
      if (cellPlaces.length > 4) {
        var more = document.createElement('div');
        more.style.cssText = 'font-size:9px;color:#9AA581;font-weight:700;';
        more.textContent = '+' + (cellPlaces.length - 4);
        dotRow.appendChild(more);
      }
      cell.appendChild(dotRow);
    }

    (function(k) { cell.addEventListener('click', function() { calSelectedDay = k; renderCalendar(); }); })(key);
    grid.appendChild(cell);
  }

  var detail = document.getElementById('calDayDetail');
  if (!calSelectedDay) { detail.innerHTML = ''; return; }
  var dayPlaces = dateMap[calSelectedDay] || [];
  var label = new Date(calSelectedDay + 'T12:00:00').toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  if (!dayPlaces.length) {
    detail.innerHTML = '<div class="text-center py-4 text-gray-400 text-sm">No visits on ' + label + '</div>';
  } else {
    detail.innerHTML = '<div class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">' + label + '</div>' +
      dayPlaces.map(function(p){ return renderCard(p); }).join('');
  }
}

function calPrev() { calMonth--; if (calMonth < 0) { calMonth = 11; calYear--; } calSelectedDay = null; renderCalendar(); }
function calNext() { calMonth++; if (calMonth > 11) { calMonth = 0; calYear++; } calSelectedDay = null; renderCalendar(); }

// ================================================================
// STATS VIEW
// ================================================================
function rebuildSets() {
  [allTypeTags, allPeopleTags, allCities, allStates, allCountries, allTrips].forEach(function(s){ s.clear(); });
  places.forEach(function(p) {
    (p.typeTags||[]).forEach(function(t){ allTypeTags.add(t); });
    (p.peopleTags||[]).forEach(function(t){ allPeopleTags.add(t); });
    if (p.city) allCities.add(p.city);
    if (p.state) allStates.add(p.state);
    if (p.country) allCountries.add(p.country);
    if (p.trip) allTrips.add(p.trip);
  });
}

function refreshYearSelect() {
  var years = Array.from(new Set(places.flatMap(function(p){ return (p.dates||[p.date]).filter(Boolean).map(function(d){ return new Date(d).getFullYear(); }); }))).filter(Boolean).sort(function(a,b){ return b-a; });
  var ys = document.getElementById('yearReviewSelect');
  ys.innerHTML = '<option value="">Year in Review...</option>' + years.map(function(y){ return '<option value="' + y + '">' + y + '</option>'; }).join('');
}

function renderStats() {
  var visited = places.filter(function(p){ return !p.isWishlist; });
  if (!visited.length) {
    document.getElementById('statsContent').innerHTML = '<div class="text-center py-10 text-gray-400">No places yet</div>';
    return;
  }
  var countries = new Set(visited.map(function(p){ return p.country; }).filter(Boolean));
  var cities = new Set(visited.map(function(p){ return p.city; }).filter(Boolean));
  var avgRating = (visited.reduce(function(s,p){ return s+(p.rating||0); }, 0) / visited.length).toFixed(1);
  var topRated = visited.slice().sort(function(a,b){ return (b.rating||0)-(a.rating||0); }).slice(0,5);
  var html = '<div class="grid grid-cols-3 gap-3 mb-4">' +
    statCard(visited.length, 'Places') + statCard(countries.size, 'Countries') + statCard(cities.size, 'Cities') +
    '</div>' +
    '<div class="grid grid-cols-2 gap-3 mb-4">' + statCard(avgRating, 'Avg Rating') + statCard(new Set(visited.filter(function(p){ return p.trip; }).map(function(p){ return p.trip; })).size, 'Trips') + '</div>' +
    '<div class="bg-white border border-gray-200 rounded-xl p-4"><div class="font-semibold text-gray-700 mb-3">Top Rated Places</div>' +
    topRated.map(function(p){ return '<div class="flex justify-between items-center py-2 border-b border-gray-50 last:border-0"><span class="text-sm text-gray-700">' + esc(p.name) + '</span><span class="text-sm" style="color:#9AA581;">' + getStarText(p.rating) + '</span></div>'; }).join('') + '</div>';
  document.getElementById('statsContent').innerHTML = html;
}

function statCard(val, label) {
  return '<div class="bg-white rounded-xl p-4 text-center shadow-sm border border-gray-100"><div class="text-2xl font-bold" style="color:#9AA581;">' + val + '</div><div class="text-xs text-gray-500 mt-1">' + label + '</div></div>';
}

function renderYearReview() {
  var year = parseInt(document.getElementById('yearReviewSelect').value);
  var el = document.getElementById('yearReviewContent');
  if (!year) { el.innerHTML = ''; return; }
  var yearPlaces = places.filter(function(p) {
    return !p.isWishlist && (p.dates||[p.date]).filter(Boolean).some(function(d){ return new Date(d).getFullYear() === year; });
  });
  if (!yearPlaces.length) { el.innerHTML = '<div class="text-center py-4 text-gray-400">No places in ' + year + '</div>'; return; }
  el.innerHTML = '<div class="bg-white border border-gray-200 rounded-xl p-4"><div class="font-bold text-gray-800 mb-3">' + year + ' — ' + yearPlaces.length + ' places</div>' +
    yearPlaces.map(function(p){ return '<div class="flex justify-between items-center py-2 border-b border-gray-50 last:border-0"><div><div class="text-sm font-medium text-gray-700">' + esc(p.name) + '</div><div class="text-xs text-gray-400">' + esc(p.location||'') + '</div></div><span class="text-sm" style="color:#9AA581;">' + getStarText(p.rating) + '</span></div>'; }).join('') + '</div>';
}

function exportPDF() {
  var el = document.getElementById('pdfContent');
  var visited = places.filter(function(p){ return !p.isWishlist; });
  el.innerHTML = '<h1 style="font-size:24px;font-weight:bold;margin-bottom:20px;color:#9AA581;">My Travel Journal</h1>' +
    visited.map(function(p){ return '<div style="margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid #eee;"><h2 style="font-size:16px;font-weight:bold;">' + p.name + '</h2><p style="color:#666;font-size:14px;">' + (p.location||'') + '</p><p>' + getStarText(p.rating) + '</p>' + (p.notes ? '<p style="font-size:13px;color:#444;">' + p.notes + '</p>' : '') + '</div>'; }).join('');
  el.style.display = 'block';
  var doc = new window.jspdf.jsPDF();
  doc.html(el, { callback: function(d){ d.save('travel-journal.pdf'); el.style.display='none'; }, x:10, y:10, width:190 });
}

// ================================================================
// AUTOCOMPLETE
// ================================================================
function setupAutocomplete(inputId, sugId, dataSet) {
  var inp = document.getElementById(inputId);
  var sug = document.getElementById(sugId);
  inp.addEventListener('input', function() {
    var val = inp.value.toLowerCase();
    if (!val) { sug.classList.remove('active'); return; }
    var matches = Array.from(dataSet).filter(function(x){ return x.toLowerCase().startsWith(val); });
    if (!matches.length) { sug.classList.remove('active'); return; }
    sug.innerHTML = matches.slice(0,8).map(function(m){ return '<div class="tag-suggestion-item" onclick="pickSuggestion(\'' + inputId + '\',\'' + sugId + '\',\'' + esc(m) + '\')">' + esc(m) + '</div>'; }).join('');
    sug.classList.add('active');
  });
  inp.addEventListener('blur', function(){ setTimeout(function(){ sug.classList.remove('active'); }, 200); });
}

function setupTagAutocomplete(inputId, sugId, dataSet) {
  var inp = document.getElementById(inputId);
  var sug = document.getElementById(sugId);
  inp.addEventListener('input', function() {
    var parts = inp.value.split(',');
    var val = parts[parts.length-1].trim().toLowerCase();
    if (!val) { sug.classList.remove('active'); return; }
    var matches = Array.from(dataSet).filter(function(x){ return x.toLowerCase().startsWith(val); });
    if (!matches.length) { sug.classList.remove('active'); return; }
    sug.innerHTML = matches.slice(0,8).map(function(m){ return '<div class="tag-suggestion-item" onclick="pickTagSuggestion(\'' + inputId + '\',\'' + sugId + '\',\'' + esc(m) + '\')">' + esc(m) + '</div>'; }).join('');
    sug.classList.add('active');
  });
  inp.addEventListener('blur', function(){ setTimeout(function(){ sug.classList.remove('active'); }, 200); });
}

function pickSuggestion(inputId, sugId, val) {
  document.getElementById(inputId).value = val;
  document.getElementById(sugId).classList.remove('active');
}

function pickTagSuggestion(inputId, sugId, val) {
  var inp = document.getElementById(inputId);
  var parts = inp.value.split(',');
  parts[parts.length-1] = ' ' + val;
  inp.value = parts.join(',').replace(/^,\s*/,'');
  document.getElementById(sugId).classList.remove('active');
}

// ================================================================
// UTILS
// ================================================================
function showToast(msg) {
  var t = document.getElementById('successToast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(function(){ t.classList.remove('show'); }, 2500);
}

function esc(str) {
  if (typeof str !== 'string') return '';
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}
</script>
</body>
</html>
