<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>PinDrop</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<style>
:root {
  /* Palette: sage, slate-blue, dark-sage, blush */
  --sage:       #97ac9f;
  --slate:      #859eac;
  --dark-sage:  #6e8175;
  --blush:      #e6c8c6;
  --blush-dark: #c9a5a2;

  --bg:         #f4f6f4;
  --surface:    #ffffff;
  --surface2:   #eef0ed;
  --border:     #dde2de;
  --text:       #1c2420;
  --text-muted: #5a6e64;
  --text-light: #8fa899;

  --accent:       var(--dark-sage);
  --accent-light: #e5ebe7;
  --accent-dark:  #556660;

  --hunter:      #dce8e2;
  --hunter-dark: #3d6654;
  --brandon:     #d9e4eb;
  --brandon-dark: #2d5268;
  --other:       #ede8e7;
  --other-dark:  #6b5a59;

  --trip-color: var(--slate);
  --trip-light: #dde6ec;
  --wish-color: var(--blush-dark);
  --wish-light: #f5ebe9;

  --star-color: var(--dark-sage);

  --nav-h: 68px;
  --radius: 14px;
  --sys:   -apple-system, BlinkMacSystemFont, 'SF Pro Text',    'Helvetica Neue', sans-serif;
  --sys-d: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', sans-serif;
}

* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
body { font-family: var(--sys); background: var(--bg); color: var(--text); min-height: 100dvh; max-width: 430px; margin: 0 auto; position: relative; overflow-x: hidden; }
h1,h2,h3 { font-family: var(--sys-d); font-weight: 700; letter-spacing: -0.03em; }

/* ── NAV ── */
.nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 430px; background: var(--surface); border-top: 1px solid var(--border); display: flex; height: var(--nav-h); z-index: 100; padding-bottom: env(safe-area-inset-bottom); }
.nav-btn { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 3px; border: none; background: none; cursor: pointer; color: var(--text-light); font-family: var(--sys); font-size: 9px; font-weight: 600; letter-spacing: 0.03em; text-transform: uppercase; transition: color 0.2s; }
.nav-btn.active { color: var(--dark-sage); }
.nav-btn svg { width: 22px; height: 22px; stroke-width: 1.7; }
.nav-btn.add-btn .add-inner { width: 48px; height: 48px; border-radius: 50%; background: var(--dark-sage); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 18px rgba(110,129,117,0.45); transition: transform 0.15s; }
.nav-btn.add-btn:active .add-inner { transform: scale(0.92); }

/* ── VIEWS ── */
.view { display: none; flex-direction: column; padding: 0 0 calc(var(--nav-h) + 8px); min-height: 100dvh; }
.view.active { display: flex; }

/* ── PAGE HEADER ── */
.page-header { padding: 14px 20px 10px; background: var(--surface); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 50; }
.page-header h2 { font-size: 18px; font-weight: 700; color: var(--text); letter-spacing: -0.02em; }
.page-header .sub { font-size: 11px; color: var(--text-muted); margin-top: 1px; }
.page-header-row { display: flex; align-items: flex-end; justify-content: space-between; }

/* ── CHIPS ── */
.controls { display: flex; gap: 8px; padding: 10px 16px; overflow-x: auto; scrollbar-width: none; flex-shrink: 0; }
.controls::-webkit-scrollbar { display: none; }
.chip { flex-shrink: 0; padding: 6px 13px; border-radius: 20px; border: 1.5px solid var(--border); background: var(--surface); font-family: var(--sys); font-size: 12px; font-weight: 500; color: var(--text-muted); cursor: pointer; transition: all 0.15s; white-space: nowrap; }
.chip.active { background: var(--dark-sage); border-color: var(--dark-sage); color: #fff; }
.chip.wish-chip.active { background: var(--wish-color); border-color: var(--wish-color); }
.chip.trip-chip.active { background: var(--slate); border-color: var(--slate); }

/* ── PLACE CARD ── */
.place-list { padding: 0 16px; display: flex; flex-direction: column; gap: 10px; }
.place-card { background: var(--surface); border-radius: var(--radius); border: 1px solid var(--border); overflow: hidden; cursor: pointer; transition: box-shadow 0.15s; }
.place-card:active { box-shadow: 0 0 0 2px var(--sage); }
.place-card-inner { padding: 14px 16px; }
.place-card-top { display: flex; justify-content: space-between; align-items: flex-start; }
.place-name { font-family: var(--sys-d); font-size: 17px; font-weight: 600; letter-spacing: -0.02em; }
.place-loc { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
.place-cat { font-size: 10px; font-weight: 700; padding: 3px 8px; border-radius: 10px; background: var(--accent-light); color: var(--dark-sage); white-space: nowrap; flex-shrink: 0; margin-left: 8px; cursor: pointer; letter-spacing: 0.02em; }
.place-meta { display: flex; align-items: center; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
.rating-pair { display: flex; gap: 5px; }
.rating-badge { font-size: 11px; font-weight: 600; padding: 3px 8px; border-radius: 8px; display: flex; align-items: center; gap: 3px; }
.rating-badge.hunter { background: var(--hunter); color: var(--hunter-dark); }
.rating-badge.brandon { background: var(--brandon); color: var(--brandon-dark); }
.visits-count { font-size: 11px; color: var(--text-light); margin-left: auto; }
.tags-row { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 8px; }
.tag { font-size: 10px; padding: 2px 8px; border-radius: 8px; background: var(--surface2); color: var(--text-muted); cursor: pointer; transition: all 0.12s; }
.tag:hover,.tag:active { background: var(--accent-light); color: var(--dark-sage); }
.trip-badge { font-size: 10px; padding: 2px 7px; border-radius: 8px; background: var(--trip-light); color: var(--trip-color); font-weight: 600; }

/* ── PLACE PHOTO STRIP ── */
.photo-strip { display: flex; gap: 6px; overflow-x: auto; scrollbar-width: none; padding: 0 16px 0; margin-top: 8px; }
.photo-strip::-webkit-scrollbar { display: none; }
.photo-thumb { width: 72px; height: 54px; border-radius: 8px; object-fit: cover; flex-shrink: 0; }

/* ── CALENDAR ── */
.cal-header { display: flex; align-items: center; justify-content: space-between; padding: 16px 20px 8px; }
.cal-header h3 { font-size: 20px; }
.cal-nav-btn { width: 36px; height: 36px; border-radius: 50%; border: 1px solid var(--border); background: var(--surface); cursor: pointer; display: flex; align-items: center; justify-content: center; }
.cal-grid { display: grid; grid-template-columns: repeat(7,1fr); gap: 0; padding: 0 8px; }
.cal-day-label { text-align: center; font-size: 10px; font-weight: 700; color: var(--text-light); padding: 4px 0; letter-spacing: 0.06em; }
.cal-day { display: flex; flex-direction: column; align-items: stretch; cursor: pointer; }
.cal-day-num { height: 30px; display: flex; align-items: center; justify-content: center; font-size: 13px; transition: background 0.15s; position: relative; z-index: 2; border-radius: 50%; margin: 2px auto; width: 30px; flex-shrink: 0; }
.cal-day:hover .cal-day-num { background: var(--surface2); }
.cal-day.today .cal-day-num { font-weight: 700; color: var(--dark-sage); }
.cal-day.other-month .cal-day-num { color: var(--text-light); }
.cal-day.selected .cal-day-num { background: var(--dark-sage) !important; color: #fff; }
.cal-bars { display: flex; flex-direction: column; gap: 2px; padding-bottom: 4px; min-height: 8px; }
.cal-bar { height: 5px; border-radius: 0; }
.cal-bar.start { border-radius: 3px 0 0 3px; margin-left: 40%; }
.cal-bar.end   { border-radius: 0 3px 3px 0; margin-right: 40%; }
.cal-bar.solo  { border-radius: 3px; margin-left: 15%; margin-right: 15%; }
.cal-bar.mid   { }
.cal-day.col-0 .cal-bar.mid,
.cal-day.col-0 .cal-bar.end  { border-radius: 3px 0 0 3px; margin-left: 0; }
.cal-day.col-6 .cal-bar.mid,
.cal-day.col-6 .cal-bar.start { border-radius: 0 3px 3px 0; margin-right: 0; }
.cal-bar.lane-0 { background: var(--dark-sage); }
.cal-bar.lane-1 { background: var(--slate); }
.cal-bar.lane-2 { background: var(--wish-color); }
.cal-more-dot { width: 4px; height: 4px; border-radius: 50%; background: var(--text-light); margin: 1px auto 0; }
.cal-visits { padding: 16px; display: flex; flex-direction: column; gap: 8px; }
.cal-visit-duration { font-size: 10px; font-weight: 700; color: var(--dark-sage); letter-spacing: 0.04em; text-transform: uppercase; margin-bottom: 2px; }
.cal-visit-card { background: var(--surface); border-radius: 12px; padding: 12px 14px; border: 1px solid var(--border); cursor: pointer; display: flex; align-items: flex-start; gap: 10px; transition: box-shadow 0.15s; }
.cal-visit-card.dragging { opacity: 0.4; box-shadow: 0 4px 16px rgba(28,36,32,0.18); }
.cal-visit-card.drag-over { box-shadow: 0 0 0 2px var(--dark-sage); }
.cal-visit-drag-handle { flex-shrink: 0; padding: 2px 0; color: var(--border); cursor: grab; touch-action: none; }
.cal-visit-drag-handle:active { cursor: grabbing; }
.cal-visit-drag-handle svg { display: block; }
.cal-visit-body { flex: 1; min-width: 0; }
.cal-visit-place { font-family: var(--sys-d); font-size: 15px; font-weight: 600; letter-spacing: -0.02em; }
.cal-visit-meta { font-size: 11px; color: var(--text-muted); margin-top: 3px; }
.cal-miles-row { display: flex; align-items: center; gap: 6px; padding: 8px 14px 2px; font-size: 11px; color: var(--text-muted); }
.cal-miles-icon { color: var(--dark-sage); }
.cal-miles-val { font-weight: 700; color: var(--dark-sage); font-size: 13px; }
.cal-miles-leg { font-size: 10px; color: var(--text-light); padding: 0 14px 6px; display: flex; flex-direction: column; gap: 2px; }
.cal-miles-leg-item { display: flex; align-items: center; gap: 4px; }
.cal-miles-leg-arrow { color: var(--border); }

/* ── STATS ── */
.stats-container { padding: 0 0 20px; display: flex; flex-direction: column; gap: 0; }
.stats-section { padding: 16px; border-bottom: 1px solid var(--border); }
.stats-section:last-child { border-bottom: none; }
.stats-section-label { font-size: 10px; font-weight: 700; color: var(--text-light); letter-spacing: 0.08em; text-transform: uppercase; margin-bottom: 12px; }
.stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.stat-card { background: var(--surface); border-radius: var(--radius); padding: 14px; border: 1px solid var(--border); }
.stat-card.full { grid-column: 1/-1; }
.stat-label { font-size: 10px; font-weight: 700; color: var(--text-light); letter-spacing: 0.06em; text-transform: uppercase; }
.stat-value { font-family: var(--sys-d); font-size: 28px; font-weight: 700; color: var(--text); margin-top: 4px; line-height: 1; letter-spacing: -0.03em; }
.stat-sub { font-size: 11px; color: var(--text-muted); margin-top: 4px; line-height: 1.4; }
.stat-card.hunter-card .stat-value { color: var(--hunter-dark); }
.stat-card.brandon-card .stat-value { color: var(--brandon-dark); }
.stat-card.wish-card .stat-value { color: var(--wish-color); }
.stat-card.trip-card .stat-value { color: var(--slate); }

/* ── RATING BAR CHART ── */
.rating-chart-wrap { background: var(--surface); border-radius: var(--radius); border: 1px solid var(--border); padding: 16px; }
.rating-chart-title { font-size: 10px; font-weight: 700; color: var(--text-light); letter-spacing: 0.07em; text-transform: uppercase; margin-bottom: 14px; }
.rating-bars { display: flex; align-items: flex-end; gap: 3px; height: 80px; }
.rating-bar-col { display: flex; flex-direction: column; align-items: center; flex: 1; height: 100%; }
.rating-bar-track { flex: 1; display: flex; align-items: flex-end; width: 100%; }
.rating-bar-fill { width: 100%; border-radius: 3px 3px 0 0; transition: height 0.4s ease; min-height: 3px; }
.rating-bar-fill.has-data { background: var(--dark-sage); }
.rating-bar-fill.no-data { background: var(--border); border-radius: 3px; height: 3px !important; min-height: 3px; }
.rating-bar-label { font-size: 8px; color: var(--text-light); margin-top: 4px; font-weight: 500; }

/* ── PIE CHART (SVG) ── */
.pie-wrap { display: flex; align-items: center; gap: 14px; }
.pie-legend { display: flex; flex-direction: column; gap: 5px; flex: 1; min-width: 0; }
.pie-legend-item { display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--text-muted); min-width: 0; }
.pie-dot { width: 8px; height: 8px; border-radius: 2px; flex-shrink: 0; }
.pie-legend-name { flex: 1; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.pie-legend-count { font-weight: 700; color: var(--text); flex-shrink: 0; }

/* ── BAR CHART HORIZONTAL ── */
.hbar-chart { display: flex; flex-direction: column; gap: 8px; }
.hbar-row { display: flex; align-items: center; gap: 8px; }
.hbar-label { font-size: 12px; font-weight: 500; width: 100px; flex-shrink: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text); }
.hbar-track { flex: 1; height: 8px; background: var(--surface2); border-radius: 4px; overflow: hidden; }
.hbar-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }
.hbar-count { font-size: 11px; color: var(--text-muted); width: 28px; text-align: right; flex-shrink: 0; }

/* ── MODAL ── */
.modal-overlay { position: fixed; inset: 0; background: rgba(28,36,32,0.42); backdrop-filter: blur(6px); z-index: 200; display: none; align-items: flex-end; }
.modal-overlay.open { display: flex; }
.modal { background: var(--surface); border-radius: 24px 24px 0 0; width: 100%; max-width: 430px; margin: 0 auto; max-height: 92dvh; overflow-y: auto; padding: 0 0 env(safe-area-inset-bottom); animation: slideUp 0.28s cubic-bezier(0.22,1,0.36,1); }
@keyframes slideUp { from { transform: translateY(100%); opacity: 0; } }
.modal-handle { width: 36px; height: 4px; border-radius: 2px; background: var(--border); margin: 12px auto 0; }
.modal-header { padding: 14px 20px 12px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); }
.modal-title { font-family: var(--sys-d); font-size: 20px; font-weight: 700; letter-spacing: -0.03em; }
.modal-close { width: 32px; height: 32px; border-radius: 50%; border: none; background: var(--surface2); cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-muted); }
.modal-body { padding: 20px; display: flex; flex-direction: column; gap: 16px; }

/* ── FORM ── */
.form-group { display: flex; flex-direction: column; gap: 6px; }
.form-label { font-size: 12px; font-weight: 700; color: var(--text-muted); letter-spacing: 0.02em; }
.form-input,.form-select,.form-textarea { width: 100%; min-width: 0; padding: 11px 14px; border-radius: 10px; border: 1.5px solid var(--border); background: var(--bg); font-family: var(--sys); font-size: 14px; color: var(--text); outline: none; transition: border-color 0.15s; box-sizing: border-box; }
input[type=date].form-input { font-size: 13px; padding: 11px 8px; -webkit-appearance: none; appearance: none; }
.form-input:focus,.form-select:focus,.form-textarea:focus { border-color: var(--dark-sage); background: #fff; }
.form-textarea { resize: none; min-height: 80px; }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.form-hint { font-size: 11px; color: var(--text-light); }

/* ── TAGS INPUT ── */
.tags-input-wrap { display: flex; flex-wrap: wrap; gap: 6px; padding: 8px 12px; border-radius: 10px; border: 1.5px solid var(--border); background: var(--bg); cursor: text; min-height: 44px; align-items: center; }
.tags-input-wrap:focus-within { border-color: var(--dark-sage); background: #fff; }
.tag-pill { display: flex; align-items: center; gap: 4px; padding: 3px 8px; border-radius: 8px; background: var(--accent-light); color: var(--dark-sage); font-size: 12px; }
.tag-pill button { background: none; border: none; cursor: pointer; color: var(--dark-sage); font-size: 14px; line-height: 1; padding: 0; }
.tags-input-wrap input { border: none; background: none; outline: none; font-family: var(--sys); font-size: 14px; min-width: 80px; flex: 1; }

/* ── BTNS ── */
.btn { width: 100%; padding: 14px; border-radius: 12px; border: none; font-family: var(--sys); font-size: 15px; font-weight: 700; cursor: pointer; transition: all 0.15s; display: flex; align-items: center; justify-content: center; gap: 8px; }
.btn-primary { background: var(--dark-sage); color: #fff; }
.btn-primary:active { transform: scale(0.98); background: var(--accent-dark); }
.btn-secondary { background: var(--surface2); color: var(--text); }
.btn-danger { background: #f5eae9; color: #a0413b; }
.btn-wish { background: var(--wish-light); color: var(--wish-color); }
.btn-trip { background: var(--trip-light); color: var(--trip-color); }
.btn-sm { width: auto; padding: 8px 14px; font-size: 13px; border-radius: 8px; }

/* ── FULLSCREEN MODAL ── */
.fullscreen-modal { align-items: flex-start; }
.fullscreen-modal .modal { border-radius: 0; max-height: 100dvh; height: 100dvh; }
.fullscreen-header { position: sticky; top: 0; background: var(--surface); z-index: 10; padding: 14px 16px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 12px; }
.fullscreen-header h3 { font-size: 17px; font-weight: 700; letter-spacing: -0.02em; flex: 1; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.back-btn { width: 36px; height: 36px; border-radius: 50%; border: 1px solid var(--border); background: var(--bg); cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.fullscreen-body { padding: 20px; display: flex; flex-direction: column; gap: 20px; padding-bottom: 40px; }

/* ── PLACE DETAIL HERO ── */
.detail-hero { padding: 24px 20px 20px; background: linear-gradient(160deg, var(--accent-light) 0%, var(--surface) 100%); border-bottom: 1px solid var(--border); }
.detail-hero-name { font-family: var(--sys-d); font-size: 26px; font-weight: 800; color: var(--text); letter-spacing: -0.04em; line-height: 1.15; }
.detail-loc { font-size: 13px; color: var(--text-muted); margin-top: 5px; display: flex; align-items: center; gap: 5px; }
.detail-loc-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--sage); flex-shrink: 0; }
.detail-badges { display: flex; gap: 8px; margin-top: 14px; flex-wrap: wrap; align-items: center; }
.detail-avg-row { display: flex; gap: 12px; margin-top: 14px; }
.detail-avg-pill { display: flex; align-items: center; gap: 8px; background: var(--surface); border-radius: 30px; padding: 7px 14px 7px 10px; border: 1px solid var(--border); box-shadow: 0 1px 4px rgba(28,36,32,0.06); }
.detail-avg-avatar { width: 26px; height: 26px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 800; letter-spacing: -0.03em; flex-shrink: 0; }
.detail-avg-avatar.h { background: var(--hunter); color: var(--hunter-dark); }
.detail-avg-avatar.b { background: var(--brandon); color: var(--brandon-dark); }
.detail-avg-score { font-family: var(--sys-d); font-size: 18px; font-weight: 800; color: var(--text); letter-spacing: -0.04em; }
.detail-avg-label { font-size: 10px; color: var(--text-light); font-weight: 600; }
.place-map-link { display: inline-flex; align-items: center; gap: 5px; font-size: 12px; color: var(--dark-sage); text-decoration: none; margin-top: 12px; font-weight: 600; opacity: 0.8; }
.place-map-link:hover { opacity: 1; }

/* ── DETAIL SECTIONS ── */
.detail-sections { padding: 0 0 32px; }
.detail-section { padding: 18px 20px; border-bottom: 1px solid var(--border); }
.detail-section-title { font-size: 10px; font-weight: 800; color: var(--text-light); letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 12px; }

/* ── VISIT ITEM ── */
.visit-item { background: var(--surface); border-radius: 14px; padding: 14px 16px; margin-bottom: 8px; cursor: pointer; border: 1px solid var(--border); transition: transform 0.12s, box-shadow 0.12s; box-shadow: 0 1px 4px rgba(28,36,32,0.05); }
.visit-item:active { transform: scale(0.985); box-shadow: none; }
.visit-item-date { font-size: 14px; font-weight: 700; color: var(--text); letter-spacing: -0.02em; }
.visit-item-ratings { display: flex; gap: 6px; margin-top: 6px; }
.visit-item-rating-pill { display: flex; align-items: center; gap: 5px; border-radius: 20px; padding: 3px 9px 3px 6px; font-size: 11px; font-weight: 700; }
.visit-item-rating-pill.h { background: var(--hunter); color: var(--hunter-dark); }
.visit-item-rating-pill.b { background: var(--brandon); color: var(--brandon-dark); }
.visit-item-rating-pip { width: 16px; height: 16px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 8px; font-weight: 800; }
.visit-item-rating-pill.h .visit-item-rating-pip { background: var(--hunter-dark); color: var(--hunter); }
.visit-item-rating-pill.b .visit-item-rating-pip { background: var(--brandon-dark); color: var(--brandon); }
.visit-item-meta { font-size: 11px; color: var(--text-muted); margin-top: 7px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }

/* ── VISIT DETAIL HERO ── */
.visit-hero { padding: 20px 20px 18px; background: linear-gradient(150deg, #eef3ef 0%, var(--surface) 100%); border-bottom: 1px solid var(--border); }
.visit-hero-place { font-size: 11px; font-weight: 700; color: var(--dark-sage); letter-spacing: 0.07em; text-transform: uppercase; margin-bottom: 4px; }
.visit-hero-date { font-family: var(--sys-d); font-size: 22px; font-weight: 800; color: var(--text); letter-spacing: -0.04em; }
.visit-hero-ratings { display: flex; gap: 10px; margin-top: 14px; }
.visit-rating-card { flex: 1; background: var(--surface); border-radius: 14px; padding: 12px 14px; border: 1px solid var(--border); box-shadow: 0 1px 4px rgba(28,36,32,0.06); }
.visit-rating-card.h { border-top: 3px solid var(--hunter-dark); }
.visit-rating-card.b { border-top: 3px solid var(--brandon-dark); }
.visit-rating-name { font-size: 9px; font-weight: 800; letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 6px; }
.visit-rating-card.h .visit-rating-name { color: var(--hunter-dark); }
.visit-rating-card.b .visit-rating-name { color: var(--brandon-dark); }
.visit-rating-stars { font-size: 18px; letter-spacing: -1px; color: var(--star-color); line-height: 1; }
.visit-rating-num { font-size: 11px; color: var(--text-muted); margin-top: 4px; }

/* ── VISIT META CHIPS ── */
.visit-meta-row { display: flex; flex-wrap: wrap; gap: 8px; }
.visit-meta-chip { display: inline-flex; align-items: center; gap: 5px; padding: 6px 12px; border-radius: 20px; background: var(--surface2); border: 1px solid var(--border); font-size: 12px; font-weight: 500; color: var(--text-muted); }
.visit-meta-chip svg { width: 12px; height: 12px; opacity: 0.6; }

/* ── THREAD ── */
.thread { display: flex; flex-direction: column; gap: 12px; }
.thread-msg { display: flex; flex-direction: column; max-width: 80%; }
.thread-msg.hunter { align-self: flex-end; }
.thread-msg.brandon { align-self: flex-start; }
.thread-msg.other { align-self: center; max-width: 92%; }
.bubble { padding: 11px 14px; border-radius: 18px; font-size: 14px; line-height: 1.5; word-break: break-word; }
.hunter .bubble { background: var(--hunter); color: #1a3028; border-bottom-right-radius: 5px; }
.brandon .bubble { background: var(--brandon); color: #102030; border-bottom-left-radius: 5px; }
.other .bubble { background: var(--surface2); color: var(--text); border-radius: 12px; border: 1px solid var(--border); font-style: italic; font-size: 13px; }
.bubble-meta { display: flex; gap: 8px; margin-top: 5px; font-size: 10px; color: var(--text-light); align-items: center; }
.hunter .bubble-meta { justify-content: flex-end; padding-right: 4px; }
.brandon .bubble-meta { padding-left: 4px; }
.other .bubble-meta { justify-content: center; }
.bubble-author { font-weight: 700; }
.hunter .bubble-author { color: var(--hunter-dark); }
.brandon .bubble-author { color: var(--brandon-dark); }
.other .bubble-author { color: var(--other-dark); }
.bubble-actions { display: flex; gap: 4px; margin-left: auto; }
.bubble-action-btn { background: none; border: none; cursor: pointer; font-size: 11px; color: var(--text-light); padding: 0 3px; opacity: 0.6; }
.bubble-action-btn:hover { opacity: 1; }
.thread-empty { text-align: center; padding: 24px 0 8px; }
.thread-empty-icon { font-size: 28px; margin-bottom: 8px; }
.thread-empty-text { font-size: 13px; color: var(--text-light); }

/* ── NOTE INPUT ── */
.add-note-bar { display: flex; gap: 8px; margin-top: 4px; align-items: flex-end; }
.add-note-bar select,.add-note-bar input,.add-note-bar button { font-family: var(--sys); }
.add-note-bar select { flex-shrink: 0; padding: 9px 10px; border-radius: 12px; border: 1.5px solid var(--border); background: var(--surface); font-size: 12px; font-weight: 600; outline: none; color: var(--text); appearance: none; text-align: center; min-width: 76px; }
.add-note-bar input { flex: 1; padding: 10px 14px; border-radius: 22px; border: 1.5px solid var(--border); background: var(--surface); font-size: 13px; outline: none; transition: border-color 0.15s; }
.add-note-bar input:focus { border-color: var(--dark-sage); }
.add-note-bar button { flex-shrink: 0; width: 38px; height: 38px; border-radius: 50%; border: none; background: var(--dark-sage); color: #fff; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.12s; }
.add-note-bar button:active { transform: scale(0.9); }

/* ── STAR RATING INPUT ── */
.star-input-wrap { display: flex; gap: 2px; align-items: center; }
.star-input-btn { font-size: 26px; cursor: pointer; color: var(--border); user-select: none; -webkit-user-select: none; background: none; border: none; padding: 0 2px; line-height: 1; transition: color 0.1s; }
.star-input-btn.lit { color: var(--star-color); }
.star-input-btn.half-lit { color: var(--star-color); }

/* ── STAR DISPLAY ── */
.stars-display { color: var(--star-color); font-size: 13px; letter-spacing: -1px; }
.desire-stars { color: var(--wish-color); font-size: 12px; letter-spacing: -1px; }

/* ── PHOTO UPLOAD ── */
.photo-upload-strip { display: flex; gap: 8px; overflow-x: auto; scrollbar-width: none; padding-bottom: 4px; }
.photo-upload-strip::-webkit-scrollbar { display: none; }
.photo-add-btn { width: 72px; height: 72px; border-radius: 10px; border: 1.5px dashed var(--border); background: var(--bg); display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; color: var(--text-light); font-size: 10px; gap: 4px; }
.photo-add-btn svg { width: 20px; height: 20px; }
.photo-thumb-wrap { position: relative; flex-shrink: 0; }
.photo-thumb-wrap img { width: 72px; height: 72px; border-radius: 10px; object-fit: cover; display: block; }
.photo-thumb-del { position: absolute; top: 2px; right: 2px; width: 18px; height: 18px; border-radius: 50%; background: rgba(28,36,32,0.7); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 10px; line-height: 1; }

/* ── EMPTY ── */
.empty-state { text-align: center; padding: 60px 30px; color: var(--text-muted); }
.empty-state svg { width: 48px; height: 48px; stroke: var(--border); margin-bottom: 16px; }
.empty-state h3 { font-family: var(--sys-d); font-size: 20px; font-weight: 700; color: var(--text); margin-bottom: 8px; letter-spacing: -0.02em; }
.empty-state p { font-size: 13px; line-height: 1.6; }

/* ── SEARCH ── */
.search-wrap { padding: 10px 16px 0; }
.search-input { width: 100%; padding: 10px 14px 10px 38px; border-radius: 12px; border: 1.5px solid var(--border); background: var(--surface); font-family: var(--sys); font-size: 14px; outline: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%238fa899' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cpath d='m21 21-4.35-4.35'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: 12px center; transition: border-color 0.15s; }
.search-input:focus { border-color: var(--dark-sage); }

/* ── SECTION TITLE INLINE ── */
.section-title { font-size: 10px; font-weight: 700; color: var(--text-light); letter-spacing: 0.08em; text-transform: uppercase; margin-bottom: 10px; }
.visited-with-row { display: flex; flex-wrap: wrap; gap: 6px; }
.vw-tag { font-size: 12px; padding: 4px 10px; border-radius: 8px; background: var(--surface2); color: var(--text-muted); }

/* ── WISHLIST ── */
.wish-list-wrap { padding: 0 16px; display: flex; flex-direction: column; gap: 10px; }
.wish-card { background: var(--surface); border-radius: var(--radius); border: 1px solid var(--border); padding: 14px 16px; cursor: pointer; transition: box-shadow 0.15s; }
.wish-card:active { box-shadow: 0 0 0 2px var(--blush); }
.wish-name { font-family: var(--sys-d); font-size: 17px; font-weight: 600; letter-spacing: -0.02em; }
.wish-loc { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
.wish-meta { display: flex; gap: 8px; margin-top: 8px; align-items: center; flex-wrap: wrap; }
.wish-priority { font-size: 10px; font-weight: 700; padding: 3px 8px; border-radius: 10px; letter-spacing: 0.02em; }
.wish-priority.high { background: #f5eae9; color: #a0413b; }
.wish-priority.medium { background: #f5f1e4; color: #7a6120; }
.wish-priority.low { background: var(--surface2); color: var(--text-muted); }
.wish-cat { font-size: 10px; font-weight: 700; padding: 3px 8px; border-radius: 10px; background: var(--wish-light); color: var(--wish-color); }

/* ── TRIP SELECT ── */
.trip-select-item { display: flex; align-items: center; gap: 10px; padding: 10px 14px; border-radius: 10px; background: var(--bg); border: 1.5px solid var(--border); cursor: pointer; margin-bottom: 6px; transition: border-color 0.15s; }
.trip-select-item.selected { border-color: var(--slate); background: var(--trip-light); }
.trip-select-item-name { font-size: 14px; font-weight: 500; flex: 1; }
.trip-select-item-dates { font-size: 11px; color: var(--text-muted); }
.trip-indicator { width: 8px; height: 8px; border-radius: 50%; background: var(--slate); flex-shrink: 0; }

/* ── OTHER MENU ── */
.other-menu-overlay { position: fixed; inset: 0; z-index: 200; display: none; }
.other-menu-overlay.open { display: block; }
.other-menu-backdrop { position: absolute; inset: 0; background: rgba(28,36,32,0.35); }
.other-menu-panel { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 430px; background: var(--surface); border-radius: 20px 20px 0 0; padding: 8px 16px calc(var(--nav-h) + 12px); }
.other-menu-handle { width: 36px; height: 4px; border-radius: 2px; background: var(--border); margin: 6px auto 16px; }
.other-menu-title { font-size: 11px; font-weight: 700; color: var(--text-light); letter-spacing: 0.08em; text-transform: uppercase; margin-bottom: 10px; }
.other-menu-item { display: flex; align-items: center; gap: 14px; padding: 13px 14px; border-radius: 12px; cursor: pointer; transition: background 0.12s; border: none; background: none; width: 100%; font-family: var(--sys); text-align: left; margin-bottom: 4px; }
.other-menu-item:active { background: var(--surface2); }
.other-menu-icon { width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.other-menu-icon svg { width: 20px; height: 20px; }
.other-menu-label { font-size: 15px; font-weight: 600; color: var(--text); }
.other-menu-sub { font-size: 11px; color: var(--text-muted); margin-top: 1px; }

/* ── STATS YEAR TABS ── */
.stats-year-tabs { display: flex; gap: 4px; padding: 12px 16px 4px; overflow-x: auto; scrollbar-width: none; flex-shrink: 0; }
.stats-year-tabs::-webkit-scrollbar { display: none; }
.stats-year-tab { flex-shrink: 0; padding: 6px 14px; border-radius: 20px; border: 1.5px solid var(--border); background: var(--surface); font-family: var(--sys); font-size: 12px; font-weight: 600; color: var(--text-muted); cursor: pointer; transition: all 0.15s; white-space: nowrap; }
.stats-year-tab.active { background: var(--dark-sage); border-color: var(--dark-sage); color: #fff; }

/* ── PIE CHART ── */
.pie-row { display: flex; align-items: center; gap: 14px; }
.pie-legend-list { flex: 1; display: flex; flex-direction: column; gap: 5px; min-width: 0; }
.pie-legend-row { display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--text-muted); min-width: 0; }
.pie-legend-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.pie-legend-name { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; min-width: 0; }
.pie-legend-pct { font-weight: 700; color: var(--text); flex-shrink: 0; }

/* ── GEO EXTREMES ── */
.geo-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.geo-card { background: var(--bg); border-radius: 10px; padding: 12px 13px; border: 1px solid var(--border); }
.geo-card-label { font-size: 9px; font-weight: 700; color: var(--text-light); letter-spacing: 0.07em; text-transform: uppercase; margin-bottom: 4px; }
.geo-card-name { font-size: 13px; font-weight: 700; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.geo-card-sub { font-size: 10px; color: var(--text-muted); margin-top: 2px; }
.geo-card-rating { font-size: 12px; font-weight: 700; color: var(--dark-sage); margin-top: 5px; }

/* ── TRIP CARDS ── */
.trip-card-list { padding: 0 16px; display: flex; flex-direction: column; gap: 10px; }
.trip-card { background: var(--surface); border-radius: var(--radius); border: 1px solid var(--border); padding: 16px; cursor: pointer; }
.trip-card-top { display: flex; justify-content: space-between; align-items: flex-start; }
.trip-name { font-family: var(--sys-d); font-size: 17px; font-weight: 600; letter-spacing: -0.02em; }
.trip-dates { font-size: 12px; color: var(--text-muted); margin-top: 3px; }
.trip-meta-row { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; align-items: center; }
.trip-stat { font-size: 11px; color: var(--text-muted); display: flex; align-items: center; gap: 3px; }

/* ── MAP ── */
#map-container { width: 100%; flex: 1; position: relative; }
#leaflet-map { width: 100%; height: 100%; z-index: 1; }
.map-mode-row { position: absolute; bottom: calc(var(--nav-h) + 16px); left: 16px; right: 16px; z-index: 10; display: flex; gap: 4px; background: var(--surface); border-radius: 12px; padding: 4px; box-shadow: 0 4px 20px rgba(28,36,32,0.15); }
.map-mode-btn { flex: 1; padding: 8px; border: none; border-radius: 8px; font-family: var(--sys); font-size: 11px; font-weight: 700; cursor: pointer; background: none; color: var(--text-muted); transition: all 0.15s; letter-spacing: 0.02em; }
.map-mode-btn.active { background: var(--dark-sage); color: #fff; }
.map-wish-toggle { position: absolute; top: 12px; right: 12px; z-index: 10; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 8px 12px; font-family: var(--sys); font-size: 12px; font-weight: 700; cursor: pointer; color: var(--text); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
.map-wish-toggle.active { background: var(--wish-color); color: #fff; border-color: var(--wish-color); }
.leaflet-popup-content-wrapper { font-family: var(--sys) !important; border-radius: 12px !important; border: 1px solid var(--border); box-shadow: 0 4px 20px rgba(28,36,32,0.14) !important; }
.leaflet-popup-tip-container { display: none; }
.map-popup-name { font-family: var(--sys-d); font-weight: 700; font-size: 14px; margin-bottom: 2px; }
.map-popup-loc { font-size: 11px; color: var(--text-muted); margin-bottom: 6px; }
.map-popup-badge { font-size: 10px; padding: 2px 6px; border-radius: 6px; font-weight: 700; display: inline-block; }

/* ── TIMELINE ── */
.timeline { display: flex; flex-direction: column; }
.timeline-item { display: flex; gap: 12px; }
.timeline-dot-wrap { display: flex; flex-direction: column; align-items: center; width: 20px; flex-shrink: 0; padding-top: 4px; }
.timeline-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--dark-sage); flex-shrink: 0; }
.timeline-line { flex: 1; width: 2px; background: var(--border); margin: 3px 0; min-height: 12px; }
.timeline-content { flex: 1; padding-bottom: 12px; }
.timeline-date { font-size: 10px; font-weight: 700; color: var(--text-muted); letter-spacing: 0.04em; text-transform: uppercase; margin-bottom: 2px; }
.timeline-name { font-size: 14px; font-weight: 600; cursor: pointer; color: var(--dark-sage); }
.timeline-meta { font-size: 11px; color: var(--text-muted); margin-top: 2px; }

/* ── CAT BREAKDOWN ── */
.cat-breakdown { display: flex; flex-direction: column; gap: 8px; }

/* ── TOAST ── */
.toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--text); color: #fff; padding: 10px 18px; border-radius: 20px; font-size: 13px; z-index: 999; pointer-events: none; animation: fadeInOut 2.2s ease forwards; white-space: nowrap; }
@keyframes fadeInOut { 0%{opacity:0;transform:translateX(-50%) translateY(-8px)} 15%{opacity:1;transform:translateX(-50%) translateY(0)} 80%{opacity:1} 100%{opacity:0} }

/* ── DISCOVER VIEW ── */
.discover-body { padding: 16px; display: flex; flex-direction: column; gap: 16px; }
.discover-form-card { background: var(--surface); border-radius: var(--radius); border: 1px solid var(--border); padding: 16px; display: flex; flex-direction: column; gap: 12px; }
.discover-form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.mood-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 6px; }
.mood-btn { padding: 9px 6px; border-radius: 10px; border: 1.5px solid var(--border); background: var(--bg); font-family: var(--sys); font-size: 11px; font-weight: 600; cursor: pointer; text-align: center; transition: all 0.15s; color: var(--text-muted); }
.mood-btn.active { border-color: var(--dark-sage); background: var(--accent-light); color: var(--dark-sage); }
.energy-row { display: flex; gap: 6px; }
.energy-btn { flex: 1; padding: 8px; border-radius: 8px; border: 1.5px solid var(--border); background: var(--bg); font-family: var(--sys); font-size: 11px; font-weight: 700; cursor: pointer; text-align: center; transition: all 0.15s; color: var(--text-muted); }
.energy-btn.active { border-color: var(--dark-sage); background: var(--accent-light); color: var(--dark-sage); }
.discover-generate-btn { background: var(--dark-sage); color: #fff; border: none; border-radius: 12px; padding: 14px; font-family: var(--sys); font-size: 15px; font-weight: 700; cursor: pointer; width: 100%; transition: all 0.15s; }
.discover-generate-btn:active { transform: scale(0.98); background: var(--accent-dark); }
.discover-result { display: none; flex-direction: column; gap: 14px; }
.discover-result.visible { display: flex; }
.disc-primary { background: var(--surface); border-radius: var(--radius); border: 2px solid var(--dark-sage); overflow: hidden; }
.disc-primary-header { background: var(--dark-sage); padding: 14px 16px; }
.disc-primary-label { font-size: 9px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: rgba(255,255,255,0.7); margin-bottom: 4px; }
.disc-primary-name { font-family: var(--sys-d); font-size: 20px; font-weight: 700; color: #fff; letter-spacing: -0.02em; }
.disc-primary-loc { font-size: 12px; color: rgba(255,255,255,0.75); margin-top: 2px; }
.disc-score-row { display: flex; gap: 8px; align-items: center; padding: 12px 16px; border-bottom: 1px solid var(--border); }
.disc-score-ring { flex-shrink: 0; }
.disc-score-info { flex: 1; }
.disc-score-num { font-family: var(--sys-d); font-size: 28px; font-weight: 700; color: var(--dark-sage); line-height: 1; letter-spacing: -0.03em; }
.disc-confidence { font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 8px; display: inline-block; margin-top: 3px; }
.disc-confidence.high { background: var(--accent-light); color: var(--dark-sage); }
.disc-confidence.medium { background: #f5f1e4; color: #7a6120; }
.disc-confidence.low { background: var(--surface2); color: var(--text-muted); }
.disc-reasons { padding: 12px 16px; }
.disc-reasons-title { font-size: 10px; font-weight: 700; color: var(--text-light); letter-spacing: 0.06em; text-transform: uppercase; margin-bottom: 8px; }
.disc-reason-item { display: flex; gap: 8px; align-items: flex-start; font-size: 12px; color: var(--text-muted); margin-bottom: 5px; line-height: 1.4; }
.disc-reason-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--sage); flex-shrink: 0; margin-top: 5px; }
.disc-alts { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.disc-alt-card { background: var(--surface); border-radius: 12px; border: 1px solid var(--border); padding: 12px; }
.disc-alt-label { font-size: 9px; font-weight: 700; letter-spacing: 0.08em; color: var(--text-light); text-transform: uppercase; margin-bottom: 4px; }
.disc-alt-name { font-size: 14px; font-weight: 700; color: var(--text); letter-spacing: -0.01em; }
.disc-alt-loc { font-size: 11px; color: var(--text-muted); margin-top: 1px; }
.disc-alt-score { font-size: 12px; font-weight: 700; color: var(--dark-sage); margin-top: 6px; }
.disc-wildcard { background: linear-gradient(135deg, #e6c8c6 0%, #dde6ec 100%); border-radius: var(--radius); border: 1px solid var(--blush); padding: 14px 16px; }
.disc-wildcard-label { font-size: 9px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--blush-dark); margin-bottom: 4px; }
.disc-wildcard-name { font-family: var(--sys-d); font-size: 17px; font-weight: 700; color: var(--text); }
.disc-wildcard-sub { font-size: 11px; color: var(--text-muted); margin-top: 3px; }
.disc-empty { text-align: center; padding: 30px 16px; color: var(--text-muted); font-size: 13px; background: var(--surface); border-radius: var(--radius); border: 1px dashed var(--border); }

/* ── DRIVE SYNC ── */
.sync-bar { position: fixed; top: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 430px; z-index: 150; padding: 8px 16px; padding-top: calc(8px + env(safe-area-inset-top)); display: flex; align-items: center; justify-content: space-between; background: var(--surface); border-bottom: 1px solid var(--border); font-size: 11px; }
.sync-bar-h { height: calc(36px + env(safe-area-inset-top)); flex-shrink: 0; }
.sync-status { display: flex; align-items: center; gap: 6px; font-weight: 600; }
.sync-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
.sync-dot.synced { background: #5a9e7a; }
.sync-dot.syncing { background: var(--slate); animation: pulse 1s infinite; }
.sync-dot.offline { background: var(--text-light); }
.sync-dot.error { background: #a0413b; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
.sync-btn { padding: 5px 12px; border-radius: 8px; border: 1.5px solid var(--border); background: var(--dark-sage); font-family: var(--sys); font-size: 11px; font-weight: 700; cursor: pointer; color: #fff; transition: opacity 0.15s; }
.sync-btn:active { opacity: 0.75; }
.drive-setup-card { background: var(--surface2); border-radius: var(--radius); border: 1px solid var(--border); padding: 14px 16px; margin: 16px; }
.drive-setup-title { font-size: 13px; font-weight: 700; margin-bottom: 6px; }
.drive-setup-sub { font-size: 11px; color: var(--text-muted); line-height: 1.5; }

/* ── ENHANCED STATS ── */
.stats-chart-card { background: var(--surface); border-radius: var(--radius); border: 1px solid var(--border); padding: 16px; overflow: hidden; }
.stats-chart-title { font-size: 10px; font-weight: 700; color: var(--text-light); letter-spacing: 0.07em; text-transform: uppercase; margin-bottom: 12px; }
.stats-chart-toggle { display: flex; gap: 4px; margin-bottom: 12px; }
.stats-toggle-btn { padding: 4px 10px; border-radius: 6px; border: 1px solid var(--border); background: none; font-family: var(--sys); font-size: 10px; font-weight: 700; cursor: pointer; color: var(--text-muted); }
.stats-toggle-btn.active { background: var(--dark-sage); border-color: var(--dark-sage); color: #fff; }
.country-heat-table { display: flex; flex-direction: column; gap: 6px; }
.country-heat-row { display: flex; align-items: center; gap: 8px; padding: 8px 10px; border-radius: 8px; position: relative; overflow: hidden; }
.country-heat-bg { position: absolute; inset: 0; pointer-events: none; border-radius: 8px; }
.country-heat-name { font-size: 13px; font-weight: 600; flex: 1; position: relative; }
.country-heat-visits { font-size: 11px; color: var(--text-muted); position: relative; width: 40px; text-align: right; }
.country-heat-rating { font-size: 11px; font-weight: 700; position: relative; color: var(--dark-sage); width: 32px; text-align: right; }
.scatter-svg { display: block; width: 100%; }
.circ-progress-wrap { display: flex; flex-direction: column; align-items: center; gap: 8px; }
.circ-progress-label { font-size: 11px; color: var(--text-muted); font-weight: 600; }
.trip-perf-card { background: var(--bg); border-radius: 10px; padding: 12px 14px; border: 1px solid var(--border); }
.trip-perf-name { font-size: 14px; font-weight: 700; }
.trip-perf-meta { font-size: 11px; color: var(--text-muted); margin-top: 3px; margin-bottom: 8px; }
.trip-perf-bar-track { height: 5px; background: var(--surface2); border-radius: 3px; overflow: hidden; }
.trip-perf-bar-fill { height: 100%; border-radius: 3px; background: var(--dark-sage); transition: width 0.5s ease; }

#ds-sidebar { display: none; }
#ds-kbd { display: none; }
::-webkit-scrollbar { width: 0; }
body.modal-open { overflow: hidden; }

/* ── LOCATION CHIPS (clickable city/state/country) ── */
.loc-chip { display: inline-block; cursor: pointer; color: var(--text-muted); border-bottom: 1px dotted var(--border); transition: color 0.12s, border-color 0.12s; padding-bottom: 1px; }
.loc-chip:hover, .loc-chip:active { color: var(--dark-sage); border-bottom-color: var(--dark-sage); }

/* ── LOCATION STATS SHEET ── */
.loc-sheet-overlay { position: fixed; inset: 0; z-index: 230; display: none; background: rgba(28,36,32,0.4); backdrop-filter: blur(5px); align-items: flex-end; }
.loc-sheet-overlay.open { display: flex; }
.loc-sheet { background: var(--bg); border-radius: 24px 24px 0 0; width: 100%; max-width: 430px; margin: 0 auto; max-height: 88dvh; overflow-y: auto; animation: slideUp 0.26s cubic-bezier(0.22,1,0.36,1); padding-bottom: env(safe-area-inset-bottom); }
.loc-sheet-header { position: sticky; top: 0; background: var(--bg); z-index: 2; padding: 14px 16px 10px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; }
.loc-sheet-close { width: 28px; height: 28px; border-radius: 50%; border: none; background: var(--surface2); cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-muted); flex-shrink: 0; margin-left: auto; }
.loc-sheet-kicker { font-size: 9px; font-weight: 800; letter-spacing: 0.12em; text-transform: uppercase; color: var(--text-light); margin-bottom: 3px; }
.loc-sheet-title { font-family: var(--sys-d); font-size: 22px; font-weight: 800; letter-spacing: -0.04em; color: var(--text); }
.loc-sheet-body { padding: 14px 16px 24px; }
.loc-sheet-metric { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
.loc-sheet-mc { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 10px 14px; flex: 1; min-width: 80px; }
.loc-sheet-mc-label { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.07em; color: var(--text-light); }
.loc-sheet-mc-value { font-family: var(--sys-d); font-size: 22px; font-weight: 800; letter-spacing: -0.03em; color: var(--text); margin-top: 2px; }
.loc-sheet-mc-value.h { color: var(--hunter-dark); }
.loc-sheet-mc-value.b { color: var(--brandon-dark); }
.loc-sheet-section-label { font-size: 9px; font-weight: 800; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text-light); margin: 14px 0 8px; }
.loc-place-row { display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: var(--surface); border-radius: 12px; border: 1px solid var(--border); margin-bottom: 6px; cursor: pointer; -webkit-tap-highlight-color: transparent; transition: box-shadow 0.12s; }
.loc-place-row:active { box-shadow: 0 0 0 2px var(--sage); }
.loc-place-row-name { font-size: 14px; font-weight: 700; flex: 1; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.loc-place-row-sub { font-size: 11px; color: var(--text-muted); }
.loc-place-row-rating { font-size: 11px; font-weight: 700; color: var(--dark-sage); flex-shrink: 0; }

/* ── CLICKABLE PLACES STAT CARD ── */
.stat-card.clickable { cursor: pointer; transition: box-shadow 0.12s; -webkit-tap-highlight-color: transparent; }
.stat-card.clickable:active { box-shadow: 0 0 0 2px var(--sage); }
.stat-card.clickable .stat-value { text-decoration: underline dotted var(--border); text-underline-offset: 3px; }

/* ── CALENDAR MODAL ── */
.cal-modal-overlay{position:fixed;inset:0;z-index:220;display:none;background:rgba(28,36,32,0.4);backdrop-filter:blur(5px);align-items:flex-end;}
.cal-modal-overlay.open{display:flex;}
.cal-modal{background:var(--bg);border-radius:24px 24px 0 0;width:100%;max-width:430px;margin:0 auto;max-height:94dvh;overflow-y:auto;overflow-x:hidden;animation:slideUp 0.26s cubic-bezier(0.22,1,0.36,1);padding-bottom:env(safe-area-inset-bottom);}
.otd-banner{background:linear-gradient(135deg,var(--accent-light) 0%,#e8ecf0 100%);padding:16px 16px 14px;border-bottom:1px solid var(--border);}
.otd-banner-empty{background:var(--surface);padding:12px 16px;border-bottom:1px solid var(--border);}
.otd-kicker{font-size:9px;font-weight:800;letter-spacing:0.12em;text-transform:uppercase;margin-bottom:5px;}
.otd-kicker.has{color:var(--dark-sage);}
.otd-kicker.empty{color:var(--text-light);}
.otd-headline{font-family:var(--sys-d);font-size:16px;font-weight:800;color:var(--text);letter-spacing:-0.03em;line-height:1.25;margin-bottom:10px;}
.otd-empty-txt{font-size:12px;color:var(--text-muted);}
.otd-scroll{display:flex;gap:8px;overflow-x:auto;scrollbar-width:none;padding-bottom:2px;}
.otd-scroll::-webkit-scrollbar{display:none;}
.otd-card{flex-shrink:0;background:var(--surface);border-radius:12px;border:1px solid var(--border);padding:10px 13px;cursor:pointer;min-width:138px;max-width:170px;transition:box-shadow 0.12s;-webkit-tap-highlight-color:transparent;}
.otd-card:active{box-shadow:0 0 0 2px var(--sage);}
.otd-card-year{font-size:10px;font-weight:700;color:var(--dark-sage);margin-bottom:2px;}
.otd-card-place{font-size:13px;font-weight:700;color:var(--text);line-height:1.3;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.otd-card-loc{font-size:11px;color:var(--text-muted);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.otd-card-pills{display:flex;gap:4px;margin-top:5px;flex-wrap:wrap;}
.otd-pill{font-size:10px;font-weight:700;padding:2px 6px;border-radius:6px;}
.otd-pill.h{background:var(--hunter);color:var(--hunter-dark);}
.otd-pill.b{background:var(--brandon);color:var(--brandon-dark);}
.cml-header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px 10px;background:var(--surface);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:5;}
.cml-nav{display:flex;align-items:center;gap:6px;}
.cml-nav-btn{width:28px;height:28px;border-radius:50%;border:1px solid var(--border);background:var(--surface);cursor:pointer;display:flex;align-items:center;justify-content:center;-webkit-tap-highlight-color:transparent;}
.cml-month{font-size:13px;font-weight:700;color:var(--text);min-width:118px;text-align:center;}
.cml-close{width:28px;height:28px;border-radius:50%;border:none;background:var(--surface2);cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--text-muted);}
.cml-grid-wrap{padding:0 10px 6px;background:var(--surface);}
.cml-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;}
.cml-day-lbl{text-align:center;font-size:9px;font-weight:700;color:var(--text-light);padding:6px 0 3px;letter-spacing:0.05em;}
.cml-day{aspect-ratio:1;display:flex;align-items:center;justify-content:center;border-radius:50%;font-size:12px;cursor:pointer;position:relative;transition:background 0.12s;-webkit-tap-highlight-color:transparent;}
.cml-day.other-month{color:var(--border);}
.cml-day.today{font-weight:800;color:var(--dark-sage);}
.cml-day.has-visit::after{content:'';width:3px;height:3px;border-radius:50%;background:var(--dark-sage);position:absolute;bottom:2px;}
.cml-day.selected{background:var(--dark-sage)!important;color:#fff;}
.cml-day.selected.today{color:#fff;}
.cml-day.selected::after{background:rgba(255,255,255,0.7);}
.cml-day.otd-ring{outline:1.5px solid var(--sage);outline-offset:-2px;border-radius:50%;}
.cml-visits-wrap{padding:10px 14px 24px;display:flex;flex-direction:column;gap:8px;}
.cml-visits-lbl{font-size:9px;font-weight:800;letter-spacing:0.1em;text-transform:uppercase;color:var(--text-light);margin-bottom:2px;}
.cml-vcard{background:var(--surface);border-radius:12px;padding:12px 14px;border:1px solid var(--border);cursor:pointer;-webkit-tap-highlight-color:transparent;}
.cml-vcard:active{box-shadow:0 0 0 2px var(--sage);}
.cml-vcard-name{font-family:var(--sys-d);font-size:15px;font-weight:700;letter-spacing:-0.02em;}
.cml-vcard-loc{font-size:11px;color:var(--text-muted);margin-top:2px;}
.cml-vcard-pills{display:flex;gap:5px;margin-top:7px;}
.cml-empty{text-align:center;padding:20px 0 8px;font-size:13px;color:var(--text-light);}


/* ══════════════════════════════════════════════════════════════
   DESKTOP LAYER — activates at ≥ 1024px
   Mobile styles above are completely preserved.
   All desktop rules are scoped inside this media query.
══════════════════════════════════════════════════════════════ */
@media (min-width: 1024px) {
  :root {
    --sb-w: 216px;   /* sidebar width */
    --ds-b: 1px solid var(--border);
  }

  /* ── Reset mobile body constraints ── */
  body {
    max-width: 100%;
    overflow: hidden;
    display: grid;
    grid-template-columns: var(--sb-w) 1fr;
    grid-template-rows: 100dvh;
  }

  /* ── Hide mobile-only chrome ── */
  .nav, .sync-bar, .sync-bar-h,
  #other-menu-overlay { display: none !important; }

  /* ── All views: reset mobile padding/scroll ── */
  .view {
    display: none;
    padding: 0;
    min-height: 0;
    height: 100dvh;
    overflow: hidden;
  }
  .view.active { display: flex; flex-direction: column; min-height: 0; }

  /* ══ SIDEBAR ══ */
  #ds-sidebar {
    display: flex;
    position: fixed; top: 0; left: 0;
    width: var(--sb-w); height: 100dvh;
    background: var(--surface);
    border-right: var(--ds-b);
    display: flex; flex-direction: column;
    z-index: 60;
  }
  .ds-logo {
    padding: 20px 18px 14px;
    border-bottom: var(--ds-b);
    flex-shrink: 0;
  }
  .ds-logo-name {
    font-family: var(--sys-d); font-size: 18px;
    font-weight: 800; letter-spacing: -0.05em; color: var(--text); line-height: 1;
  }
  .ds-logo-sub {
    font-size: 10px; font-weight: 500; letter-spacing: 0.06em;
    text-transform: uppercase; color: var(--text-light); margin-top: 3px;
  }
  .ds-nav { flex: 1; overflow-y: auto; padding: 10px 8px; scrollbar-width: none; }
  .ds-nav::-webkit-scrollbar { display: none; }
  .ds-nav-section {
    font-size: 9px; font-weight: 700; letter-spacing: 0.1em;
    text-transform: uppercase; color: var(--text-light);
    padding: 10px 10px 4px;
  }
  .ds-nb {
    display: flex; align-items: center; gap: 9px;
    padding: 8px 10px; border-radius: 8px;
    border: none; background: none;
    font-family: var(--sys); font-size: 13px; font-weight: 500;
    color: var(--text-muted); cursor: pointer;
    transition: background .12s, color .12s;
    width: 100%; text-align: left;
  }
  .ds-nb:hover { background: var(--surface2); color: var(--text); }
  .ds-nb.active {
    background: var(--accent-light); color: var(--dark-sage); font-weight: 700;
  }
  .ds-nb svg { width: 15px; height: 15px; flex-shrink: 0; stroke-width: 1.8; opacity: .75; }
  .ds-nb.active svg { opacity: 1; }
  .ds-nb-badge {
    margin-left: auto; font-size: 9px; font-weight: 700;
    padding: 1px 5px; border-radius: 8px;
    background: var(--surface2); color: var(--text-light);
  }
  .ds-nb.active .ds-nb-badge { background: rgba(110,129,117,.15); color: var(--dark-sage); }

  .ds-add-btn {
    margin: 6px 8px; padding: 9px 12px; border-radius: 9px;
    border: none; background: var(--dark-sage); color: #fff;
    font-family: var(--sys); font-size: 13px; font-weight: 700;
    cursor: pointer; display: flex; align-items: center; gap: 7px;
    transition: background .12s, transform .1s; flex-shrink: 0;
  }
  .ds-add-btn:hover { background: var(--accent-dark); }
  .ds-add-btn:active { transform: scale(0.98); }
  .ds-add-btn svg { width: 14px; height: 14px; stroke-width: 2.5; }

  .ds-footer {
    padding: 10px 12px; border-top: var(--ds-b); flex-shrink: 0;
  }
  .ds-footer-lbl { font-size: 10px; color: var(--text-light); margin-bottom: 7px; }
  .ds-footer-btns { display: flex; gap: 5px; }
  .ds-footer-btn {
    flex: 1; padding: 5px 0; border-radius: 6px;
    border: var(--ds-b); background: var(--surface);
    font-family: var(--sys); font-size: 10px; font-weight: 600;
    color: var(--text-muted); cursor: pointer; text-align: center;
    transition: background .12s;
  }
  .ds-footer-btn:hover { background: var(--surface2); }

  /* ══ MAIN WRAPPER — occupies the right column ══ */
  #ds-main {
    grid-column: 2;
    margin-left: 0;
    height: 100dvh; overflow: hidden;
    display: flex; flex-direction: column;
    min-width: 0;
  }

  /* ══ DASHBOARD VIEW ══ */
  #view-dashboard {
    overflow-y: auto; scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
    padding-bottom: 24px;
  }
  .ds-dash-hd {
    padding: 22px 26px 0; flex-shrink: 0;
  }
  .ds-dash-title {
    font-family: var(--sys-d); font-size: 21px;
    font-weight: 800; letter-spacing: -0.04em;
  }
  .ds-dash-sub { font-size: 12px; color: var(--text-muted); margin-top: 2px; }

  .ds-metrics {
    display: grid; grid-template-columns: repeat(6,1fr);
    gap: 10px; padding: 16px 26px 0;
  }
  .ds-mc {
    background: var(--surface); border-radius: 11px;
    border: var(--ds-b); padding: 13px 13px 11px;
    transition: box-shadow .15s;
  }
  .ds-mc:hover { box-shadow: 0 2px 12px rgba(28,36,32,.07); }
  .ds-mc-lbl {
    font-size: 9px; font-weight: 700; letter-spacing: .09em;
    text-transform: uppercase; color: var(--text-light); margin-bottom: 5px;
  }
  .ds-mc-val {
    font-family: var(--sys-d); font-size: 25px; font-weight: 800;
    letter-spacing: -0.04em; color: var(--text); line-height: 1;
  }
  .ds-mc-sub { font-size: 10px; color: var(--text-muted); margin-top: 3px; }

  .ds-grid {
    display: grid; grid-template-columns: 1fr 320px;
    gap: 14px; padding: 14px 26px 26px;
  }
  .ds-col { display: flex; flex-direction: column; gap: 14px; }

  .ds-panel {
    background: var(--surface); border-radius: 12px;
    border: var(--ds-b); overflow: hidden;
  }
  .ds-ph {
    padding: 13px 16px 0;
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 10px;
  }
  .ds-ph-title {
    font-size: 9px; font-weight: 700; letter-spacing: .09em;
    text-transform: uppercase; color: var(--text-light);
  }
  .ds-ph-link {
    font-size: 11px; font-weight: 600; color: var(--dark-sage);
    background: none; border: none; cursor: pointer; padding: 0;
  }
  .ds-ph-link:hover { text-decoration: underline; }

  /* Activity items */
  .ds-act {
    display: flex; align-items: flex-start; gap: 9px;
    padding: 9px 16px; border-bottom: var(--ds-b);
    cursor: pointer; transition: background .1s;
  }
  .ds-act:last-child { border-bottom: none; }
  .ds-act:hover { background: var(--bg); }
  .ds-act-dot {
    width: 7px; height: 7px; border-radius: 50%;
    flex-shrink: 0; margin-top: 4px;
  }
  .ds-act-dot.place { background: var(--dark-sage); }
  .ds-act-dot.visit { background: var(--slate); }
  .ds-act-dot.note  { background: var(--blush-dark); }
  .ds-act-name { font-size: 13px; font-weight: 600; line-height: 1.3; }
  .ds-act-meta { font-size: 11px; color: var(--text-muted); margin-top: 1px; }
  .ds-act-time {
    font-size: 10px; color: var(--text-light);
    margin-left: auto; flex-shrink: 0; padding-top: 2px;
  }

  /* Wishlist highlights */
  .ds-wi {
    display: flex; align-items: center; gap: 9px;
    padding: 9px 16px; border-bottom: var(--ds-b);
    cursor: pointer; transition: background .1s;
  }
  .ds-wi:last-child { border-bottom: none; }
  .ds-wi:hover { background: var(--bg); }
  .ds-wi-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
  .ds-wi-dot.high { background: #a0413b; }
  .ds-wi-dot.medium { background: var(--slate); }
  .ds-wi-dot.low { background: var(--border); }
  .ds-wi-name { font-size: 13px; font-weight: 600; flex: 1; min-width: 0;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .ds-wi-loc { font-size: 11px; color: var(--text-muted); flex-shrink: 0; }

  /* Category rows */
  .ds-cat-row {
    display: flex; align-items: center; gap: 10px;
    padding: 8px 16px; border-bottom: var(--ds-b);
  }
  .ds-cat-row:last-child { border-bottom: none; }
  .ds-cat-lbl { font-size: 12px; font-weight: 500; flex: 1; min-width: 0;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .ds-cat-track { width: 80px; height: 5px; background: var(--surface2);
    border-radius: 3px; overflow: hidden; flex-shrink: 0; }
  .ds-cat-fill { height: 100%; border-radius: 3px; background: var(--dark-sage); }
  .ds-cat-cnt { font-size: 11px; color: var(--text-muted); width: 24px;
    text-align: right; flex-shrink: 0; }

  /* Mini map */
  .ds-mini-map { height: 170px; background: var(--bg); overflow: hidden; }
  #ds-mini-leaf { width: 100%; height: 100%; pointer-events: none; }

  /* ══ LIST VIEW ══ */
  /* Single scrollable column — matches wishlist view structure */
  #view-list.active {
    flex-direction: column;
    overflow-y: auto;
    overflow-x: hidden;
    height: 100dvh;
    min-height: 0;
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
  }
  #view-list .page-header {
    flex-shrink: 0;
    padding: 18px 26px 12px;
    border-bottom: var(--ds-b);
    /* sticky so header stays visible while list scrolls */
    position: sticky; top: 0; z-index: 10;
    background: var(--surface);
  }
  #view-list .search-wrap {
    flex-shrink: 0;
    padding: 8px 26px;
    border-bottom: var(--ds-b);
  }
  #view-list .search-wrap .search-input { font-size: 13px; }
  #view-list .controls {
    flex-shrink: 0;
    padding: 6px 26px;
    border-bottom: var(--ds-b);
  }
  #sort-chips .chip   { font-size: 11px; padding: 5px 12px; }
  #filter-chips .chip { font-size: 11px; padding: 4px 10px; }

  /* Scrollable card list — single column, generous padding */
  #view-list .place-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
    padding: 18px 26px 32px;
    /* no overflow here — parent #view-list.active scrolls */
  }

  /* Cards: restored border-radius, shadow, and proper height */
  #view-list .place-card {
    border-radius: var(--radius);
    border: 1px solid var(--border);
    box-shadow: 0 2px 8px rgba(28,36,32,0.06);
    flex-shrink: 0;
    height: auto;
  }
  #view-list .place-card-inner { padding: 14px 18px; }
  #view-list .place-card:hover {
    background: var(--surface2);
    box-shadow: 0 4px 16px rgba(28,36,32,0.10);
    transform: translateY(-1px);
  }

  /* Place detail in right pane */
  .ds-dp {
    display: flex; flex-direction: column; flex: 1;
  }
  .ds-dp-hero {
    padding: 22px 26px 18px;
    background: linear-gradient(150deg, var(--accent-light) 0%, var(--surface) 100%);
    border-bottom: var(--ds-b); flex-shrink: 0;
  }
  .ds-dp-name {
    font-family: var(--sys-d); font-size: 20px; font-weight: 800;
    letter-spacing: -0.04em;
  }
  .ds-dp-loc { font-size: 12px; color: var(--text-muted); margin-top: 3px; }
  .ds-dp-meta {
    display: flex; gap: 8px; margin-top: 12px;
    align-items: center; flex-wrap: wrap;
  }
  .ds-dp-avg {
    display: flex; align-items: center; gap: 5px;
    background: var(--surface); border-radius: 18px;
    padding: 4px 10px 4px 7px; border: var(--ds-b);
  }
  .ds-dp-pip {
    width: 20px; height: 20px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 8px; font-weight: 800;
  }
  .ds-dp-pip.h { background: var(--hunter); color: var(--hunter-dark); }
  .ds-dp-pip.b { background: var(--brandon); color: var(--brandon-dark); }
  .ds-dp-score { font-size: 13px; font-weight: 700; letter-spacing: -0.03em; }
  .ds-dp-actions {
    display: flex; gap: 5px; padding: 10px 26px;
    border-bottom: var(--ds-b); background: var(--surface); flex-shrink: 0;
  }
  .ds-dp-btn {
    padding: 5px 11px; border-radius: 6px; border: var(--ds-b);
    background: var(--surface2); font-family: var(--sys); font-size: 11px;
    font-weight: 600; color: var(--text-muted); cursor: pointer;
    transition: background .12s;
  }
  .ds-dp-btn:hover { background: var(--accent-light); color: var(--dark-sage); }
  .ds-dp-btn.danger { color: #a0413b; }
  .ds-dp-btn.danger:hover { background: #f5eae9; }
  .ds-dp-body {
    flex: 1; overflow-y: auto;
    scrollbar-width: thin; scrollbar-color: var(--border) transparent;
  }
  .ds-dp-sec {
    padding: 14px 26px; border-bottom: var(--ds-b);
  }
  .ds-dp-sec:last-child { border-bottom: none; }
  .ds-dp-sec-lbl {
    font-size: 9px; font-weight: 700; letter-spacing: .1em;
    text-transform: uppercase; color: var(--text-light); margin-bottom: 9px;
  }

  /* Visit rows in right panel */
  .ds-vr {
    display: flex; align-items: center; gap: 10px;
    padding: 9px 11px; border-radius: 8px; cursor: pointer;
    border: var(--ds-b); background: var(--bg);
    margin-bottom: 5px; transition: background .1s;
  }
  .ds-vr:hover { background: var(--accent-light); }
  .ds-vr-date { font-size: 13px; font-weight: 700; flex-shrink: 0; width: 95px; }
  .ds-vr-ratings { display: flex; gap: 4px; }
  .ds-vr-rp {
    font-size: 10px; font-weight: 700; padding: 2px 6px; border-radius: 5px;
  }
  .ds-vr-rp.h { background: var(--hunter); color: var(--hunter-dark); }
  .ds-vr-rp.b { background: var(--brandon); color: var(--brandon-dark); }
  .ds-vr-meta { font-size: 11px; color: var(--text-muted); margin-left: auto; }

  /* Thread in right pane */
  .ds-thread .thread-msg { max-width: 72%; }
  .ds-thread .bubble { font-size: 13px; }
  .ds-thread .bubble-meta { font-size: 9px; }
  .ds-thread .add-note-bar { margin-top: 10px; }

  /* ══ MAP SPLIT VIEW ══ */
  #view-map { flex-direction: row !important; padding: 0 !important; }
  #view-map .page-header { display: none; }

  .ds-map-left {
    width: 240px; flex-shrink: 0;
    border-right: var(--ds-b); background: var(--surface);
    display: flex; flex-direction: column;
    overflow-y: auto; scrollbar-width: thin;
  }
  .ds-map-lhd { padding: 14px 14px 10px; border-bottom: var(--ds-b); flex-shrink: 0; }
  .ds-map-lhd-title { font-size: 13px; font-weight: 700; }
  .ds-map-fg { padding: 10px 12px; border-bottom: var(--ds-b); }
  .ds-map-fg-lbl {
    font-size: 9px; font-weight: 700; letter-spacing: .09em;
    text-transform: uppercase; color: var(--text-light); margin-bottom: 6px;
  }
  .ds-map-chips { display: flex; flex-wrap: wrap; gap: 4px; }
  .ds-map-chip {
    padding: 3px 8px; border-radius: 10px; border: var(--ds-b);
    background: var(--surface2); font-size: 11px; font-weight: 500;
    color: var(--text-muted); cursor: pointer; transition: all .12s;
  }
  .ds-map-chip.on { background: var(--dark-sage); border-color: var(--dark-sage); color: #fff; }
  .ds-map-chip.wish-on { background: var(--wish-color); border-color: var(--wish-color); color: #fff; }

  .ds-map-modes { display: flex; flex-direction: column; gap: 3px; padding: 8px 10px; border-bottom: var(--ds-b); }
  .ds-map-mode-btn {
    padding: 7px 10px; border-radius: 6px; border: var(--ds-b);
    background: none; font-family: var(--sys); font-size: 12px; font-weight: 500;
    color: var(--text-muted); cursor: pointer; text-align: left; transition: all .12s;
  }
  .ds-map-mode-btn.on { background: var(--dark-sage); border-color: var(--dark-sage); color: #fff; font-weight: 700; }

  /* Canvas area */
  .ds-map-right { flex: 1; position: relative; overflow: hidden; }
  #map-container { position: absolute; inset: 0; }
  #leaflet-map { position: absolute; inset: 0; z-index: 1; }

  /* Hide mobile map controls */
  .map-mode-row, .map-wish-toggle { display: none !important; }

  /* Floating card on marker click */
  #ds-map-card {
    position: absolute; top: 14px; right: 14px;
    width: 270px; background: var(--surface);
    border-radius: 12px; border: var(--ds-b);
    box-shadow: 0 4px 22px rgba(28,36,32,.14);
    z-index: 10; display: none; overflow: hidden;
    animation: dsFadeIn .16s ease;
  }
  #ds-map-card.on { display: block; }
  @keyframes dsFadeIn { from { opacity:0; transform: translateY(-5px); } }
  .ds-mc-hd {
    padding: 12px 14px 9px; border-bottom: var(--ds-b);
    display: flex; justify-content: space-between; align-items: flex-start;
  }
  .ds-mc-name { font-size: 14px; font-weight: 700; }
  .ds-mc-loc { font-size: 11px; color: var(--text-muted); margin-top: 1px; }
  .ds-mc-close {
    width: 22px; height: 22px; border-radius: 50%; border: none;
    background: var(--surface2); cursor: pointer; display: flex;
    align-items: center; justify-content: center;
    color: var(--text-muted); font-size: 13px; flex-shrink: 0;
  }
  .ds-mc-bd { padding: 9px 14px 13px; }
  .ds-mc-rats { display: flex; gap: 5px; margin-bottom: 7px; }
  .ds-mc-open {
    display: block; width: 100%; padding: 7px 0; border-radius: 6px;
    border: none; background: var(--dark-sage); color: #fff;
    font-family: var(--sys); font-size: 12px; font-weight: 700;
    cursor: pointer; text-align: center;
  }

  /* ══ STATS — 2-column grid ══ */
  #view-stats .page-header { display: none; }
  .ds-stats-hd {
    padding: 16px 26px 12px; background: var(--surface);
    border-bottom: var(--ds-b); display: flex; align-items: center;
    gap: 12px; flex-shrink: 0;
  }
  .ds-stats-hd h2 { font-size: 19px; font-weight: 800; }
  .ds-stats-ytabs { margin-left: auto; }

  .stats-year-tabs { border-bottom: none !important; padding: 0 !important; background: transparent !important; }

  #view-stats { overflow: hidden; }
  .ds-stats-body {
    flex: 1; overflow-y: auto;
    scrollbar-width: thin; scrollbar-color: var(--border) transparent;
    padding: 18px 26px 26px;
    display: grid; grid-template-columns: 1fr 1fr;
    gap: 14px; align-content: start;
  }
  .stats-section {
    border: var(--ds-b) !important;
    border-radius: 12px !important;
    background: var(--surface);
    break-inside: avoid;
  }
  .stats-section:first-child { grid-column: 1 / -1; }
  .stats-section:last-child { border-bottom: var(--ds-b) !important; }

  /* ══ DISCOVER SPLIT VIEW ══ */
  #view-discover { flex-direction: row !important; }
  #view-discover .page-header { display: none; }

  .ds-disc-left {
    width: 300px; flex-shrink: 0;
    border-right: var(--ds-b); background: var(--surface);
    overflow-y: auto; scrollbar-width: thin;
    padding: 18px 18px 24px;
    display: flex; flex-direction: column; gap: 12px;
  }
  .ds-disc-left h3 { font-size: 14px; font-weight: 800; letter-spacing: -0.03em; }
  .ds-disc-right {
    flex: 1; overflow-y: auto; scrollbar-width: thin;
    background: var(--bg); padding: 18px 22px;
    display: flex; flex-direction: column; gap: 12px;
  }
  .ds-disc-right-title {
    font-size: 9px; font-weight: 700; letter-spacing: .09em;
    text-transform: uppercase; color: var(--text-light); margin-bottom: 2px;
  }

  /* Result cards */
  .ds-rc {
    background: var(--surface); border-radius: 11px;
    border: var(--ds-b); overflow: hidden; transition: box-shadow .15s;
  }
  .ds-rc:hover { box-shadow: 0 2px 14px rgba(28,36,32,.08); }
  .ds-rc-hd {
    padding: 13px 14px 10px;
    display: flex; align-items: flex-start; gap: 10px;
    border-bottom: var(--ds-b);
  }
  .ds-rc-rank {
    font-family: var(--sys-d); font-size: 22px; font-weight: 800;
    color: var(--border); line-height: 1; flex-shrink: 0;
    width: 24px; text-align: center; margin-top: 3px;
  }
  .ds-rc-rank.top { color: var(--dark-sage); }
  .ds-rc-info { flex: 1; min-width: 0; }
  .ds-rc-name { font-size: 14px; font-weight: 700; }
  .ds-rc-loc { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
  .ds-rc-score { text-align: right; flex-shrink: 0; }
  .ds-rc-score-num {
    font-family: var(--sys-d); font-size: 20px; font-weight: 800;
    letter-spacing: -0.03em; color: var(--dark-sage);
  }
  .ds-rc-score-sub { font-size: 9px; color: var(--text-light); }
  .ds-rc-body { padding: 11px 14px; }
  .ds-sc {
    display: flex; align-items: center; gap: 7px; margin-bottom: 6px;
  }
  .ds-sc:last-child { margin-bottom: 0; }
  .ds-sc-lbl { font-size: 10px; color: var(--text-muted); width: 65px; flex-shrink: 0; }
  .ds-sc-track { flex: 1; height: 4px; background: var(--surface2); border-radius: 2px; overflow: hidden; }
  .ds-sc-fill { height: 100%; border-radius: 2px; transition: width .4s; }
  .ds-sc-val { font-size: 10px; font-weight: 700; color: var(--text); width: 32px; text-align: right; flex-shrink: 0; }
  .ds-rc-reasons { padding: 9px 14px 12px; border-top: var(--ds-b); }
  .ds-rc-reason {
    display: flex; align-items: flex-start; gap: 6px;
    font-size: 11px; color: var(--text-muted); line-height: 1.4; margin-bottom: 4px;
  }
  .ds-rc-reason-dot {
    width: 3px; height: 3px; border-radius: 50%;
    background: var(--sage); flex-shrink: 0; margin-top: 5px;
  }

  /* Side-by-side compare */
  .ds-cmp {
    background: var(--surface); border-radius: 11px;
    border: var(--ds-b); padding: 13px 14px;
    display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
  }
  .ds-cmp-title {
    font-size: 9px; font-weight: 700; letter-spacing: .09em;
    text-transform: uppercase; color: var(--text-light);
    grid-column: 1/-1; margin-bottom: 4px;
  }
  .ds-cmp-col { display: flex; flex-direction: column; gap: 4px; }
  .ds-cmp-name { font-size: 12px; font-weight: 700; }
  .ds-cmp-loc { font-size: 10px; color: var(--text-muted); margin-bottom: 3px; }
  .ds-cmp-row {
    display: flex; justify-content: space-between;
    font-size: 11px; padding: 3px 0; border-bottom: var(--ds-b);
  }
  .ds-cmp-row:last-child { border-bottom: none; }
  .ds-cmp-row-lbl { color: var(--text-muted); }
  .ds-cmp-row-val { font-weight: 600; color: var(--text); }
  .ds-cmp-row-val.better { color: var(--dark-sage); }

  /* ══ Keyboard shortcut hint ══ */
  #ds-kbd {
    position: fixed; bottom: 14px; right: 14px;
    background: var(--surface); border: var(--ds-b);
    border-radius: 10px; padding: 11px 13px;
    box-shadow: 0 4px 18px rgba(28,36,32,.12);
    z-index: 300; display: none;
    flex-direction: column; gap: 5px; min-width: 170px;
  }
  #ds-kbd.on { display: flex; }
  .ds-kbd-title {
    font-size: 9px; font-weight: 700; letter-spacing: .07em;
    text-transform: uppercase; color: var(--text-light); margin-bottom: 2px;
  }
  .ds-kbd-row {
    display: flex; align-items: center;
    justify-content: space-between; gap: 8px;
    font-size: 11px; color: var(--text-muted);
  }
  kbd {
    display: inline-flex; align-items: center; justify-content: center;
    padding: 2px 5px; border-radius: 4px;
    background: var(--surface2); border: var(--ds-b);
    font-family: var(--sys); font-size: 10px; font-weight: 700;
    color: var(--text); box-shadow: 0 1px 0 var(--border);
  }

  /* ══ Fullscreen modals become centered dialogs ══ */
  .modal-overlay.fullscreen-modal { align-items: center; justify-content: center; }
  .modal-overlay.fullscreen-modal .modal {
    border-radius: var(--radius);
    height: auto; max-height: 90dvh;
    max-width: 560px; width: 100%;
    animation: dsPop .2s cubic-bezier(.22,1,.36,1);
  }
  @keyframes dsPop { from { opacity:0; transform: scale(.96); } }

  /* Hide mobile page headers in views that have desktop headers */
  #view-stats .page-header,
  #view-discover .page-header { display: none !important; }

  /* Wishlist + Calendar: simple desktop padding */
  #view-wishlist, #view-calendar {
    overflow-y: auto; scrollbar-width: thin;
  }
  #view-wishlist .page-header,
  #view-calendar .page-header { padding: 18px 26px 14px; }
  #view-wishlist .wish-list-wrap { padding: 0 26px; }
  #view-wishlist .controls { padding: 8px 26px; }

  /* ══ Trips view ══ */
  #view-trips.active { display: flex; flex-direction: column; overflow-y: auto; }
  #view-trips .page-header { padding: 18px 26px 14px; }

  /* Stat grid: 4 columns on desktop */
  .stat-grid { grid-template-columns: repeat(4,1fr); }

  /* Search wrap desktop */
  .search-wrap { padding: 7px 10px 0; }
  .search-input { font-size: 12px; padding: 7px 12px 7px 30px; }
  #sort-chips.controls, #filter-chips.controls { padding: 5px 10px; gap: 4px; }

} /* end @media (min-width: 1024px) */


/* ── ANALYTICS: shared score bars ── */
.ana-section { padding: 14px 16px; border-top: 1px solid var(--border); }
.ana-section-title {
  font-size: 10px; font-weight: 800; letter-spacing: 0.08em; text-transform: uppercase;
  color: var(--text-light); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;
}
.ana-classify-badge {
  display: inline-block; padding: 3px 10px; border-radius: 20px;
  font-size: 11px; font-weight: 700; letter-spacing: 0.04em;
  background: var(--accent-light); color: var(--dark-sage); border: 1px solid var(--border);
  margin-bottom: 10px;
}
.ana-badge-tag {
  display: inline-block; padding: 2px 9px; border-radius: 20px;
  font-size: 10px; font-weight: 700; letter-spacing: 0.05em;
  background: #e0eae8; color: var(--hunter-dark); border: 1px solid var(--border);
  margin-bottom: 8px;
}
.ana-score-row { margin-bottom: 10px; }
.ana-score-label {
  display: flex; justify-content: space-between; align-items: baseline;
  font-size: 11px; color: var(--text-muted); margin-bottom: 4px;
}
.ana-score-label span:last-child { font-weight: 700; color: var(--text); font-size: 12px; }
.ana-bar-track {
  height: 6px; background: var(--surface2); border-radius: 6px; overflow: hidden;
}
.ana-bar-fill {
  height: 100%; border-radius: 6px; transition: width 0.6s ease;
  background: linear-gradient(90deg, var(--dark-sage), var(--slate));
}
.ana-bar-fill.depth   { background: linear-gradient(90deg, #4a7a6a, #6e9a8a); }
.ana-bar-fill.density { background: linear-gradient(90deg, #3d6880, #6a9ab0); }
.ana-bar-fill.dim1    { background: linear-gradient(90deg, #4a7a6a, #6e9a8a); }
.ana-bar-fill.dim2    { background: linear-gradient(90deg, #7a6e4a, #a09060); }
.ana-bar-fill.dim3    { background: linear-gradient(90deg, #3d6880, #6a9ab0); }
.ana-bar-fill.dim4    { background: linear-gradient(90deg, #5a4a7a, #8a7aaa); }
.ana-bar-fill.dim5    { background: linear-gradient(90deg, #7a4a5a, #aa7a8a); }
.ana-metric-grid {
  display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-top: 10px;
}
.ana-metric-card {
  background: var(--surface2); border-radius: 8px; padding: 8px 10px;
}
.ana-metric-label { font-size: 9px; font-weight: 700; color: var(--text-light); letter-spacing: 0.06em; text-transform: uppercase; }
.ana-metric-value { font-size: 16px; font-weight: 700; color: var(--text); margin-top: 1px; font-family: var(--sys-d); }
.ana-summary {
  font-size: 12px; line-height: 1.6; color: var(--text-muted);
  background: var(--surface2); border-radius: 8px; padding: 10px 12px;
  margin-top: 10px; border-left: 3px solid var(--dark-sage);
}
.ana-expand-btn {
  width: 100%; background: none; border: none; cursor: pointer;
  font-size: 11px; color: var(--dark-sage); font-weight: 600; padding: 6px 0 0;
  text-align: left; display: flex; align-items: center; gap: 4px;
}

/* ══════════════════════════════════════════
   PLAN A TRIP — ITINERARY BUILDER
══════════════════════════════════════════ */

/* Modal shell */
#modal-plan-trip .modal {
  display: flex; flex-direction: column; height: 100dvh;
  border-radius: 0; overflow: hidden;
}
.plan-header {
  display: flex; align-items: center; gap: 10px;
  padding: 16px 18px 12px; border-bottom: 1px solid var(--border);
  flex-shrink: 0; background: var(--surface);
}
.plan-header h3 { font-size: 17px; font-weight: 800; letter-spacing: -0.03em; flex: 1; }
.plan-body { flex: 1; overflow-y: auto; padding: 0 0 32px; scrollbar-width: thin; }

/* Phase tabs */
.plan-phases {
  display: flex; border-bottom: 1px solid var(--border);
  background: var(--surface); flex-shrink: 0;
}
.plan-phase-dot {
  flex: 1; padding: 10px 4px; text-align: center;
  font-size: 10px; font-weight: 700; letter-spacing: 0.06em;
  color: var(--text-light); text-transform: uppercase; cursor: default;
  border-bottom: 2px solid transparent; transition: color 0.2s, border-color 0.2s;
}
.plan-phase-dot.active { color: var(--dark-sage); border-bottom-color: var(--dark-sage); }
.plan-phase-dot.done   { color: var(--slate); }

/* Step containers */
.plan-step { display: none; padding: 16px 18px 0; }
.plan-step.active { display: block; }

/* Parameter inputs */
.plan-card {
  background: var(--surface); border-radius: 14px;
  border: 1px solid var(--border); padding: 16px;
  margin-bottom: 12px;
}
.plan-card-title {
  font-size: 10px; font-weight: 800; letter-spacing: 0.08em;
  text-transform: uppercase; color: var(--text-light); margin-bottom: 12px;
}
.plan-toggle-row {
  display: flex; gap: 6px; flex-wrap: wrap;
}
.plan-toggle {
  padding: 7px 14px; border-radius: 20px; border: 1.5px solid var(--border);
  background: var(--surface); font-size: 12px; font-weight: 600;
  color: var(--text-muted); cursor: pointer; transition: all 0.15s;
  font-family: var(--sys);
}
.plan-toggle.active {
  background: var(--accent-light); border-color: var(--dark-sage);
  color: var(--dark-sage);
}
.plan-days-input {
  display: flex; align-items: center; gap: 12px;
}
.plan-days-stepper {
  display: flex; align-items: center; gap: 0;
  border: 1.5px solid var(--border); border-radius: 10px; overflow: hidden;
}
.plan-days-btn {
  width: 36px; height: 36px; border: none; background: var(--surface2);
  font-size: 18px; font-weight: 600; cursor: pointer; color: var(--text-muted);
  transition: background 0.1s; display: flex; align-items: center; justify-content: center;
}
.plan-days-btn:active { background: var(--border); }
.plan-days-num {
  width: 44px; text-align: center; font-size: 18px; font-weight: 800;
  font-family: var(--sys-d); color: var(--text);
}

/* Wishlist item picker */
.plan-wish-grid {
  display: flex; flex-direction: column; gap: 6px; max-height: 260px;
  overflow-y: auto; scrollbar-width: thin;
}
.plan-wish-item {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 12px; border-radius: 10px; border: 1.5px solid var(--border);
  cursor: pointer; transition: all 0.15s; background: var(--surface);
}
.plan-wish-item.selected {
  border-color: var(--dark-sage); background: var(--accent-light);
}
.plan-wish-item-check {
  width: 18px; height: 18px; border-radius: 50%;
  border: 2px solid var(--border); flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.15s;
}
.plan-wish-item.selected .plan-wish-item-check {
  background: var(--dark-sage); border-color: var(--dark-sage);
}
.plan-wish-item-check svg { display: none; }
.plan-wish-item.selected .plan-wish-item-check svg { display: block; }
.plan-wish-item-name { font-size: 13px; font-weight: 600; flex: 1; min-width: 0;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.plan-wish-item-loc { font-size: 10px; color: var(--text-light); }
.plan-wish-item-cat {
  font-size: 9px; font-weight: 700; padding: 2px 6px; border-radius: 5px;
  background: var(--surface2); color: var(--text-muted); flex-shrink: 0;
}
.plan-select-all { font-size: 11px; color: var(--dark-sage); font-weight: 600;
  background: none; border: none; cursor: pointer; margin-bottom: 6px; padding: 0; }

/* Generate button */
.plan-generate-btn {
  width: 100%; padding: 14px; border-radius: 12px;
  background: var(--dark-sage); color: white; border: none;
  font-size: 15px; font-weight: 700; font-family: var(--sys-d);
  cursor: pointer; transition: opacity 0.15s; margin-top: 4px;
  letter-spacing: -0.01em;
}
.plan-generate-btn:disabled { opacity: 0.5; cursor: not-allowed; }
.plan-surprise-btn {
  width: 100%; padding: 11px; border-radius: 12px;
  background: none; border: 1.5px solid var(--slate);
  color: var(--slate); font-size: 13px; font-weight: 600;
  font-family: var(--sys); cursor: pointer; margin-top: 8px;
  transition: all 0.15s;
}
.plan-surprise-btn:hover { background: var(--brandon); }

/* Generated itinerary */
.plan-narrative {
  font-size: 12px; line-height: 1.65; color: var(--text-muted);
  background: linear-gradient(135deg, var(--accent-light) 0%, #e8eef2 100%);
  border-radius: 12px; padding: 14px 16px; margin-bottom: 14px;
  border-left: 3px solid var(--dark-sage);
}
.plan-score-grid {
  display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 14px;
}
.plan-score-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 12px; padding: 10px 12px;
}
.plan-score-label {
  font-size: 9px; font-weight: 700; text-transform: uppercase;
  letter-spacing: 0.07em; color: var(--text-light); margin-bottom: 4px;
}
.plan-score-val { font-size: 16px; font-weight: 800; font-family: var(--sys-d); color: var(--text); }
.plan-score-bar-track {
  height: 4px; background: var(--surface2); border-radius: 4px; margin-top: 5px; overflow: hidden;
}
.plan-score-bar-fill {
  height: 100%; border-radius: 4px;
  background: linear-gradient(90deg, var(--dark-sage), var(--slate));
}

/* Day cards */
.plan-day-block { margin-bottom: 12px; }
.plan-day-header {
  display: flex; align-items: center; gap: 8px;
  padding: 8px 14px 6px; position: sticky; top: 0;
  background: var(--bg); z-index: 2;
}
.plan-day-label {
  font-size: 10px; font-weight: 800; letter-spacing: 0.08em;
  text-transform: uppercase; color: var(--dark-sage);
}
.plan-day-miles {
  font-size: 10px; color: var(--text-light); margin-left: auto;
}
.plan-place-card {
  display: flex; align-items: center; gap: 10px;
  background: var(--surface); border-radius: 12px;
  border: 1px solid var(--border); padding: 12px 14px;
  margin: 0 0 6px; cursor: grab; transition: box-shadow 0.15s;
  position: relative;
}
.plan-place-card.dragging { opacity: 0.4; box-shadow: 0 6px 20px rgba(28,36,32,0.15); }
.plan-place-card.drag-over { box-shadow: 0 0 0 2px var(--dark-sage); }
.plan-place-drag { color: var(--border); flex-shrink: 0; }
.plan-place-body { flex: 1; min-width: 0; }
.plan-place-name { font-size: 13px; font-weight: 700;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.plan-place-loc { font-size: 11px; color: var(--text-muted); margin-top: 1px; }
.plan-place-cat {
  font-size: 9px; font-weight: 700; padding: 2px 6px; border-radius: 5px;
  background: var(--accent-light); color: var(--dark-sage); margin-top: 4px;
  display: inline-block;
}
.plan-place-remove {
  width: 26px; height: 26px; border-radius: 50%; border: none;
  background: var(--surface2); color: var(--text-light); cursor: pointer;
  font-size: 14px; display: flex; align-items: center; justify-content: center;
  flex-shrink: 0; transition: background 0.1s;
}
.plan-place-remove:hover { background: var(--blush); color: var(--blush-dark); }

/* Add to day button */
.plan-add-to-day {
  width: 100%; background: none; border: 1.5px dashed var(--border);
  border-radius: 10px; padding: 8px; font-size: 11px; color: var(--text-light);
  cursor: pointer; transition: all 0.15s; margin-bottom: 6px; font-family: var(--sys);
}
.plan-add-to-day:hover { border-color: var(--dark-sage); color: var(--dark-sage); }

/* Add-to-day picker sheet */
.plan-day-picker {
  position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
  width: 100%; max-width: 430px; background: var(--surface);
  border-radius: 18px 18px 0 0; border: 1px solid var(--border);
  padding: 16px 18px 32px; z-index: 300; max-height: 60dvh;
  overflow-y: auto; box-shadow: 0 -8px 32px rgba(28,36,32,0.14);
  transition: transform 0.3s ease;
}
.plan-day-picker-title {
  font-size: 13px; font-weight: 700; margin-bottom: 10px; color: var(--text);
}
.plan-day-picker-close {
  position: absolute; top: 14px; right: 16px; background: none; border: none;
  font-size: 18px; color: var(--text-light); cursor: pointer;
}

/* Footer actions */
.plan-footer {
  position: sticky; bottom: 0; background: var(--surface);
  border-top: 1px solid var(--border); padding: 12px 18px;
  display: flex; gap: 8px; flex-shrink: 0;
}
.plan-save-btn {
  flex: 1; padding: 13px; border-radius: 12px;
  background: var(--dark-sage); color: white; border: none;
  font-size: 14px; font-weight: 700; cursor: pointer;
  font-family: var(--sys-d); letter-spacing: -0.01em;
}
.plan-back-btn {
  padding: 13px 18px; border-radius: 12px;
  background: var(--surface2); color: var(--text-muted); border: none;
  font-size: 13px; font-weight: 600; cursor: pointer; font-family: var(--sys);
}
.plan-regen-btn {
  padding: 13px 14px; border-radius: 12px;
  background: var(--surface2); border: none; cursor: pointer;
  font-size: 12px; font-weight: 600; color: var(--slate); font-family: var(--sys);
}

/* Desktop overrides */
@media (min-width: 1024px) {
  #modal-plan-trip .modal {
    max-width: 520px; margin: auto; height: auto; max-height: 90dvh;
    border-radius: 18px;
  }
  .plan-day-picker { max-width: 520px; border-radius: 14px; position: sticky; }
}

/* ══════════════════════════════════════════════
   TRAVEL WRAPPED — MONTHLY REVIEW
══════════════════════════════════════════════ */

#modal-wrapped .modal {
  height: 100dvh; border-radius: 0;
  display: flex; flex-direction: column;
  background: #0d1a14; overflow: hidden;
}

/* Header bar */
.wr-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 14px 18px 10px; flex-shrink: 0; z-index: 20;
  position: relative; background: transparent;
}
.wr-close {
  width: 34px; height: 34px; border-radius: 50%;
  border: none; background: rgba(255,255,255,0.1);
  color: rgba(255,255,255,0.7); cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: background 0.15s; flex-shrink: 0;
}
.wr-close:hover { background: rgba(255,255,255,0.18); }
.wr-title-small {
  font-size: 11px; font-weight: 700; letter-spacing: 0.1em;
  text-transform: uppercase; color: rgba(255,255,255,0.45);
}

/* Progress bar */
.wr-progress-track {
  height: 2px; background: transparent;
  position: relative; flex-shrink: 0;
  display: flex; gap: 3px; padding: 0 18px 8px;
}
.wr-progress-seg {
  flex: 1; height: 2px; border-radius: 2px;
  background: rgba(255,255,255,0.15); transition: background 0.3s;
}
.wr-progress-seg.done { background: rgba(255,255,255,0.55); }
.wr-progress-seg.active { background: #a8c4b0; }

/* Slide viewport */
.wr-viewport {
  flex: 1; position: relative; overflow: hidden; touch-action: pan-y;
}

/* Individual slides */
.wr-slide {
  position: absolute; inset: 0;
  display: flex; flex-direction: column;
  justify-content: flex-end; padding: 20px 24px 36px;
  opacity: 0; transform: translateX(64px);
  transition: opacity 0.36s cubic-bezier(0.22,1,0.36,1), transform 0.36s cubic-bezier(0.22,1,0.36,1);
  pointer-events: none;
  will-change: transform, opacity;
}
.wr-slide.active {
  opacity: 1; transform: translateX(0); pointer-events: auto;
}
.wr-slide.exit {
  opacity: 0; transform: translateX(-64px);
}
.wr-slide.enter-prev {
  opacity: 0; transform: translateX(-64px);
}

/* Slide background layers */
.wr-slide-bg {
  position: absolute; inset: 0; z-index: 0;
}
.wr-slide-content { position: relative; z-index: 1; overflow: hidden; }
.wr-slide-content > *:last-child { margin-bottom: 0; }

/* Gradient themes */
.wr-bg-hometown {
  background: linear-gradient(160deg, #1a2e24 0%, #0d1a10 50%, #141f1c 100%);
}
.wr-bg-travel {
  background: linear-gradient(160deg, #0d1a2e 0%, #0d1a14 50%, #141c1a 100%);
}
.wr-bg-mixed {
  background: linear-gradient(160deg, #1a2224 0%, #0d1518 50%, #141e1c 100%);
}
.wr-bg-stat {
  background: linear-gradient(160deg, #111d17 0%, #0e1a1a 100%);
}
.wr-bg-rating {
  background: linear-gradient(160deg, #1a1e2e 0%, #0d1020 100%);
}
.wr-bg-identity {
  background: linear-gradient(160deg, #1a2417 0%, #0d1a14 100%);
}
.wr-bg-wishlist {
  background: linear-gradient(160deg, #1e1a24 0%, #14101a 100%);
}
.wr-bg-surprise {
  background: linear-gradient(160deg, #1a1014 0%, #200d14 100%);
}
.wr-bg-close {
  background: linear-gradient(160deg, #141a1e 0%, #0d1218 100%);
}

/* Ambient orb decorations */
.wr-orb {
  position: absolute; border-radius: 50%;
  filter: blur(60px); opacity: 0.22; pointer-events: none;
}
.wr-orb-green  { background: #5d9e78; }
.wr-orb-blue   { background: #4a7a9e; }
.wr-orb-teal   { background: #3d8e8e; }
.wr-orb-warm   { background: #8e6e3d; }
.wr-orb-violet { background: #6a4a8e; }
.wr-orb-rose   { background: #8e3d5a; }

/* Typography */
.wr-kicker {
  font-size: 10px; font-weight: 800; letter-spacing: 0.12em;
  text-transform: uppercase; color: rgba(255,255,255,0.4);
  margin-bottom: 10px;
}
.wr-headline {
  font-family: var(--sys-d); font-size: 38px; font-weight: 800;
  letter-spacing: -0.04em; line-height: 1.05;
  color: #ffffff; margin-bottom: 12px;
}
.wr-headline.sm { font-size: 28px; }
.wr-headline.md { font-size: 32px; }
.wr-subline {
  font-size: 14px; line-height: 1.6; color: rgba(255,255,255,0.55);
  max-width: 320px;
}
.wr-accent-word { color: #a8c4b0; }
.wr-accent-blue { color: #8ab4c8; }
.wr-accent-warm { color: #c4b08a; }

/* Stat blocks */
.wr-stat-row {
  display: flex; gap: 10px; margin-bottom: 18px; flex-wrap: wrap;
}
.wr-stat-block {
  background: rgba(255,255,255,0.07); border-radius: 14px;
  padding: 14px 16px; flex: 1; min-width: 100px;
  border: 1px solid rgba(255,255,255,0.08);
}
.wr-stat-val {
  font-family: var(--sys-d); font-size: 28px; font-weight: 800;
  color: #ffffff; letter-spacing: -0.04em; line-height: 1;
}
.wr-stat-val.lg { font-size: 40px; }
.wr-stat-lbl {
  font-size: 10px; font-weight: 700; letter-spacing: 0.06em;
  text-transform: uppercase; color: rgba(255,255,255,0.35);
  margin-top: 4px;
}

/* List items */
.wr-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px; }
.wr-list-item {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 14px; background: rgba(255,255,255,0.06);
  border-radius: 12px; border: 1px solid rgba(255,255,255,0.07);
}
.wr-list-rank {
  font-size: 11px; font-weight: 800; color: rgba(255,255,255,0.3);
  width: 18px; text-align: right; flex-shrink: 0;
}
.wr-list-name {
  flex: 1; font-size: 13px; font-weight: 600; color: rgba(255,255,255,0.85);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.wr-list-val {
  font-size: 12px; font-weight: 700; color: #a8c4b0; flex-shrink: 0;
}

/* Bar charts on dark */
.wr-bar-set { display: flex; flex-direction: column; gap: 10px; margin-bottom: 16px; }
.wr-bar-row { display: flex; flex-direction: column; gap: 4px; }
.wr-bar-meta { display: flex; justify-content: space-between; }
.wr-bar-label { font-size: 11px; color: rgba(255,255,255,0.5); font-weight: 600; }
.wr-bar-num   { font-size: 11px; color: rgba(255,255,255,0.4); }
.wr-bar-track {
  height: 5px; background: rgba(255,255,255,0.1); border-radius: 5px; overflow: hidden;
}
.wr-bar-fill {
  height: 100%; border-radius: 5px;
  background: linear-gradient(90deg, #6e9a8a, #7aabbf);
  transition: width 0.8s cubic-bezier(0.16,1,0.3,1);
}
.wr-bar-fill.warm { background: linear-gradient(90deg, #9a846e, #bfa87a); }

/* Identity card */
.wr-identity-badge {
  display: inline-block; padding: 8px 20px;
  border-radius: 40px; border: 2px solid rgba(255,255,255,0.25);
  font-size: 13px; font-weight: 800; letter-spacing: 0.04em;
  color: #fff; margin-bottom: 16px; background: rgba(255,255,255,0.07);
}
.wr-identity-badge.hometown { border-color: #7ab09a; color: #a8d4b8; }
.wr-identity-badge.travel   { border-color: #7aaec0; color: #a8cedd; }
.wr-identity-badge.mixed    { border-color: #8a9ab0; color: #b0c0d8; }

/* Score bars */
.wr-score-pair { display: flex; gap: 12px; margin-bottom: 20px; }
.wr-score-item { flex: 1; }
.wr-score-name { font-size: 10px; font-weight: 700; letter-spacing: 0.06em;
  text-transform: uppercase; color: rgba(255,255,255,0.35); margin-bottom: 6px; }
.wr-score-num {
  font-family: var(--sys-d); font-size: 36px; font-weight: 800;
  letter-spacing: -0.04em; color: #fff; margin-bottom: 6px;
}
.wr-score-track {
  height: 4px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden;
}
.wr-score-fill {
  height: 100%; border-radius: 4px;
  background: linear-gradient(90deg, #6e9a8a, #4a7a9e);
}

/* Surprise insight */
.wr-insight-pill {
  display: inline-block; padding: 6px 14px; border-radius: 20px;
  font-size: 11px; font-weight: 700; letter-spacing: 0.05em;
  background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.6);
  margin-bottom: 14px; border: 1px solid rgba(255,255,255,0.1);
  text-transform: uppercase;
}

/* Navigation tap zones */
.wr-tap-prev, .wr-tap-next {
  position: absolute; top: 0; bottom: 0; width: 35%; z-index: 4;
  cursor: pointer;
}
.wr-tap-prev { left: 0; }
.wr-tap-next { right: 0; }

/* Footer action */
.wr-footer {
  padding: 12px 24px calc(12px + env(safe-area-inset-bottom));
  flex-shrink: 0; z-index: 10;
  background: linear-gradient(to top, rgba(13,26,20,0.98) 70%, transparent);
}
.wr-share-btn {
  width: 100%; padding: 14px; border-radius: 14px;
  background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.15);
  color: rgba(255,255,255,0.8); font-size: 14px; font-weight: 700;
  font-family: var(--sys-d); cursor: pointer; letter-spacing: -0.01em;
  transition: background 0.15s;
}
.wr-share-btn:hover { background: rgba(255,255,255,0.16); }

/* Month picker for wrapped trigger */
.wr-month-picker {
  display: flex; flex-direction: column; gap: 8px; padding: 4px 0;
}
.wr-month-row {
  display: flex; align-items: center; justify-content: space-between;
  padding: 10px 14px; border-radius: 12px; cursor: pointer;
  background: var(--surface2); border: 1px solid var(--border);
  transition: background 0.12s;
}
.wr-month-row:hover { background: var(--accent-light); }
.wr-month-row-label { font-size: 13px; font-weight: 600; color: var(--text); }
.wr-month-row-sub { font-size: 11px; color: var(--text-muted); }
.wr-month-row-arrow { color: var(--text-light); }

/* Desktop */
@media (min-width: 1024px) {
  #modal-wrapped .modal {
    max-width: 430px; height: 90dvh; border-radius: 20px;
    margin: auto; box-shadow: 0 20px 80px rgba(0,0,0,0.5);
  }
}

/* ════════════════════════════════════════════
   GOOGLE CLOUD SYNC UI
════════════════════════════════════════════ */

/* Status pill in other-menu */
.sync-status-pill {
  display: inline-flex; align-items: center; gap: 5px;
  font-size: 10px; font-weight: 700; letter-spacing: 0.05em;
  padding: 3px 8px; border-radius: 20px; flex-shrink: 0;
  text-transform: uppercase;
}
.sync-status-pill.synced   { background: #e5ebe7; color: var(--dark-sage); }
.sync-status-pill.syncing  { background: #dde6ec; color: var(--slate); }
.sync-status-pill.offline  { background: #eee8e7; color: var(--other-dark); }
.sync-status-pill.conflict { background: #f5ebe9; color: var(--blush-dark); }
.sync-status-pill.off      { background: var(--surface2); color: var(--text-light); }
.sync-dot {
  width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0;
}
.sync-dot.synced   { background: var(--dark-sage); }
.sync-dot.syncing  { background: var(--slate); animation: syncPulse 1.2s ease-in-out infinite; }
.sync-dot.offline  { background: var(--other-dark); }
.sync-dot.conflict { background: var(--blush-dark); }
.sync-dot.off      { background: var(--border); }
@keyframes syncPulse { 0%,100%{opacity:.4;} 50%{opacity:1;} }

/* Floating sync badge (bottom-left, above nav) */
.sync-float-badge {
  position: fixed; bottom: calc(var(--nav-h) + 10px); left: 14px;
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 20px; padding: 5px 10px 5px 8px;
  display: flex; align-items: center; gap: 6px;
  font-size: 11px; font-weight: 600; color: var(--text-muted);
  box-shadow: 0 2px 12px rgba(28,36,32,0.08);
  z-index: 90; transition: opacity 0.3s, transform 0.3s;
  pointer-events: none; opacity: 0; transform: translateY(6px);
}
.sync-float-badge.visible { opacity: 1; transform: translateY(0); }
@media (min-width: 1024px) {
  .sync-float-badge { left: 50%; transform: translateX(-50%) translateY(6px); }
  .sync-float-badge.visible { transform: translateX(-50%) translateY(0); }
}

/* Sync settings modal */
.sync-modal-section {
  background: var(--surface2); border-radius: 12px;
  padding: 14px 16px; margin-bottom: 12px;
}
.sync-modal-section-title {
  font-size: 10px; font-weight: 800; text-transform: uppercase;
  letter-spacing: 0.08em; color: var(--text-light); margin-bottom: 10px;
}
.sync-account-row {
  display: flex; align-items: center; gap: 10px;
}
.sync-account-avatar {
  width: 36px; height: 36px; border-radius: 50%;
  background: var(--accent-light); color: var(--dark-sage);
  display: flex; align-items: center; justify-content: center;
  font-size: 14px; font-weight: 800; flex-shrink: 0;
}
.sync-account-name { font-size: 13px; font-weight: 700; color: var(--text); }
.sync-account-email { font-size: 11px; color: var(--text-muted); }
.sync-meta-row {
  display: flex; justify-content: space-between; align-items: center;
  padding: 6px 0; border-bottom: 1px solid var(--border);
}
.sync-meta-row:last-child { border-bottom: none; }
.sync-meta-label { font-size: 12px; color: var(--text-muted); }
.sync-meta-val   { font-size: 12px; font-weight: 600; color: var(--text); }
.sync-connect-btn {
  width: 100%; padding: 13px; border-radius: 12px;
  background: #4285f4; color: white; border: none;
  font-size: 14px; font-weight: 700; font-family: var(--sys-d);
  cursor: pointer; display: flex; align-items: center;
  justify-content: center; gap: 8px; transition: opacity 0.15s;
  letter-spacing: -0.01em;
}
.sync-connect-btn:hover { opacity: 0.88; }
.sync-connect-btn svg { flex-shrink: 0; }
.sync-action-row { display: flex; gap: 8px; margin-top: 4px; }
.sync-action-btn {
  flex: 1; padding: 10px 12px; border-radius: 10px;
  background: var(--surface); border: 1.5px solid var(--border);
  font-size: 12px; font-weight: 600; color: var(--text-muted);
  cursor: pointer; font-family: var(--sys); transition: all 0.12s;
  text-align: center;
}
.sync-action-btn:hover { border-color: var(--dark-sage); color: var(--dark-sage); }
.sync-action-btn.danger { color: var(--blush-dark); }
.sync-action-btn.danger:hover { border-color: var(--blush-dark); background: var(--wish-light); }
.sync-setup-note {
  font-size: 11px; line-height: 1.6; color: var(--text-muted);
  background: var(--surface2); border-radius: 8px; padding: 10px 12px;
  border-left: 3px solid var(--border); margin-top: 4px;
}
.sync-setup-note a { color: var(--dark-sage); text-decoration: none; font-weight: 600; }

/* Conflict resolution modal */
.sync-conflict-option {
  display: flex; align-items: flex-start; gap: 12px;
  padding: 12px 14px; border-radius: 12px; border: 1.5px solid var(--border);
  cursor: pointer; transition: all 0.12s; background: var(--surface);
  margin-bottom: 8px; text-align: left;
}
.sync-conflict-option:hover { border-color: var(--dark-sage); background: var(--accent-light); }
.sync-conflict-option-icon {
  width: 32px; height: 32px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0; font-size: 14px;
}
.sync-conflict-option h4 { font-size: 13px; font-weight: 700; margin-bottom: 2px; }
.sync-conflict-option p  { font-size: 11px; color: var(--text-muted); line-height: 1.4; }
</style>
</head>
<body>

<!-- ══ DESKTOP SIDEBAR ══ -->
<div id="ds-sidebar">
  <div class="ds-logo">
    <div class="ds-logo-name">PinDrop</div>
    <div class="ds-logo-sub">Travel Journal</div>
  </div>

  <div class="ds-nav">
    <div class="ds-nav-section">Views</div>
    <button class="ds-nb active" data-view="list">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/></svg>
      Places
      <span class="ds-nb-badge" id="ds-badge-places">0</span>
    </button>
    <button class="ds-nb" data-view="map">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 6l6-3 6 3 6-3v15l-6 3-6-3-6 3V6z"/><path d="M9 3v15M15 6v15"/></svg>
      Map
    </button>
    <button class="ds-nb" data-view="stats">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>
      Stats
    </button>
    <button class="ds-nb" data-view="calendar">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>
      Calendar
    </button>

    <div class="ds-nav-section" style="margin-top:6px;">Explore</div>
    <button class="ds-nb" data-view="wishlist">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
      Wishlist
      <span class="ds-nb-badge" id="ds-badge-wish">0</span>
    </button>
    <button class="ds-nb" data-view="discover">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10"/><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"/></svg>
      Discover
    </button>
    <button class="ds-nb" id="ds-trips-btn">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M17.8 19.2L16 11l3.5-3.5C21 6 21 4 21 4s-2 0-3.5 1.5L14 9 5.8 7.2c-.6-.1-1.1.3-1.3.9l-.6 2.8c-.2.9.4 1.7 1.3 1.9l5.2 1.1L9 16H6l-1 2h3l2-1 1.1 5.2c.2.9 1 1.5 1.9 1.3l2.8-.6c.6-.2 1-.7.9-1.3z"/></svg>
      Trips
      <span class="ds-nb-badge" id="ds-badge-trips">0</span>
    </button>
  </div>

  <button class="ds-add-btn" id="ds-add-btn">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 5v14M5 12h14"/></svg>
    Add Place
  </button>

  <div class="ds-footer">
    <button class="ds-footer-btn" id="ds-sync-btn" style="width:100%;margin-bottom:6px;display:flex;align-items:center;justify-content:space-between;padding:7px 10px;">
      <span style="display:flex;align-items:center;gap:6px;">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a10 10 0 1 0 10 10"/><path d="M18 2v6h-6"/></svg>
        Cloud Sync
      </span>
      <span class="sync-status-pill off" id="ds-sync-pill" style="font-size:9px;padding:2px 6px;">
        <span class="sync-dot off" id="ds-sync-dot"></span>
        <span id="ds-sync-pill-txt">Off</span>
      </span>
    </button>
    <div class="ds-footer-lbl">Data</div>
    <div class="ds-footer-btns">
      <button class="ds-footer-btn" id="ds-export-btn">&#x2193; Export</button>
      <button class="ds-footer-btn" id="ds-import-btn">&#x2191; Import</button>
    </div>
  </div>
</div><!-- /ds-sidebar -->


<div id="ds-main">

<!-- ── DASHBOARD VIEW (desktop only) ── -->
<div id="view-dashboard" class="view">
  <div class="ds-dash-hd">
    <div class="ds-dash-title" id="ds-dash-title">Good morning</div>
    <div class="ds-dash-sub" id="ds-dash-sub"></div>
  </div>
  <div class="ds-metrics" id="ds-metrics"></div>
  <div class="ds-grid">
    <div class="ds-col" id="ds-col-left"></div>
    <div class="ds-col" id="ds-col-right"></div>
  </div>
</div>

<!-- ── LIST VIEW ── -->
<div id="view-list" class="view active">
  <div class="page-header">
    <div class="page-header-row">
      <div><h2>PinDrop</h2><div class="sub" id="list-count">0 places</div></div>
    </div>
  </div>
  <div class="search-wrap"><input class="search-input" id="search-input" type="search" placeholder="Search places&#x2026;"></div>
  <div class="controls" id="sort-chips">
    <button class="chip active" data-sort="name">A&#x2013;Z</button>
    <button class="chip" data-sort="rating">Top Rated</button>
    <button class="chip" data-sort="visits">Most Visited</button>
    <button class="chip" data-sort="recent">Recent</button>
  </div>
  <div class="controls" id="filter-chips" style="padding-top:0;margin-top:-4px;"></div>
  <div class="place-list" id="place-list"></div>
</div>

<!-- ── MAP VIEW ── -->
<div id="view-map" class="view" style="padding:0;">
  <div class="page-header" style="padding:52px 20px 10px;"><h2>Map</h2></div>
  <div id="map-container">
    <div id="leaflet-map"></div>
    <button class="map-wish-toggle" id="map-wish-toggle">Wishlist</button>
    <div class="map-mode-row">
      <button class="map-mode-btn active" data-mode="markers">Markers</button>
      <button class="map-mode-btn" data-mode="heatmap">Heat</button>
      <button class="map-mode-btn" data-mode="choropleth">Regions</button>
    </div>
  </div>
</div>

<!-- ── CALENDAR VIEW ── -->
<div id="view-calendar" class="view">
  <div class="page-header"><h2>Calendar</h2></div>
  <div class="cal-header">
    <button class="cal-nav-btn" id="cal-prev"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="m15 18-6-6 6-6"/></svg></button>
    <h3 id="cal-month-label"></h3>
    <button class="cal-nav-btn" id="cal-next"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="m9 18 6-6-6-6"/></svg></button>
  </div>
  <div class="cal-grid" id="cal-grid"></div>
  <div class="cal-visits" id="cal-visits"></div>
</div>

<!-- ── STATS VIEW ── -->
<div id="view-stats" class="view">
  <div class="page-header"><h2>Stats</h2></div>
  <div class="stats-year-tabs" id="stats-year-tabs">
    <button class="stats-year-tab active" data-year="all">All Time</button>
    <!-- year buttons injected by JS -->
  </div>
  <div class="stats-container" id="stats-container"></div>
</div>

<!-- ── WISHLIST VIEW ── -->
<div id="view-wishlist" class="view">
  <div class="page-header">
    <div class="page-header-row">
      <div><h2>Wishlist</h2><div class="sub" id="wish-count">0 items</div></div>
      <div style="display:flex;gap:6px;">
        <button class="btn btn-sm" id="plan-trip-btn" style="width:auto;background:var(--accent-light);color:var(--dark-sage);border:1.5px solid var(--border);font-weight:700;">Plan a Trip</button>
        <button class="btn btn-sm btn-wish" id="add-wish-btn" style="width:auto;">+ Add</button>
      </div>
    </div>
  </div>
  <div class="controls" id="wish-filter-chips"></div>
  <div class="wish-list-wrap" id="wish-list"></div>
</div>

<!-- ── DISCOVER VIEW ── -->
<div id="view-discover" class="view">
  <div class="page-header">
    <div class="page-header-row">
      <div><h2>Discover</h2><div class="sub">Smart destination suggestions</div></div>
    </div>
  </div>
  <div class="discover-body">
    <div class="discover-form-card">
      <div class="form-group">
        <label class="form-label">Mood</label>
        <div class="mood-grid">
          <button class="mood-btn active" data-mood="mixed">Any Vibe</button>
          <button class="mood-btn" data-mood="food-focused">Food</button>
          <button class="mood-btn" data-mood="relaxing">Relaxing</button>
          <button class="mood-btn" data-mood="culture">Culture</button>
          <button class="mood-btn" data-mood="nature">Nature</button>
          <button class="mood-btn" data-mood="romantic">Romantic</button>
        </div>
      </div>
      <div class="discover-form-row">
        <div class="form-group">
          <label class="form-label">Trip Length</label>
          <select class="form-select" id="disc-length">
            <option value="weekend">Weekend</option>
            <option value="5-7">5&#x2013;7 Days</option>
            <option value="1-2wk" selected>1&#x2013;2 Weeks</option>
            <option value="extended">Extended</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Month</label>
          <select class="form-select" id="disc-month">
            <option value="">Any</option>
            <option value="1">January</option><option value="2">February</option><option value="3">March</option>
            <option value="4">April</option><option value="5">May</option><option value="6">June</option>
            <option value="7">July</option><option value="8">August</option><option value="9">September</option>
            <option value="10">October</option><option value="11">November</option><option value="12">December</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Region (optional)</label>
        <input class="form-input" id="disc-region" type="text" placeholder="e.g. Europe, Southeast Asia&#x2026;">
      </div>
      <div class="form-group">
        <label class="form-label">Energy Level</label>
        <div class="energy-row">
          <button class="energy-btn active" data-energy="medium">&#x25CF; Medium</button>
          <button class="energy-btn" data-energy="low">&#x25CB; Low</button>
          <button class="energy-btn" data-energy="high">&#x25CF;&#x25CF; High</button>
        </div>
      </div>
      <button class="discover-generate-btn" id="disc-generate-btn">Generate Suggestion</button>
    </div>
    <div class="discover-result" id="discover-result">
      <!-- filled by JS -->
    </div>
  </div>
</div>


</div>
<input type="file" id="import-file-input" accept=".json" style="display:none;">


<!-- ══ MODAL: PLAN A TRIP (Itinerary Builder) ══ -->
<div class="modal-overlay fullscreen-modal" id="modal-plan-trip">
  <div class="modal">
    <div class="plan-header">
      <button class="back-btn" id="plan-trip-close">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18M6 6l12 12"/></svg>
      </button>
      <h3>Plan a Trip</h3>
      <span id="plan-phase-indicator" style="font-size:11px;color:var(--text-light);font-weight:600;"></span>
    </div>
    <div class="plan-phases" id="plan-phases">
      <div class="plan-phase-dot active" data-phase="0">Parameters</div>
      <div class="plan-phase-dot" data-phase="1">Itinerary</div>
      <div class="plan-phase-dot" data-phase="2">Confirm</div>
    </div>
    <div class="plan-body" id="plan-body">

      <!-- STEP 0: Parameters -->
      <div class="plan-step active" id="plan-step-0">

        <!-- Wishlist selection -->
        <div class="plan-card">
          <div class="plan-card-title">Select Places from Wishlist</div>
          <button class="plan-select-all" id="plan-select-all">Select all</button>
          <div class="plan-wish-grid" id="plan-wish-grid"></div>
        </div>

        <!-- Trip length -->
        <div class="plan-card">
          <div class="plan-card-title">Trip Length</div>
          <div class="plan-days-input">
            <div class="plan-days-stepper">
              <button class="plan-days-btn" id="plan-days-minus">&#x2212;</button>
              <div class="plan-days-num" id="plan-days-num">5</div>
              <button class="plan-days-btn" id="plan-days-plus">+</button>
            </div>
            <span style="font-size:13px;color:var(--text-muted);">days</span>
          </div>
        </div>

        <!-- Pace -->
        <div class="plan-card">
          <div class="plan-card-title">Pace</div>
          <div class="plan-toggle-row" id="plan-pace-row">
            <button class="plan-toggle" data-val="slow">Slow</button>
            <button class="plan-toggle active" data-val="balanced">Balanced</button>
            <button class="plan-toggle" data-val="dense">Dense</button>
          </div>
        </div>

        <!-- Vibe -->
        <div class="plan-card">
          <div class="plan-card-title">Trip Vibe</div>
          <div class="plan-toggle-row" id="plan-vibe-row">
            <button class="plan-toggle active" data-val="mixed">Mixed</button>
            <button class="plan-toggle" data-val="culinary">Culinary</button>
            <button class="plan-toggle" data-val="cultural">Cultural</button>
            <button class="plan-toggle" data-val="nature">Nature</button>
            <button class="plan-toggle" data-val="urban">Urban</button>
          </div>
        </div>

        <!-- Energy -->
        <div class="plan-card">
          <div class="plan-card-title">Energy Level</div>
          <div class="plan-toggle-row" id="plan-energy-row">
            <button class="plan-toggle" data-val="relaxed">Relaxed</button>
            <button class="plan-toggle active" data-val="moderate">Moderate</button>
            <button class="plan-toggle" data-val="high">High</button>
          </div>
        </div>

        <!-- Season -->
        <div class="plan-card">
          <div class="plan-card-title">Season / Month</div>
          <div class="plan-toggle-row" id="plan-season-row">
            <button class="plan-toggle active" data-val="">Any</button>
            <button class="plan-toggle" data-val="spring">Spring</button>
            <button class="plan-toggle" data-val="summer">Summer</button>
            <button class="plan-toggle" data-val="autumn">Autumn</button>
            <button class="plan-toggle" data-val="winter">Winter</button>
          </div>
        </div>

        <!-- Optimize for -->
        <div class="plan-card">
          <div class="plan-card-title">Optimize For</div>
          <div class="plan-toggle-row" id="plan-optimize-row">
            <button class="plan-toggle active" data-val="both">Balance Both</button>
            <button class="plan-toggle" data-val="hunter">Hunter</button>
            <button class="plan-toggle" data-val="brandon">Brandon</button>
          </div>
        </div>

        <button class="plan-generate-btn" id="plan-generate-btn">Generate Itinerary</button>
        <button class="plan-surprise-btn" id="plan-surprise-btn">Build the Trip I Didn't Know I Wanted</button>
        <div style="height:16px;"></div>
      </div>

      <!-- STEP 1: Generated Itinerary -->
      <div class="plan-step" id="plan-step-1">
        <div id="plan-narrative" class="plan-narrative" style="display:none;"></div>
        <div class="plan-score-grid" id="plan-score-grid"></div>
        <div id="plan-itinerary-days"></div>
        <div style="height:80px;"></div>
      </div>

      <!-- STEP 2: Confirm + Name -->
      <div class="plan-step" id="plan-step-2">
        <div class="plan-card">
          <div class="plan-card-title">Trip Name</div>
          <input class="form-input" id="plan-trip-name" type="text" placeholder="e.g. Italy Spring 2025">
        </div>
        <div class="plan-card">
          <div class="plan-card-title">Dates (optional)</div>
          <div class="form-row" style="gap:8px;">
            <div class="form-group" style="margin:0;">
              <label class="form-label">Start</label>
              <input class="form-input" id="plan-start-date" type="date">
            </div>
            <div class="form-group" style="margin:0;">
              <label class="form-label">End</label>
              <input class="form-input" id="plan-end-date" type="date">
            </div>
          </div>
        </div>
        <div id="plan-confirm-summary" style="padding:0 0 8px;"></div>
      </div>

    </div><!-- /plan-body -->

    <!-- Footer (shown on step 1+) -->
    <div class="plan-footer" id="plan-footer" style="display:none;">
      <button class="plan-back-btn" id="plan-back-btn">Back</button>
      <button class="plan-regen-btn" id="plan-regen-btn" style="display:none;">Regenerate</button>
      <button class="plan-save-btn" id="plan-save-btn">Save Trip</button>
    </div>
  </div>
</div>


<!-- ══ MODAL: TRAVEL WRAPPED ══ -->
<div class="modal-overlay fullscreen-modal" id="modal-wrapped" style="padding:0;background:#0d1a14;">
  <div class="modal" style="max-width:430px;margin:auto;">

    <!-- Header -->
    <div class="wr-header">
      <span class="wr-title-small">Travel Wrapped</span>
      <button class="wr-close" id="wr-close">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 6 6 18M6 6l12 12"/></svg>
      </button>
    </div>

    <!-- Progress segments -->
    <div class="wr-progress-track" id="wr-progress-track"></div>

    <!-- Slide viewport -->
    <div class="wr-viewport" id="wr-viewport">
      <!-- Slides injected by JS -->
      <!-- Tap zones -->
      <div class="wr-tap-prev" id="wr-tap-prev"></div>
      <div class="wr-tap-next" id="wr-tap-next"></div>
    </div>

    <!-- Footer (last slide only) -->
    <div class="wr-footer" id="wr-footer" style="display:none;">
      <button class="wr-share-btn" id="wr-done-btn">Done</button>
    </div>

  </div>
</div>

<!-- ══ MODAL: WRAPPED MONTH PICKER ══ -->
<div class="modal-overlay" id="modal-wrapped-pick">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <span class="modal-title">Choose a Month</span>
      <button class="modal-close" id="wr-pick-close">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18M6 6l12 12"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="wr-month-picker" id="wr-month-picker-list"></div>
    </div>
  </div>
</div>


<!-- ══ MODAL: CLOUD SYNC SETTINGS ══ -->
<div class="modal-overlay" id="modal-sync-settings">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <span class="modal-title">Cloud Sync</span>
      <button class="modal-close" id="sync-settings-close"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18M6 6l12 12"/></svg></button>
    </div>
    <div class="modal-body" id="sync-settings-body">
      <!-- filled by JS depending on connected state -->
    </div>
  </div>
</div>

<!-- ══ MODAL: SYNC CONFLICT ══ -->
<div class="modal-overlay" id="modal-sync-conflict">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <span class="modal-title">Data Conflict</span>
    </div>
    <div class="modal-body">
      <p style="font-size:13px;color:var(--text-muted);margin-bottom:14px;line-height:1.6;" id="conflict-desc">
        A newer version of your data was found in the cloud.
      </p>
      <button class="sync-conflict-option" id="conflict-use-cloud">
        <div class="sync-conflict-option-icon" style="background:var(--brandon);">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--brandon-dark)" stroke-width="2"><path d="M12 2a10 10 0 1 0 10 10"/><path d="M18 2v6h-6"/></svg>
        </div>
        <div>
          <h4>Use Cloud Version</h4>
          <p>Replace this device with the newer cloud data.</p>
        </div>
      </button>
      <button class="sync-conflict-option" id="conflict-keep-local">
        <div class="sync-conflict-option-icon" style="background:var(--hunter);">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--hunter-dark)" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg>
        </div>
        <div>
          <h4>Keep This Device</h4>
          <p>Upload this device's data and overwrite the cloud.</p>
        </div>
      </button>
      <button class="sync-conflict-option" id="conflict-merge">
        <div class="sync-conflict-option-icon" style="background:var(--accent-light);">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--dark-sage)" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 2v7M12 15v7M2 12h7M15 12h7"/></svg>
        </div>
        <div>
          <h4>Merge Automatically</h4>
          <p>Combine both versions, keeping the most recent edit of each item.</p>
        </div>
      </button>
    </div>
  </div>
</div>

<!-- ══ MODAL: SYNC SETUP (OAuth instructions) ══ -->
<div class="modal-overlay" id="modal-sync-setup">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <span class="modal-title">Enable Cloud Sync</span>
      <button class="modal-close" id="sync-setup-close"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18M6 6l12 12"/></svg></button>
    </div>
    <div class="modal-body">
      <div id="sync-setup-body">
        <!-- Filled by JS -->
      </div>
    </div>
  </div>
</div>
<!-- ── IMPORT CONFIRM MODAL ── -->
<div class="modal-overlay" id="modal-import-confirm">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <span class="modal-title">Import Data</span>
      <button class="modal-close" id="import-confirm-close"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18M6 6l12 12"/></svg></button>
    </div>
    <div class="modal-body">
      <div id="import-preview" style="font-size:13px;color:var(--text-muted);background:var(--surface2);border-radius:10px;padding:14px;line-height:1.7;margin-bottom:4px;"></div>
      <div style="font-size:12px;color:var(--blush-dark);font-weight:600;margin-bottom:8px;">&#x26A0;&#xFE0F; This will replace all current data.</div>
      <button class="btn btn-primary" id="import-confirm-btn">Replace with imported data</button>
      <button class="btn btn-secondary" id="import-cancel-btn">Cancel</button>
    </div>
  </div>
</div>

<!-- ── BOTTOM NAV ── -->
<nav class="nav">
  <button class="nav-btn active" data-view="list">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2"/><rect x="9" y="3" width="6" height="4" rx="1"/><path d="M9 12h6M9 16h4"/></svg>
    List
  </button>
  <button class="nav-btn" data-view="map">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polygon points="3 7 9 4 15 7 21 4 21 17 15 20 9 17 3 20"/><line x1="9" y1="4" x2="9" y2="17"/><line x1="15" y1="7" x2="15" y2="20"/></svg>
    Map
  </button>
  <button class="nav-btn add-btn" id="add-btn">
    <div class="add-inner">
      <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M12 5v14M5 12h14"/></svg>
    </div>
  </button>
  <button class="nav-btn" data-view="stats">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg>
    Stats
  </button>
  <button class="nav-btn" id="other-nav-btn">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="5" r="1.5" fill="currentColor" stroke="none"/><circle cx="12" cy="12" r="1.5" fill="currentColor" stroke="none"/><circle cx="12" cy="19" r="1.5" fill="currentColor" stroke="none"/></svg>
    More
  </button>
</nav>

</div><!-- /ds-main -->

<!-- ── OTHER MENU ── -->
<div class="other-menu-overlay" id="other-menu-overlay">
  <div class="other-menu-backdrop" id="other-menu-backdrop"></div>
  <div class="other-menu-panel">
    <div class="other-menu-handle"></div>
    <div class="other-menu-title">More</div>
    <button class="other-menu-item" id="other-goto-calendar">
      <div class="other-menu-icon" style="background:#eaf0ed;">
        <svg viewBox="0 0 24 24" fill="none" stroke="var(--dark-sage)" stroke-width="1.8"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><rect x="7" y="14" width="3" height="3" rx="0.5" fill="var(--dark-sage)" stroke="none"/></svg>
      </div>
      <div>
        <div class="other-menu-label">Calendar</div>
        <div class="other-menu-sub">Browse visits &amp; On This Day</div>
      </div>
    </button>
    <button class="other-menu-item" id="other-goto-discover">
      <div class="other-menu-icon" style="background:var(--accent-light);">
        <svg viewBox="0 0 24 24" fill="none" stroke="var(--dark-sage)" stroke-width="1.8"><circle cx="12" cy="12" r="10"/><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"/></svg>
      </div>
      <div>
        <div class="other-menu-label">Discover</div>
        <div class="other-menu-sub">Smart destination suggestions</div>
      </div>
    </button>
    <button class="other-menu-item" id="other-goto-trips">
      <div class="other-menu-icon" style="background:var(--trip-light);">
        <svg viewBox="0 0 24 24" fill="none" stroke="var(--trip-color)" stroke-width="1.8"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07A19.5 19.5 0 0 1 4.69 12 19.79 19.79 0 0 1 1.61 3.42 2 2 0 0 1 3.6 1.24h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L7.91 8.9a16 16 0 0 0 6 6l.91-.91a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 21.5 16z"/></svg>
      </div>
      <div>
        <div class="other-menu-label">Trips</div>
        <div class="other-menu-sub">Plan and review your trips</div>
      </div>
    </button>
    <button class="other-menu-item" id="other-goto-wishlist">
      <div class="other-menu-icon" style="background:var(--wish-light);">
        <svg viewBox="0 0 24 24" fill="none" stroke="var(--wish-color)" stroke-width="1.8"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
      </div>
      <div>
        <div class="other-menu-label">Wishlist</div>
        <div class="other-menu-sub">Places you want to go</div>
      </div>
    </button>
    <button class="other-menu-item" id="other-goto-wrapped">
      <div class="other-menu-icon" style="background:linear-gradient(135deg,#1a2e24,#1a1e2e);">
        <svg viewBox="0 0 24 24" fill="none" stroke="#a8c4b0" stroke-width="1.8"><path d="M12 2l2.4 7.4H22l-6.2 4.5 2.4 7.4L12 17l-6.2 4.3 2.4-7.4L2 9.4h7.6z"/></svg>
      </div>
      <div>
        <div class="other-menu-label">Travel Wrapped</div>
        <div class="other-menu-sub">Monthly review of your travel</div>
      </div>
    </button>
    <button class="other-menu-item" id="other-goto-sync">
      <div class="other-menu-icon" style="background:#e8f0fe;">
        <svg viewBox="0 0 24 24" fill="none" stroke="#4285f4" stroke-width="1.8"><path d="M12 2a10 10 0 1 0 10 10"/><path d="M18 2v6h-6"/><path d="M22 12A10 10 0 0 1 12 22"/></svg>
      </div>
      <div style="flex:1;">
        <div class="other-menu-label">Cloud Sync</div>
        <div class="other-menu-sub" id="menu-sync-sub">Back up &amp; sync across devices</div>
      </div>
      <span class="sync-status-pill off" id="menu-sync-pill">
        <span class="sync-dot off" id="menu-sync-dot"></span>
        <span id="menu-sync-pill-txt">Off</span>
      </span>
    </button>
    <div style="height:1px;background:var(--border);margin:6px 0;"></div>
    <button class="other-menu-item" id="other-export-btn">
      <div class="other-menu-icon" style="background:#eef0ed;">
        <svg viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="1.8"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
      </div>
      <div>
        <div class="other-menu-label">Export Data</div>
        <div class="other-menu-sub">Download a backup JSON file</div>
      </div>
    </button>
    <button class="other-menu-item" id="other-import-btn">
      <div class="other-menu-icon" style="background:#eef0ed;">
        <svg viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="1.8"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10" transform="rotate(180 12 12)"/><line x1="12" y1="9" x2="12" y2="21"/></svg>
      </div>
      <div>
        <div class="other-menu-label">Import Data</div>
        <div class="other-menu-sub">Restore from a backup file</div>
      </div>
    </button>
  </div>
</div>

<!-- ══ MODAL: ADD CHOICE ══ -->
<div class="modal-overlay" id="modal-add-choice">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header"><span class="modal-title">Add to PinDrop</span><button class="modal-close" id="add-choice-close"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18M6 6l12 12"/></svg></button></div>
    <div class="modal-body">
      <button class="btn btn-primary" id="choice-place">&#x25CE; Add Place</button>
      <button class="btn btn-trip" id="choice-trip">&#x2708; Add Trip</button>
      <button class="btn btn-wish" id="choice-wish">&#x2665; Add to Wishlist</button>
    </div>
  </div>
</div>

<!-- ══ MODAL: ADD PLACE ══ -->
<div class="modal-overlay" id="modal-add-place">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <span class="modal-title" id="add-place-title">Add Place</span>
      <button class="modal-close" id="add-place-close"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18M6 6l12 12"/></svg></button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Google Maps URL</label>
        <input class="form-input" id="place-maps-url" type="text" inputmode="url" autocomplete="off" autocorrect="off" spellcheck="false" placeholder="Paste full Maps link to auto-fill&#x2026;">
        <div class="form-hint" id="maps-parse-hint">Paste a full Google Maps link — name, city, country &amp; altitude fill automatically.</div>
      </div>
      <button class="btn btn-secondary btn-sm" id="parse-maps-btn" style="display:none;">Parse Link</button>
      <div class="form-group"><label class="form-label">Name *</label><input class="form-input" id="place-name" type="text"></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">City</label><input class="form-input" id="place-city" type="text"></div>
        <div class="form-group"><label class="form-label">State / Region</label><input class="form-input" id="place-state" type="text"></div>
      </div>
      <div class="form-group"><label class="form-label">Country</label><input class="form-input" id="place-country" type="text" value="United States"></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Latitude</label><input class="form-input" id="place-lat" type="number" step="any"></div>
        <div class="form-group"><label class="form-label">Longitude</label><input class="form-input" id="place-lng" type="number" step="any"></div>
      </div>
      <div class="form-group"><label class="form-label">Altitude (ft)</label><input class="form-input" id="place-alt" type="number"></div>
      <div class="form-group">
        <label class="form-label">Category</label>
        <select class="form-select" id="place-category">
          <option value="">Select&#x2026;</option>
          <option>Restaurant</option><option>Café</option><option>Bar / Cocktail</option><option>Hotel / Lodging</option>
          <option>Hike / Nature</option><option>City / Neighborhood</option><option>Museum / Culture</option>
          <option>Beach</option><option>Market / Shop</option><option>Brewery / Winery</option>
          <option>Experience</option><option>Sporting Experience</option><option>Golf</option><option>Other</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Discovery</label>
        <div style="display:flex;flex-wrap:wrap;gap:8px 16px;margin-top:4px;">
          <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer;"><input type="checkbox" id="place-discovery-social-media" name="place-discovery" value="Social Media" style="accent-color:var(--dark-sage);width:15px;height:15px;">Social Media</label>
          <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer;"><input type="checkbox" id="place-discovery-friend" name="place-discovery" value="Friend" style="accent-color:var(--dark-sage);width:15px;height:15px;">Friend</label>
          <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer;"><input type="checkbox" id="place-discovery-eater" name="place-discovery" value="Eater" style="accent-color:var(--dark-sage);width:15px;height:15px;">Eater</label>
          <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer;"><input type="checkbox" id="place-discovery-michelin" name="place-discovery" value="Michelin" style="accent-color:var(--dark-sage);width:15px;height:15px;">Michelin</label>
          <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer;"><input type="checkbox" id="place-discovery-icon" name="place-discovery" value="Icon" style="accent-color:var(--dark-sage);width:15px;height:15px;">Icon</label>
          <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer;"><input type="checkbox" id="place-discovery-random" name="place-discovery" value="Random" style="accent-color:var(--dark-sage);width:15px;height:15px;">Random</label>
          <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer;"><input type="checkbox" id="place-discovery-local-tip" name="place-discovery" value="Local Tip" style="accent-color:var(--dark-sage);width:15px;height:15px;">Local Tip</label>
          <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer;"><input type="checkbox" id="place-discovery-other" name="place-discovery" value="Other" style="accent-color:var(--dark-sage);width:15px;height:15px;">Other</label>
        </div>
      </div>
      <div class="form-group"><label class="form-label">Sub-Tags</label><div class="tags-input-wrap" id="subtags-wrap"><input type="text" id="subtags-input" placeholder="Type tag + Enter&#x2026;"></div></div>

      <div class="form-group">
        <label class="form-label">Photos</label>
        <input type="file" id="place-photo-input" accept="image/*" multiple style="display:none">
        <div class="photo-upload-strip" id="place-photos-strip">
          <label class="photo-add-btn" for="place-photo-input">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
            Add Photo
          </label>
        </div>
      </div>
      <button class="btn btn-primary" id="save-place-btn">Save Place &amp; Add First Visit &#x2192;</button>
    </div>
  </div>
</div>

<!-- ══ MODAL: ADD/EDIT VISIT ══ -->
<div class="modal-overlay" id="modal-add-visit">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <span class="modal-title" id="add-visit-title">Add Visit</span>
      <button class="modal-close" id="add-visit-close"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18M6 6l12 12"/></svg></button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group"><label class="form-label">Start Date *</label><input class="form-input" id="visit-date" type="date"></div>
        <div class="form-group"><label class="form-label">End Date</label><input class="form-input" id="visit-end-date" type="date"></div>
      </div>
      <div class="form-group"><label class="form-label">Hunter Rating <span style="font-size:10px;color:var(--text-light);font-weight:400;">(tap right side = whole, left side = half)</span></label><div id="hunter-rating-input" class="star-input-wrap"></div></div>
      <div class="form-group"><label class="form-label">Brandon Rating <span style="font-size:10px;color:var(--text-light);font-weight:400;">(tap right side = whole, left side = half)</span></label><div id="brandon-rating-input" class="star-input-wrap"></div></div>
      <div class="form-group"><label class="form-label">Visited With</label><div class="tags-input-wrap" id="visit-vw-wrap"><input type="text" id="visit-vw-input" placeholder="Who came along?"></div></div>
      <div class="form-group"><label class="form-label">Assign to Trip</label><div id="visit-trip-select"></div></div>
      <div class="form-group">
        <label class="form-label">Photos</label>
        <input type="file" id="visit-photo-input" accept="image/*" multiple style="display:none">
        <div class="photo-upload-strip" id="visit-photos-strip">
          <label class="photo-add-btn" for="visit-photo-input">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
            Add Photo
          </label>
        </div>
      </div>
      <button class="btn btn-primary" id="save-visit-btn">Save Visit</button>
    </div>
  </div>
</div>

<!-- ══ MODAL: PLACE DETAIL ══ -->
<div class="modal-overlay fullscreen-modal" id="modal-place-detail">
  <div class="modal">
    <div class="modal-handle"></div>
    <!-- Sticky close -->
    <div style="position:sticky;top:0;z-index:20;display:flex;justify-content:flex-end;padding:10px 14px 0;background:transparent;pointer-events:none;">
      <button class="modal-close" id="detail-close" style="pointer-events:all;background:var(--surface);border:1px solid var(--border);box-shadow:0 2px 8px rgba(28,36,32,0.1);"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18M6 6l12 12"/></svg></button>
    </div>
    <!-- Hero -->
    <div class="detail-hero" style="margin-top:-42px;padding-top:52px;">
      <div class="detail-hero-name" id="detail-place-name"></div>
      <div class="detail-loc" id="detail-loc"><div class="detail-loc-dot"></div><span></span></div>
      <div class="detail-avg-row" id="detail-avg-row"></div>
      <div class="detail-badges" id="detail-badges"></div>
      <a id="detail-maps-link" class="place-map-link" href="#" target="_blank" rel="noopener" style="display:none">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
        Open in Maps
      </a>
    </div>
    <!-- Photos -->
    <div id="detail-photo-strip-wrap" style="display:none;padding:14px 20px 0;"><div class="photo-strip" id="detail-photo-strip"></div></div>
    <!-- Sections -->
    <div class="detail-sections">
      <div class="detail-section">
        <div class="detail-section-title">Visits</div>
        <div id="detail-visits-list"></div>
        <button class="btn btn-secondary btn-sm" id="detail-add-visit-btn" style="margin-top:10px;">+ Log a Visit</button>
      </div>
      <div class="detail-section">
        <div class="detail-section-title">Notes</div>
        <div class="thread" id="place-thread"></div>
        <div class="add-note-bar" style="margin-top:14px;">
          <select id="note-author-select"><option>Hunter</option><option>Brandon</option><option>Other</option></select>
          <input type="text" id="note-text-input" placeholder="Add a memory…" autocomplete="off">
          <button id="add-note-btn" title="Send">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          </button>
        </div>
      </div>
      <div class="detail-section"><div class="detail-section-title">Tags</div><div class="tags-row" id="detail-tags-row"></div></div>
      <div id="detail-personality-section"></div>
      <div class="detail-section" style="border-bottom:none;">
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn btn-secondary btn-sm" id="detail-edit-place-btn">✏ Edit</button>
          <button class="btn btn-wish btn-sm" id="detail-to-wish-btn">♥ Wishlist</button>
          <button class="btn btn-danger btn-sm" id="detail-delete-place-btn">Delete</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ══ MODAL: VISIT DETAIL ══ -->
<div class="modal-overlay fullscreen-modal" id="modal-visit-detail">
  <div class="modal">
    <!-- Back button floats over hero -->
    <div style="position:sticky;top:0;z-index:20;padding:12px 16px 0;pointer-events:none;">
      <button class="back-btn" id="visit-detail-back" style="pointer-events:all;background:rgba(255,255,255,0.9);backdrop-filter:blur(8px);border-color:var(--border);box-shadow:0 2px 8px rgba(28,36,32,0.1);">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="m15 18-6-6 6-6"/></svg>
      </button>
    </div>
    <!-- Hero: place name + date -->
    <div class="visit-hero" style="margin-top:-52px;padding-top:62px;">
      <div class="visit-hero-place" id="visit-hero-place"></div>
      <div class="visit-hero-date" id="visit-hero-date"></div>
      <!-- Rating cards -->
      <div class="visit-hero-ratings" id="visit-ratings-display"></div>
    </div>
    <!-- Body -->
    <div class="fullscreen-body" style="gap:24px;">
      <!-- Visited With + Trip + Photos as chips -->
      <div id="visit-meta-section">
        <div class="section-title">Details</div>
        <div class="visit-meta-row" id="visit-vw-display"></div>
        <div id="visit-trip-display-wrap" style="display:none;margin-top:8px;"><div id="visit-trip-display"></div></div>
      </div>
      <!-- Photos -->
      <div id="visit-photos-display-wrap" style="display:none;">
        <div class="section-title">Photos</div>
        <div class="photo-strip" id="visit-photos-display"></div>
      </div>

      <!-- Actions -->
      <div style="display:flex;gap:8px;padding-bottom:8px;">
        <button class="btn btn-secondary btn-sm" id="visit-edit-btn">✏ Edit Visit</button>
        <button class="btn btn-danger btn-sm" id="visit-delete-btn">Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- ══ MODAL: ADD/EDIT TRIP ══ -->
<div class="modal-overlay" id="modal-add-trip">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <span class="modal-title" id="add-trip-title">New Trip</span>
      <button class="modal-close" id="add-trip-close"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18M6 6l12 12"/></svg></button>
    </div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">Trip Name *</label><input class="form-input" id="trip-name" type="text"></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Start Date</label><input class="form-input" id="trip-start" type="date"></div>
        <div class="form-group"><label class="form-label">End Date</label><input class="form-input" id="trip-end" type="date"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Primary City</label><input class="form-input" id="trip-city" type="text"></div>
        <div class="form-group"><label class="form-label">Country</label><input class="form-input" id="trip-country" type="text"></div>
      </div>
      <div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="trip-notes"></textarea></div>
      <div class="form-group"><label class="form-label">Tags</label><div class="tags-input-wrap" id="trip-tags-wrap"><input type="text" id="trip-tags-input"></div></div>
      <button class="btn btn-primary" id="save-trip-btn">Save Trip</button>
    </div>
  </div>
</div>

<!-- ══ MODAL: TRIP DETAIL ══ -->
<div class="modal-overlay fullscreen-modal" id="modal-trip-detail">
  <div class="modal">
    <div class="fullscreen-header">
      <button class="back-btn" id="trip-detail-back"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m15 18-6-6 6-6"/></svg></button>
      <h3 id="trip-detail-title">Trip</h3>
      <button class="btn btn-secondary btn-sm" id="trip-edit-btn" style="margin-left:auto;">Edit</button>
    </div>
    <div class="fullscreen-body" id="trip-detail-body"></div>
  </div>
</div>

<!-- ══ MODAL: ADD/EDIT WISHLIST ══ -->
<div class="modal-overlay" id="modal-add-wish">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <span class="modal-title" id="add-wish-title">Add to Wishlist</span>
      <button class="modal-close" id="add-wish-close"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18M6 6l12 12"/></svg></button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Google Maps Link</label>
        <input class="form-input" id="wish-maps-url" type="text" inputmode="url" autocomplete="off" autocorrect="off" spellcheck="false" placeholder="Paste Maps link to auto-fill&#x2026;">
        <div class="form-hint" id="wish-maps-hint">Paste a Google Maps link — name &amp; location fill automatically.</div>
      </div>
      <div class="form-group"><label class="form-label">Name *</label><input class="form-input" id="wish-name" type="text"></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">City</label><input class="form-input" id="wish-city" type="text"></div>
        <div class="form-group"><label class="form-label">State / Region</label><input class="form-input" id="wish-state" type="text"></div>
        <div class="form-group"><label class="form-label">Country</label><input class="form-input" id="wish-country" type="text"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Latitude</label><input class="form-input" id="wish-lat" type="number" step="any"></div>
        <div class="form-group"><label class="form-label">Longitude</label><input class="form-input" id="wish-lng" type="number" step="any"></div>
      </div>
      <div class="form-group">
        <label class="form-label">Category</label>
        <select class="form-select" id="wish-category">
          <option value="">Select&#x2026;</option>
          <option>Restaurant</option><option>Café</option><option>Bar / Cocktail</option><option>Hotel / Lodging</option>
          <option>Hike / Nature</option><option>City / Neighborhood</option><option>Museum / Culture</option>
          <option>Beach</option><option>Market / Shop</option><option>Brewery / Winery</option>
          <option>Experience</option><option>Sporting Experience</option><option>Golf</option><option>Other</option>
        </select>
      </div>
      <div class="form-group"><label class="form-label">Tags</label><div class="tags-input-wrap" id="wish-tags-wrap"><input type="text" id="wish-tags-input"></div></div>
      <div class="form-group">
        <label class="form-label">Priority</label>
        <select class="form-select" id="wish-priority"><option value="high">&#x25CF; High</option><option value="medium" selected>&#x25CE; Medium</option><option value="low">&#x25CB; Low</option></select>
      </div>
      <div class="form-group">
        <label class="form-label">Source</label>
        <div style="display:flex;flex-wrap:wrap;gap:8px 16px;margin-top:4px;">
          <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer;"><input type="checkbox" id="wish-source-social-media" name="wish-source" value="Social Media" style="accent-color:var(--dark-sage);width:15px;height:15px;">Social Media</label>
          <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer;"><input type="checkbox" id="wish-source-friend" name="wish-source" value="Friend" style="accent-color:var(--dark-sage);width:15px;height:15px;">Friend</label>
          <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer;"><input type="checkbox" id="wish-source-eater" name="wish-source" value="Eater" style="accent-color:var(--dark-sage);width:15px;height:15px;">Eater</label>
          <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer;"><input type="checkbox" id="wish-source-michelin" name="wish-source" value="Michelin" style="accent-color:var(--dark-sage);width:15px;height:15px;">Michelin</label>
          <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer;"><input type="checkbox" id="wish-source-icon" name="wish-source" value="Icon" style="accent-color:var(--dark-sage);width:15px;height:15px;">Icon</label>
          <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer;"><input type="checkbox" id="wish-source-other" name="wish-source" value="Other" style="accent-color:var(--dark-sage);width:15px;height:15px;">Other</label>
        </div>
      </div>
      <div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="wish-notes"></textarea></div>
      <button class="btn btn-primary" id="save-wish-btn">Save to Wishlist</button>
    </div>
  </div>
</div>

<!-- ══ MODAL: WISH DETAIL ══ -->
<div class="modal-overlay fullscreen-modal" id="modal-wish-detail">
  <div class="modal">
    <div class="fullscreen-header">
      <button class="back-btn" id="wish-detail-back"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m15 18-6-6 6-6"/></svg></button>
      <h3 id="wish-detail-title">Wishlist Item</h3>
    </div>
    <div class="fullscreen-body" id="wish-detail-body"></div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script>
// ═══════════════════════════════════════════
//  DATA LAYER
// ═══════════════════════════════════════════
const DB = {
  get places()   {
    // Photos stored separately to avoid localStorage quota errors.
    // Re-attach photos from pd_photos_{id} when reading.
    const places = JSON.parse(localStorage.getItem('pd_places') || '[]');
    places.forEach(p => {
      if (!p.photos || !p.photos.length) {
        try { p.photos = JSON.parse(localStorage.getItem('pd_photos_' + p.id) || '[]'); } catch(e) { p.photos = []; }
      }
    });
    return places;
  },
  set places(v)  {
    // Strip photos before saving the main array; save each place's photos separately.
    const slim = v.map(p => {
      const { photos, ...rest } = p;
      try {
        if (photos && photos.length) localStorage.setItem('pd_photos_' + p.id, JSON.stringify(photos));
        else localStorage.removeItem('pd_photos_' + p.id);
      } catch(e) { console.warn('Photo storage failed for', p.id, e); }
      return rest;
    });
    localStorage.setItem('pd_places', JSON.stringify(slim));
  },
  get visits()   {
    const visits = JSON.parse(localStorage.getItem('pd_visits') || '[]');
    visits.forEach(v => {
      if (!v.photos || !v.photos.length) {
        try { v.photos = JSON.parse(localStorage.getItem('pd_vphotos_' + v.id) || '[]'); } catch(e) { v.photos = []; }
      }
    });
    // One-time migration: move notes from visits → their parent place
    if(!localStorage.getItem('pd_notes_migrated_v1')) {
      const places = JSON.parse(localStorage.getItem('pd_places') || '[]');
      let dirty = false;
      visits.forEach(v => {
        if(v.notes && v.notes.length) {
          const p = places.find(x => x.id === v.placeId);
          if(p) {
            if(!p.notes) p.notes = [];
            v.notes.forEach(n => p.notes.push({...n, migratedFrom: v.startDate||v.date}));
            v.notes = [];
            dirty = true;
          }
        }
      });
      if(dirty) {
        const slimPlaces = places.map(p => { const s={...p}; delete s.photos; return s; });
        localStorage.setItem('pd_places', JSON.stringify(slimPlaces));
        const slimVisits = visits.map(v => { const s={...v}; delete s.photos; s.notes=[]; return s; });
        localStorage.setItem('pd_visits', JSON.stringify(slimVisits));
      }
      localStorage.setItem('pd_notes_migrated_v1', '1');
    }
    return visits;
  },
  set visits(v)  {
    const slim = v.map(visit => {
      const { photos, ...rest } = visit;
      try {
        if (photos && photos.length) localStorage.setItem('pd_vphotos_' + visit.id, JSON.stringify(photos));
        else localStorage.removeItem('pd_vphotos_' + visit.id);
      } catch(e) { console.warn('Visit photo storage failed for', visit.id, e); }
      return rest;
    });
    localStorage.setItem('pd_visits', JSON.stringify(slim));
  },
  get trips()    { return JSON.parse(localStorage.getItem('pd_trips')    ||'[]'); },
  set trips(v)   { localStorage.setItem('pd_trips',    JSON.stringify(v)); },
  get wishlist() { return JSON.parse(localStorage.getItem('pd_wishlist') ||'[]'); },
  set wishlist(v){ localStorage.setItem('pd_wishlist', JSON.stringify(v)); },
};

function uid() { return Date.now().toString(36)+Math.random().toString(36).slice(2,6); }

// Read checked values from a checkbox group by name attribute
function getChecks(name) {
  return [...document.querySelectorAll(`input[name="${name}"]:checked`)].map(el=>el.value);
}
// Set checked state for a checkbox group
function setChecks(name, values=[]) {
  document.querySelectorAll(`input[name="${name}"]`).forEach(el=>{
    el.checked = values.includes(el.value);
  });
}
function _origSavePlace(p){ const a=DB.places,i=a.findIndex(x=>x.id===p.id); if(i>=0)a[i]=p;else a.push(p); DB.places=a; }
function _origDeletePlace(id){ DB.places=DB.places.filter(p=>p.id!==id); DB.visits=DB.visits.filter(v=>v.placeId!==id); }
function _origSaveVisit(v){ const a=DB.visits,i=a.findIndex(x=>x.id===v.id); if(i>=0)a[i]=v;else a.push(v); DB.visits=a; updatePlaceStats(v.placeId); }
function _origDeleteVisit(id){ const v=DB.visits.find(x=>x.id===id); DB.visits=DB.visits.filter(x=>x.id!==id); if(v) updatePlaceStats(v.placeId); }
function _origSaveTrip(t){ const a=DB.trips,i=a.findIndex(x=>x.id===t.id); if(i>=0)a[i]=t;else a.push(t); DB.trips=a; }
function _origDeleteTrip(id){ DB.trips=DB.trips.filter(t=>t.id!==id); const vis=DB.visits; vis.forEach(v=>{ if(v.tripId===id) v.tripId=null; }); DB.visits=vis; }
function _origSaveWish(w){ const a=DB.wishlist,i=a.findIndex(x=>x.id===w.id); if(i>=0)a[i]=w;else a.push(w); DB.wishlist=a; }
function _origDeleteWish(id){ DB.wishlist=DB.wishlist.filter(w=>w.id!==id); }

function updatePlaceStats(placeId){
  const places=DB.places, p=places.find(x=>x.id===placeId); if(!p) return;
  const visits=DB.visits.filter(v=>v.placeId===placeId);
  p.totalVisits=visits.length;
  const hr=visits.map(v=>v.hunterRating).filter(r=>r>0), br=visits.map(v=>v.brandonRating).filter(r=>r>0);
  p.hunterAvg=hr.length?(hr.reduce((a,b)=>a+b,0)/hr.length):0;
  p.brandonAvg=br.length?(br.reduce((a,b)=>a+b,0)/br.length):0;
  p.avgRating=(hr.length+br.length)?([...hr,...br].reduce((a,b)=>a+b,0)/(hr.length+br.length)):0;
  if(visits.length){ const s=[...visits].sort((a,b)=>a.date.localeCompare(b.date)); p.firstVisited=s[0].date; }
  DB.places=places;
}

// ═══════════════════════════════════════════
//  STATE
// ═══════════════════════════════════════════
let currentSort='name', currentFilter=null, searchQuery='', tagFilter=null;
let editingPlaceId=null, currentPlaceId=null, currentVisitId=null;
let editingTripId=null, currentTripId=null;
let editingWishId=null, currentWishId=null;
let calYear, calMonth, calSelectedDate=null, wishFilterCat=null;
let mapInitialized=false, leafletMap=null, mapMode='markers', showWishOnMap=false;
let mapLayer=null, mapWishLayer=null;
let placePhotoDataURLs=[], visitPhotoDataURLs=[];

const subTags     ={wrap:'subtags-wrap',input:'subtags-input',tags:[]};
const vwTags      ={wrap:'vw-wrap',input:'vw-input',tags:[]};
const visitVwTags ={wrap:'visit-vw-wrap',input:'visit-vw-input',tags:[]};
const tripTagsCfg ={wrap:'trip-tags-wrap',input:'trip-tags-input',tags:[]};
const wishTagsCfg ={wrap:'wish-tags-wrap',input:'wish-tags-input',tags:[]};

// ═══════════════════════════════════════════
//  NAV
// ═══════════════════════════════════════════
document.querySelectorAll('.nav-btn[data-view]').forEach(btn=>{
  btn.addEventListener('click',()=>switchView(btn.dataset.view,btn));
});

// ═══════════════════════════════════════════
//  TAGS INPUT
// ═══════════════════════════════════════════
function initTagsInput(cfg){
  cfg.tags=[];
  const wrap=document.getElementById(cfg.wrap), inp=document.getElementById(cfg.input);
  if(!wrap||!inp) return;
  inp.addEventListener('keydown',e=>{
    if((e.key==='Enter'||e.key===',')&&inp.value.trim()){e.preventDefault();addTag(cfg,inp.value.trim());inp.value='';}
    if(e.key==='Backspace'&&!inp.value&&cfg.tags.length) removeTag(cfg,cfg.tags.length-1);
  });
  wrap.addEventListener('click',()=>inp.focus());
}
function addTag(cfg,t){ if(cfg.tags.includes(t)) return; cfg.tags.push(t); renderTagPills(cfg); }
function removeTag(cfg,i){ cfg.tags.splice(i,1); renderTagPills(cfg); }
function setTags(cfg,arr){ cfg.tags=[...(arr||[])]; renderTagPills(cfg); }
function renderTagPills(cfg){
  const wrap=document.getElementById(cfg.wrap), inp=document.getElementById(cfg.input);
  if(!wrap||!inp) return;
  wrap.querySelectorAll('.tag-pill').forEach(p=>p.remove());
  cfg.tags.forEach((t,i)=>{
    const pill=document.createElement('span'); pill.className='tag-pill';
    pill.innerHTML=`${escHtml(t)}<button type="button">&times;</button>`;
    pill.querySelector('button').addEventListener('click',()=>removeTag(cfg,i));
    wrap.insertBefore(pill,inp);
  });
}
[subTags,vwTags,visitVwTags,tripTagsCfg,wishTagsCfg].forEach(cfg => {
  if (document.getElementById(cfg.wrap)) initTagsInput(cfg);
});

// ═══════════════════════════════════════════
//  STAR RATING INPUT (single tap = whole star, double tap = half star)
// ═══════════════════════════════════════════
function renderStarInput(containerId, maxStars=5){
  const container=document.getElementById(containerId); if(!container) return null;
  container.innerHTML=''; let val=0;
  const btns=[];

  // Half-star: tap left half of a star = i-0.5, right half = i
  // Works on both mouse and touch via pointer events + getBoundingClientRect
  function starFromPointer(btn, clientX) {
    const rect = btn.getBoundingClientRect();
    const i    = parseInt(btn.dataset.star);
    return clientX < rect.left + rect.width / 2 ? i - 0.5 : i;
  }

  for(let i=1;i<=maxStars;i++){
    const btn=document.createElement('button');
    btn.type='button'; btn.className='star-input-btn'; btn.textContent='\u2605';
    btn.dataset.star=i;

    // Pointer-based: works on touch and mouse uniformly
    btn.addEventListener('pointerdown', e => {
      e.preventDefault(); // stops iOS scroll interference
      val = starFromPointer(btn, e.clientX);
      refreshStars();
    });

    // Mouse hover preview (desktop only — pointer: coarse skips this naturally)
    btn.addEventListener('mousemove', e => {
      const hov = starFromPointer(btn, e.clientX);
      btns.forEach((b,j) => b.style.color = j < Math.ceil(hov) ? 'var(--star-color)' : 'var(--border)');
    });
    btn.addEventListener('mouseenter', () =>
      btns.forEach((b,j) => b.style.color = j < i ? 'var(--star-color)' : 'var(--border)')
    );
    container.appendChild(btn); btns.push(btn);
  }
  container.addEventListener('mouseleave', refreshStars);

  function refreshStars(){
    const full=Math.floor(val), half=val%1>=0.5;
    btns.forEach((b,j)=>{
      if(j<full){ b.style.color='var(--star-color)'; b.textContent='\u2605'; }
      else if(j===full&&half){ b.style.color='var(--star-color)'; b.textContent='\u00BD'; }
      else{ b.style.color='var(--border)'; b.textContent='\u2605'; }
    });
  }
  container.getValue=()=>val;
  container.setValue=v=>{ val=v; refreshStars(); };
  refreshStars(); return container;
}

function starsDisplay(rating){
  if(!rating) return '<span style="color:var(--text-light);font-size:12px;">\u2014</span>';
  const full=Math.floor(rating), half=rating%1>=0.5;
  return `<span class="stars-display">${'\u2605'.repeat(full)}${half?'\u00BD':''}</span> <span style="font-size:12px;color:var(--text-muted);">${rating.toFixed(1)}</span>`;
}
function desireStars(r){ if(!r) return '\u2014'; return `<span class="desire-stars">${'\u2665'.repeat(Math.round(r))}</span> <span style="font-size:11px;color:var(--text-muted);">${r.toFixed(1)}</span>`; }

// ═══════════════════════════════════════════
//  PHOTO UPLOAD
//  Input lives OUTSIDE the strip so strip.innerHTML='' never destroys it.
//  initPhotoUpload clones the input to strip stale listeners each open.
// ═══════════════════════════════════════════
function renderPhotoStrip(stripId, inputId, photosArr){
  const strip = document.getElementById(stripId); if(!strip) return;
  strip.innerHTML = '';
  photosArr.forEach((src, i) => {
    const wrap = document.createElement('div'); wrap.className = 'photo-thumb-wrap';
    const img  = document.createElement('img'); img.className  = 'photo-thumb'; img.src = src;
    const del  = document.createElement('button'); del.className = 'photo-thumb-del'; del.innerHTML = '&times;';
    del.addEventListener('click', () => { photosArr.splice(i, 1); renderPhotoStrip(stripId, inputId, photosArr); });
    wrap.appendChild(img); wrap.appendChild(del); strip.appendChild(wrap);
  });
  // Re-append label pointing to the input (which lives outside/above the strip)
  const label = document.createElement('label'); label.className = 'photo-add-btn'; label.htmlFor = inputId;
  label.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>Add Photo`;
  strip.appendChild(label);
}

function initPhotoUpload(inputId, stripId, photosArr){
  let input = document.getElementById(inputId); if(!input) return;
  // Clone to strip any stale event listeners from previous modal opens
  const fresh = input.cloneNode(true);
  input.parentNode.replaceChild(fresh, input);
  fresh.addEventListener('change', e => {
    const files = Array.from(e.target.files); if(!files.length) return;
    let loaded = 0;
    files.forEach(f => {
      const reader = new FileReader();
      reader.onload = ev => {
        photosArr.push(ev.target.result);
        if(++loaded === files.length) renderPhotoStrip(stripId, inputId, photosArr);
      };
      reader.readAsDataURL(f);
    });
    fresh.value = ''; // reset so same file can be picked again
  });
}

// ═══════════════════════════════════════════
//  MAPS URL PARSER — ASYNC with reverse geocode + elevation
//
//  Coordinate extraction: handles all major Google Maps URL formats
//  Name extraction: /place/NAME/@ segment (URL-decoded, cleaned)
//  City / State / Country: Nominatim reverse geocode (free, no auth)
//  Altitude: Open-Elevation API (free, no auth) → meters × 3.28084 = feet
// ═══════════════════════════════════════════

/**
 * Extract name and coordinates from a Google Maps URL (synchronous, pure regex).
 * Returns { name, lat, lng } — all may be null if unparseable.
 */
function extractFromMapsUrl(url) {
  const result = { name: '', lat: null, lng: null };
  try {
    // ── Name: /place/ENCODED_NAME/@  or  /place/ENCODED_NAME/data
    // The place segment is just the place name — do NOT split on commas for location
    const placeM = url.match(/\/place\/([^/@]+)/);
    if (placeM) {
      let raw = decodeURIComponent(placeM[1]).replace(/\+/g, ' ').trim();
      // Remove trailing junk like "+Washington,+VA+22747"
      // The real name ends at the first comma that looks like a location suffix
      // Heuristic: if it contains a comma, take only the first segment if ≥2 chars
      // But actually Google encodes the full formatted address in some URLs.
      // Strategy: take everything before the first ", " that looks like a US state or country
      const commaParts = raw.split(/, */);
      if (commaParts.length > 1) {
        // Check if 2nd part looks like a state abbrev, state name, or country
        const second = commaParts[1].trim();
        const usStatePattern = /^[A-Z]{2}$|^(Alabama|Alaska|Arizona|Arkansas|California|Colorado|Connecticut|Delaware|Florida|Georgia|Hawaii|Idaho|Illinois|Indiana|Iowa|Kansas|Kentucky|Louisiana|Maine|Maryland|Massachusetts|Michigan|Minnesota|Mississippi|Missouri|Montana|Nebraska|Nevada|New Hampshire|New Jersey|New Mexico|New York|North Carolina|North Dakota|Ohio|Oklahoma|Oregon|Pennsylvania|Rhode Island|South Carolina|South Dakota|Tennessee|Texas|Utah|Vermont|Virginia|Washington|West Virginia|Wisconsin|Wyoming|DC|District of Columbia)$/i;
        if (usStatePattern.test(second) || second.length <= 3 || commaParts.length >= 3) {
          raw = commaParts[0].trim(); // just the place name
        }
      }
      result.name = raw;
    }

    // ── Coordinates: prefer !3d!4d (most precise, embedded in data param)
    const d3dM = url.match(/!3d(-?\d+\.?\d*)!4d(-?\d+\.?\d*)/);
    if (d3dM) {
      result.lat = parseFloat(d3dM[1]);
      result.lng = parseFloat(d3dM[2]);
    }

    // ── Fallback: @lat,lng,zoom in the path
    if (!result.lat) {
      const atM = url.match(/@(-?\d+\.?\d*),(-?\d+\.?\d*),\d+\.?\d*[zm]/);
      if (atM) { result.lat = parseFloat(atM[1]); result.lng = parseFloat(atM[2]); }
    }

    // ── Fallback 2: ?q=lat,lng
    if (!result.lat) {
      const qLatM = url.match(/[?&]q=(-?\d+\.?\d*),(-?\d+\.?\d*)/);
      if (qLatM) { result.lat = parseFloat(qLatM[1]); result.lng = parseFloat(qLatM[2]); }
    }

    // ── Fallback 3: ?q=place+name (no coords at all)
    if (!result.name) {
      const qM = url.match(/[?&]q=([^&]+)/);
      if (qM) result.name = decodeURIComponent(qM[1]).replace(/\+/g, ' ').split(',')[0].trim();
    }
  } catch(e) {}
  return result;
}

/**
 * Reverse geocode lat/lng.
 * Tries BigDataCloud (best CORS), then Nominatim, then Open-Meteo (has locality).
 * Returns { city, state, country, _source } — city/state/country may be empty strings.
 */
async function reverseGeocode(lat, lng) {
  const empty = { city: '', state: '', country: '' };

  // 1. BigDataCloud — free, no key, explicit CORS headers
  try {
    const r = await fetch(
      `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lng}&localityLanguage=en`,
      { signal: AbortSignal.timeout(6000) }
    );
    if (r.ok) {
      const d = await r.json();
      const city    = d.city || d.locality || '';
      const state   = d.principalSubdivision || '';
      const country = d.countryName || '';
      if (city || country) return { city, state, country };
    }
  } catch(e) { console.warn('BigDataCloud failed:', e.message); }

  // 2. Nominatim — free OSM, no key needed
  try {
    const r = await fetch(
      `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&addressdetails=1&accept-language=en`,
      { signal: AbortSignal.timeout(6000) }
    );
    if (r.ok) {
      const d = await r.json();
      const a = d.address || {};
      const city    = a.city || a.town || a.village || a.suburb || a.municipality || a.county || '';
      const state   = a.state || a.region || '';
      const country = a.country || '';
      if (city || country) return { city, state, country };
    }
  } catch(e) { console.warn('Nominatim failed:', e.message); }

  return empty;
}

/**
 * Fetch elevation in feet. Tries Open-Meteo first (reliable), then open-elevation.com.
 * Returns feet as integer, or null.
 */
async function fetchElevation(lat, lng) {
  // 1. Open-Meteo — very reliable, fast, free
  try {
    const r = await fetch(
      `https://api.open-meteo.com/v1/elevation?latitude=${lat}&longitude=${lng}`,
      { signal: AbortSignal.timeout(6000) }
    );
    if (r.ok) {
      const d = await r.json();
      const m = Array.isArray(d.elevation) ? d.elevation[0] : d.elevation;
      if (m != null && m > -500) return Math.round(m * 3.28084);
    }
  } catch(e) { console.warn('Open-Meteo elevation failed:', e.message); }

  // 2. open-elevation.com fallback
  try {
    const r = await fetch(
      `https://api.open-elevation.com/api/v1/lookup?locations=${lat},${lng}`,
      { signal: AbortSignal.timeout(8000) }
    );
    if (r.ok) {
      const d = await r.json();
      const m = d?.results?.[0]?.elevation;
      if (m != null && m > -500) return Math.round(m * 3.28084);
    }
  } catch(e) { console.warn('open-elevation failed:', e.message); }

  return null;
}

// ── Auto-parse: fires on paste or when a Maps URL is typed/pasted ──
async function doParse(url) {
  if (!url) return;
  const hint = document.getElementById('maps-parse-hint');
  const setHint = (msg, color) => { if (hint) { hint.textContent = msg; hint.style.color = color || ''; } };

  if (!/google\.com\/maps|maps\.google\.|goo\.gl\/maps/i.test(url)) {
    setHint('Paste a full Google Maps link — name, city, country & altitude fill automatically.');
    return;
  }

  setHint('Reading link…');

  try {
    // Step 1: instant sync extraction
    const ex = extractFromMapsUrl(url);
    if (ex.name) document.getElementById('place-name').value = ex.name;

    if (!ex.lat || !ex.lng) {
      setHint('⚠ No coordinates found — use the full Maps link, not a short goo.gl link.', '#a05020');
      return;
    }

    document.getElementById('place-lat').value = ex.lat;
    document.getElementById('place-lng').value = ex.lng;
    setHint('Fetching city, state & altitude…');

    // Step 2: parallel network calls with a visible timeout message
    const timeout = new Promise(res => setTimeout(() => res(null), 10000));
    const [geo, altFt] = await Promise.all([
      Promise.race([reverseGeocode(ex.lat, ex.lng), timeout.then(() => null)]),
      Promise.race([fetchElevation(ex.lat, ex.lng), timeout.then(() => null)]),
    ]);

    const filled = [];
    if (ex.name) filled.push('name');

    if (geo) {
      if (geo.city)    { document.getElementById('place-city').value    = geo.city;    filled.push('city'); }
      if (geo.state)   { document.getElementById('place-state').value   = geo.state;   filled.push('state'); }
      if (geo.country) { document.getElementById('place-country').value = geo.country; filled.push('country'); }
    }
    if (altFt != null) { document.getElementById('place-alt').value = altFt; filled.push(`${altFt.toLocaleString()} ft`); }

    const missing = [];
    if (!geo || (!geo.city && !geo.country)) missing.push('city/state (network blocked?)');
    if (altFt == null) missing.push('altitude');

    if (filled.length > 1) {
      const msg = `✓ Filled: ${filled.join(', ')}.` + (missing.length ? ` Check ${missing.join(' & ')} manually.` : ' Check category.');
      setHint(msg, missing.length ? '#6e5020' : '');
    } else {
      setHint('⚠ Coords found but city/state lookup failed — check your connection or fill manually.', '#a05020');
    }
  } catch(e) {
    console.error('doParse error:', e);
    setHint('Could not parse — try copying the link fresh from Google Maps.', '#a05020');
  }
}

// ── Auto-parse on paste / input / change ──
let _parseDebounce = null;

function scheduleParse(url, delay) {
  clearTimeout(_parseDebounce);
  _parseDebounce = setTimeout(() => doParse(url.trim()), delay);
}

const mapsInput = document.getElementById('place-maps-url');

// paste: clipboardData has the text before the value updates
mapsInput.addEventListener('paste', e => {
  const text = e.clipboardData?.getData('text/plain') || '';
  if (text) {
    scheduleParse(text, 0);   // immediate — we already have the string
  } else {
    scheduleParse(mapsInput.value, 120); // fallback: wait for value to land
  }
});

// input: catches drag-drop, autofill, keyboard
mapsInput.addEventListener('input', e => scheduleParse(e.target.value, 300));

// change: safety net for mobile browsers that batch events
mapsInput.addEventListener('change', e => scheduleParse(e.target.value, 0));

// hidden button fallback
document.getElementById('parse-maps-btn').addEventListener('click', () =>
  doParse(mapsInput.value.trim()));

// ═══════════════════════════════════════════
//  ADD PLACE
// ═══════════════════════════════════════════
document.getElementById('add-place-close').addEventListener('click',()=>closeModal('modal-add-place'));

function openAddPlace(placeId=null){
  editingPlaceId=placeId; placePhotoDataURLs=[];
  document.getElementById('add-place-title').textContent=placeId?'Edit Place':'Add Place';
  if(placeId){
    const p=DB.places.find(x=>x.id===placeId);
    document.getElementById('place-maps-url').value=p.mapsUrl||'';
    document.getElementById('place-name').value=p.name||'';
    document.getElementById('place-city').value=p.city||'';
    document.getElementById('place-state').value=p.state||'';
    document.getElementById('place-country').value=p.country||'';
    document.getElementById('place-lat').value=p.lat||'';
    document.getElementById('place-lng').value=p.lng||'';
    document.getElementById('place-alt').value=p.altitude||'';
    document.getElementById('place-category').value=p.category||'';setChecks('place-discovery',p.discovery||[]);
    setTags(subTags,p.subTags||[]); setTags(vwTags,p.defaultVisitedWith||[]);
    if(p.photos) placePhotoDataURLs=[...p.photos];
  } else {
    ['place-maps-url','place-name','place-city','place-state','place-lat','place-lng','place-alt'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('place-country').value='United States';
    document.getElementById('place-category').value='';setChecks('place-discovery',[]);
    setTags(subTags,[]); setTags(vwTags,[]);
  }
  renderPhotoStrip('place-photos-strip','place-photo-input',placePhotoDataURLs);
  initPhotoUpload('place-photo-input','place-photos-strip',placePhotoDataURLs);
  openModal('modal-add-place');
}

document.getElementById('save-place-btn').addEventListener('click',()=>{
  const name=document.getElementById('place-name').value.trim(); if(!name){toast('Name is required');return;}
  const p=editingPlaceId?{...DB.places.find(x=>x.id===editingPlaceId)}:{id:uid(),totalVisits:0,hunterAvg:0,brandonAvg:0,avgRating:0,firstVisited:null};
  p.name=name; p.city=document.getElementById('place-city').value.trim();
  p.state=document.getElementById('place-state').value.trim();
  p.country=document.getElementById('place-country').value.trim();
  p.lat=parseFloat(document.getElementById('place-lat').value)||null;
  p.lng=parseFloat(document.getElementById('place-lng').value)||null;
  p.altitude=parseFloat(document.getElementById('place-alt').value)||null;
  p.mapsUrl=document.getElementById('place-maps-url').value.trim();
  p.category=document.getElementById('place-category').value;
  p.discovery=getChecks('place-discovery');
  p.subTags=[...subTags.tags]; p.defaultVisitedWith=[...vwTags.tags];
  p.photos=[...placePhotoDataURLs];
  savePlace(p); closeModal('modal-add-place'); renderList();
  if(!editingPlaceId){ setTimeout(()=>openAddVisit(p.id),320); }
  else { toast('Place updated'); if(currentPlaceId===p.id) openPlaceDetail(p.id); }
});

// ═══════════════════════════════════════════
//  ADD VISIT
// ═══════════════════════════════════════════
let hunterCtrl,brandonCtrl,editingVisitId=null;
document.getElementById('add-visit-close').addEventListener('click',()=>closeModal('modal-add-visit'));

function openAddVisit(placeId,visitId=null){
  currentPlaceId=placeId; editingVisitId=visitId; visitPhotoDataURLs=[];
  const p=DB.places.find(x=>x.id===placeId);
  document.getElementById('add-visit-title').textContent=visitId?'Edit Visit':`Visit \u2013 ${p?.name||'Place'}`;
  document.getElementById('visit-date').value=new Date().toISOString().slice(0,10);
  document.getElementById('visit-end-date').value='';
  hunterCtrl=renderStarInput('hunter-rating-input',5);
  brandonCtrl=renderStarInput('brandon-rating-input',5);
  if(visitId){
    const v=DB.visits.find(x=>x.id===visitId);
    document.getElementById('visit-date').value=v.startDate||v.date||'';
    document.getElementById('visit-end-date').value=v.endDate||'';
    hunterCtrl.setValue(v.hunterRating||0); brandonCtrl.setValue(v.brandonRating||0);
    setTags(visitVwTags,v.visitedWith||[]);
    if(v.photos) visitPhotoDataURLs=[...v.photos];
  } else {
    setTags(visitVwTags,p?.defaultVisitedWith||[]);
  }
  renderTripSelect(visitId?DB.visits.find(x=>x.id===visitId)?.tripId:null);
  renderPhotoStrip('visit-photos-strip','visit-photo-input',visitPhotoDataURLs);
  initPhotoUpload('visit-photo-input','visit-photos-strip',visitPhotoDataURLs);
  openModal('modal-add-visit');
}

function renderTripSelect(selTripId){
  const trips=DB.trips, wrap=document.getElementById('visit-trip-select'); wrap.innerHTML='';
  if(!trips.length){wrap.innerHTML='<p style="font-size:12px;color:var(--text-light);">No trips yet.</p>';return;}
  const none=document.createElement('div'); none.className='trip-select-item'+(selTripId?'':' selected');
  none.innerHTML='<span class="trip-select-item-name">No trip</span>';
  none.addEventListener('click',()=>{wrap.querySelectorAll('.trip-select-item').forEach(x=>x.classList.remove('selected'));none.classList.add('selected');});
  wrap.appendChild(none);
  trips.forEach(t=>{
    const el=document.createElement('div'); el.className='trip-select-item'+(t.id===selTripId?' selected':'');
    el.innerHTML=`<div class="trip-indicator"></div><span class="trip-select-item-name">${escHtml(t.name)}</span><span class="trip-select-item-dates">${t.startDate?formatDate(t.startDate):''}</span>`;
    el.addEventListener('click',()=>{wrap.querySelectorAll('.trip-select-item').forEach(x=>x.classList.remove('selected'));el.classList.add('selected');});
    wrap.appendChild(el);
  });
}
function getSelTripId(){
  const s=document.querySelector('#visit-trip-select .trip-select-item.selected'); if(!s) return null;
  const n=s.querySelector('.trip-select-item-name'); if(!n||n.textContent==='No trip') return null;
  return DB.trips.find(t=>t.name===n.textContent)?.id||null;
}
document.getElementById('save-visit-btn').addEventListener('click',()=>{
  const date=document.getElementById('visit-date').value; if(!date){toast('Start date required');return;}
  const endDate=document.getElementById('visit-end-date').value||null;
  if(endDate&&endDate<date){toast('End date must be after start date');return;}
  const v=editingVisitId?{...DB.visits.find(x=>x.id===editingVisitId)}:{id:uid(),placeId:currentPlaceId,notes:[],tripId:null};
  v.startDate=date; v.endDate=endDate||null; v.date=date;
  v.hunterRating=hunterCtrl.getValue(); v.brandonRating=brandonCtrl.getValue();
  v.visitedWith=[...visitVwTags.tags]; v.tripId=getSelTripId(); v.photos=[...visitPhotoDataURLs];
  saveVisit(v); closeModal('modal-add-visit'); toast(editingVisitId?'Visit updated':'Visit added!'); renderList();
  setTimeout(()=>{if(currentPlaceId) openPlaceDetail(currentPlaceId);},350);
});

// ═══════════════════════════════════════════
//  PLACE DETAIL
// ═══════════════════════════════════════════
document.getElementById('detail-close').addEventListener('click',()=>closeModal('modal-place-detail'));
document.getElementById('detail-add-visit-btn').addEventListener('click',()=>{ closeModal('modal-place-detail'); setTimeout(()=>openAddVisit(currentPlaceId),320); });
document.getElementById('detail-edit-place-btn').addEventListener('click',()=>{ closeModal('modal-place-detail'); setTimeout(()=>openAddPlace(currentPlaceId),320); });
document.getElementById('detail-delete-place-btn').addEventListener('click',()=>{ if(!confirm('Delete this place and all its visits?')) return; deletePlace(currentPlaceId); closeModal('modal-place-detail'); renderList(); toast('Place deleted'); });
document.getElementById('detail-to-wish-btn').addEventListener('click',()=>{
  const p=DB.places.find(x=>x.id===currentPlaceId); if(!p) return;
  closeModal('modal-place-detail');
  setTimeout(()=>openAddWish(null,{name:p.name,city:p.city,country:p.country,lat:p.lat,lng:p.lng,category:p.category,subTags:p.subTags}),320);
});

function openPlaceDetail(placeId){
  currentPlaceId=placeId;
  const p=DB.places.find(x=>x.id===placeId); if(!p) return;
  const visits=DB.visits.filter(v=>v.placeId===placeId).sort((a,b)=>{
    const ad=a.startDate||a.date||''; const bd=b.startDate||b.date||'';
    return bd.localeCompare(ad); // newest first
  });

  // Hero
  document.getElementById('detail-place-name').textContent=p.name;
  const locSpan=document.getElementById('detail-loc').querySelector('span');
  // Build clickable city · state · country chips
  const locEl = document.getElementById('detail-loc');
  const locSpan2 = locEl.querySelector('span');
  if (locSpan2) {
    const parts = [
      p.city    ? {type:'city',    val:p.city}    : null,
      p.state   ? {type:'state',   val:p.state}   : null,
      p.country ? {type:'country', val:p.country} : null,
    ].filter(Boolean);
    locSpan2.innerHTML = parts.map(({type,val}) =>
      `<span class="loc-chip" data-loc-type="${type}" data-loc-val="${escHtml(val)}">${escHtml(val)}</span>`
    ).join(' · ');
    locSpan2.querySelectorAll('.loc-chip').forEach(chip =>
      chip.addEventListener('click', e => { e.stopPropagation(); openLocationStats(chip.dataset.locType, chip.dataset.locVal); })
    );
  }

  // Avg rating pills
  const avgRow=document.getElementById('detail-avg-row'); avgRow.innerHTML='';
  if(p.hunterAvg) avgRow.innerHTML+=`<div class="detail-avg-pill"><div class="detail-avg-avatar h">H</div><div><div class="detail-avg-score">${p.hunterAvg.toFixed(1)}</div><div class="detail-avg-label">avg</div></div></div>`;
  if(p.brandonAvg) avgRow.innerHTML+=`<div class="detail-avg-pill"><div class="detail-avg-avatar b">B</div><div><div class="detail-avg-score">${p.brandonAvg.toFixed(1)}</div><div class="detail-avg-label">avg</div></div></div>`;
  if(visits.length) avgRow.innerHTML+=`<div class="detail-avg-pill" style="gap:6px;"><div style="font-size:18px;line-height:1;">●</div><div><div class="detail-avg-score">${visits.length}</div><div class="detail-avg-label">${visits.length===1?'visit':'visits'}</div></div></div>`;

  // Category + altitude badges
  const badges=document.getElementById('detail-badges'); badges.innerHTML='';
  if(p.category) badges.innerHTML+=`<span class="place-cat" data-cat="${escHtml(p.category)}">${escHtml(p.category)}</span>`;
  if(p.discovery?.length) badges.innerHTML+=p.discovery.map(d=>`<span class="tag" style="background:var(--surface2);">${escHtml(d)}</span>`).join('');
  if(p.altitude) badges.innerHTML+=`<span class="tag">▲ ${p.altitude.toLocaleString()} ft</span>`;
  badges.querySelectorAll('[data-cat]').forEach(el=>el.addEventListener('click',()=>{closeModal('modal-place-detail');filterByTag(el.dataset.cat,'category');}));

  // Maps link
  const mLink=document.getElementById('detail-maps-link');
  if(p.mapsUrl){mLink.href=p.mapsUrl;mLink.style.display='inline-flex';}
  else if(p.lat&&p.lng){mLink.href=`https://maps.google.com/?q=${p.lat},${p.lng}`;mLink.style.display='inline-flex';}
  else mLink.style.display='none';

  // Place photos
  const photoWrap=document.getElementById('detail-photo-strip-wrap'), photoStrip=document.getElementById('detail-photo-strip');
  if(p.photos?.length){ photoWrap.style.display=''; photoStrip.innerHTML=p.photos.map(src=>`<img class="photo-thumb" src="${src}">`).join(''); } else photoWrap.style.display='none';

  // Visit cards
  const vList=document.getElementById('detail-visits-list'); vList.innerHTML='';
  if(!visits.length){
    vList.innerHTML=`<div style="text-align:center;padding:20px 0 8px;color:var(--text-light);font-size:13px;">No visits yet — add your first!</div>`;
  } else visits.forEach(v=>{
    const trip=v.tripId?DB.trips.find(t=>t.id===v.tripId):null;
    const hRating=v.hunterRating||0, bRating=v.brandonRating||0;
    const card=document.createElement('div'); card.className='visit-item';
    card.innerHTML=`
      <div class="visit-item-date">${formatVisitDate(v)}</div>
      <div class="visit-item-ratings">
        ${hRating?`<div class="visit-item-rating-pill h"><div class="visit-item-rating-pip">H</div>Hunter ${hRating.toFixed(1)} ★</div>`:''}
        ${bRating?`<div class="visit-item-rating-pill b"><div class="visit-item-rating-pip">B</div>Brandon ${bRating.toFixed(1)} ★</div>`:''}
      </div>
      <div class="visit-item-meta">
        ${v.visitedWith?.length?`<span>• ${v.visitedWith.join(', ')}</span>`:''}
        ${trip?`<span class="trip-badge" style="font-size:10px;padding:2px 7px;">✈ ${escHtml(trip.name)}</span>`:''}

        ${v.photos?.length?`<span>▣ ${v.photos.length}</span>`:''}
      </div>`;
    card.addEventListener('click',()=>{closeModal('modal-place-detail');setTimeout(()=>openVisitDetail(v.id),320);});
    vList.appendChild(card);
  });

  // Tags
  const tagsRow=document.getElementById('detail-tags-row'); tagsRow.innerHTML='';
  [...(p.subTags||[]),...(p.defaultVisitedWith||[])].forEach(t=>{
    const el=document.createElement('span'); el.className='tag'; el.textContent=t;
    el.addEventListener('click',()=>{closeModal('modal-place-detail');filterByTag(t,'tag');});
    tagsRow.appendChild(el);
  });
  if(!tagsRow.children.length) tagsRow.innerHTML='<span style="font-size:12px;color:var(--text-light);">No tags yet</span>';
  renderThread();
  // Place Personality
  const _ppSec = document.getElementById('detail-personality-section');
  _ppSec.innerHTML = '';
  renderPlacePersonalitySection(placeId, _ppSec);
  openModal('modal-place-detail');
}

// ═══════════════════════════════════════════
//  VISIT DETAIL
// ═══════════════════════════════════════════
document.getElementById('visit-detail-back').addEventListener('click',()=>{closeModal('modal-visit-detail');setTimeout(()=>openPlaceDetail(currentPlaceId),320);});
document.getElementById('visit-edit-btn').addEventListener('click',()=>{closeModal('modal-visit-detail');setTimeout(()=>openAddVisit(currentPlaceId,currentVisitId),320);});
document.getElementById('visit-delete-btn').addEventListener('click',()=>{
  if(!confirm('Delete this visit?')) return;
  deleteVisit(currentVisitId); closeModal('modal-visit-detail'); renderList(); toast('Visit deleted');
  setTimeout(()=>openPlaceDetail(currentPlaceId),320);
});
document.getElementById('add-note-btn').addEventListener('click',()=>{
  const text=document.getElementById('note-text-input').value.trim(); if(!text) return;
  const author=document.getElementById('note-author-select').value;
  const places=DB.places, p=places.find(x=>x.id===currentPlaceId); if(!p) return;
  if(!p.notes) p.notes=[];
  p.notes.push({id:uid(),author,text,ts:new Date().toISOString()});
  DB.places=places; document.getElementById('note-text-input').value=''; renderThread();
});
document.getElementById('note-text-input').addEventListener('keydown',e=>{if(e.key==='Enter')document.getElementById('add-note-btn').click();});

function openVisitDetail(visitId){
  currentVisitId=visitId;
  const v=DB.visits.find(x=>x.id===visitId); if(!v) return;
  const p=DB.places.find(x=>x.id===v.placeId); currentPlaceId=v.placeId;

  // Hero
  const vheroPlace = document.getElementById('visit-hero-place');
  vheroPlace.textContent = p?.name || '';
  vheroPlace.style.cursor = p ? 'pointer' : '';
  vheroPlace.onclick = p ? () => { closeModal('modal-visit-detail'); setTimeout(() => openPlaceDetail(p.id), 280); } : null;

  // Location chips below date (reuse detail-loc if exists, else append)
  let vLocRow = document.getElementById('visit-loc-row');
  if (!vLocRow) {
    vLocRow = document.createElement('div');
    vLocRow.id = 'visit-loc-row';
    vLocRow.style.cssText = 'font-size:12px;color:var(--text-muted);margin-top:4px;display:flex;flex-wrap:wrap;gap:2px;align-items:center;';
    document.getElementById('visit-hero-date').insertAdjacentElement('afterend', vLocRow);
  }
  if (p) {
    const locParts = [
      p.city    ? {type:'city',    val:p.city}    : null,
      p.state   ? {type:'state',   val:p.state}   : null,
      p.country ? {type:'country', val:p.country} : null,
    ].filter(Boolean);
    vLocRow.innerHTML = locParts.map(({type,val}) =>
      `<span class="loc-chip" data-loc-type="${type}" data-loc-val="${escHtml(val)}">${escHtml(val)}</span>`
    ).join(' · ');
    vLocRow.querySelectorAll('.loc-chip').forEach(chip =>
      chip.addEventListener('click', e => { e.stopPropagation(); closeModal('modal-visit-detail'); setTimeout(() => openLocationStats(chip.dataset.locType, chip.dataset.locVal), 280); })
    );
  } else { vLocRow.innerHTML = ''; }
  document.getElementById('visit-hero-date').textContent=formatVisitDate(v);

  // Rating cards
  const ratingEl=document.getElementById('visit-ratings-display');
  const starsHtml=(r)=>{
    if(!r) return '<span style="color:var(--text-light);font-size:13px;">Not rated</span>';
    const full=Math.floor(r), half=(r%1)>=0.5?1:0, empty=5-full-half;
    return '★'.repeat(full)+(half?'½':'')+'☆'.repeat(empty);
  };
  ratingEl.innerHTML=`
    <div class="visit-rating-card h">
      <div class="visit-rating-name">Hunter</div>
      <div class="visit-rating-stars">${starsHtml(v.hunterRating)}</div>
      ${v.hunterRating?`<div class="visit-rating-num">${v.hunterRating.toFixed(1)} / 5</div>`:''}
    </div>
    <div class="visit-rating-card b">
      <div class="visit-rating-name">Brandon</div>
      <div class="visit-rating-stars">${starsHtml(v.brandonRating)}</div>
      ${v.brandonRating?`<div class="visit-rating-num">${v.brandonRating.toFixed(1)} / 5</div>`:''}
    </div>`;

  // Meta chips: visited with
  const vwEl=document.getElementById('visit-vw-display'); vwEl.innerHTML='';
  if(v.visitedWith?.length){
    v.visitedWith.forEach(name=>{
      const chip=document.createElement('div'); chip.className='visit-meta-chip';
      chip.innerHTML=`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>${escHtml(name)}`;
      vwEl.appendChild(chip);
    });
  } else {
    vwEl.innerHTML='<div class="visit-meta-chip" style="opacity:0.5;">Solo adventure</div>';
  }

  // Trip chip
  const tripW=document.getElementById('visit-trip-display-wrap');
  const tripD=document.getElementById('visit-trip-display');
  if(v.tripId){
    const trip=DB.trips.find(t=>t.id===v.tripId);
    if(trip){
      tripD.innerHTML=`<span class="trip-badge" style="padding:6px 12px;font-size:12px;cursor:pointer;display:inline-flex;align-items:center;gap:5px;">✈ ${escHtml(trip.name)}</span>`;
      tripD.querySelector('.trip-badge').addEventListener('click',()=>{closeModal('modal-visit-detail');setTimeout(()=>openTripDetail(trip.id),320);});
      tripW.style.display='';
    } else tripW.style.display='none';
  } else tripW.style.display='none';

  // Photos
  const vPhotoWrap=document.getElementById('visit-photos-display-wrap');
  const vPhotoStrip=document.getElementById('visit-photos-display');
  if(v.photos?.length){vPhotoWrap.style.display='';vPhotoStrip.innerHTML=v.photos.map(src=>`<img class="photo-thumb" src="${src}">`).join('');}
  else vPhotoWrap.style.display='none';

  openModal('modal-visit-detail');
}

function renderThread(){
  const p=DB.places.find(x=>x.id===currentPlaceId); if(!p) return;
  const thread=document.getElementById('place-thread'); if(!thread) return;
  thread.innerHTML='';
  if(!p.notes||!p.notes.length){
    thread.innerHTML=`<div class="thread-empty"><div class="thread-empty-icon">◌</div><div class="thread-empty-text">No memories yet — add your first note!</div></div>`;
    return;
  }
  p.notes.forEach((note,idx)=>{
    const cls=note.author==='Hunter'?'hunter':note.author==='Brandon'?'brandon':'other';
    const msg=document.createElement('div'); msg.className=`thread-msg ${cls}`;
    msg.innerHTML=`<div class="bubble">${escHtml(note.text)}</div>
      <div class="bubble-meta">
        <span class="bubble-author">${escHtml(note.author)}</span>
        <span>${formatTime(note.ts)}</span>
        <div class="bubble-actions">
          <button class="bubble-action-btn" data-edit="${idx}" title="Edit">✏</button>
          <button class="bubble-action-btn" data-del="${idx}" title="Delete">×</button>
        </div>
      </div>`;
    thread.appendChild(msg);
  });
  thread.querySelectorAll('[data-edit]').forEach(b=>b.addEventListener('click',()=>editNote(parseInt(b.dataset.edit))));
  thread.querySelectorAll('[data-del]').forEach(b=>b.addEventListener('click',()=>deleteNote(parseInt(b.dataset.del))));
}
function editNote(i){const places=DB.places,p=places.find(x=>x.id===currentPlaceId);const note=p.notes[i];const t=prompt('Edit note:',note.text);if(t===null)return;note.text=t.trim();note.ts=new Date().toISOString();DB.places=places;renderThread();}
function deleteNote(i){if(!confirm('Delete note?'))return;const places=DB.places,p=places.find(x=>x.id===currentPlaceId);p.notes.splice(i,1);DB.places=places;renderThread();}

// ═══════════════════════════════════════════
//  ADD BUTTON
// ═══════════════════════════════════════════
document.getElementById('add-btn').addEventListener('click',()=>openModal('modal-add-choice'));
document.getElementById('add-choice-close').addEventListener('click',()=>closeModal('modal-add-choice'));
document.getElementById('choice-place').addEventListener('click',()=>{closeModal('modal-add-choice');setTimeout(()=>openAddPlace(),200);});
document.getElementById('choice-trip').addEventListener('click',()=>{closeModal('modal-add-choice');setTimeout(()=>openAddTrip(),200);});
document.getElementById('choice-wish').addEventListener('click',()=>{closeModal('modal-add-choice');setTimeout(()=>openAddWish(),200);});

// ═══════════════════════════════════════════
//  LIST
// ═══════════════════════════════════════════
document.getElementById('search-input').addEventListener('input',e=>{searchQuery=e.target.value.toLowerCase();renderList();});
document.getElementById('sort-chips').addEventListener('click',e=>{
  const chip=e.target.closest('.chip');if(!chip)return;
  document.querySelectorAll('#sort-chips .chip').forEach(c=>c.classList.remove('active'));
  chip.classList.add('active');currentSort=chip.dataset.sort;renderList();
});

function filterByTag(value,type){
  switchView('list');
  if(type==='category') currentFilter=value;
  else if(type==='tag') tagFilter=value;
  renderList();
}

function renderFilterChips(){
  const categories=[...new Set(DB.places.map(p=>p.category).filter(Boolean))];
  const trips=DB.trips;
  const wrap=document.getElementById('filter-chips');wrap.innerHTML='';
  const all=document.createElement('button');all.className='chip'+((!currentFilter&&!tagFilter)?' active':'');all.textContent='All';
  all.addEventListener('click',()=>{currentFilter=null;tagFilter=null;renderFilterChips();renderList();});
  wrap.appendChild(all);
  categories.forEach(cat=>{
    const c=document.createElement('button');c.className='chip'+(currentFilter===cat?' active':'');c.textContent=cat;
    c.addEventListener('click',()=>{currentFilter=cat;tagFilter=null;renderFilterChips();renderList();});wrap.appendChild(c);
  });
  trips.forEach(t=>{
    const c=document.createElement('button');c.className='chip trip-chip'+(currentFilter===('trip:'+t.id)?' active':'');c.textContent=t.name;
    c.addEventListener('click',()=>{currentFilter='trip:'+t.id;tagFilter=null;renderFilterChips();renderList();});wrap.appendChild(c);
  });
  if(tagFilter){
    const c=document.createElement('button');c.className='chip active';c.textContent='\u2715 '+tagFilter;
    c.addEventListener('click',()=>{tagFilter=null;renderFilterChips();renderList();});wrap.appendChild(c);
  }
}

function renderList(){
  renderFilterChips();
  let places=DB.places;
  if(currentFilter?.startsWith('trip:')){
    const tid=currentFilter.slice(5);const ids=new Set(DB.visits.filter(v=>v.tripId===tid).map(v=>v.placeId));
    places=places.filter(p=>ids.has(p.id));
  } else if(currentFilter){
    places=places.filter(p=>p.category===currentFilter);
  }
  if(tagFilter) places=places.filter(p=>p.subTags?.includes(tagFilter)||p.defaultVisitedWith?.includes(tagFilter));
  if(searchQuery) places=places.filter(p=>p.name?.toLowerCase().includes(searchQuery)||p.city?.toLowerCase().includes(searchQuery)||p.country?.toLowerCase().includes(searchQuery)||p.category?.toLowerCase().includes(searchQuery));
  switch(currentSort){
    case 'name':   places.sort((a,b)=>a.name.localeCompare(b.name)); break;
    case 'rating': places.sort((a,b)=>(b.avgRating||0)-(a.avgRating||0)); break;
    case 'visits': places.sort((a,b)=>(b.totalVisits||0)-(a.totalVisits||0)); break;
    case 'recent': places.sort((a,b)=>(b.firstVisited||'').localeCompare(a.firstVisited||'')); break;
  }
  document.getElementById('list-count').textContent=`${places.length} place${places.length!==1?'s':''}`;
  const list=document.getElementById('place-list');list.innerHTML='';
  if(!places.length){list.innerHTML=`<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg><h3>No places yet</h3><p>Tap + to add your first PinDrop.</p></div>`;return;}
  places.forEach(p=>{
    const tripIds=[...new Set(DB.visits.filter(v=>v.placeId===p.id&&v.tripId).map(v=>v.tripId))];
    const tripBadges=tripIds.map(tid=>{const t=DB.trips.find(x=>x.id===tid);return t?`<span class="trip-badge">${escHtml(t.name)}</span>`:''}).join('');
    const card=document.createElement('div');card.className='place-card';
    const firstPhoto=p.photos?.[0];
    card.innerHTML=`<div class="place-card-inner">
      ${firstPhoto?`<img src="${firstPhoto}" style="width:100%;height:120px;object-fit:cover;border-radius:10px;margin-bottom:10px;display:block;">`:''}
      <div class="place-card-top">
        <div><div class="place-name">${escHtml(p.name)}</div><div class="place-loc">${[p.city,p.state,p.country].filter(Boolean).join(', ')}</div></div>
        ${p.category?`<span class="place-cat" data-cat="${escHtml(p.category)}">${escHtml(p.category)}</span>`:''}
      </div>
      <div class="place-meta">
        <div class="rating-pair">
          ${p.hunterAvg?`<span class="rating-badge hunter">Hunter ${p.hunterAvg.toFixed(1)}</span>`:''}
          ${p.brandonAvg?`<span class="rating-badge brandon">Brandon ${p.brandonAvg.toFixed(1)}</span>`:''}
        </div>
        ${tripBadges}
        <span class="visits-count">${p.totalVisits||0} visit${p.totalVisits!==1?'s':''}</span>
      </div>
      ${(p.subTags?.length)?`<div class="tags-row">${p.subTags.map(t=>`<span class="tag" data-tag="${escHtml(t)}">${escHtml(t)}</span>`).join('')}</div>`:''}
    </div>`;
    card.addEventListener('click',()=>openPlaceDetail(p.id));
    card.querySelectorAll('[data-cat]').forEach(el=>el.addEventListener('click',e=>{e.stopPropagation();filterByTag(el.dataset.cat,'category');}));
    card.querySelectorAll('[data-tag]').forEach(el=>el.addEventListener('click',e=>{e.stopPropagation();filterByTag(el.dataset.tag,'tag');}));
    list.appendChild(card);
  });
}

// ═══════════════════════════════════════════
//  TRIPS
// ═══════════════════════════════════════════
document.getElementById('add-trip-close').addEventListener('click',()=>closeModal('modal-add-trip'));
function openAddTrip(tripId=null){
  editingTripId=tripId;
  document.getElementById('add-trip-title').textContent=tripId?'Edit Trip':'New Trip';
  if(tripId){
    const t=DB.trips.find(x=>x.id===tripId);
    document.getElementById('trip-name').value=t.name||'';
    document.getElementById('trip-start').value=t.startDate||'';
    document.getElementById('trip-end').value=t.endDate||'';
    document.getElementById('trip-city').value=t.primaryCity||'';
    document.getElementById('trip-country').value=t.primaryCountry||'';
    document.getElementById('trip-notes').value=t.notes||'';
    setTags(tripTagsCfg,t.tags||[]);
  } else {
    ['trip-name','trip-start','trip-end','trip-city','trip-country','trip-notes'].forEach(id=>document.getElementById(id).value='');
    setTags(tripTagsCfg,[]);
  }
  openModal('modal-add-trip');
}
document.getElementById('save-trip-btn').addEventListener('click',()=>{
  const name=document.getElementById('trip-name').value.trim();if(!name){toast('Name required');return;}
  const t=editingTripId?{...DB.trips.find(x=>x.id===editingTripId)}:{id:uid()};
  t.name=name;t.startDate=document.getElementById('trip-start').value;
  t.endDate=document.getElementById('trip-end').value;
  t.primaryCity=document.getElementById('trip-city').value.trim();
  t.primaryCountry=document.getElementById('trip-country').value.trim();
  t.notes=document.getElementById('trip-notes').value.trim();
  t.tags=[...tripTagsCfg.tags];
  saveTrip(t);closeModal('modal-add-trip');toast(editingTripId?'Trip updated':'Trip saved!');renderFilterChips();
  if(currentTripId===t.id) openTripDetail(t.id);
});
document.getElementById('trip-detail-back').addEventListener('click',()=>closeModal('modal-trip-detail'));
document.getElementById('trip-edit-btn').addEventListener('click',()=>{closeModal('modal-trip-detail');setTimeout(()=>openAddTrip(currentTripId),320);});
function openTripDetail(tripId){
  currentTripId=tripId;
  const t=DB.trips.find(x=>x.id===tripId); if(!t) return;
  const allPlaces=DB.places;
  const tripVisits=DB.visits.filter(v=>v.tripId===tripId).sort((a,b)=>(a.startDate||a.date||'').localeCompare(b.startDate||b.date||''));
  const placeIds=[...new Set(tripVisits.map(v=>v.placeId))];
  const duration=t.startDate&&t.endDate?Math.round((new Date(t.endDate)-new Date(t.startDate))/86400000)+1:null;
  const hr=tripVisits.map(v=>v.hunterRating).filter(r=>r>0);
  const br=tripVisits.map(v=>v.brandonRating).filter(r=>r>0);
  const hAvg=hr.length?hr.reduce((a,b)=>a+b,0)/hr.length:0;
  const bAvg=br.length?br.reduce((a,b)=>a+b,0)/br.length:0;

  // ── Miles per day ──
  // Collect all distinct dates spanned by this trip's visits
  const tripDateSet = new Set();
  tripVisits.forEach(v => {
    const s = v.startDate||v.date; const e = v.endDate||s; if(!s) return;
    let step=0, cur=s;
    while(cur<=e && step<400){ tripDateSet.add(cur); step++; cur=dateAddDays(s,step); }
  });
  const tripDates = [...tripDateSet].sort();

  // For each date, get ordered visits and compute miles
  const dayMilesData = tripDates.map(ds => {
    const dayVisits = DayOrder.ordered(ds, tripVisits.filter(v => visitSpansDate(v, ds)));
    if(dayVisits.length < 2) return { ds, result: null };
    const stops = buildDayStops(dayVisits);
    const result = stops.length >= 2 ? calcDayMiles(stops) : null;
    return { ds, result };
  }).filter(d => d.result !== null);

  const tripTotalMiles = dayMilesData.reduce((sum, d) => sum + d.result.total, 0);
  const hasMiles = dayMilesData.length > 0 && tripTotalMiles > 0;

  // Per-place averages for distribution + rankings
  const tripPlaces=placeIds.map(pid=>{
    const pvs=tripVisits.filter(v=>v.placeId===pid);
    const rs=pvs.flatMap(v=>[...(v.hunterRating>0?[v.hunterRating]:[]),...(v.brandonRating>0?[v.brandonRating]:[])]);
    const avg=rs.length?rs.reduce((a,b)=>a+b,0)/rs.length:0;
    return {p:allPlaces.find(x=>x.id===pid),avg,visits:pvs.length};
  }).filter(x=>x.p);

  // Countries
  const countriesSet=new Set(tripPlaces.map(x=>x.p.country).filter(Boolean));

  // Rating distribution
  const distBuckets={};
  for(let v=0.5;v<=5.0;v+=0.5) distBuckets[v.toFixed(1)]=0;
  tripPlaces.forEach(({avg})=>{
    if(avg){const k=(Math.round(avg*2)/2).toFixed(1);if(distBuckets[k]!==undefined)distBuckets[k]++;}
  });
  const maxBkt=Math.max(1,...Object.values(distBuckets));
  const distHtml=Object.entries(distBuckets).map(([label,count])=>{
    const pct=count?Math.max(8,(count/maxBkt)*100):0;
    return `<div class="rating-bar-col"><div class="rating-bar-track"><div class="rating-bar-fill ${count?'has-data':'no-data'}" style="height:${count?pct+'%':'3px'};"></div></div><div class="rating-bar-label">${label}</div></div>`;
  }).join('');

  // Top places by avg rating
  const ratedPlaces=[...tripPlaces].filter(x=>x.avg>0).sort((a,b)=>b.avg-a.avg);
  const topHtml=ratedPlaces.slice(0,5).map((x,i)=>
    `<div style="display:flex;align-items:center;gap:8px;padding:8px 0;${i<ratedPlaces.slice(0,5).length-1?'border-bottom:1px solid var(--border);':''}">
      <div style="width:18px;font-size:11px;color:var(--text-muted);text-align:right;flex-shrink:0;">${i+1}.</div>
      <div style="flex:1;min-width:0;">
        <div style="font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${escHtml(x.p.name)}</div>
        <div style="font-size:11px;color:var(--text-muted);">${escHtml([x.p.city,x.p.country].filter(Boolean).join(', '))}</div>
      </div>
      <div style="font-size:12px;font-weight:700;color:var(--dark-sage);flex-shrink:0;">${x.avg.toFixed(1)} \u2605</div>
    </div>`).join('');

  document.getElementById('trip-detail-title').textContent=t.name;
  const body=document.getElementById('trip-detail-body');
  body.innerHTML=`
    <div style="padding:16px 16px 0;">
      <div class="stat-grid" style="grid-template-columns:repeat(3,1fr);gap:8px;">
        ${duration?`<div class="stat-card"><div class="stat-label">Duration</div><div class="stat-value" style="font-size:22px;">${duration}<span style="font-size:14px;">d</span></div></div>`:''}
        <div class="stat-card"><div class="stat-label">Places</div><div class="stat-value" style="font-size:22px;">${placeIds.length}</div></div>
        <div class="stat-card"><div class="stat-label">Visits</div><div class="stat-value" style="font-size:22px;">${tripVisits.length}</div></div>
        ${hAvg?`<div class="stat-card hunter-card"><div class="stat-label">H Avg</div><div class="stat-value" style="font-size:22px;">${hAvg.toFixed(1)}</div></div>`:''}
        ${bAvg?`<div class="stat-card brandon-card"><div class="stat-label">B Avg</div><div class="stat-value" style="font-size:22px;">${bAvg.toFixed(1)}</div></div>`:''}
        ${countriesSet.size?`<div class="stat-card"><div class="stat-label">Countries</div><div class="stat-value" style="font-size:22px;">${countriesSet.size}</div><div class="stat-sub">${[...countriesSet].join(', ')}</div></div>`:''}
        ${hasMiles?`<div class="stat-card" style="grid-column:1/-1;"><div class="stat-label">Miles Travelled</div><div class="stat-value" style="font-size:22px;">${tripTotalMiles.toFixed(0)}<span style="font-size:14px;">mi</span></div><div class="stat-sub">${dayMilesData.length} day${dayMilesData.length!==1?'s':''} with tracked movement</div></div>`:''}
      </div>
    </div>

    ${ratedPlaces.length>=2?`
    <div style="padding:16px 16px 0;">
      <div class="stats-section-label">Rating Distribution</div>
      <div class="stats-chart-card">
        <div class="rating-bars">${distHtml}</div>
        <div style="display:flex;justify-content:space-between;margin-top:8px;">
          <span style="font-size:11px;color:var(--text-light);">${ratedPlaces.length} rated</span>
          <span style="font-size:11px;color:var(--text-muted);">H\u00a0${hAvg?hAvg.toFixed(1):'\u2014'} &nbsp; B\u00a0${bAvg?bAvg.toFixed(1):'\u2014'}</span>
        </div>
      </div>
    </div>`:''}

    ${ratedPlaces.length?`
    <div style="padding:16px 16px 0;">
      <div class="stats-section-label">Top Places</div>
      <div class="stats-chart-card" style="padding:0 14px;">${topHtml}</div>
    </div>`:''}

    ${t.notes?`<div style="padding:16px 16px 0;"><div class="section-title">Notes</div><p style="font-size:14px;line-height:1.6;color:var(--text-muted);">${escHtml(t.notes)}</p></div>`:''}

    ${hasMiles?`
    <div style="padding:16px 16px 0;">
      <div class="section-title">Daily Miles</div>
      <div class="stats-chart-card" style="padding:0;">
        ${dayMilesData.map(({ds,result}) => `
          <div style="display:flex;align-items:baseline;gap:10px;padding:10px 14px;border-bottom:1px solid var(--border);">
            <div style="font-size:11px;color:var(--text-muted);flex-shrink:0;min-width:72px;">${formatDate(ds)}</div>
            <div style="flex:1;min-width:0;">
              ${result.legs.map(l=>`<div style="font-size:11px;color:var(--text-light);">→ ${escHtml(l.from)} → ${escHtml(l.to)}</div>`).join('')}
            </div>
            <div style="font-size:13px;font-weight:700;color:var(--dark-sage);flex-shrink:0;">${result.total.toFixed(1)} mi</div>
          </div>`).join('')}
      </div>
    </div>`:''}

    <div style="padding:16px 16px 0;">
      <div class="section-title">Timeline</div>
      <div class="timeline">${tripVisits.map((v,i)=>{
        const p=allPlaces.find(x=>x.id===v.placeId);
        const isLast=i===tripVisits.length-1;
        return `<div class="timeline-item"><div class="timeline-dot-wrap"><div class="timeline-dot"></div>${!isLast?'<div class="timeline-line"></div>':''}</div><div class="timeline-content"><div class="timeline-date">${formatVisitDate(v)}</div><div class="timeline-name" data-visit="${v.id}">${escHtml(p?.name||'Unknown')}</div><div class="timeline-meta">H:${v.hunterRating||'\u2014'} B:${v.brandonRating||'\u2014'}</div></div></div>`;
      }).join('')}</div>
    </div>

    <div style="padding:14px 16px 24px;">
      <button class="btn btn-danger btn-sm" id="trip-del-btn">Delete Trip</button>
    </div>`;

  body.querySelectorAll('[data-visit]').forEach(el=>el.addEventListener('click',()=>{
    const v=DB.visits.find(x=>x.id===el.dataset.visit);
    if(v){closeModal('modal-trip-detail');currentPlaceId=v.placeId;setTimeout(()=>openVisitDetail(v.id),320);}
  }));
  document.getElementById('trip-del-btn').addEventListener('click',()=>{
    if(!confirm('Delete trip? Visits will be unlinked.'))return;
    deleteTrip(tripId);closeModal('modal-trip-detail');renderFilterChips();renderList();toast('Trip deleted');
  });
  // Travel Style analytics
  renderTripAnalyticsSection(tripId, body);
  // Feedback loop for planned trips
  _planCheckFeedback(tripId);
  openModal('modal-trip-detail');
}

// ═══════════════════════════════════════════
//  WISHLIST
// ═══════════════════════════════════════════
let wishDesireCtrl=null;
document.getElementById('add-wish-btn').addEventListener('click',()=>openAddWish());
document.getElementById('add-wish-close').addEventListener('click',()=>closeModal('modal-add-wish'));
document.getElementById('wish-detail-back').addEventListener('click',()=>closeModal('modal-wish-detail'));

function openAddWish(wishId=null,prefill=null){
  editingWishId=wishId;
  document.getElementById('add-wish-title').textContent=wishId?'Edit Wishlist Item':'Add to Wishlist';
  document.getElementById('wish-maps-url').value='';
  document.getElementById('wish-maps-hint').textContent='Paste a Google Maps link — name & location fill automatically.';
  document.getElementById('wish-maps-hint').style.color='';
  if(wishId){
    const w=DB.wishlist.find(x=>x.id===wishId);
    document.getElementById('wish-name').value=w.name||'';document.getElementById('wish-city').value=w.city||'';
    document.getElementById('wish-state').value=w.state||'';document.getElementById('wish-country').value=w.country||'';document.getElementById('wish-lat').value=w.lat||'';
    document.getElementById('wish-lng').value=w.lng||'';document.getElementById('wish-category').value=w.category||'';
    document.getElementById('wish-priority').value=w.priority||'medium';setChecks('wish-source',w.source||[]);document.getElementById('wish-notes').value=w.notes||'';
    setTags(wishTagsCfg,w.subTags||[]);
  } else {
    ['wish-name','wish-city','wish-state','wish-country','wish-lat','wish-lng','wish-notes'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('wish-category').value='';document.getElementById('wish-priority').value='medium';setChecks('wish-source',[]);
    setTags(wishTagsCfg,[]);
    if(prefill){
      if(prefill.name)document.getElementById('wish-name').value=prefill.name;
      if(prefill.city)document.getElementById('wish-city').value=prefill.city;
      if(prefill.state)document.getElementById('wish-state').value=prefill.state;
      if(prefill.country)document.getElementById('wish-country').value=prefill.country;
      if(prefill.lat)document.getElementById('wish-lat').value=prefill.lat;
      if(prefill.lng)document.getElementById('wish-lng').value=prefill.lng;
      if(prefill.category)document.getElementById('wish-category').value=prefill.category;
      setTags(wishTagsCfg,prefill.subTags||[]);
    }
  }
  openModal('modal-add-wish');
}

// ── Wishlist Maps URL parser (mirrors place parser) ──
async function doParseWish(url) {
  if (!url) return;
  const hint = document.getElementById('wish-maps-hint');
  const setHint = (msg, color) => { if(hint){hint.textContent=msg;hint.style.color=color||'';} };
  if (!/google\.com\/maps|maps\.google\.|goo\.gl\/maps/i.test(url)) {
    setHint('Paste a Google Maps link — name & location fill automatically.');
    return;
  }
  setHint('Reading link…');
  try {
    const ex = extractFromMapsUrl(url);
    if (ex.name && !document.getElementById('wish-name').value) {
      document.getElementById('wish-name').value = ex.name;
    }
    if (!ex.lat || !ex.lng) {
      setHint('⚠ No coordinates found — use the full Maps link.', '#a05020');
      return;
    }
    document.getElementById('wish-lat').value = ex.lat;
    document.getElementById('wish-lng').value = ex.lng;
    setHint('Fetching city & country…');
    const timeout = new Promise(res => setTimeout(()=>res(null), 10000));
    const geo = await Promise.race([reverseGeocode(ex.lat, ex.lng), timeout]);
    const filled = [];
    if (ex.name) filled.push('name');
    if (geo) {
      if (geo.city)    { document.getElementById('wish-city').value    = geo.city;    filled.push('city'); }
      if (geo.state)   { document.getElementById('wish-state').value   = geo.state;   filled.push('state'); }
      if (geo.country) { document.getElementById('wish-country').value = geo.country; filled.push('country'); }
    }
    if (filled.length > 1) {
      setHint(`✓ Filled: ${filled.join(', ')}. Check category & priority.`);
    } else {
      setHint('⚠ Coords found but city lookup failed — fill manually.', '#a05020');
    }
  } catch(e) {
    setHint('Could not parse — try copying the link fresh from Google Maps.', '#a05020');
  }
}

let _wishParseDebounce = null;
const wishMapsInput = document.getElementById('wish-maps-url');
wishMapsInput.addEventListener('paste', e => {
  const text = e.clipboardData?.getData('text/plain') || '';
  clearTimeout(_wishParseDebounce);
  _wishParseDebounce = setTimeout(() => doParseWish(text || wishMapsInput.value), text ? 0 : 120);
});
wishMapsInput.addEventListener('input', e => {
  clearTimeout(_wishParseDebounce);
  _wishParseDebounce = setTimeout(() => doParseWish(e.target.value), 300);
});
wishMapsInput.addEventListener('change', e => {
  clearTimeout(_wishParseDebounce);
  _wishParseDebounce = setTimeout(() => doParseWish(e.target.value), 0);
});
document.getElementById('save-wish-btn').addEventListener('click',()=>{
  const name=document.getElementById('wish-name').value.trim();if(!name){toast('Name required');return;}
  const w=editingWishId?{...DB.wishlist.find(x=>x.id===editingWishId)}:{id:uid(),dateAdded:new Date().toISOString()};
  w.name=name;w.city=document.getElementById('wish-city').value.trim();w.state=document.getElementById('wish-state').value.trim();w.country=document.getElementById('wish-country').value.trim();
  w.lat=parseFloat(document.getElementById('wish-lat').value)||null;w.lng=parseFloat(document.getElementById('wish-lng').value)||null;
  w.category=document.getElementById('wish-category').value;w.priority=document.getElementById('wish-priority').value;
  w.source=getChecks('wish-source');w.notes=document.getElementById('wish-notes').value.trim();w.subTags=[...wishTagsCfg.tags];
  saveWish(w);closeModal('modal-add-wish');renderWishlist();toast(editingWishId?'Updated':'Added to wishlist!');
});

function renderWishlist(){
  const wishlist=DB.wishlist;document.getElementById('wish-count').textContent=`${wishlist.length} item${wishlist.length!==1?'s':''}`;
  const cats=[...new Set(wishlist.map(w=>w.category).filter(Boolean))];
  const fc=document.getElementById('wish-filter-chips');fc.innerHTML='';
  const allBtn=document.createElement('button');allBtn.className='chip wish-chip'+(!wishFilterCat?' active':'');allBtn.textContent='All';
  allBtn.addEventListener('click',()=>{wishFilterCat=null;renderWishlist();});fc.appendChild(allBtn);
  cats.forEach(cat=>{const c=document.createElement('button');c.className='chip wish-chip'+(wishFilterCat===cat?' active':'');c.textContent=cat;c.addEventListener('click',()=>{wishFilterCat=cat;renderWishlist();});fc.appendChild(c);});
  let items=wishFilterCat?wishlist.filter(w=>w.category===wishFilterCat):[...wishlist];
  items.sort((a,b)=>{const po={high:0,medium:1,low:2};return(po[a.priority]||1)-(po[b.priority]||1)||a.name.localeCompare(b.name);});
  const list=document.getElementById('wish-list');list.innerHTML='';
  if(!items.length){list.innerHTML=`<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg><h3>Wishlist empty</h3><p>Add places you want to visit.</p></div>`;return;}
  items.forEach(w=>{
    const card=document.createElement('div');card.className='wish-card';
    card.innerHTML=`
      <div style="display:flex;justify-content:space-between;align-items:flex-start;">
        <div><div class="wish-name">${escHtml(w.name)}</div><div class="wish-loc">${[w.city,w.state,w.country].filter(Boolean).join(', ')}</div></div>
        ${w.category?`<span class="wish-cat">${escHtml(w.category)}</span>`:''}
      </div>
      <div class="wish-meta">
        <span class="wish-priority ${w.priority||'medium'}">${w.priority==='high'?'\u25CF High':w.priority==='low'?'\u25CB Low':'\u25CE Med'}</span>
        ${w.source?.length?`<span style="font-size:11px;color:var(--text-muted);">${w.source.join(' · ')}</span>`:''}

        ${w.subTags?.length?w.subTags.slice(0,2).map(t=>`<span class="tag">${escHtml(t)}</span>`).join(''):''}
      </div>`;
    card.addEventListener('click',()=>openWishDetail(w.id));
    list.appendChild(card);
  });
}

function openWishDetail(wishId){
  currentWishId=wishId;const w=DB.wishlist.find(x=>x.id===wishId);if(!w)return;
  document.getElementById('wish-detail-title').textContent=w.name;
  const body=document.getElementById('wish-detail-body');
  body.innerHTML=`
    <div><div class="section-title">Location</div><p style="font-size:14px;color:var(--text-muted);">${[w.city,w.state,w.country].filter(Boolean).join(', ')||'\u2014'}</p></div>
    ${w.category?`<div><div class="section-title">Category</div><span class="wish-cat">${escHtml(w.category)}</span></div>`:''}
    <div style="display:flex;gap:10px;flex-wrap:wrap;">
      <div class="stat-card" style="flex:1;min-width:0;"><div class="stat-label">Priority</div><div style="font-size:18px;margin-top:6px;">${w.priority==='high'?'\u25CF High':w.priority==='low'?'\u25CB Low':'\u25CE Medium'}</div></div>

    </div>
    ${w.notes?`<div><div class="section-title">Notes</div><p style="font-size:14px;line-height:1.6;color:var(--text-muted);">${escHtml(w.notes)}</p></div>`:''}
    ${w.subTags?.length?`<div><div class="section-title">Tags</div><div class="tags-row">${w.subTags.map(t=>`<span class="tag">${escHtml(t)}</span>`).join('')}</div></div>`:''}
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <button class="btn btn-primary btn-sm" id="wish-convert-btn">\u2192 Convert to Place</button>
      <button class="btn btn-secondary btn-sm" id="wish-edit-detail-btn">Edit</button>
      <button class="btn btn-danger btn-sm" id="wish-delete-detail-btn">Remove</button>
    </div>`;
  document.getElementById('wish-convert-btn').addEventListener('click',()=>{
    closeModal('modal-wish-detail');
    setTimeout(()=>{
      openAddPlace();
      setTimeout(()=>{
        if(w.name)document.getElementById('place-name').value=w.name;
        if(w.city)document.getElementById('place-city').value=w.city;
        if(w.country)document.getElementById('place-country').value=w.country;
        if(w.lat)document.getElementById('place-lat').value=w.lat;
        if(w.lng)document.getElementById('place-lng').value=w.lng;
        if(w.category)document.getElementById('place-category').value=w.category;
        setChecks('place-discovery',w.source||[]);
        setTags(subTags,w.subTags||[]);
      },100);
    },320);
  });
  document.getElementById('wish-edit-detail-btn').addEventListener('click',()=>{closeModal('modal-wish-detail');setTimeout(()=>openAddWish(wishId),320);});
  document.getElementById('wish-delete-detail-btn').addEventListener('click',()=>{if(!confirm('Remove from wishlist?'))return;deleteWish(wishId);closeModal('modal-wish-detail');renderWishlist();toast('Removed');});
  openModal('modal-wish-detail');
}

// ═══════════════════════════════════════════
//  CALENDAR
// ═══════════════════════════════════════════
const _n=new Date();calYear=_n.getFullYear();calMonth=_n.getMonth();
document.getElementById('cal-prev').addEventListener('click',()=>{calMonth--;if(calMonth<0){calMonth=11;calYear--;}renderCalendar();});
document.getElementById('cal-next').addEventListener('click',()=>{calMonth++;if(calMonth>11){calMonth=0;calYear++;}renderCalendar();});

// ── Day order storage (per-date ordering of visit IDs) ──
const DayOrder = {
  _key: ds => 'pd_dayorder_' + ds,
  get(ds) { try { return JSON.parse(localStorage.getItem(this._key(ds)) || 'null') || null; } catch(e){ return null; } },
  set(ds, ids) { localStorage.setItem(this._key(ds), JSON.stringify(ids)); },
  // Return visits for a date in user-defined order (unordered visits appended at end)
  ordered(ds, visits) {
    const saved = this.get(ds);
    if (!saved) return visits;
    const map = Object.fromEntries(visits.map(v => [v.id, v]));
    const ordered = saved.map(id => map[id]).filter(Boolean);
    const extra = visits.filter(v => !saved.includes(v.id));
    return [...ordered, ...extra];
  },
};

// Haversine distance in miles between two {lat,lng} points
function haversineMiles(a, b) {
  if (!a?.lat || !a?.lng || !b?.lat || !b?.lng) return null;
  const R = 3958.8, toRad = d => d * Math.PI / 180;
  const dLat = toRad(b.lat - a.lat), dLng = toRad(b.lng - a.lng);
  const x = Math.sin(dLat/2)**2 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)**2;
  return R * 2 * Math.asin(Math.sqrt(x));
}

// Build the ordered stop list for a day's miles calculation.
// If any stop is Hotel/Lodging, bookend with it (first & last).
function buildDayStops(orderedVisits) {
  const places = orderedVisits.map(v => DB.places.find(p => p.id === v.placeId)).filter(Boolean);
  const hotel = places.find(p => p.category === 'Hotel / Lodging');
  if (hotel && places.length > 1) {
    const others = places.filter(p => p.id !== hotel.id);
    return [hotel, ...others, hotel];
  }
  return places;
}

function calcDayMiles(stops) {
  let total = 0, legs = [];
  for (let i = 0; i < stops.length - 1; i++) {
    const d = haversineMiles(stops[i], stops[i+1]);
    if (d === null) return null;
    legs.push({ from: stops[i].name, to: stops[i+1].name, miles: d });
    total += d;
  }
  return { total, legs };
}


// ═══════════════════════════════════════════
//  ANALYTICS ENGINE
// ═══════════════════════════════════════════

// Simple keyword-based note intensity score
function _noteIntensity(notes) {
  if (!notes || !notes.length) return 0;
  const totalChars = notes.reduce((s, n) => s + (n.text||'').length, 0);
  const avgLen = totalChars / notes.length;
  // Normalize: 0 chars = 0, 200+ chars = 100
  return Math.min(100, (avgLen / 200) * 100);
}

function _variance(arr) {
  if (arr.length < 2) return 0;
  const mean = arr.reduce((a,b)=>a+b,0)/arr.length;
  return arr.reduce((s,x)=>s+(x-mean)**2,0)/arr.length;
}

function _clamp(v,lo=0,hi=100){ return Math.max(lo,Math.min(hi,v)); }
function _norm(v, max) { return max > 0 ? _clamp((v/max)*100) : 0; }

// ── TRIP ANALYTICS ──────────────────────────────────
function computeTripAnalytics(tripId) {
  const t = DB.trips.find(x => x.id === tripId);
  if (!t) return null;
  const allPlaces = DB.places;
  const tripVisits = DB.visits.filter(v => v.tripId === tripId);
  if (!tripVisits.length) return null;

  // Trip length
  const dayMs = 86400000;
  const tripLen = (t.startDate && t.endDate)
    ? Math.max(1, Math.round((new Date(t.endDate) - new Date(t.startDate)) / dayMs) + 1)
    : Math.max(1, [...new Set(tripVisits.map(v => v.startDate||v.date||'').filter(Boolean))].length);

  const placeIds = [...new Set(tripVisits.map(v => v.placeId))];
  const totalPlaces = placeIds.length;
  const totalVisits = tripVisits.length;
  const placesPerDay = totalPlaces / tripLen;
  const visitsPerDay = totalVisits / tripLen;

  // Notes
  const allNotes = tripVisits.flatMap(v => {
    const p = allPlaces.find(x => x.id === v.placeId);
    return p ? (p.notes||[]) : [];
  });
  const noteDensity = allNotes.length / tripLen;
  const avgNoteLen = allNotes.length
    ? allNotes.reduce((s,n)=>s+(n.text||'').length,0) / allNotes.length
    : 0;

  // Category diversity
  const cats = placeIds.map(pid => allPlaces.find(p=>p.id===pid)?.category).filter(Boolean);
  const uniqueCats = new Set(cats).size;
  const catDiversity = totalPlaces > 0 ? uniqueCats / totalPlaces : 0;

  // Repeat ratio (places visited more than once in trip)
  const visitCountPerPlace = {};
  tripVisits.forEach(v => { visitCountPerPlace[v.placeId] = (visitCountPerPlace[v.placeId]||0)+1; });
  const repeatPlaces = Object.values(visitCountPerPlace).filter(c=>c>1).length;
  const repeatRatio = totalPlaces > 0 ? repeatPlaces / totalPlaces : 0;

  // Average rating
  const ratings = tripVisits.flatMap(v => [v.hunterRating,v.brandonRating].filter(r=>r>0));
  const avgRating = ratings.length ? ratings.reduce((a,b)=>a+b,0)/ratings.length : 0;
  const ratingVariance = _variance(ratings);
  const ratingStability = _clamp(100 - (ratingVariance / 3) * 100); // low variance = high stability

  // ── DEPTH SCORE ──
  const dNoteDensity  = _norm(noteDensity,  5);     // 5 notes/day = max
  const dNoteLen      = _norm(avgNoteLen,   200);   // 200 chars = max
  const dRepeat       = repeatRatio * 100;
  const dCatDiv       = catDiversity * 100;
  const dStability    = ratingStability;
  const depthScore = _clamp(
    dNoteDensity * 0.25 + dNoteLen * 0.20 + dRepeat * 0.20 + dCatDiv * 0.20 + dStability * 0.15
  );

  // ── DENSITY SCORE ──
  const nPPD = _norm(placesPerDay, 4);   // 4+ places/day = max
  const nVPD = _norm(visitsPerDay, 5);
  const nCat = catDiversity * 100;
  // Compression: short trip (1-3 days) with many places = high compression
  const compression = _clamp(totalPlaces > 1 ? (totalPlaces / Math.max(tripLen,1)) / 3 * 100 : 0);
  const densityScore = _clamp(
    nPPD * 0.40 + nVPD * 0.30 + nCat * 0.20 + compression * 0.10
  );

  // ── CLASSIFICATION ──
  let classification;
  if      (densityScore >= 60 && depthScore < 40)  classification = 'Sampler';
  else if (densityScore >= 60 && depthScore >= 60) classification = 'Hyper-Optimized';
  else if (densityScore < 40  && depthScore >= 60) classification = 'Deep Dive';
  else if (densityScore < 35  && depthScore < 35)  classification = 'Slow Burn';
  else                                              classification = 'Balanced Explorer';

  // ── SUMMARY ──
  const summaries = {
    'Sampler': 'This trip prioritized breadth over immersion, covering many places with rapid turnover. Documentation was light, suggesting a focus on discovery over reflection.',
    'Hyper-Optimized': 'Every day was packed with variety and emotional engagement. High documentation and diverse categories signal a deliberate, high-intensity travel style.',
    'Deep Dive': 'This trip favored depth over breadth — fewer places, stronger documentation, and meaningful revisits. A sign of intentional, immersive travel.',
    'Balanced Explorer': 'A well-rounded trip balancing discovery with engagement. Moderate pace with consistent documentation across a variety of places.',
    'Slow Burn': 'A relaxed, unhurried pace with minimal documentation. This trip reads as restorative rather than exploratory — quality of time over quantity of places.',
  };

  return {
    depthScore, densityScore, classification,
    summary: summaries[classification],
    metrics: {
      tripLen, totalPlaces, totalVisits, placesPerDay, visitsPerDay,
      noteDensity, avgNoteLen, catDiversity, repeatRatio, avgRating, uniqueCats,
    },
  };
}

// ── PLACE PERSONALITY ────────────────────────────────
function computePlacePersonality(placeId) {
  const p = DB.places.find(x => x.id === placeId);
  if (!p) return null;
  const visits = DB.visits.filter(v => v.placeId === placeId);
  if (!visits.length) return null;

  const hRatings = visits.map(v=>v.hunterRating).filter(r=>r>0);
  const bRatings = visits.map(v=>v.brandonRating).filter(r=>r>0);
  const allRatings = [...hRatings,...bRatings];
  const hAvg = hRatings.length ? hRatings.reduce((a,b)=>a+b,0)/hRatings.length : 0;
  const bAvg = bRatings.length ? bRatings.reduce((a,b)=>a+b,0)/bRatings.length : 0;
  const ratingVar = _variance(allRatings);

  // Notes
  const notes = p.notes||[];
  const noteIntensity = _noteIntensity(notes);
  const noteCount = notes.length;

  // Visits
  const totalVisits = visits.length;
  const repeatRate = totalVisits > 1 ? (totalVisits - 1) / totalVisits : 0;

  // Seasonality (month → season)
  const getSeason = ds => {
    const m = parseInt((ds||'').slice(5,7));
    if(m>=3&&m<=5) return 'Spring'; if(m>=6&&m<=8) return 'Summer';
    if(m>=9&&m<=11) return 'Autumn'; return 'Winter';
  };
  const seasonCounts = {};
  visits.forEach(v => {
    const s = getSeason(v.startDate||v.date);
    seasonCounts[s] = (seasonCounts[s]||0)+1;
  });
  const topSeason = Object.entries(seasonCounts).sort((a,b)=>b[1]-a[1])[0]?.[0] || 'Unknown';

  // Companion frequency
  const companions = {};
  visits.forEach(v=>(v.visitedWith||[]).forEach(c=>{ companions[c]=(companions[c]||0)+1; }));
  const topCompanion = Object.entries(companions).sort((a,b)=>b[1]-a[1])[0]?.[0]||null;

  // Category concentration (single place → always 100%)
  const catConc = p.category ? 1.0 : 0;

  // Altitude category
  const alt = p.altitude||0;
  const altCat = alt > 8000 ? 'High Altitude' : alt > 3000 ? 'Mid Altitude' : alt > 0 ? 'Low Altitude' : null;

  // ── 5 DIMENSIONS ──
  const immersion  = _clamp((repeatRate*50) + (noteIntensity*0.5));
  const spontaneity = _clamp(100 - (noteIntensity * 0.4) - (repeatRate*30) + (noteCount > 3 ? 20 : 0));
  const stability  = _clamp(100 - (ratingVar / 3) * 100);
  const specialty  = _clamp(catConc * 70 + (p.category ? 30 : 0));
  const energy     = _clamp((noteCount/Math.max(totalVisits,1))*40 + noteIntensity*0.4 + repeatRate*20);

  // ── BADGE ──
  let badge;
  if      (repeatRate > 0.5 && stability > 70)         badge = 'Reliable Favorite';
  else if (immersion > 65 && noteIntensity > 60)        badge = 'High-Emotion Destination';
  else if (specialty > 80 && catConc > 0.8)             badge = 'Specialist City';
  else if (totalVisits === 1 && repeatRate === 0)       badge = 'One-Time Wonder';
  else if (repeatRate > 0.3 && hAvg > 0 && hAvg < 4.0) badge = 'Underrated Repeat';
  else                                                  badge = null;

  // ── SUMMARY ──
  let summary = '';
  const avgR = allRatings.length ? allRatings.reduce((a,b)=>a+b,0)/allRatings.length : 0;
  const ratingWord = avgR >= 4.5 ? 'exceptional' : avgR >= 3.5 ? 'solid' : avgR > 0 ? 'modest' : '';
  const repeatWord = repeatRate > 0.5 ? 'strong repeat appeal' : repeatRate > 0 ? 'some revisit value' : 'a single-visit history';
  const noteWord = noteIntensity > 60 ? 'rich emotional documentation' : noteIntensity > 25 ? 'moderate documentation' : 'minimal notes';
  const catWord = p.category ? p.category.toLowerCase() : 'general interest';
  summary = `This place has ${repeatWord} with ${noteWord}${ratingWord ? ` and ${ratingWord} ratings` : ''}. It operates primarily as a ${catWord} destination${topSeason !== 'Unknown' ? `, most often visited in ${topSeason}` : ''}${topCompanion ? `, frequently enjoyed with ${topCompanion}` : ''}.`;

  return {
    immersion, spontaneity, stability, specialty, energy,
    badge, summary,
    meta: { totalVisits, repeatRate, hAvg, bAvg, topSeason, topCompanion, altCat, noteCount, noteIntensity },
  };
}

// ── RENDER HELPERS ───────────────────────────────────
function _anaBar(label, score, cls) {
  return `<div class="ana-score-row">
    <div class="ana-score-label"><span>${label}</span><span>${Math.round(score)}</span></div>
    <div class="ana-bar-track"><div class="ana-bar-fill ${cls}" style="width:${score}%"></div></div>
  </div>`;
}

function renderTripAnalyticsSection(tripId, container) {
  const data = computeTripAnalytics(tripId);
  if (!data) return;
  const { depthScore, densityScore, classification, summary, metrics: m } = data;

  const sec = document.createElement('div');
  sec.className = 'ana-section';
  sec.innerHTML = `
    <div class="ana-section-title">Travel Style</div>
    <div class="ana-classify-badge">${escHtml(classification)}</div>
    ${_anaBar('Depth', depthScore, 'depth')}
    ${_anaBar('Density', densityScore, 'density')}
    <div class="ana-metric-grid">
      <div class="ana-metric-card"><div class="ana-metric-label">Days</div><div class="ana-metric-value">${m.tripLen}</div></div>
      <div class="ana-metric-card"><div class="ana-metric-label">Places</div><div class="ana-metric-value">${m.totalPlaces}</div></div>
      <div class="ana-metric-card"><div class="ana-metric-label">Places / Day</div><div class="ana-metric-value">${m.placesPerDay.toFixed(1)}</div></div>
      <div class="ana-metric-card"><div class="ana-metric-label">Categories</div><div class="ana-metric-value">${m.uniqueCats}</div></div>
      ${m.avgRating > 0 ? `<div class="ana-metric-card"><div class="ana-metric-label">Avg Rating</div><div class="ana-metric-value">${m.avgRating.toFixed(1)}</div></div>` : ''}
      ${m.repeatRatio > 0 ? `<div class="ana-metric-card"><div class="ana-metric-label">Repeat Rate</div><div class="ana-metric-value">${Math.round(m.repeatRatio*100)}%</div></div>` : ''}
    </div>
    <div class="ana-summary">${escHtml(summary)}</div>`;
  container.appendChild(sec);
}

function renderPlacePersonalitySection(placeId, container) {
  const data = computePlacePersonality(placeId);
  if (!data) return;
  const { immersion, spontaneity, stability, specialty, energy, badge, summary, meta } = data;

  const dims = [
    { label: 'Immersion',   score: immersion,   cls: 'dim1' },
    { label: 'Spontaneity', score: spontaneity,  cls: 'dim2' },
    { label: 'Stability',   score: stability,    cls: 'dim3' },
    { label: 'Specialty',   score: specialty,    cls: 'dim4' },
    { label: 'Energy',      score: energy,       cls: 'dim5' },
  ];

  const sec = document.createElement('div');
  sec.className = 'ana-section';
  sec.innerHTML = `
    <div class="ana-section-title">Place Personality</div>
    ${badge ? `<div class="ana-badge-tag">${escHtml(badge)}</div>` : ''}
    ${dims.map(d => _anaBar(d.label, d.score, d.cls)).join('')}
    <div class="ana-metric-grid">
      <div class="ana-metric-card"><div class="ana-metric-label">Visits</div><div class="ana-metric-value">${meta.totalVisits}</div></div>
      ${meta.hAvg ? `<div class="ana-metric-card"><div class="ana-metric-label">Hunter Avg</div><div class="ana-metric-value">${meta.hAvg.toFixed(1)}</div></div>` : ''}
      ${meta.bAvg ? `<div class="ana-metric-card"><div class="ana-metric-label">Brandon Avg</div><div class="ana-metric-value">${meta.bAvg.toFixed(1)}</div></div>` : ''}
      ${meta.topSeason !== 'Unknown' ? `<div class="ana-metric-card"><div class="ana-metric-label">Top Season</div><div class="ana-metric-value" style="font-size:12px;">${meta.topSeason}</div></div>` : ''}
      ${meta.topCompanion ? `<div class="ana-metric-card"><div class="ana-metric-label">Frequent With</div><div class="ana-metric-value" style="font-size:11px;">${escHtml(meta.topCompanion)}</div></div>` : ''}
      ${meta.altCat ? `<div class="ana-metric-card"><div class="ana-metric-label">Altitude</div><div class="ana-metric-value" style="font-size:11px;">${meta.altCat}</div></div>` : ''}
    </div>
    <div class="ana-summary">${escHtml(summary)}</div>`;
  container.appendChild(sec);
}

// Advance a YYYY-MM-DD string by n days without any timezone conversion
function dateAddDays(str, n) {
  const [y,m,d] = str.split('-').map(Number);
  const dt = new Date(y, m-1, d+n);
  return dt.getFullYear()+'-'+String(dt.getMonth()+1).padStart(2,'0')+'-'+String(dt.getDate()).padStart(2,'0');
}

// Build map: dateStr -> [{v, isStart, isEnd, isSingle}]
function buildCalEventMap(visits) {
  const sorted = [...visits].sort((a,b) => {
    const aM = !!(a.endDate && a.endDate !== (a.startDate||a.date));
    const bM = !!(b.endDate && b.endDate !== (b.startDate||b.date));
    if(aM !== bM) return aM ? -1 : 1;
    return (a.startDate||a.date||'').localeCompare(b.startDate||b.date||'');
  });
  const map = {};
  sorted.forEach(v => {
    const s = v.startDate||v.date;
    const e = v.endDate||s;
    if(!s) return;
    // Use pure string date arithmetic — no Date objects, no timezone issues
    let step = 0, cur = s;
    while(cur <= e && step < 400) {
      if(!map[cur]) map[cur] = [];
      map[cur].push({ v, isStart: cur===s, isEnd: cur===e, isSingle: s===e });
      step++;
      cur = dateAddDays(s, step);
    }
  });
  return map;
}

function renderCalendar(){
  const months=['January','February','March','April','May','June','July','August','September','October','November','December'];
  document.getElementById('cal-month-label').textContent=`${months[calMonth]} ${calYear}`;
  const visits=DB.visits;
  const eventMap = buildCalEventMap(visits);
  // Debug: log a sample of the event map
  const emKeys = Object.keys(eventMap);
  if(emKeys.length) console.log('[cal] eventMap has',emKeys.length,'days, sample:', emKeys.slice(0,3), eventMap[emKeys[0]]);
  else console.log('[cal] eventMap is EMPTY. DB.visits:', DB.visits.length, 'visits');
  const grid=document.getElementById('cal-grid');grid.innerHTML='';
  ['SU','MO','TU','WE','TH','FR','SA'].forEach(d=>{const el=document.createElement('div');el.className='cal-day-label';el.textContent=d;grid.appendChild(el);});
  const firstDay=new Date(calYear,calMonth,1).getDay(),dim=new Date(calYear,calMonth+1,0).getDate(),dip=new Date(calYear,calMonth,0).getDate();
  const todayStr=new Date().toISOString().slice(0,10);
  let _colIdx = firstDay; // track day-of-week column (0=Sun)
  for(let i=firstDay-1;i>=0;i--){const d=dip-i,m=calMonth===0?12:calMonth,ds=`${calMonth===0?calYear-1:calYear}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;addCalDay(grid,d,ds,'other-month',eventMap,todayStr,(firstDay-1-i+0)%7);}
  for(let d=1;d<=dim;d++){const ds=`${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;addCalDay(grid,d,ds,'',eventMap,todayStr,_colIdx%7);_colIdx++;}
}

function addCalDay(grid,d,dateStr,extra,eventMap,todayStr,colIndex){
  const entries = eventMap[dateStr] || [];
  const hasAny = entries.length > 0;
  const isSel = calSelectedDate === dateStr;
  const el = document.createElement('div');
  el.className = `cal-day ${extra} ${dateStr===todayStr?'today':''} ${isSel?'selected':''} col-${colIndex}`;

  const numDiv = document.createElement('div');
  numDiv.className = 'cal-day-num';
  numDiv.textContent = d;
  el.appendChild(numDiv);

  const bars = document.createElement('div');
  bars.className = 'cal-bars';

  entries.slice(0, 3).forEach(({v, isStart, isEnd, isSingle}, laneIdx) => {
    const bar = document.createElement('div');
    let shape = isSingle ? 'solo' : isStart ? 'start' : isEnd ? 'end' : 'mid';
    bar.className = `cal-bar lane-${laneIdx} ${shape}`;
    if(isSel) bar.style.background = 'rgba(255,255,255,0.85)';
    bars.appendChild(bar);
  });

  if(entries.length > 3) {
    const dot = document.createElement('div');
    dot.className = 'cal-more-dot';
    bars.appendChild(dot);
  }

  el.appendChild(bars);
  el.addEventListener('click',()=>{calSelectedDate=dateStr;renderCalendar();renderCalVisits(dateStr);});
  grid.appendChild(el);
}

function renderCalVisits(dateStr){
  const rawVisits = DB.visits.filter(v=>visitSpansDate(v,dateStr));
  const visits = DayOrder.ordered(dateStr, rawVisits);
  const container = document.getElementById('cal-visits'); container.innerHTML = '';
  if(!visits.length){
    container.innerHTML = `<p style="font-size:13px;color:var(--text-light);text-align:center;padding:12px;">No visits on ${formatDate(dateStr)}</p>`;
    return;
  }

  const title = document.createElement('div');
  title.style.cssText = 'font-size:11px;font-weight:700;letter-spacing:0.06em;color:var(--text-light);text-transform:uppercase;margin-bottom:8px;';
  title.textContent = formatDate(dateStr);
  container.appendChild(title);

  // Miles metric (only when ≥2 visits with coords)
  if(visits.length >= 2) {
    const stops = buildDayStops(visits);
    const result = stops.length >= 2 ? calcDayMiles(stops) : null;
    if(result !== null) {
      const milesRow = document.createElement('div');
      milesRow.className = 'cal-miles-row';
      milesRow.innerHTML = `<span class="cal-miles-icon">✈</span><span class="cal-miles-val">${result.total.toFixed(1)} mi</span><span style="color:var(--text-light);">travelled today</span>`;
      container.appendChild(milesRow);
      if(result.legs.length > 1 || stops[0].id === stops[stops.length-1].id) {
        const legDiv = document.createElement('div');
        legDiv.className = 'cal-miles-leg';
        legDiv.innerHTML = result.legs.map(l =>
          `<div class="cal-miles-leg-item"><span class="cal-miles-leg-arrow">→</span><span>${escHtml(l.from)} → ${escHtml(l.to)}: ${l.miles.toFixed(1)} mi</span></div>`
        ).join('');
        container.appendChild(legDiv);
      }
    }
  }

  // Drag state
  let dragSrcIdx = null;

  visits.forEach((v, idx) => {
    const p = DB.places.find(x => x.id === v.placeId);
    const days = visitDayCount(v);
    const card = document.createElement('div');
    card.className = 'cal-visit-card';
    card.draggable = true;
    card.dataset.idx = idx;

    const handleSvg = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="9" cy="6" r="1.5" fill="currentColor"/><circle cx="15" cy="6" r="1.5" fill="currentColor"/><circle cx="9" cy="12" r="1.5" fill="currentColor"/><circle cx="15" cy="12" r="1.5" fill="currentColor"/><circle cx="9" cy="18" r="1.5" fill="currentColor"/><circle cx="15" cy="18" r="1.5" fill="currentColor"/></svg>`;

    card.innerHTML = `
      <div class="cal-visit-drag-handle" title="Drag to reorder">${handleSvg}</div>
      <div class="cal-visit-body">
        ${days>1?`<div class="cal-visit-duration">${days}-day visit · ${formatVisitDate(v)}</div>`:''}
        <div class="cal-visit-place">${escHtml(p?.name||'Unknown')}</div>
        <div class="cal-visit-meta">H:${v.hunterRating||'—'} B:${v.brandonRating||'—'}${v.visitedWith?.length?' · '+v.visitedWith.join(', '):''}</div>
      </div>`;

    // Click body to open detail (not handle)
    card.querySelector('.cal-visit-body').addEventListener('click', () => {
      currentPlaceId = v.placeId; openVisitDetail(v.id);
    });

    // Drag events
    card.addEventListener('dragstart', e => {
      dragSrcIdx = idx;
      card.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    });
    card.addEventListener('dragend', () => {
      card.classList.remove('dragging');
      container.querySelectorAll('.cal-visit-card').forEach(c => c.classList.remove('drag-over'));
    });
    card.addEventListener('dragover', e => {
      e.preventDefault(); e.dataTransfer.dropEffect = 'move';
      if(parseInt(card.dataset.idx) !== dragSrcIdx) card.classList.add('drag-over');
    });
    card.addEventListener('dragleave', () => card.classList.remove('drag-over'));
    card.addEventListener('drop', e => {
      e.preventDefault();
      const destIdx = parseInt(card.dataset.idx);
      if(dragSrcIdx === null || dragSrcIdx === destIdx) return;
      // Reorder
      const reordered = [...visits];
      const [moved] = reordered.splice(dragSrcIdx, 1);
      reordered.splice(destIdx, 0, moved);
      DayOrder.set(dateStr, reordered.map(x => x.id));
      renderCalVisits(dateStr);
    });

    container.appendChild(card);
  });
}

// ═══════════════════════════════════════════
//  MAP
// ═══════════════════════════════════════════
document.querySelectorAll('.map-mode-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{document.querySelectorAll('.map-mode-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');mapMode=btn.dataset.mode;updateMap();});
});
document.getElementById('map-wish-toggle').addEventListener('click',()=>{
  showWishOnMap=!showWishOnMap;
  document.getElementById('map-wish-toggle').classList.toggle('active',showWishOnMap);
  updateMap();
});

function initMap(){
  const mapEl=document.getElementById('leaflet-map');
  const viewEl=document.getElementById('view-map');
  const headerH=viewEl.querySelector('.page-header').offsetHeight||80;
  mapEl.style.height=`${window.innerHeight-headerH}px`;
  if(!mapInitialized){
    leafletMap=L.map('leaflet-map',{zoomControl:false}).setView([25,10],2);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{attribution:'&copy; CartoDB',maxZoom:19}).addTo(leafletMap);
    L.control.zoom({position:'topright'}).addTo(leafletMap);
    mapLayer=L.layerGroup().addTo(leafletMap);
    mapInitialized=true;
    setTimeout(()=>{leafletMap.invalidateSize();updateMap();},200);
  } else {
    setTimeout(()=>{leafletMap.invalidateSize();updateMap();},200);
  }
}

function updateMap(){
  if(!mapInitialized||!leafletMap) return;
  mapLayer.clearLayers();
  if(mapWishLayer){leafletMap.removeLayer(mapWishLayer);mapWishLayer=null;}
  if(typeof _choroplethLayer!=='undefined'&&_choroplethLayer){leafletMap.removeLayer(_choroplethLayer);_choroplethLayer=null;}
  const places=DB.places.filter(p=>p.lat&&p.lng);
  const visits=DB.visits;

  if(mapMode==='markers'){
    places.forEach(p=>{
      const visits_p=visits.filter(v=>v.placeId===p.id);
      const tripIds=[...new Set(visits_p.filter(v=>v.tripId).map(v=>v.tripId))];
      const tripBadgesHtml=tripIds.map(tid=>{const t=DB.trips.find(x=>x.id===tid);return t?`<span class="map-popup-badge" style="background:var(--trip-light);color:var(--trip-color);margin-right:4px;">${escHtml(t.name)}</span>`:''}).join('');
      const dotColor=p.avgRating>=4.5?'#6e8175':p.avgRating>=3?'#97ac9f':'#859eac';
      const icon=L.divIcon({html:`<div style="width:14px;height:14px;border-radius:50%;background:${dotColor};border:2.5px solid #fff;box-shadow:0 2px 8px rgba(28,36,32,0.22);"></div>`,iconSize:[14,14],iconAnchor:[7,7],className:''});
      L.marker([p.lat,p.lng],{icon}).bindPopup(`<div style="min-width:160px;"><div class="map-popup-name">${escHtml(p.name)}</div><div class="map-popup-loc">${[p.city,p.country].filter(Boolean).join(', ')}</div><div class="map-popup-ratings" style="display:flex;gap:5px;margin-bottom:6px;">${p.hunterAvg?`<span class="map-popup-badge" style="background:var(--hunter);color:var(--hunter-dark);">H ${p.hunterAvg.toFixed(1)}</span>`:''} ${p.brandonAvg?`<span class="map-popup-badge" style="background:var(--brandon);color:var(--brandon-dark);">B ${p.brandonAvg.toFixed(1)}</span>`:''}</div>${tripBadgesHtml?`<div style="margin-bottom:4px;">${tripBadgesHtml}</div>`:''}<div style="font-size:10px;color:var(--text-light);">${p.totalVisits||0} visit${p.totalVisits!==1?'s':''}</div></div>`,{className:'',maxWidth:240}).addTo(mapLayer);
    });
    // Fit to all markers
    if(places.length===1) { leafletMap.setView([places[0].lat,places[0].lng],10); }
    else if(places.length>1) { leafletMap.fitBounds(L.latLngBounds(places.map(p=>[p.lat,p.lng])).pad(0.15)); }
  } else if(mapMode==='heatmap'){
    // Smooth gradient heatmap using overlapping radial circles
    const maxV=Math.max(1,...places.map(p=>p.totalVisits||1));
    places.forEach(p=>{
      const w=(p.totalVisits||1)/maxV;
      // outer glow
      L.circleMarker([p.lat,p.lng],{radius:20+w*30,fillColor:'#6e8175',fillOpacity:0.04*w,color:'transparent'}).addTo(mapLayer);
      L.circleMarker([p.lat,p.lng],{radius:12+w*18,fillColor:'#6e8175',fillOpacity:0.08+w*0.08,color:'transparent'}).addTo(mapLayer);
      L.circleMarker([p.lat,p.lng],{radius:6+w*10,fillColor:'#6e8175',fillOpacity:0.2+w*0.25,color:'transparent'}).addTo(mapLayer);
      L.circleMarker([p.lat,p.lng],{radius:3+w*4,fillColor:'#3d5a48',fillOpacity:0.6+w*0.35,color:'transparent'}).bindPopup(`<div class="map-popup-name">${escHtml(p.name)}</div><div style="font-size:11px;color:var(--text-muted);">${p.totalVisits||0} visits &middot; avg ${p.avgRating?p.avgRating.toFixed(1):'\u2014'}</div>`).addTo(mapLayer);
    });
  } else if(mapMode==='choropleth'){
    // renderChoropleth is async — it adds its own wishlist layer after GeoJSON lands.
    // We do NOT add wishlist here to avoid a race where sync markers land under the polygon layer.
    _choroplethRenderPromise = renderChoropleth();
    return; // wishlist handled inside renderChoropleth after polygons are ready
  }

  if(showWishOnMap){
    const wLayer=L.layerGroup();
    DB.wishlist.filter(w=>w.lat&&w.lng).forEach(w=>{
      const icon=L.divIcon({html:`<div style="width:12px;height:12px;border-radius:50%;background:#c9a5a2;border:2px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,0.2);"></div>`,iconSize:[12,12],iconAnchor:[6,6],className:''});
      L.marker([w.lat,w.lng],{icon}).bindPopup(`<div class="map-popup-name" style="color:var(--wish-color);">\u2665 ${escHtml(w.name)}</div><div class="map-popup-loc">${[w.city,w.state,w.country].filter(Boolean).join(', ')}</div>`).addTo(wLayer);
    });
    mapWishLayer=wLayer;wLayer.addTo(leafletMap);
  }
}

// ── Choropleth render generation — incremented on each updateMap call
// that triggers a render. renderChoropleth checks this on resume to
// discard results from a cancelled (stale) run.
let _chorRenderGen = 0;
let _choroplethRenderPromise = null;

// Called after any choropleth render completes — adds wishlist on top if needed.
// Separated so the async path can call it at the right moment.
function _mapAddWishlistLayer() {
  if (!showWishOnMap) return;
  if (mapWishLayer) { leafletMap.removeLayer(mapWishLayer); mapWishLayer = null; }
  const wLayer = L.layerGroup();
  DB.wishlist.filter(w => w.lat && w.lng).forEach(w => {
    const icon = L.divIcon({
      html: `<div style="width:12px;height:12px;border-radius:50%;background:#c9a5a2;border:2px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,0.2);"></div>`,
      iconSize: [12,12], iconAnchor: [6,6], className: ''
    });
    L.marker([w.lat, w.lng], { icon })
      .bindPopup(`<div class="map-popup-name" style="color:var(--wish-color);">♥ ${escHtml(w.name)}</div><div class="map-popup-loc">${[w.city, w.state, w.country].filter(Boolean).join(', ')}</div>`)
      .addTo(wLayer);
  });
  mapWishLayer = wLayer;
  wLayer.addTo(leafletMap);
}

// ═══════════════════════════════════════════
//  CHOROPLETH — real polygon fills via GeoJSON
// ═══════════════════════════════════════════

// ── GeoJSON cache (fetched once, reused on mode toggle) ──────────
const _geoCache = {};

// fetchGeo: resilient multi-mirror fetch with manual timeout
// Uses AbortController instead of AbortSignal.timeout() for iOS Safari < 15.4
async function fetchGeo(url) {
  if (_geoCache[url]) return _geoCache[url];

  const mirrors = {
    'https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson': [
      'https://cdn.jsdelivr.net/gh/datasets/geo-countries/data/countries.geojson',
      'https://cdn.jsdelivr.net/gh/datasets/geo-countries@master/data/countries.geojson',
      'https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson',
    ],
    'https://raw.githubusercontent.com/PublicaMundi/MappingAPI/master/data/geojson/us-states.json': [
      'https://cdn.jsdelivr.net/gh/PublicaMundi/MappingAPI/data/geojson/us-states.json',
      'https://cdn.jsdelivr.net/gh/PublicaMundi/MappingAPI@master/data/geojson/us-states.json',
      'https://raw.githubusercontent.com/PublicaMundi/MappingAPI/master/data/geojson/us-states.json',
    ],
  };

  const urls = mirrors[url] || [url];

  for (const u of urls) {
    // Manual AbortController timeout — works on all browsers including iOS Safari < 15.4
    const ctrl = new AbortController();
    const tid  = setTimeout(() => ctrl.abort(), 12000);
    try {
      console.log('[choropleth] fetching', u);
      const resp = await fetch(u, { signal: ctrl.signal });
      clearTimeout(tid);
      if (resp.ok) {
        const data = await resp.json();
        console.log('[choropleth] loaded', u, '—', data.features?.length, 'features');
        _geoCache[url] = data;
        return data;
      }
      console.warn('[choropleth] HTTP', resp.status, u);
    } catch(e) {
      clearTimeout(tid);
      if (e.name === 'AbortError') console.warn('[choropleth] timeout', u);
      else console.warn('[choropleth] failed', u, e.message);
    }
  }

  throw new Error('GeoJSON unavailable from all sources: ' + url);
}

// ── Region data aggregation ───────────────────────────────────────
// Returns: { [regionKey]: { visits, places[], ratings[], avgRating } }
// Country keys  = p.country  (e.g. "United States")
// US state keys = "STATE:" + p.state  (e.g. "STATE:Texas")
function buildRegionData() {
  const places = DB.places;
  const visits = DB.visits;
  const rd = {};

  // Build place index for O(1) visit→place lookup
  const placeById = new Map(places.map(p => [p.id, p]));

  // Seed from places
  places.forEach(p => {
    if (!p.country) return;
    const cKey = p.country;
    if (!rd[cKey]) rd[cKey] = { visits: 0, places: [], ratings: [] };
    rd[cKey].places.push(p);

    if (_isUSPlace(p) && p.state) {
      const sKey = 'STATE:' + p.state;
      if (!rd[sKey]) rd[sKey] = { visits: 0, places: [], ratings: [] };
      rd[sKey].places.push(p);
    }
  });

  // Accumulate visits and ratings
  visits.forEach(v => {
    const p = placeById.get(v.placeId);
    if (!p || !p.country) return;

    const cKey = p.country;
    if (rd[cKey]) {
      rd[cKey].visits++;
      if (v.hunterRating  > 0) rd[cKey].ratings.push(v.hunterRating);
      if (v.brandonRating > 0) rd[cKey].ratings.push(v.brandonRating);
    }

    if (_isUSPlace(p) && p.state) {
      const sKey = 'STATE:' + p.state;
      if (rd[sKey]) {
        rd[sKey].visits++;
        if (v.hunterRating  > 0) rd[sKey].ratings.push(v.hunterRating);
        if (v.brandonRating > 0) rd[sKey].ratings.push(v.brandonRating);
      }
    }
  });

  // Compute avgRating and effective visit count
  // If a region has places but zero visit *records*, use places.length as a
  // floor so the region still shows as clearly visited (not faded).
  Object.values(rd).forEach(d => {
    d.avgRating   = d.ratings.length
      ? d.ratings.reduce((a, b) => a + b, 0) / d.ratings.length
      : 0;
    d.effectiveVisits = d.visits > 0 ? d.visits : d.places.length;
  });

  const countryCount = Object.keys(rd).filter(k => !k.startsWith('STATE:')).length;
  const stateCount   = Object.keys(rd).filter(k =>  k.startsWith('STATE:')).length;
  console.log(`[choropleth] aggregated: ${countryCount} countries, ${stateCount} US states`);

  return rd;
}

function _isUSPlace(p) {
  return p.country === 'United States' || p.country === 'US'
      || p.country === 'United States of America';
}

// ── Normalization helper ──────────────────────────────────────────
// Returns 0–1; safe against min===max (returns 0.5)
function _normalize(value, min, max) {
  if (max === min) return 0.5;
  return Math.max(0, Math.min(1, (value - min) / (max - min)));
}

// ── Country name translation ──────────────────────────────────────
// Two SEPARATE unidirectional maps to avoid conflicts.
//
// GEO_TO_APP: GeoJSON ADMIN name → name as stored in user's data
//   (reverse geocoders and manual entry use common English names)
//
// APP_TO_GEO: app stored name → GeoJSON ADMIN name
//   (only needed as a secondary fallback in lookupRegion)
const _GEO_TO_APP = {
  'United States of America':                         'United States',
  'Russian Federation':                               'Russia',
  'United Kingdom of Great Britain and Northern Ireland': 'United Kingdom',
  "Democratic People's Republic of Korea":            'North Korea',
  'Republic of Korea':                                'South Korea',
  'Viet Nam':                                         'Vietnam',
  "Lao People's Democratic Republic":                 'Laos',
  'Lao PDR':                                          'Laos',
  'Syrian Arab Republic':                             'Syria',
  'Islamic Republic of Iran':                         'Iran',
  'Plurinational State of Bolivia':                   'Bolivia',
  'Bolivarian Republic of Venezuela':                 'Venezuela',
  'United Republic of Tanzania':                      'Tanzania',
  'Democratic Republic of the Congo':                 'DR Congo',
  'Republic of the Congo':                            'Congo',
  'Republic of Moldova':                              'Moldova',
  'Republic of Belarus':                              'Belarus',
  'Republic of Armenia':                              'Armenia',
  'Republic of Azerbaijan':                           'Azerbaijan',
  'Republic of Georgia':                              'Georgia',
  "Côte d'Ivoire":                                    'Ivory Coast',
  'Cabo Verde':                                       'Cape Verde',
  'Eswatini':                                         'Eswatini',
  'Taiwan, Province of China':                        'Taiwan',
  'China, Taiwan Province':                           'Taiwan',
  'Republic of North Macedonia':                      'North Macedonia',
  'Czechia':                                          'Czech Republic', // geo uses 'Czechia', app may store 'Czech Republic'
  'Czech Republic':                                   'Czech Republic', // passthrough in case geo uses old name
  'Republic of Türkiye':                              'Turkey',
  'Türkiye':                                          'Turkey',
};

const _APP_TO_GEO = {
  'United States':    'United States of America',
  'Russia':           'Russian Federation',
  'United Kingdom':   'United Kingdom of Great Britain and Northern Ireland',
  'South Korea':      'Republic of Korea',
  'North Korea':      "Democratic People's Republic of Korea",
  'Vietnam':          'Viet Nam',
  'Laos':             'Lao PDR',
  'Syria':            'Syrian Arab Republic',
  'Iran':             'Islamic Republic of Iran',
  'Bolivia':          'Plurinational State of Bolivia',
  'Venezuela':        'Bolivarian Republic of Venezuela',
  'Tanzania':         'United Republic of Tanzania',
  'DR Congo':         'Democratic Republic of the Congo',
  'Ivory Coast':      "Côte d'Ivoire",
  'Cape Verde':       'Cabo Verde',
  'Taiwan':           'Taiwan, Province of China',
  'North Macedonia':  'Republic of North Macedonia',
  'Czech Republic':   'Czechia',
  'Turkey':           'Republic of Türkiye',
};

// ── Color scale ───────────────────────────────────────────────────
// Unvisited:  light warm grey
// Visited:    soft blue (#b8cfe0) → teal (#5a9e8a) → deep sage (#2e6654)
// The gradient is perceptually smooth and distinct from the base map.
function choroplethColor(visited, t) {
  if (!visited) return '#e5eae6'; // very light grey-sage for unvisited regions

  // t: 0 → 1 normalized intensity
  // 0   = at least one place, minimum visits  → soft blue-sage
  // 0.5 = medium                              → teal
  // 1.0 = most visited country                → deep sage
  const stops = [
    [0xc2, 0xd9, 0xd0], // #c2d9d0  soft sage-teal
    [0x6a, 0xaa, 0x94], // #6aaa94  mid teal
    [0x2e, 0x66, 0x54], // #2e6654  deep sage
  ];

  // Two-segment lerp
  let r, g, b;
  if (t <= 0.5) {
    const s = t * 2; // 0→1 in first half
    r = Math.round(stops[0][0] + (stops[1][0] - stops[0][0]) * s);
    g = Math.round(stops[0][1] + (stops[1][1] - stops[0][1]) * s);
    b = Math.round(stops[0][2] + (stops[1][2] - stops[0][2]) * s);
  } else {
    const s = (t - 0.5) * 2; // 0→1 in second half
    r = Math.round(stops[1][0] + (stops[2][0] - stops[1][0]) * s);
    g = Math.round(stops[1][1] + (stops[2][1] - stops[1][1]) * s);
    b = Math.round(stops[1][2] + (stops[2][2] - stops[1][2]) * s);
  }
  return `rgb(${r},${g},${b})`;
}

// ── GeoJSON layer factory ─────────────────────────────────────────
let _choroplethLayer = null;

function _chorMakeLayer(geoData, nameKey, rd, stats, keyPrefix) {
  // stats: { min, max } of effectiveVisits across all visited regions

  function lookupRegion(rawName) {
    if (keyPrefix) {
      // US states: prefix + exact match
      return rd[keyPrefix + rawName] || null;
    }
    // Countries: try raw name first, then GEO_TO_APP translation, then APP_TO_GEO reverse
    const appName  = _GEO_TO_APP[rawName] || rawName;
    const geoName  = _APP_TO_GEO[rawName] || rawName;
    return rd[rawName] || rd[appName] || rd[geoName] || null;
  }

  function styleFeature(feature) {
    const rawName = feature.properties[nameKey];
    if (!rawName) return { fillColor: '#e5eae6', fillOpacity: 0.3, color: '#c8d4cc', weight: 0.5, opacity: 0.6 };

    const d       = lookupRegion(rawName);
    const visited = !!d && d.places.length > 0;
    const t       = visited
      ? _normalize(d.effectiveVisits, stats.min, stats.max)
      : 0;
    const fill    = choroplethColor(visited, t);

    return {
      fillColor:   fill,
      fillOpacity: visited ? 0.82 : 0.28,
      color:       visited ? '#ffffff' : '#d0dbd4',
      weight:      visited ? 0.8 : 0.4,
      opacity:     0.9,
    };
  }

  const layer = L.geoJSON(geoData, {
    style: styleFeature,
    onEachFeature: (feature, lyr) => {
      const rawName = feature.properties[nameKey];
      const d = lookupRegion(rawName);

      lyr.on({
        mouseover: e => {
          if (!e.target) return;
          const d2 = lookupRegion(e.target.feature.properties[nameKey]);
          e.target.setStyle({
            fillOpacity: d2 && d2.places.length ? 0.96 : 0.45,
            weight:      1.8,
            color:       '#2e6654',
          });
          if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
            e.target.bringToFront();
          }
        },
        mouseout: e => {
          if (e.target) layer.resetStyle(e.target);
        },
        click: e => {
          const name = feature.properties[nameKey];
          const regionD = lookupRegion(name);
          if (!regionD || !regionD.places.length) {
            lyr.bindPopup(
              `<div style="font-family:var(--sys);padding:4px 0;">
                <strong style="font-size:13px;">${escHtml(name)}</strong><br>
                <span style="color:var(--text-muted);font-size:11px;">No places visited yet</span>
              </div>`
            ).openPopup();
            return;
          }
          const topPlaces = regionD.places.slice(0, 5).map(p => {
            const rating = p.avgRating ? ` <strong style="color:var(--dark-sage);">${p.avgRating.toFixed(1)}★</strong>` : '';
            return `<div style="font-size:11px;color:var(--text-muted);margin-top:3px;padding-left:8px;">· ${escHtml(p.name)}${rating}</div>`;
          }).join('');
          const more = regionD.places.length > 5
            ? `<div style="font-size:10px;color:var(--text-light);margin-top:4px;padding-left:8px;">+${regionD.places.length - 5} more</div>` : '';
          const avgStr = regionD.avgRating ? ` · ${regionD.avgRating.toFixed(1)}★ avg` : '';
          lyr.bindPopup(
            `<div style="font-family:var(--sys);min-width:170px;padding:4px 0;">
              <div style="font-weight:800;font-size:14px;margin-bottom:5px;">${escHtml(name)}</div>
              <div style="font-size:11px;color:var(--text-muted);margin-bottom:8px;">
                ${regionD.places.length} place${regionD.places.length !== 1 ? 's' : ''} · ${regionD.visits} visit${regionD.visits !== 1 ? 's' : ''}${avgStr}
              </div>
              ${topPlaces}${more}
            </div>`,
            { maxWidth: 240 }
          ).openPopup();
        },
      });
    },
  });

  // Debug: count matches
  let matchCount = 0;
  geoData.features.forEach(f => {
    if (lookupRegion(f.properties[nameKey])?.places.length) matchCount++;
  });
  if (matchCount === 0 && Object.keys(rd).filter(k => !k.startsWith('STATE:')).length > 0) {
    console.warn('[choropleth] REGION KEY MISMATCH — 0 features matched. Sample GeoJSON ADMIN:', geoData.features[0]?.properties[nameKey]);
  } else {
    console.log(`[choropleth] matched ${matchCount} features (${keyPrefix || 'countries'})`);
  }

  return layer;
}

// ── Main render function ──────────────────────────────────────────
async function renderChoropleth() {
  // Capture generation ID at entry — if it changes before we finish,
  // a newer render was requested and we should discard our results.
  const myGen = ++_chorRenderGen;

  // Remove any existing choropleth layer immediately (synchronous)
  if (_choroplethLayer) {
    leafletMap.removeLayer(_choroplethLayer);
    _choroplethLayer = null;
  }
  if (mapWishLayer) {
    leafletMap.removeLayer(mapWishLayer);
    mapWishLayer = null;
  }

  const rd = buildRegionData();

  // Edge case: no regional data at all
  const countryKeys = Object.keys(rd).filter(k => !k.startsWith('STATE:'));
  if (countryKeys.length === 0) {
    console.log('[choropleth] no regional data — showing empty state');
    _chorShowNoData();
    return;
  }

  // Compute normalisation stats across visited regions only
  const visitedValues = countryKeys
    .filter(k => rd[k].places.length > 0)
    .map(k => rd[k].effectiveVisits);
  const statsMin = visitedValues.length ? Math.min(...visitedValues) : 0;
  const statsMax = visitedValues.length ? Math.max(...visitedValues) : 1;
  console.log(`[choropleth] visits range: min=${statsMin} max=${statsMax}`);

  const hasUSStates = Object.keys(rd).some(k => k.startsWith('STATE:'));

  // Fetch GeoJSON (served from cache after first load)
  let worldGeo, statesGeo;
  try {
    if (hasUSStates) {
      [worldGeo, statesGeo] = await Promise.all([
        fetchGeo('https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson'),
        fetchGeo('https://raw.githubusercontent.com/PublicaMundi/MappingAPI/master/data/geojson/us-states.json'),
      ]);
    } else {
      worldGeo = await fetchGeo('https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson');
    }
  } catch(e) {
    console.error('[choropleth] GeoJSON fetch failed:', e);
    if (myGen !== _chorRenderGen) return; // stale — another render started
    _chorShowError();
    return;
  }

  // Stale check: user may have switched modes during the fetch
  if (myGen !== _chorRenderGen) {
    console.log('[choropleth] render', myGen, 'is stale — discarding');
    return;
  }
  if (!leafletMap || mapMode !== 'choropleth') return;

  const layerGroup = L.layerGroup();

  // World countries layer
  console.log('[choropleth] world ADMIN sample:', worldGeo.features?.[0]?.properties?.ADMIN);
  _chorMakeLayer(worldGeo, 'ADMIN', rd, { min: statsMin, max: statsMax }, '').addTo(layerGroup);

  // US states overlay (renders on top, covering the US polygon)
  if (statesGeo) {
    const stateValues = Object.keys(rd)
      .filter(k => k.startsWith('STATE:') && rd[k].places.length > 0)
      .map(k => rd[k].effectiveVisits);
    const sMin = stateValues.length ? Math.min(...stateValues) : 0;
    const sMax = stateValues.length ? Math.max(...stateValues) : 1;
    _chorMakeLayer(statesGeo, 'name', rd, { min: sMin, max: sMax }, 'STATE:').addTo(layerGroup);
  }

  _choroplethLayer = layerGroup;
  layerGroup.addTo(leafletMap);

  // Add wishlist markers on top, after GeoJSON polygons are in place
  _mapAddWishlistLayer();

  // Fit to visited places
  const visitedPlaces = DB.places.filter(p => p.lat && p.lng && p.country);
  if (visitedPlaces.length) {
    leafletMap.fitBounds(
      L.latLngBounds(visitedPlaces.map(p => [p.lat, p.lng])).pad(0.12)
    );
  }
}

// ── Edge case: no regional data overlay ──────────────────────────
function _chorShowNoData() {
  const container = leafletMap.getContainer();
  // Remove any existing overlay
  container.querySelectorAll('._chor-overlay').forEach(el => el.remove());
  const el = document.createElement('div');
  el.className = '_chor-overlay';
  el.style.cssText = [
    'position:absolute', 'top:50%', 'left:50%',
    'transform:translate(-50%,-50%)',
    'background:var(--surface)', 'border:1px solid var(--border)',
    'border-radius:14px', 'padding:18px 22px', 'z-index:500',
    'text-align:center', 'font-family:var(--sys)', 'max-width:260px',
    'box-shadow:0 4px 20px rgba(28,36,32,0.12)', 'pointer-events:none',
  ].join(';');
  el.innerHTML = `
    <div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:5px;">No regional data yet</div>
    <div style="font-size:12px;color:var(--text-muted);line-height:1.55;">
      Add places with a country to see them shaded on the map.
    </div>`;
  container.style.position = 'relative';
  container.appendChild(el);
  // Auto-remove when mode changes
  setTimeout(() => el.remove(), 8000);
}

// ── Edge case: GeoJSON fetch error overlay ────────────────────────
function _chorShowError() {
  const container = leafletMap.getContainer();
  container.querySelectorAll('._chor-overlay').forEach(el => el.remove());
  const el = document.createElement('div');
  el.className = '_chor-overlay';
  el.style.cssText = [
    'position:absolute', 'top:50%', 'left:50%',
    'transform:translate(-50%,-50%)',
    'background:var(--surface)', 'border:1px solid var(--border)',
    'border-radius:14px', 'padding:18px 22px', 'z-index:500',
    'text-align:center', 'font-family:var(--sys)', 'max-width:280px',
    'box-shadow:0 4px 20px rgba(28,36,32,0.12)',
  ].join(';');
  el.innerHTML = `
    <div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:5px;">Regions unavailable</div>
    <div style="font-size:12px;color:var(--text-muted);line-height:1.55;margin-bottom:12px;">
      Map region outlines could not be loaded. Check your connection and try again.
    </div>
    <button style="padding:7px 16px;border-radius:8px;border:none;background:var(--dark-sage);color:#fff;font-size:12px;font-weight:700;cursor:pointer;font-family:var(--sys);"
      onclick="this.closest('._chor-overlay').remove();document.querySelector('.map-mode-btn[data-mode=markers]').click();">
      Switch to Markers
    </button>`;
  container.style.position = 'relative';
  container.appendChild(el);
}

// ═══════════════════════════════════════════
//  MODAL HELPERS
// ═══════════════════════════════════════════
function openModal(id){document.getElementById(id).classList.add('open');document.body.classList.add('modal-open');}
function closeModal(id){document.getElementById(id).classList.remove('open');if(!document.querySelector('.modal-overlay.open'))document.body.classList.remove('modal-open');}
['modal-add-place','modal-add-visit','modal-add-trip','modal-add-wish','modal-add-choice'].forEach(id=>{
  document.getElementById(id).addEventListener('click',e=>{if(e.target===document.getElementById(id))closeModal(id);});
});

// ═══════════════════════════════════════════
//  UTILS
// ═══════════════════════════════════════════
function formatDate(str){if(!str)return'—';const[y,m,d]=str.split('-');const months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];return`${months[parseInt(m)-1]} ${parseInt(d)}, ${y}`;}
function formatVisitDate(v){
  const s=v.startDate||v.date; if(!s) return '—';
  const e=v.endDate; if(!e||e===s) return formatDate(s);
  const [sy,sm,sd]=s.split('-'); const [ey,em,ed]=e.split('-');
  const months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  if(sy===ey){
    if(sm===em) return `${months[parseInt(sm)-1]} ${parseInt(sd)}–${parseInt(ed)}, ${sy}`;
    return `${months[parseInt(sm)-1]} ${parseInt(sd)} – ${months[parseInt(em)-1]} ${parseInt(ed)}, ${sy}`;
  }
  return `${formatDate(s)} – ${formatDate(e)}`;
}
function visitSpansDate(v,dateStr){
  const s=v.startDate||v.date; if(!s) return false;
  const e=v.endDate||s;
  return dateStr>=s && dateStr<=e;
}
function visitDayCount(v){
  const s=v.startDate||v.date; const e=v.endDate||s; if(!s) return 1;
  return Math.round((new Date(e)-new Date(s))/86400000)+1;
}
function formatTime(iso){if(!iso)return'';const d=new Date(iso);return d.toLocaleDateString('en-US',{month:'short',day:'numeric'})+' '+d.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});}
function escHtml(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function toast(msg){const t=document.createElement('div');t.className='toast';t.textContent=msg;document.body.appendChild(t);setTimeout(()=>t.remove(),2500);}

// ═══════════════════════════════════════════
//  SEED DATA
// ═══════════════════════════════════════════
function seedDemoData(){
  if(DB.places.length>0) return;
  const p1={id:uid(),name:'The Inn at Little Washington',city:'Washington',state:'Virginia',country:'United States',lat:38.7118,lng:-78.1618,altitude:520,mapsUrl:'',category:'Restaurant',subTags:['Fine Dining','Tasting Menu'],defaultVisitedWith:['Just Us'],totalVisits:0,hunterAvg:0,brandonAvg:0,avgRating:0,firstVisited:null,photos:[]};
  const p2={id:uid(),name:'Amalfi Coast',city:'Ravello',state:'Campania',country:'Italy',lat:40.6476,lng:14.6147,altitude:180,mapsUrl:'',category:'City / Neighborhood',subTags:['Scenic','UNESCO'],defaultVisitedWith:['Just Us','Mom'],totalVisits:0,hunterAvg:0,brandonAvg:0,avgRating:0,firstVisited:null,photos:[]};
  const p3={id:uid(),name:'Eleven Madison Park',city:'New York',state:'New York',country:'United States',lat:40.7416,lng:-73.9867,altitude:10,mapsUrl:'',category:'Restaurant',subTags:['Fine Dining','Plant-Based'],defaultVisitedWith:['Just Us'],totalVisits:0,hunterAvg:0,brandonAvg:0,avgRating:0,firstVisited:null,photos:[]};
  savePlace(p1);savePlace(p2);savePlace(p3);
  const t1={id:uid(),name:'Italy 2023',startDate:'2023-09-18',endDate:'2023-09-28',primaryCity:'Rome',primaryCountry:'Italy',notes:'Ten magical days.',tags:['Europe','Anniversary']};
  saveTrip(t1);
  const v1={id:uid(),placeId:p1.id,date:'2024-06-14',hunterRating:4.5,brandonRating:5,visitedWith:['Just Us'],notes:[{id:uid(),author:'Hunter',text:"Absolutely stunning tasting menu. Patrick O'Connell is a genius.",ts:'2024-06-14T21:00:00Z'},{id:uid(),author:'Brandon',text:'The cheese trolley. I still dream about it.',ts:'2024-06-14T21:05:00Z'}],tripId:null,photos:[]};
  const v2={id:uid(),placeId:p2.id,date:'2023-09-22',hunterRating:5,brandonRating:4.5,visitedWith:['Just Us','Mom'],notes:[{id:uid(),author:'Other',text:'Arrived by ferry from Salerno. Golden hour light was magical.',ts:'2023-09-22T18:00:00Z'}],tripId:t1.id,photos:[]};
  const v3={id:uid(),placeId:p3.id,date:'2024-09-01',hunterRating:4,brandonRating:4.5,visitedWith:['Just Us'],notes:[],tripId:null,photos:[]};
  saveVisit(v1);saveVisit(v2);saveVisit(v3);
  const w1={id:uid(),name:'Noma',city:'Copenhagen',country:'Denmark',lat:55.6895,lng:12.5989,category:'Restaurant',subTags:['Fermentation','Nordic'],priority:'high',desireRating:5,notes:'Must go.',dateAdded:new Date().toISOString()};
  const w2={id:uid(),name:'Kyoto in Cherry Blossom',city:'Kyoto',country:'Japan',lat:35.0116,lng:135.7681,category:'City / Neighborhood',subTags:['Culture','Seasonal'],priority:'high',desireRating:4.5,notes:'Spring 2025.',dateAdded:new Date().toISOString()};
  saveWish(w1);saveWish(w2);
}

// ═══════════════════════════════════════════
//  PHASE III — METRICS CACHE (precomputed once per data change)
//  Cached in memory; recomputed when DB changes.
// ═══════════════════════════════════════════

let _metricsCache = null; // { data, placesHash }

/** Lightweight hash to detect data changes without deep comparison */
function dataHash() {
  const p = DB.places, v = DB.visits, w = DB.wishlist;
  return `${p.length}|${v.length}|${w.length}|${(p[0]?.id||'')}|${(v[0]?.id||'')}`;
}

/**
 * Precompute all metrics used by Discover and Stats.
 * Called lazily; results cached until data changes.
 */
function getMetrics() {
  const h = dataHash();
  if (_metricsCache && _metricsCache.hash === h) return _metricsCache.data;

  const places   = DB.places;
  const visits   = DB.visits;
  const wishlist = DB.wishlist;
  const trips    = DB.trips;
  const now      = Date.now();
  const MS_DAY   = 86400000;

  // — Per-category scores —
  const catScores   = {}; // { cat: { h:[], b:[], combined:[] } }
  visits.forEach(v => {
    const p = places.find(x => x.id === v.placeId); if (!p || !p.category) return;
    if (!catScores[p.category]) catScores[p.category] = { h:[], b:[], combined:[] };
    if (v.hunterRating  > 0) catScores[p.category].h.push(v.hunterRating);
    if (v.brandonRating > 0) catScores[p.category].b.push(v.brandonRating);
    if (v.hunterRating > 0 || v.brandonRating > 0) {
      const both = [v.hunterRating, v.brandonRating].filter(r => r > 0);
      catScores[p.category].combined.push(...both);
    }
  });
  const catAvg = {}; // { cat: { hunter, brandon, combined, variance } }
  Object.entries(catScores).forEach(([cat, s]) => {
    const avg = arr => arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : 0;
    const variance = arr => {
      if (arr.length < 2) return 0;
      const m = avg(arr);
      return arr.reduce((s,v) => s + (v-m)**2, 0) / arr.length;
    };
    catAvg[cat] = {
      hunter:   avg(s.h),
      brandon:  avg(s.b),
      combined: avg(s.combined),
      variance: variance(s.combined)
    };
  });

  // — Top 5 loved categories (by combined avg, min 1 rating) —
  const top5Cats = Object.entries(catAvg)
    .filter(([,v]) => v.combined >= 3.5)
    .sort((a,b) => b[1].combined - a[1].combined)
    .slice(0, 5)
    .map(([cat]) => cat);

  // — High-rated sub-tags —
  const tagFreq = {};
  visits.forEach(v => {
    const p = places.find(x => x.id === v.placeId);
    if (!p || v.hunterRating < 4 && v.brandonRating < 4) return;
    (p.subTags || []).forEach(t => { tagFreq[t] = (tagFreq[t]||0) + 1; });
  });
  const topTags = Object.entries(tagFreq).sort((a,b)=>b[1]-a[1]).slice(0,10).map(([t])=>t);

  // — Country stats —
  const countryVisits  = {}; // { country: visit count }
  const countryRatings = {}; // { country: [ratings] }
  const countryLastVisit = {}; // { country: ms timestamp }
  visits.forEach(v => {
    const p = places.find(x => x.id === v.placeId); if (!p || !p.country) return;
    countryVisits[p.country] = (countryVisits[p.country]||0) + 1;
    if (!countryRatings[p.country]) countryRatings[p.country] = [];
    if (v.hunterRating > 0)  countryRatings[p.country].push(v.hunterRating);
    if (v.brandonRating > 0) countryRatings[p.country].push(v.brandonRating);
    const ts = new Date(v.startDate||v.date).getTime();
    if (!countryLastVisit[p.country] || ts > countryLastVisit[p.country])
      countryLastVisit[p.country] = ts;
  });
  const countryAvgRating = {};
  Object.entries(countryRatings).forEach(([c, arr]) => {
    countryAvgRating[c] = arr.reduce((a,b)=>a+b,0) / arr.length;
  });
  const mostVisitedCountries = Object.entries(countryVisits)
    .sort((a,b)=>b[1]-a[1]).map(([c])=>c);

  // — Most active travel month —
  const monthCounts = Array(12).fill(0);
  visits.forEach(v => { const _d=v.startDate||v.date; if (_d) monthCounts[parseInt(_d.slice(5,7))-1]++; });
  const mostActiveMonth = monthCounts.indexOf(Math.max(...monthCounts));

  // — Month × country performance: { "country:month": [ratings] } —
  const seasonPerf = {};
  visits.forEach(v => {
    const p = places.find(x => x.id === v.placeId); const _vd=v.startDate||v.date; if (!p || !p.country || !_vd) return;
    const mo = parseInt(_vd.slice(5,7));
    const key = `${p.country}:${mo}`;
    if (!seasonPerf[key]) seasonPerf[key] = [];
    if (v.hunterRating  > 0) seasonPerf[key].push(v.hunterRating);
    if (v.brandonRating > 0) seasonPerf[key].push(v.brandonRating);
  });
  const seasonAvg = {};
  Object.entries(seasonPerf).forEach(([k, arr]) => {
    seasonAvg[k] = arr.reduce((a,b)=>a+b,0)/arr.length;
  });

  // — Average altitude of highly rated places —
  const highRatedAlts = places.filter(p => p.altitude && p.avgRating >= 4.2).map(p => p.altitude);
  const avgHighAlt = highRatedAlts.length ? highRatedAlts.reduce((a,b)=>a+b,0)/highRatedAlts.length : 0;

  // — Days since last visit per country —
  const daysSinceLast = {};
  Object.entries(countryLastVisit).forEach(([c, ts]) => {
    daysSinceLast[c] = Math.floor((now - ts) / MS_DAY);
  });

  const data = {
    catAvg, top5Cats, topTags,
    countryVisits, countryAvgRating, mostVisitedCountries,
    countryLastVisit, daysSinceLast, mostActiveMonth,
    seasonAvg, avgHighAlt, monthCounts,
    // also cache full stats for Stats page
    trips, places, visits, wishlist
  };
  _metricsCache = { hash: h, data };
  return data;
}

/** Call after any DB write to invalidate cache */
function invalidateMetrics() { _metricsCache = null; }

// Patch save functions to invalidate cache
function savePlace(p)      { _origSavePlace(p);   invalidateMetrics(); }
function saveVisit(v)      { _origSaveVisit(v);   invalidateMetrics(); }
function saveTrip(t)       { _origSaveTrip(t);    invalidateMetrics(); }
function saveWish(w)       { _origSaveWish(w);    invalidateMetrics(); }
function deletePlace(id)   { _origDeletePlace(id);invalidateMetrics(); }
function deleteVisit(id)   { _origDeleteVisit(id);invalidateMetrics(); }
function deleteTrip(id)    { _origDeleteTrip(id); invalidateMetrics(); }
function deleteWish(id)    { _origDeleteWish(id); invalidateMetrics(); }


// ═══════════════════════════════════════════
//  PHASE III — DISCOVER ENGINE
// ═══════════════════════════════════════════

// Current discover UI state
let discMood = 'mixed', discEnergy = 'medium';

// Wire mood buttons
document.querySelectorAll('.mood-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    discMood = btn.dataset.mood;
  });
});
// Wire energy buttons
document.querySelectorAll('.energy-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.energy-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    discEnergy = btn.dataset.energy;
  });
});

document.getElementById('disc-generate-btn').addEventListener('click', runDiscover);

/**
 * Build candidate destinations from wishlist items grouped by country.
 * Each candidate = { country, city, items:[], category counts }
 */
function buildCandidates() {
  const wishlist = DB.wishlist;
  const places   = DB.places;
  if (!wishlist.length) return [];

  // Group by country (and city if available)
  const grouped = {};
  wishlist.forEach(w => {
    const key = w.country || 'Unknown';
    if (!grouped[key]) grouped[key] = { country: key, cities: {}, items: [] };
    grouped[key].items.push(w);
    if (w.city) grouped[key].cities[w.city] = (grouped[key].cities[w.city]||0) + 1;
  });

  return Object.values(grouped).map(g => {
    const primaryCity = Object.entries(g.cities).sort((a,b)=>b[1]-a[1])[0]?.[0] || '';
    const cats = {};
    g.items.forEach(w => { if (w.category) cats[w.category] = (cats[w.category]||0)+1; });
    // Check if visited before
    const countryPlaces = places.filter(p => p.country === g.country);
    const visited = countryPlaces.length > 0;
    const lastVisitDates = DB.visits
      .filter(v => countryPlaces.some(p => p.id === v.placeId))
      .map(v => v.startDate||v.date).sort().reverse();
    const lastVisit = lastVisitDates[0] || null;
    const avgRating = countryPlaces.filter(p=>p.avgRating>0).reduce((s,p,_,a)=>s+p.avgRating/a.length,0)||0;
    return { ...g, primaryCity, cats, visited, lastVisit, avgRating };
  });
}

/**
 * COMPONENT 1 — Wishlist Density & Desire Score (max 30)
 * WishlistScore = (ItemCount×5) + (AvgDesire×4) + (PriorityWeight×3), capped at 30
 */
function scoreWishlistDensity(candidate) {
  const items = candidate.items;
  const itemCount = Math.min(items.length, 4); // diminishing returns after 4
  const avgDesire = items.reduce((s,w)=>(s+(w.desireRating||3)),0)/items.length;
  const priorityWeight = items.reduce((s,w)=>{
    return s + (w.priority==='high' ? 3 : w.priority==='medium' ? 2 : 1);
  },0) / items.length;
  return Math.min(30, itemCount*5 + avgDesire*4 + priorityWeight*3);
}

/**
 * COMPONENT 2 — Category Alignment (max 25)
 * Count wishlist categories matching Top 5 loved categories, weighted by combined score
 */
function scoreCategoryAlignment(candidate, metrics) {
  const { top5Cats, catAvg } = metrics;
  if (!top5Cats.length) return 12; // neutral when no history
  const candCats = Object.keys(candidate.cats);
  let score = 0;
  candCats.forEach(cat => {
    if (top5Cats.includes(cat)) {
      const ca = catAvg[cat];
      score += ca ? ca.combined * 1.2 : 3;
    }
  });
  return Math.min(25, score);
}

/**
 * COMPONENT 3 — Novelty vs Revisit Balance (max 15)
 */
function scoreNovelty(candidate, metrics) {
  const { daysSinceLast, countryAvgRating } = metrics;
  const country = candidate.country;
  if (!candidate.visited) return 15; // New country: max novelty
  const days = daysSinceLast[country] || 0;
  const avg  = countryAvgRating[country] || 0;
  // New city in visited country
  const knownCities = new Set(DB.places.filter(p=>p.country===country).map(p=>p.city).filter(Boolean));
  const newCity = candidate.primaryCity && !knownCities.has(candidate.primaryCity);
  if (newCity) return 10;
  // Loved revisit (highly rated + >1 year gap)
  if (avg >= 4.2 && days > 365) return 12;
  if (avg >= 4.2 && days > 180) return 8;
  return 5; // Recent or low-rated revisit
}

/**
 * COMPONENT 4 — Agreement & Stability (max 15)
 * Boost destinations whose categories have low variance and dual high ratings
 */
function scoreAgreement(candidate, metrics) {
  const { catAvg } = metrics;
  const candCats = Object.keys(candidate.cats);
  let matches = 0;
  candCats.forEach(cat => {
    const ca = catAvg[cat];
    if (!ca) return;
    if (ca.variance < 1.0 && ca.hunter >= 4.0 && ca.brandon >= 4.0) matches += 2;
    else if (ca.hunter >= 4.0 || ca.brandon >= 4.0) matches += 1;
  });
  return Math.min(15, matches * 3.5);
}

/**
 * COMPONENT 5 — Seasonal & Pattern Match (max 15)
 */
function scoreSeasonal(candidate, metrics, selectedMonth) {
  if (!selectedMonth) return 7; // no month selected: partial score
  const { seasonAvg } = metrics;
  const mo = parseInt(selectedMonth);
  const key = `${candidate.country}:${mo}`;
  const avg = seasonAvg[key];
  if (avg === undefined) return 5;    // no data
  if (avg >= 4.2) return 15;          // high-performing season
  if (avg >= 3.5) return 8;           // partial match
  return 3;                            // poor season historically
}

/**
 * Mood modifier: adjust score based on mood + category match
 */
function moodModifier(candidate, mood) {
  const moodCatMap = {
    'food-focused': ['Restaurant','Bar / Cocktail','Brewery / Winery','Market / Shop'],
    'culture':      ['Museum / Culture','City / Neighborhood','Experience'],
    'nature':       ['Hike / Nature','Beach','City / Neighborhood'],
    'relaxing':     ['Beach','Hotel / Lodging','City / Neighborhood'],
    'romantic':     ['Restaurant','Hotel / Lodging','Experience','Beach'],
    'energetic':    ['Hike / Nature','Experience','Market / Shop'],
    'mixed':        [] // no modifier
  };
  const moodCats = moodCatMap[mood] || [];
  if (!moodCats.length) return 0;
  const overlap = Object.keys(candidate.cats).filter(c => moodCats.includes(c)).length;
  return overlap >= 2 ? 5 : overlap === 1 ? 2 : -3;
}

/**
 * Compute composite score (0–100) for a candidate destination
 */
function scoreCandidate(candidate, metrics, selectedMonth, mood) {
  const s1 = scoreWishlistDensity(candidate);
  const s2 = scoreCategoryAlignment(candidate, metrics);
  const s3 = scoreNovelty(candidate, metrics);
  const s4 = scoreAgreement(candidate, metrics);
  const s5 = scoreSeasonal(candidate, metrics, selectedMonth);
  const mod = moodModifier(candidate, mood);
  const total = Math.min(100, Math.max(0, s1+s2+s3+s4+s5+mod));
  return { total, components: { wishlist:s1, category:s2, novelty:s3, agreement:s4, seasonal:s5 } };
}

/**
 * Determine confidence level based on data availability
 */
function getConfidence(candidate, metrics) {
  const { catAvg, seasonAvg } = metrics;
  const hasSeasonData = Object.keys(seasonAvg).some(k => k.startsWith(candidate.country+':'));
  const hasCatData    = Object.keys(candidate.cats).some(c => catAvg[c]);
  const dataPoints    = candidate.items.length + (hasCatData?2:0) + (hasSeasonData?2:0);
  if (dataPoints >= 5) return 'high';
  if (dataPoints >= 3) return 'medium';
  return 'low';
}

/**
 * Build human-readable explanation bullets from scoring components
 */
function buildReasons(candidate, scored, metrics, mood, selectedMonth) {
  const { catAvg, top5Cats, countryAvgRating, daysSinceLast } = metrics;
  const reasons = [];
  const { components: c } = scored;

  // Wishlist
  if (c.wishlist >= 20) reasons.push(`${candidate.items.length} wishlist item${candidate.items.length>1?'s':''} with strong desire ratings`);
  else if (c.wishlist >= 10) reasons.push(`${candidate.items.length} wishlist item${candidate.items.length>1?'s':''}` + (candidate.items[0]?.priority==='high' ? ' (high priority)' : ''));

  // Category
  const matchedCats = Object.keys(candidate.cats).filter(cat => top5Cats.includes(cat));
  if (matchedCats.length) reasons.push(`Matches your top-loved categories: ${matchedCats.slice(0,2).join(', ')}`);

  // Novelty
  if (!candidate.visited) reasons.push(`Never visited ${candidate.country} \u2014 maximum novelty`);
  else if (c.novelty >= 12) {
    const days = daysSinceLast[candidate.country]||0;
    reasons.push(`Last visited ${candidate.country} ${Math.round(days/30)} months ago; you loved it (${(countryAvgRating[candidate.country]||0).toFixed(1)} avg)`);
  }

  // Agreement
  const stableMatch = Object.keys(candidate.cats).filter(cat => {
    const ca = catAvg[cat]; return ca && ca.variance < 1.0 && ca.hunter >= 4.0 && ca.brandon >= 4.0;
  });
  if (stableMatch.length) reasons.push(`You both consistently rate ${stableMatch[0]} highly with low variance`);

  // Seasonal
  if (selectedMonth && c.seasonal >= 12) {
    const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    reasons.push(`${months[parseInt(selectedMonth)-1]} is a historically strong month for ${candidate.country}`);
  }

  // Mood
  if (mood !== 'mixed') {
    const moodLabels = {'food-focused':'food experiences','culture':'culture & arts','nature':'nature & outdoors','relaxing':'relaxing escapes','romantic':'romantic settings','energetic':'active adventures'};
    reasons.push(`Wishlist aligns with your ${moodLabels[mood]||mood} preference`);
  }

  return reasons.slice(0, 5);
}

/** Main discover function — runs scoring and renders results */
function runDiscover() {
  const metrics       = getMetrics();
  const selectedMonth = document.getElementById('disc-month').value;
  const region        = document.getElementById('disc-region').value.trim().toLowerCase();
  const btn           = document.getElementById('disc-generate-btn');
  const resultEl      = document.getElementById('discover-result');

  btn.textContent = 'Analyzing\u2026'; btn.disabled = true;
  setTimeout(() => { btn.textContent = 'Generate Suggestion'; btn.disabled = false; }, 600);

  let candidates = buildCandidates();

  if (!candidates.length) {
    resultEl.className = 'discover-result visible';
    resultEl.innerHTML = `<div class="disc-empty">Add items to your Wishlist first to get smart suggestions.</div>`;
    return;
  }

  // Filter by region if specified
  if (region) {
    const filtered = candidates.filter(c =>
      c.country.toLowerCase().includes(region) ||
      c.primaryCity.toLowerCase().includes(region)
    );
    if (filtered.length) candidates = filtered;
  }

  // Score all candidates
  const scored = candidates.map(c => ({
    candidate: c,
    scored: scoreCandidate(c, metrics, selectedMonth, discMood)
  })).sort((a,b) => b.scored.total - a.scored.total);

  if (!scored.length) {
    resultEl.className = 'discover-result visible';
    resultEl.innerHTML = `<div class="disc-empty">No matching destinations found. Try clearing the region filter.</div>`;
    return;
  }

  const primary    = scored[0];
  const alts       = scored.slice(1, 3);
  // Wildcard = highest novelty score
  const wildcard   = [...scored].sort((a,b) =>
    (b.scored.components.novelty + (b.candidate.visited?0:5)) -
    (a.scored.components.novelty + (a.candidate.visited?0:5))
  ).find(s => s.candidate.country !== primary.candidate.country) || scored[scored.length-1];

  const confidence  = getConfidence(primary.candidate, metrics);
  const reasons     = buildReasons(primary.candidate, primary.scored, metrics, discMood, selectedMonth);
  const score       = Math.round(primary.scored.total);

  // SVG ring for score
  const pct     = score / 100;
  const r       = 22, circ = 2 * Math.PI * r;
  const dashArr = `${(pct * circ).toFixed(1)} ${circ.toFixed(1)}`;
  const ringColor = score >= 70 ? '#6e8175' : score >= 45 ? '#859eac' : '#c4b8b7';

  const renderAlt = (item, label) => {
    if (!item) return '';
    const s = Math.round(item.scored.total);
    const loc = [item.candidate.primaryCity, item.candidate.country].filter(Boolean).join(', ');
    return `<div class="disc-alt-card"><div class="disc-alt-label">${label}</div>
      <div class="disc-alt-name">${escHtml(item.candidate.country)}</div>
      <div class="disc-alt-loc">${escHtml(loc)}</div>
      <div class="disc-alt-score">Score: ${s}/100</div></div>`;
  };

  const wcLoc = [wildcard.candidate.primaryCity, wildcard.candidate.country].filter(Boolean).join(', ');

  resultEl.className = 'discover-result visible';
  resultEl.innerHTML = `
    <div class="disc-primary">
      <div class="disc-primary-header">
        <div class="disc-primary-label">Top Suggestion</div>
        <div class="disc-primary-name">${escHtml(primary.candidate.country)}</div>
        <div class="disc-primary-loc">${escHtml([primary.candidate.primaryCity, primary.candidate.country].filter(Boolean).join(', '))}</div>
      </div>
      <div class="disc-score-row">
        <svg class="disc-score-ring" width="60" height="60" viewBox="0 0 60 60">
          <circle cx="30" cy="30" r="${r}" fill="none" stroke="#eef0ed" stroke-width="5"/>
          <circle cx="30" cy="30" r="${r}" fill="none" stroke="${ringColor}" stroke-width="5"
            stroke-dasharray="${dashArr}" stroke-dashoffset="${circ*0.25}" stroke-linecap="round"
            transform="rotate(-90 30 30)"/>
          <text x="30" y="35" text-anchor="middle" font-family="var(--sys-d)" font-size="13" font-weight="700" fill="${ringColor}">${score}</text>
        </svg>
        <div class="disc-score-info">
          <div class="disc-score-num">${score}<span style="font-size:16px;">/100</span></div>
          <span class="disc-confidence ${confidence}">${confidence.charAt(0).toUpperCase()+confidence.slice(1)} confidence</span>
        </div>
        <div style="display:flex;flex-direction:column;gap:4px;font-size:10px;color:var(--text-light);">
          <span>Wishlist: ${Math.round(primary.scored.components.wishlist)}/30</span>
          <span>Category: ${Math.round(primary.scored.components.category)}/25</span>
          <span>Novelty: ${Math.round(primary.scored.components.novelty)}/15</span>
        </div>
      </div>
      <div class="disc-reasons">
        <div class="disc-reasons-title">Why this was suggested</div>
        ${reasons.map(r=>`<div class="disc-reason-item"><div class="disc-reason-dot"></div><span>${escHtml(r)}</span></div>`).join('')}
      </div>
    </div>
    ${alts.length ? `<div class="disc-alts">${alts.map((a,i)=>renderAlt(a,i===0?'Alternative 1':'Alternative 2')).join('')}</div>` : ''}
    ${wildcard && wildcard.candidate.country !== primary.candidate.country ? `
    <div class="disc-wildcard">
      <div class="disc-wildcard-label">&#x2605; Wildcard — Highest Novelty</div>
      <div class="disc-wildcard-name">${escHtml(wildcard.candidate.country)}</div>
      <div class="disc-wildcard-sub">${escHtml(wcLoc)} &middot; Score: ${Math.round(wildcard.scored.total)}/100</div>
    </div>` : ''}`;
}


// ═══════════════════════════════════════════
//  PHASE III — ENHANCED STATS
// ═══════════════════════════════════════════

const CAT_COLORS=['#97ac9f','#859eac','#b0a89f','#c4b8b7','#7a9688','#6a8494','#8f7f7e','#adbfb4','#9eadb6','#c6afa4','#748c7c','#788f9c'];
const VW_COLORS =['#859eac','#97ac9f','#c4b8b7','#b07d60','#6a8494','#8f7f7e','#adbfb4','#c9a5a2','#748c7c','#9eadb6'];

let _statsDataHash = null;
let _statsYear     = 'all'; // 'all' | 4-digit string

/** Build inline SVG pie chart; returns SVG string. radius=50, viewBox 110x110 */
function makePieSVG(data, colors, size=100) {
  const total = data.reduce((s,d)=>s+d.value,0);
  if (!total) return `<svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}"><circle cx="${size/2}" cy="${size/2}" r="${size/2-4}" fill="var(--surface2)"/></svg>`;
  const cx=size/2, cy=size/2, r=size/2-4;
  let angle = -Math.PI/2, paths='';
  data.forEach((d,i) => {
    const sweep = 2*Math.PI*(d.value/total);
    const x1=cx+r*Math.cos(angle), y1=cy+r*Math.sin(angle);
    angle+=sweep;
    const x2=cx+r*Math.cos(angle), y2=cy+r*Math.sin(angle);
    const large=sweep>Math.PI?1:0;
    const color=colors[i%colors.length];
    paths+=`<path d="M${cx},${cy} L${x1.toFixed(2)},${y1.toFixed(2)} A${r},${r} 0 ${large},1 ${x2.toFixed(2)},${y2.toFixed(2)} Z" fill="${color}" stroke="var(--surface)" stroke-width="1.5"/>`;
  });
  return `<svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}" style="flex-shrink:0;">${paths}</svg>`;
}

/** Render a pie chart + legend side by side */
function renderPieSection(title, data, colors) {
  if (!data.length) return '';
  const total = data.reduce((s,d)=>s+d.value,0);
  const top = data.slice(0,8);
  const legend = top.map((d,i)=>`
    <div class="pie-legend-row">
      <div class="pie-legend-dot" style="background:${colors[i%colors.length]};"></div>
      <span class="pie-legend-name" title="${escHtml(d.label)}">${escHtml(d.label)}</span>
      <span class="pie-legend-pct">${Math.round(d.value/total*100)}%</span>
    </div>`).join('');
  return `
  <div class="stats-section">
    <div class="stats-section-label">${escHtml(title)}</div>
    <div class="stats-chart-card">
      <div class="pie-row">
        ${makePieSVG(top, colors, 90)}
        <div class="pie-legend-list">${legend}</div>
      </div>
    </div>
  </div>`;
}

/** Populate year tabs from visit dates */
function buildYearTabs() {
  const years = [...new Set(DB.visits.map(v=>(v.startDate||v.date)?.slice(0,4)).filter(Boolean))].sort().reverse();
  const wrap  = document.getElementById('stats-year-tabs');
  // Remove any previously injected year tabs (keep "All Time")
  wrap.querySelectorAll('[data-year]:not([data-year="all"])').forEach(b=>b.remove());
  years.forEach(yr => {
    const btn=document.createElement('button');
    btn.className='stats-year-tab';
    btn.dataset.year=yr;
    btn.textContent=yr;
    wrap.appendChild(btn);
  });
  wrap.querySelectorAll('.stats-year-tab').forEach(btn=>{
    btn.addEventListener('click',()=>{
      wrap.querySelectorAll('.stats-year-tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      _statsYear=btn.dataset.year;
      _statsDataHash=null; // force re-render
      renderStats();
    });
  });
}

function renderStats() {
  const h = dataHash() + '|' + _statsYear;
  if (_statsDataHash === h && document.getElementById('stats-container').innerHTML.length > 200) return;
  _statsDataHash = h;

  // Build year tabs once
  buildYearTabs();
  // Sync active state
  document.querySelectorAll('.stats-year-tab').forEach(b=>
    b.classList.toggle('active', b.dataset.year===_statsYear));

  const allPlaces  = DB.places;
  const allVisits  = DB.visits;
  const trips      = DB.trips;
  const wishlist   = DB.wishlist;

  // Filter by year if needed
  const visits = _statsYear==='all' ? allVisits
    : allVisits.filter(v=>v.date?.startsWith(_statsYear));
  // For places: only include those that have at least one visit in the filtered set
  const activePlaceIds = new Set(visits.map(v=>v.placeId));
  const places = _statsYear==='all' ? allPlaces
    : allPlaces.filter(p=>activePlaceIds.has(p.id));

  const countries = new Set(places.map(p=>p.country).filter(Boolean));
  const allH = visits.map(v=>v.hunterRating).filter(r=>r>0);
  const allB = visits.map(v=>v.brandonRating).filter(r=>r>0);
  const hAvg = allH.length ? allH.reduce((a,b)=>a+b,0)/allH.length : 0;
  const bAvg = allB.length ? allB.reduce((a,b)=>a+b,0)/allB.length : 0;
  const allRatings = [...allH,...allB];

  const container = document.getElementById('stats-container');
  container.innerHTML = '';

  const yearLabel = _statsYear==='all' ? 'All Time' : _statsYear;

  // ── OVERVIEW CARDS ──
  const totalWish      = wishlist.length;
  const convertedNames = new Set(allPlaces.map(p=>p.name.toLowerCase()));
  const converted      = wishlist.filter(w=>convertedNames.has(w.name.toLowerCase())).length;
  const wishConvRate   = totalWish ? Math.round(converted/totalWish*100)+'%' : '\u2014';
  container.innerHTML += `
  <div class="stats-section">
    <div class="stats-section-label">Overview — ${escHtml(yearLabel)}</div>
    <div class="stat-grid">
      <div class="stat-card clickable" id="stat-places-card"><div class="stat-label">Places</div><div class="stat-value">${places.length}</div></div>
      <div class="stat-card"><div class="stat-label">Visits</div><div class="stat-value">${visits.length}</div></div>
      <div class="stat-card"><div class="stat-label">Countries</div><div class="stat-value">${countries.size}</div><div class="stat-sub">${[...countries].slice(0,3).map(c=>`<span class="loc-chip" data-loc-type="country" data-loc-val="${escHtml(c)}">${escHtml(c)}</span>`).join(', ')}${countries.size>3?'\u2026':''}</div></div>
      <div class="stat-card trip-card"><div class="stat-label">Trips</div><div class="stat-value">${trips.length}</div></div>
    </div>
  </div>`;

  if (!visits.length) {
    container.innerHTML += `<div class="stats-section"><div class="empty-state" style="padding:30px 0;"><p>No visits recorded${_statsYear!=='all'?' in '+_statsYear:''}.</p></div></div>`;
    return;
  }

  // ── 1. RATING DISTRIBUTION BAR CHART ──
  // One entry per place: average of all visit ratings for that place
  const placeAvgRatings = [];
  activePlaceIds.forEach(pid => {
    const placeVisits = visits.filter(v => v.placeId === pid);
    const rs = placeVisits.flatMap(v => [
      ...(v.hunterRating  > 0 ? [v.hunterRating]  : []),
      ...(v.brandonRating > 0 ? [v.brandonRating] : []),
    ]);
    if (rs.length) placeAvgRatings.push(rs.reduce((a,b)=>a+b,0) / rs.length);
  });
  const ratingBuckets = {};
  for (let v=0.5;v<=5.0;v+=0.5) ratingBuckets[v.toFixed(1)]=0;
  placeAvgRatings.forEach(r=>{ const k=(Math.round(r*2)/2).toFixed(1); if(ratingBuckets[k]!==undefined) ratingBuckets[k]++; });
  const maxBucket = Math.max(1,...Object.values(ratingBuckets));
  const ratingBarsHtml = Object.entries(ratingBuckets).map(([label,count])=>{
    const pct=count?Math.max(8,(count/maxBucket)*100):0;
    return `<div class="rating-bar-col">
      <div class="rating-bar-track"><div class="rating-bar-fill ${count?'has-data':'no-data'}" style="height:${count?pct+'%':'3px'};" title="${label}: ${count} place${count!==1?'s':''}"></div></div>
      <div class="rating-bar-label">${label}</div>
    </div>`;
  }).join('');
  container.innerHTML += `
  <div class="stats-section">
    <div class="stats-section-label">Rating Distribution</div>
    <div class="stats-chart-card">
      <div class="rating-bars">${ratingBarsHtml}</div>
      <div style="display:flex;justify-content:space-between;margin-top:8px;">
        <span style="font-size:11px;color:var(--text-light);">${placeAvgRatings.length} place${placeAvgRatings.length!==1?'s':''}</span>
        <span style="font-size:11px;color:var(--text-muted);">H avg <strong style="color:var(--hunter-dark);">${hAvg?hAvg.toFixed(1):'\u2014'}</strong> &nbsp; B avg <strong style="color:var(--brandon-dark);">${bAvg?bAvg.toFixed(1):'\u2014'}</strong></span>
      </div>
    </div>
  </div>`;

  // ── 2a. PIE: MOST VISITED TYPE OF PLACE (category) ──
  const catVisitCounts = {};
  visits.forEach(v=>{
    const p=places.find(x=>x.id===v.placeId); if(!p||!p.category) return;
    catVisitCounts[p.category]=(catVisitCounts[p.category]||0)+1;
  });
  const catPieData = Object.entries(catVisitCounts)
    .sort((a,b)=>b[1]-a[1])
    .map(([label,value])=>({label,value}));
  container.innerHTML += renderPieSection('Most Visited Type of Place', catPieData, CAT_COLORS);

  // ── 2b. PIE: MOST VISITED WITH (people) ──
  const vwCounts = {};
  visits.forEach(v=>{
    (v.visitedWith||[]).forEach(person=>{
      if(person) vwCounts[person]=(vwCounts[person]||0)+1;
    });
  });
  const vwPieData = Object.entries(vwCounts)
    .sort((a,b)=>b[1]-a[1])
    .map(([label,value])=>({label,value}));
  if (vwPieData.length)
    container.innerHTML += renderPieSection('Most Visited With', vwPieData, VW_COLORS);

  // ── 3. CATEGORY BREAKDOWN (horizontal bars + avg rating overlay) ──
  const catPlaceCounts={}, catRatingsMap={};
  places.forEach(p=>{ if(p.category) catPlaceCounts[p.category]=(catPlaceCounts[p.category]||0)+1; });
  visits.forEach(v=>{
    const p=places.find(x=>x.id===v.placeId); if(!p||!p.category) return;
    if(!catRatingsMap[p.category]) catRatingsMap[p.category]=[];
    if(v.hunterRating>0) catRatingsMap[p.category].push(v.hunterRating);
    if(v.brandonRating>0) catRatingsMap[p.category].push(v.brandonRating);
  });
  const catEntries=Object.entries(catPlaceCounts).sort((a,b)=>b[1]-a[1]);
  const maxCatCount=Math.max(1,...catEntries.map(([,v])=>v));
  if (catEntries.length) {
    const barsHtml=catEntries.map(([cat,count],i)=>{
      const avgArr=catRatingsMap[cat]||[];
      const avg=avgArr.length?avgArr.reduce((a,b)=>a+b,0)/avgArr.length:0;
      const pct=(count/maxCatCount*100).toFixed(0);
      const ratingPct=avg?(avg/5*100).toFixed(0):0;
      return `<div class="hbar-row" style="flex-direction:column;align-items:stretch;gap:3px;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <span class="hbar-label">${escHtml(cat)}</span>
          <span style="font-size:10px;color:var(--text-muted);">${count} place${count>1?'s':''}${avg?` · ${avg.toFixed(1)}\u2605`:''}</span>
        </div>
        <div style="position:relative;height:10px;background:var(--surface2);border-radius:5px;overflow:hidden;">
          <div style="position:absolute;left:0;top:0;height:100%;width:${pct}%;background:${CAT_COLORS[i%CAT_COLORS.length]};border-radius:5px;"></div>
          ${avg?`<div style="position:absolute;left:0;top:0;height:100%;width:${ratingPct}%;background:rgba(110,129,117,0.25);border-radius:5px;border-right:2px solid var(--dark-sage);pointer-events:none;"></div>`:''}
        </div>
      </div>`;
    }).join('');
    container.innerHTML+=`
    <div class="stats-section">
      <div class="stats-section-label">By Category</div>
      <div class="stats-chart-card">
        <div style="font-size:10px;color:var(--text-light);margin-bottom:10px;">Bar = places &nbsp;&nbsp; Green line = avg rating</div>
        <div style="display:flex;flex-direction:column;gap:10px;">${barsHtml}</div>
      </div>
    </div>`;
  }

  // ── 4. TRAVEL TIMELINE ──
  if (visits.length >= 2) {
    const now=new Date();
    const months=_statsYear==='all'?24:12;
    const buckets=[];
    for(let i=months-1;i>=0;i--){
      let d;
      if(_statsYear==='all'){
        d=new Date(now.getFullYear(),now.getMonth()-i,1);
      } else {
        d=new Date(parseInt(_statsYear),i,1);
      }
      buckets.push({label:d.toLocaleDateString('en-US',{month:'short',year:_statsYear==='all'?'2-digit':undefined}),y:d.getFullYear(),m:d.getMonth()+1,count:0,avgR:[]});
    }
    visits.forEach(v=>{
      const[yr,mo]=v.date.split('-').map(Number);
      const b=buckets.find(b=>b.y===yr&&b.m===mo);
      if(!b) return;
      b.count++;
      if(v.hunterRating>0) b.avgR.push(v.hunterRating);
      if(v.brandonRating>0) b.avgR.push(v.brandonRating);
    });
    const maxCount=Math.max(1,...buckets.map(b=>b.count));
    const W=340,H=80,pad=10;
    const xStep=(W-pad*2)/(buckets.length-1);
    const visitsPoints=buckets.map((b,i)=>`${(pad+i*xStep).toFixed(1)},${(H-pad-(b.count/maxCount*(H-pad*2))).toFixed(1)}`).join(' ');
    const ratingPoints=buckets.map((b,i)=>{
      const avg=b.avgR.length?b.avgR.reduce((a,c)=>a+c,0)/b.avgR.length:null;
      const y=avg?H-pad-(avg/5*(H-pad*2)):null;
      return y!==null?`${(pad+i*xStep).toFixed(1)},${y.toFixed(1)}`:null;
    }).filter(Boolean).join(' ');
    const step=_statsYear==='all'?6:2;
    const labelsHtml=buckets.map((b,i)=>i%step===0?`<text x="${(pad+i*xStep).toFixed(0)}" y="${H+12}" font-size="8" fill="var(--text-light)" text-anchor="middle">${b.label}</text>`:``).join('');
    container.innerHTML+=`
    <div class="stats-section">
      <div class="stats-section-label">Travel Timeline</div>
      <div class="stats-chart-card">
        <svg class="scatter-svg" viewBox="0 0 ${W} ${H+16}" xmlns="http://www.w3.org/2000/svg">
          <line x1="${pad}" y1="${H-pad}" x2="${W-pad}" y2="${H-pad}" stroke="var(--border)" stroke-width="0.5"/>
          ${buckets.map((_,i)=>i%step===0?`<line x1="${(pad+i*xStep).toFixed(0)}" y1="${pad}" x2="${(pad+i*xStep).toFixed(0)}" y2="${H-pad}" stroke="var(--border)" stroke-width="0.5"/>`:'').join('')}
          <polyline points="${visitsPoints}" fill="none" stroke="var(--slate)" stroke-width="2" stroke-linejoin="round" stroke-linecap="round"/>
          ${ratingPoints?`<polyline points="${ratingPoints}" fill="none" stroke="var(--dark-sage)" stroke-width="1.5" stroke-dasharray="3 2" stroke-linejoin="round"/>`:''}
          ${buckets.map((b,i)=>b.count>0?`<circle cx="${(pad+i*xStep).toFixed(1)}" cy="${(H-pad-(b.count/maxCount*(H-pad*2))).toFixed(1)}" r="3" fill="var(--slate)"/>`:``).join('')}
          ${labelsHtml}
        </svg>
        <div style="display:flex;gap:14px;margin-top:4px;">
          <span style="font-size:10px;color:var(--slate);display:flex;align-items:center;gap:4px;"><span style="display:inline-block;width:20px;height:2px;background:var(--slate);border-radius:1px;"></span>Visits</span>
          <span style="font-size:10px;color:var(--dark-sage);display:flex;align-items:center;gap:4px;"><span style="display:inline-block;width:20px;height:2px;background:var(--dark-sage);border-radius:1px;"></span>Avg Rating</span>
        </div>
      </div>
    </div>`;
  }

  // ── 5. GEOGRAPHIC EXTREMES ──
  const withCoords = places.filter(p=>p.lat&&p.lng);
  if (withCoords.length >= 2) {
    const northMost = [...withCoords].sort((a,b)=>b.lat-a.lat)[0];
    const southMost = [...withCoords].sort((a,b)=>a.lat-b.lat)[0];
    const eastMost  = [...withCoords].sort((a,b)=>b.lng-a.lng)[0];
    const westMost  = [...withCoords].sort((a,b)=>a.lng-b.lng)[0];
    const withAlt   = places.filter(p=>p.altitude>0);
    const highestAlt= withAlt.length?[...withAlt].sort((a,b)=>b.altitude-a.altitude)[0]:null;
    const lowestAlt = withAlt.length?[...withAlt].sort((a,b)=>a.altitude-b.altitude)[0]:null;

    const geoCard=(label,place,detail)=>{
      if(!place) return '';
      const ratingTxt = place.avgRating?`${place.avgRating.toFixed(1)} \u2605`:'';
      return `<div class="geo-card">
        <div class="geo-card-label">${label}</div>
        <div class="geo-card-name" title="${escHtml(place.name)}">${escHtml(place.name)}</div>
        <div class="geo-card-sub">${escHtml(detail)}</div>
        ${ratingTxt?`<div class="geo-card-rating">${ratingTxt}</div>`:''}
      </div>`;
    };
    container.innerHTML+=`
    <div class="stats-section">
      <div class="stats-section-label">Geographic Extremes</div>
      <div class="geo-grid">
        ${geoCard('Northernmost', northMost, `${northMost.lat.toFixed(2)}° N`)}
        ${geoCard('Southernmost', southMost, `${southMost.lat.toFixed(2)}° N`)}
        ${geoCard('Easternmost',  eastMost,  `${eastMost.lng.toFixed(2)}° E`)}
        ${geoCard('Westernmost',  westMost,  `${westMost.lng.toFixed(2)}° E`)}
        ${highestAlt?geoCard('Highest Altitude', highestAlt, `${highestAlt.altitude.toLocaleString()} ft`):''}
        ${lowestAlt&&lowestAlt.id!==highestAlt?.id?geoCard('Lowest Altitude', lowestAlt, `${lowestAlt.altitude.toLocaleString()} ft`):''}
      </div>
    </div>`;
  }

  // ── 5b. MOST VISITED COUNTRIES (excl. US) ──
  const countryVisits = {};
  const countryRatings = {};
  visits.forEach(v => {
    const p = places.find(x => x.id === v.placeId);
    if (!p || !p.country) return;
    const c = p.country;
    if (c === 'United States' || c === 'US' || c === 'USA') return; // exclude US
    countryVisits[c] = (countryVisits[c] || 0) + 1;
    if (!countryRatings[c]) countryRatings[c] = [];
    if (v.hunterRating > 0)  countryRatings[c].push(v.hunterRating);
    if (v.brandonRating > 0) countryRatings[c].push(v.brandonRating);
  });
  const topCountries = Object.entries(countryVisits)
    .map(([country, count]) => {
      const arr = countryRatings[country] || [];
      const avg = arr.length ? arr.reduce((a,b) => a+b, 0) / arr.length : 0;
      return { country, count, avg };
    })
    .sort((a, b) => b.count - a.count)
    .slice(0, 8);

  if (topCountries.length) {
    const maxCC = topCountries[0].count;
    const countryRows = topCountries.map((d, i) => {
      const barW = Math.round((d.count / maxCC) * 100);
      const medal = i === 0 ? '1.' : i === 1 ? '2.' : i === 2 ? '3.' : `${i+1}.`;
      return `<div style="display:flex;align-items:center;gap:8px;margin-bottom:7px;" data-loc-type="country" data-loc-val="${escHtml(d.country)}">
        <div style="width:22px;font-size:11px;text-align:right;flex-shrink:0;color:var(--text-muted);">${medal}</div>
        <div style="flex:1;min-width:0;">
          <div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:3px;">
            <span style="font-size:13px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:65%;">${escHtml(d.country)}</span>
            <span style="font-size:11px;color:var(--text-muted);flex-shrink:0;">${d.count} visit${d.count!==1?'s':''}${d.avg?` · ${d.avg.toFixed(1)}★`:''}</span>
          </div>
          <div style="height:5px;background:var(--surface2);border-radius:3px;overflow:hidden;">
            <div style="height:100%;width:${barW}%;background:var(--dark-sage);border-radius:3px;transition:width 0.4s;"></div>
          </div>
        </div>
      </div>`;
    }).join('');
    container.innerHTML += `
    <div class="stats-section">
      <div class="stats-section-label">Most Visited Countries</div>
      <div class="stats-chart-card">${countryRows}</div>
    </div>`;
  }

  // ── 5c. MOST VISITED US STATES (excl. Texas) ──
  const stateVisits = {};
  const stateRatings = {};
  visits.forEach(v => {
    const p = places.find(x => x.id === v.placeId);
    if (!p) return;
    const isUS = p.country === 'United States' || p.country === 'US' || p.country === 'USA';
    if (!isUS || !p.state) return;
    if (p.state === 'Texas' || p.state === 'TX') return; // exclude Texas
    const s = p.state;
    stateVisits[s] = (stateVisits[s] || 0) + 1;
    if (!stateRatings[s]) stateRatings[s] = [];
    if (v.hunterRating > 0)  stateRatings[s].push(v.hunterRating);
    if (v.brandonRating > 0) stateRatings[s].push(v.brandonRating);
  });
  const topStates = Object.entries(stateVisits)
    .map(([state, count]) => {
      const arr = stateRatings[state] || [];
      const avg = arr.length ? arr.reduce((a,b) => a+b, 0) / arr.length : 0;
      return { state, count, avg };
    })
    .sort((a, b) => b.count - a.count)
    .slice(0, 8);

  if (topStates.length) {
    const maxSC = topStates[0].count;
    const stateRows = topStates.map((d, i) => {
      const barW = Math.round((d.count / maxSC) * 100);
      const medal = i === 0 ? '1.' : i === 1 ? '2.' : i === 2 ? '3.' : `${i+1}.`;
      return `<div style="display:flex;align-items:center;gap:8px;margin-bottom:7px;" data-loc-type="state" data-loc-val="${escHtml(d.state)}">
        <div style="width:22px;font-size:11px;text-align:right;flex-shrink:0;color:var(--text-muted);">${medal}</div>
        <div style="flex:1;min-width:0;">
          <div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:3px;">
            <span style="font-size:13px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:65%;">${escHtml(d.state)}</span>
            <span style="font-size:11px;color:var(--text-muted);flex-shrink:0;">${d.count} visit${d.count!==1?'s':''}${d.avg?` · ${d.avg.toFixed(1)}★`:''}</span>
          </div>
          <div style="height:5px;background:var(--surface2);border-radius:3px;overflow:hidden;">
            <div style="height:100%;width:${barW}%;background:var(--slate);border-radius:3px;transition:width 0.4s;"></div>
          </div>
        </div>
      </div>`;
    }).join('');
    container.innerHTML += `
    <div class="stats-section">
      <div class="stats-section-label">Most Visited States</div>
      <div class="stats-chart-card">${stateRows}</div>
    </div>`;
  }

  // ── 6. COUNTRY HEAT TABLE ──
  const countryData=[];
  const countryVisitCounts={},countryRatingLists={};
  visits.forEach(v=>{
    const p=places.find(x=>x.id===v.placeId); if(!p||!p.country) return;
    countryVisitCounts[p.country]=(countryVisitCounts[p.country]||0)+1;
    if(!countryRatingLists[p.country]) countryRatingLists[p.country]=[];
    if(v.hunterRating>0) countryRatingLists[p.country].push(v.hunterRating);
    if(v.brandonRating>0) countryRatingLists[p.country].push(v.brandonRating);
  });
  Object.entries(countryVisitCounts).forEach(([country,count])=>{
    const arr=countryRatingLists[country]||[];
    const avg=arr.length?arr.reduce((a,b)=>a+b,0)/arr.length:0;
    countryData.push({country,count,avg});
  });
  countryData.sort((a,b)=>b.count-a.count);
  if(countryData.length){
    const maxC=Math.max(1,...countryData.map(d=>d.count));
    const rowsHtml=countryData.map(d=>{
      const intensity=d.count/maxC;
      const bgOpacity=0.04+intensity*0.12;
      return `<div class="country-heat-row" data-loc-type="country" data-loc-val="${escHtml(d.country)}" style="cursor:pointer;">
        <div class="country-heat-bg" style="background:rgba(110,129,117,${bgOpacity});"></div>
        <span class="country-heat-name">${escHtml(d.country)}</span>
        <span class="country-heat-visits">${d.count} v</span>
        <span class="country-heat-rating">${d.avg?d.avg.toFixed(1):'\u2014'}</span>
      </div>`;
    }).join('');
    container.innerHTML+=`
    <div class="stats-section">
      <div class="stats-section-label">Country Heat Table</div>
      <div class="stats-chart-card">
        <div style="display:flex;justify-content:flex-end;font-size:10px;color:var(--text-light);margin-bottom:6px;gap:14px;"><span>Visits</span><span>Avg \u2605</span></div>
        <div class="country-heat-table">${rowsHtml}</div>
      </div>
    </div>`;
  }

  // ── 7. RATING AGREEMENT SCATTER ──
  const bothRated=visits.filter(v=>v.hunterRating>0&&v.brandonRating>0);
  if(bothRated.length>=2){
    const SW=280,SH=200,spd=24;
    const sx=v=>spd+(v-0.5)/(5-0.5)*(SW-spd*2);
    const sy=v=>SH-spd-(v-0.5)/(5-0.5)*(SH-spd*2);
    const dots=bothRated.map(v=>{
      const p=places.find(x=>x.id===v.placeId);
      return `<circle cx="${sx(v.hunterRating).toFixed(1)}" cy="${sy(v.brandonRating).toFixed(1)}" r="5" fill="var(--sage)" fill-opacity="0.7" stroke="var(--dark-sage)" stroke-width="0.5"><title>${escHtml(p?.name||'')} Hunter:${v.hunterRating} Brandon:${v.brandonRating}</title></circle>`;
    }).join('');
    const diag=`<line x1="${sx(0.5).toFixed(0)}" y1="${sy(0.5).toFixed(0)}" x2="${sx(5).toFixed(0)}" y2="${sy(5).toFixed(0)}" stroke="var(--border)" stroke-width="1" stroke-dasharray="4 3"/>`;
    const xLabels=[1,2,3,4,5].map(v=>`<text x="${sx(v).toFixed(0)}" y="${SH-6}" font-size="8" fill="var(--text-light)" text-anchor="middle">${v}</text>`).join('');
    const yLabels=[1,2,3,4,5].map(v=>`<text x="8" y="${(sy(v)+4).toFixed(0)}" font-size="8" fill="var(--text-light)" text-anchor="middle">${v}</text>`).join('');
    container.innerHTML+=`
    <div class="stats-section">
      <div class="stats-section-label">Rating Agreement</div>
      <div class="stats-chart-card">
        <div style="font-size:10px;color:var(--text-light);margin-bottom:8px;">Each dot = one visit &nbsp; Dashed line = perfect agreement</div>
        <div style="overflow-x:auto;">
          <svg viewBox="0 0 ${SW} ${SH}" xmlns="http://www.w3.org/2000/svg" style="display:block;min-width:${SW}px;">
            <line x1="${spd}" y1="${spd}" x2="${spd}" y2="${SH-spd}" stroke="var(--border)" stroke-width="0.5"/>
            <line x1="${spd}" y1="${SH-spd}" x2="${SW-spd}" y2="${SH-spd}" stroke="var(--border)" stroke-width="0.5"/>
            ${diag}${dots}${xLabels}${yLabels}
            <text x="${SW/2}" y="${SH}" font-size="8" fill="var(--text-muted)" text-anchor="middle">Hunter Rating</text>
            <text x="6" y="${SH/2}" font-size="8" fill="var(--text-muted)" text-anchor="middle" transform="rotate(-90 6 ${SH/2})">Brandon</text>
          </svg>
        </div>
      </div>
    </div>`;
  }

  // ── 8. WISHLIST CONVERSION ──
  if(_statsYear==='all' && wishlist.length>0){
    const total=wishlist.length,done=wishlist.filter(w=>convertedNames.has(w.name.toLowerCase())).length;
    const pct=total?done/total:0,r2=36,c2=2*Math.PI*r2;
    const dashAr2=`${(pct*c2).toFixed(1)} ${c2.toFixed(1)}`;
    container.innerHTML+=`
    <div class="stats-section">
      <div class="stats-section-label">Wishlist Conversion</div>
      <div class="stats-chart-card">
        <div style="display:flex;align-items:center;gap:20px;">
          <svg width="90" height="90" viewBox="0 0 90 90" style="flex-shrink:0;">
            <circle cx="45" cy="45" r="${r2}" fill="none" stroke="var(--surface2)" stroke-width="7"/>
            <circle cx="45" cy="45" r="${r2}" fill="none" stroke="var(--wish-color)" stroke-width="7"
              stroke-dasharray="${dashAr2}" stroke-linecap="round" transform="rotate(-90 45 45)"/>
            <text x="45" y="49" text-anchor="middle" font-family="var(--sys-d)" font-size="14" font-weight="700" fill="var(--text)">${Math.round(pct*100)}%</text>
          </svg>
          <div>
            <div style="font-size:22px;font-weight:700;color:var(--text);letter-spacing:-0.03em;">${done}<span style="font-size:14px;color:var(--text-muted)">/${total}</span></div>
            <div style="font-size:12px;color:var(--text-muted);margin-top:2px;">Wishlist items visited</div>
            <div style="font-size:11px;color:var(--wish-color);margin-top:6px;font-weight:600;">${total-done} remaining</div>
          </div>
        </div>
      </div>
    </div>`;
  }

  // ── 9. TRIP PERFORMANCE ──
  const filteredTrips = _statsYear==='all' ? trips
    : trips.filter(t=>t.startDate?.startsWith(_statsYear)||t.endDate?.startsWith(_statsYear));
  if(filteredTrips.length){
    const tripCards=filteredTrips.map(t=>{
      const tv=visits.filter(v=>v.tripId===t.id);
      const places_set=new Set(tv.map(v=>v.placeId));
      const dur=t.startDate&&t.endDate?Math.round((new Date(t.endDate)-new Date(t.startDate))/86400000)+1:null;
      const allR=[...tv.map(v=>v.hunterRating),...tv.map(v=>v.brandonRating)].filter(r=>r>0);
      const avg=allR.length?allR.reduce((a,b)=>a+b,0)/allR.length:0;
      const perf=Math.min(100,avg/5*100);
      return `<div class="trip-perf-card">
        <div class="trip-perf-name">${escHtml(t.name)}</div>
        <div class="trip-perf-meta">${dur?dur+'d':'?'} &nbsp; ${places_set.size} places &nbsp; ${tv.length} visits${avg?' &nbsp; '+avg.toFixed(1)+'\u2605':''}</div>
        <div class="trip-perf-bar-track"><div class="trip-perf-bar-fill" style="width:${perf.toFixed(0)}%;"></div></div>
      </div>`;
    }).join('');
    container.innerHTML+=`
    <div class="stats-section">
      <div class="stats-section-label">Trip Performance</div>
      <div style="display:flex;flex-direction:column;gap:8px;">${tripCards}</div>
    </div>`;
  }

  // ── 10. HIGHLIGHTS ──
  const mvPlace  = places.length?[...places].sort((a,b)=>(b.totalVisits||0)-(a.totalVisits||0))[0]:null;
  const topRated = places.filter(p=>p.avgRating).sort((a,b)=>b.avgRating-a.avgRating)[0]||null;
  const polarizing=places.filter(p=>p.hunterAvg>0&&p.brandonAvg>0).sort((a,b)=>Math.abs(b.hunterAvg-b.brandonAvg)-Math.abs(a.hunterAvg-a.brandonAvg))[0];
  if(places.length){
    let hh='<div class="stat-grid">';
    if(mvPlace)   hh+=`<div class="stat-card full"><div class="stat-label">Most Revisited</div><div class="stat-value" style="font-size:18px;margin-top:4px;">${escHtml(mvPlace.name)}</div><div class="stat-sub">${mvPlace.totalVisits} visits${mvPlace.city?' \u00B7 '+mvPlace.city:''}</div></div>`;
    if(topRated)  hh+=`<div class="stat-card full"><div class="stat-label">Top Rated</div><div class="stat-value" style="font-size:18px;margin-top:4px;">${escHtml(topRated.name)}</div><div class="stat-sub">${topRated.avgRating.toFixed(1)} avg \u00B7 ${topRated.category||''}</div></div>`;
    if(polarizing)hh+=`<div class="stat-card full"><div class="stat-label">Most Polarizing</div><div class="stat-value" style="font-size:16px;margin-top:4px;">${escHtml(polarizing.name)}</div><div class="stat-sub">H: ${polarizing.hunterAvg.toFixed(1)} vs B: ${polarizing.brandonAvg.toFixed(1)}</div></div>`;
    hh+='</div>';
    container.innerHTML+=`<div class="stats-section"><div class="stats-section-label">Highlights</div>${hh}</div>`;
  }

  // Wire up all clickable stat-card/rows/chips after innerHTML is settled
  const placesCard = document.getElementById('stat-places-card');
  if (placesCard) placesCard.onclick = () => openPlacesSheet(places);

  container.querySelectorAll('[data-loc-type]').forEach(el => {
    el.style.cursor = 'pointer';
    el.addEventListener('click', e => { e.stopPropagation(); openLocationStats(el.dataset.locType, el.dataset.locVal); });
  });
}

// All places sorted by avg rating — opens the location sheet reused as a place list
function openPlacesSheet(places) {
  const allVisits = DB.visits;
  const sorted = [...places].map(p => {
    const pvs = allVisits.filter(v => v.placeId === p.id);
    const rs  = pvs.flatMap(v => [...(v.hunterRating>0?[v.hunterRating]:[]), ...(v.brandonRating>0?[v.brandonRating]:[])]);
    const avg = rs.length ? rs.reduce((a,b)=>a+b,0)/rs.length : 0;
    return { p, avg, visits: pvs.length };
  }).sort((a,b) => b.avg - a.avg || b.visits - a.visits);

  const rows = sorted.map(({p, avg, visits}) => {
    const loc = [p.city, p.state, p.country].filter(Boolean).join(', ');
    return `<div class="loc-place-row" data-place-id="${p.id}">
      <div style="flex:1;min-width:0;">
        <div class="loc-place-row-name">${escHtml(p.name)}</div>
        ${loc ? `<div class="loc-place-row-sub">${escHtml(loc)}</div>` : ''}
      </div>
      <div style="text-align:right;flex-shrink:0;">
        ${avg ? `<div class="loc-place-row-rating">${avg.toFixed(1)} ★</div>` : ''}
        <div style="font-size:10px;color:var(--text-light);">${visits} visit${visits!==1?'s':''}</div>
      </div>
    </div>`;
  }).join('');

  _showLocSheet('All Places', `${places.length} Place${places.length!==1?'s':''}`, rows);
}


// ═══════════════════════════════════════════
//  EXPORT / IMPORT  (replaces Google Drive OAuth)
//  Export: downloads pindrop-backup-DATE.json
//  Import: reads JSON file, shows preview, confirms, replaces data
// ═══════════════════════════════════════════

function exportData() {
  // DB.places and DB.visits getters already re-attach photos, so export includes them.
  const payload = {
    exportedAt: new Date().toISOString(),
    version: 1,
    places:   DB.places,
    visits:   DB.visits,
    trips:    DB.trips,
    wishlist: DB.wishlist
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  const date = new Date().toISOString().slice(0,10);
  a.href     = url;
  a.download = `pindrop-backup-${date}.json`;
  a.click();
  URL.revokeObjectURL(url);
  toast('Backup downloaded!');
}

let _importData = null;

function openImportPicker() {
  document.getElementById('import-file-input').value = '';
  document.getElementById('import-file-input').click();
}

document.getElementById('import-file-input').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const data = JSON.parse(ev.target.result);
      // Validate it looks like PinDrop data
      if (!data.places && !data.visits) {
        toast('Invalid backup file — does not look like PinDrop data.');
        return;
      }
      _importData = data;
      const places   = (data.places   || []).length;
      const visits   = (data.visits   || []).length;
      const trips    = (data.trips    || []).length;
      const wishlist = (data.wishlist || []).length;
      const date     = data.exportedAt ? new Date(data.exportedAt).toLocaleDateString() : 'unknown date';
      document.getElementById('import-preview').innerHTML =
        `<strong>Backup from ${date}</strong><br>` +
        `${places} places &nbsp;·&nbsp; ${visits} visits<br>` +
        `${trips} trips &nbsp;·&nbsp; ${wishlist} wishlist items`;
      openModal('modal-import-confirm');
    } catch(err) {
      toast('Could not read file — make sure it is a valid PinDrop JSON backup.');
    }
  };
  reader.readAsText(file);
});

document.getElementById('import-confirm-btn').addEventListener('click', () => {
  if (!_importData) return;
  if (_importData.places)   DB.places   = _importData.places;   // setter auto-splits photos
  if (_importData.visits)   DB.visits   = _importData.visits;
  if (_importData.trips)    DB.trips    = _importData.trips;
  if (_importData.wishlist) DB.wishlist = _importData.wishlist;
  invalidateMetrics();
  _importData = null;
  closeModal('modal-import-confirm');
  renderList();
  toast('Data imported successfully!');
});

document.getElementById('import-confirm-close').addEventListener('click', () => closeModal('modal-import-confirm'));
document.getElementById('import-cancel-btn').addEventListener('click', () => closeModal('modal-import-confirm'));

// Bar buttons
// export/import wired via desktop sidebar footer and other-menu only

// More menu buttons
document.getElementById('other-export-btn').addEventListener('click', () => { closeOtherMenu(); exportData(); });
document.getElementById('other-import-btn').addEventListener('click', () => { closeOtherMenu(); openImportPicker(); });
// ═══════════════════════════════════════════
//  OTHER MENU — open/close + navigation
// ═══════════════════════════════════════════
function openOtherMenu() {
  document.getElementById('other-menu-overlay').classList.add('open');
  document.getElementById('other-nav-btn').classList.add('active');
}
function closeOtherMenu() {
  document.getElementById('other-menu-overlay').classList.remove('open');
  document.getElementById('other-nav-btn').classList.remove('active');
}

document.getElementById('other-nav-btn').addEventListener('click', () => {
  const isOpen = document.getElementById('other-menu-overlay').classList.contains('open');
  if (isOpen) closeOtherMenu(); else openOtherMenu();
});
document.getElementById('other-menu-backdrop').addEventListener('click', closeOtherMenu);

document.getElementById('other-goto-discover').addEventListener('click', () => {
  closeOtherMenu();
  switchView('discover');
});
document.getElementById('other-goto-trips').addEventListener('click', () => {
  closeOtherMenu();
  // Open the trip list — filter list view by trips, or switch to discover+trips view
  // Re-use list view with trip filter active
  switchView('list');
  // Activate trip filter chip if present
  setTimeout(() => {
    const tripChip = document.querySelector('.chip.trip-chip');
    if (tripChip && !tripChip.classList.contains('active')) tripChip.click();
  }, 50);
});
document.getElementById('other-goto-wishlist').addEventListener('click', () => {
  closeOtherMenu();
  switchView('wishlist');
});

// ═══════════════════════════════════════════
//  PATCH switchView TO HANDLE ALL VIEWS
// ═══════════════════════════════════════════
function switchView(view, btn) {
  closeOtherMenu();
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.querySelectorAll('.nav-btn[data-view]').forEach(b=>b.classList.remove('active'));
  const viewEl = document.getElementById('view-'+view);
  if (viewEl) viewEl.classList.add('active');
  const navBtn = btn || document.querySelector(`.nav-btn[data-view="${view}"]`);
  if (navBtn) navBtn.classList.add('active');
  if (view==='list')     renderList();
  if (view==='calendar') renderCalendar();
  if (view==='stats')    renderStats();
  if (view==='wishlist') renderWishlist();
  if (view==='map')      initMap();
}


// ═══════════════════════════════════════════
//  CALENDAR MODAL — On This Day + month browser
// ═══════════════════════════════════════════

// Calendar modal wiring — elements exist in DOM above the script tag
let _cmlY, _cmlM, _cmlSel, _cmlWired = false;

// Wire cml-* elements lazily on first open (they live after this script tag)
function _openCml() {
  closeOtherMenu();
  const n = new Date(); _cmlY = n.getFullYear(); _cmlM = n.getMonth();
  _cmlSel = n.toISOString().slice(0, 10);
  document.getElementById('modal-calendar').classList.add('open');
  if (!_cmlWired) {
    _cmlWired = true;
    document.getElementById('cml-close').addEventListener('click', _closeCml);
    document.getElementById('modal-calendar').addEventListener('click', e => {
      if (e.target.id === 'modal-calendar') _closeCml();
    });
    document.getElementById('cml-prev').addEventListener('click', () => {
      _cmlM--; if (_cmlM < 0) { _cmlM = 11; _cmlY--; } _renderCml();
    });
    document.getElementById('cml-next').addEventListener('click', () => {
      _cmlM++; if (_cmlM > 11) { _cmlM = 0; _cmlY++; } _renderCml();
    });
  }
  _renderCml();
}

document.getElementById('other-goto-calendar').addEventListener('click', _openCml);

function _closeCml() {
  document.getElementById('modal-calendar').classList.remove('open');
}

function _renderCml() {
  const MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  document.getElementById('cml-month-label').textContent = MONTHS[_cmlM] + ' ' + _cmlY;

  const visits    = DB.visits;
  const visitDates = new Set(visits.map(v => v.startDate||v.date).filter(Boolean));
  const today     = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
  const todayMD   = today.slice(5);                         // MM-DD

  // On This Day uses today's real date always
  _renderOTD(today, todayMD);

  // Grid
  const grid = document.getElementById('cml-grid');
  grid.innerHTML = '';
  ['Su','Mo','Tu','We','Th','Fr','Sa'].forEach(lbl => {
    const el = document.createElement('div'); el.className = 'cml-day-lbl'; el.textContent = lbl; grid.appendChild(el);
  });

  const firstDay = new Date(_cmlY, _cmlM, 1).getDay();
  const daysInM  = new Date(_cmlY, _cmlM + 1, 0).getDate();
  const daysInPrev = new Date(_cmlY, _cmlM, 0).getDate();

  // Prev-month padding
  for (let i = firstDay - 1; i >= 0; i--) {
    const d = daysInPrev - i;
    const pm = _cmlM === 0 ? 12 : _cmlM;
    const py = _cmlM === 0 ? _cmlY - 1 : _cmlY;
    _addCmlDay(grid, d, `${py}-${String(pm).padStart(2,'0')}-${String(d).padStart(2,'0')}`, true, visitDates, today, todayMD);
  }
  // This month
  for (let d = 1; d <= daysInM; d++) {
    _addCmlDay(grid, d, `${_cmlY}-${String(_cmlM+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`, false, visitDates, today, todayMD);
  }

  // Visit list for selected date
  _renderCmlVisits(_cmlSel || today);
}

function _addCmlDay(grid, d, ds, otherMonth, visitDates, today, todayMD) {
  const el = document.createElement('div');
  const classes = ['cml-day'];
  if (otherMonth)           classes.push('other-month');
  if (ds === today)         classes.push('today');
  if (visitDates.has(ds))   classes.push('has-visit');
  if (ds === (_cmlSel||today)) classes.push('selected');
  // Subtle ring on days that share MM-DD with today (past "on this day" dates)
  if (!otherMonth && ds.slice(5) === todayMD && ds !== today) classes.push('otd-ring');
  el.className = classes.join(' ');
  el.textContent = d;
  el.addEventListener('click', () => {
    _cmlSel = ds;
    _renderCml();
    setTimeout(() => document.getElementById('cml-visits').scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 60);
  });
  grid.appendChild(el);
}

function _renderOTD(today, todayMD) {
  const visits = DB.visits;
  // All visits on this MM-DD in past years (not today itself)
  const matches = visits
    .filter(v => { const d = v.startDate||v.date; return d && d.slice(5) === todayMD && d !== today; })
    .sort((a, b) => (b.startDate||b.date||'').localeCompare(a.startDate||a.date||'')); // newest year first

  const el = document.getElementById('cml-otd');
  const [, mm, dd] = today.split('-');
  const MSHORT = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const dispDate = MSHORT[parseInt(mm) - 1] + ' ' + parseInt(dd);

  if (!matches.length) {
    el.className = 'otd-banner-empty';
    el.innerHTML = '<div class="otd-kicker empty">On This Day — ' + escHtml(dispDate) + '</div>'
      + '<div class="otd-empty-txt">No past visits on this date yet.</div>';
    return;
  }

  const years = [...new Set(matches.map(v => (v.startDate||v.date||'').slice(0,4)))];
  const headline = matches.length + ' past visit' + (matches.length !== 1 ? 's' : '')
    + ' · ' + years.length + ' year' + (years.length !== 1 ? 's' : '');

  const cards = matches.map(v => {
    const p = DB.places.find(x => x.id === v.placeId);
    const loc = [p?.city, p?.state, p?.country].filter(Boolean).join(', ');
    const hPill = v.hunterRating  ? '<span class="otd-pill h">H ' + v.hunterRating.toFixed(1) + '</span>' : '';
    const bPill = v.brandonRating ? '<span class="otd-pill b">B ' + v.brandonRating.toFixed(1) + '</span>' : '';
    const yr = (v.startDate||v.date||'').slice(0,4);
    return '<div class="otd-card" data-vid="' + v.id + '">'
      + '<div class="otd-card-year">' + yr + '</div>'
      + '<div class="otd-card-place">' + escHtml(p?.name || 'Unknown') + '</div>'
      + (loc ? '<div class="otd-card-loc">' + escHtml(loc) + '</div>' : '')
      + ((hPill || bPill) ? '<div class="otd-card-pills">' + hPill + bPill + '</div>' : '')
      + '</div>';
  }).join('');

  el.className = 'otd-banner';
  el.innerHTML = '<div class="otd-kicker has">On This Day — ' + escHtml(dispDate) + '</div>'
    + '<div class="otd-headline">' + escHtml(headline) + '</div>'
    + '<div class="otd-scroll">' + cards + '</div>';

  el.querySelectorAll('[data-vid]').forEach(card => {
    card.addEventListener('click', () => {
      const v = DB.visits.find(x => x.id === card.dataset.vid); if (!v) return;
      _closeCml(); currentPlaceId = v.placeId;
      setTimeout(() => openVisitDetail(v.id), 240);
    });
  });
}

function _renderCmlVisits(ds) {
  const visits = DB.visits.filter(v => visitSpansDate(v, ds));
  const wrap = document.getElementById('cml-visits');
  wrap.innerHTML = '';
  if (!visits.length) {
    wrap.innerHTML = '<div class="cml-empty">No visits on ' + escHtml(formatDate(ds)) + '</div>';
    return;
  }
  const lbl = document.createElement('div'); lbl.className = 'cml-visits-lbl';
  lbl.textContent = formatDate(ds); wrap.appendChild(lbl);
  visits.forEach(v => {
    const p = DB.places.find(x => x.id === v.placeId);
    const loc = [p?.city, p?.state, p?.country].filter(Boolean).join(', ');
    const hPill = v.hunterRating  ? '<span class="otd-pill h">Hunter ' + v.hunterRating.toFixed(1)  + '</span>' : '';
    const bPill = v.brandonRating ? '<span class="otd-pill b">Brandon ' + v.brandonRating.toFixed(1) + '</span>' : '';
    const card = document.createElement('div'); card.className = 'cml-vcard';
    card.innerHTML = '<div class="cml-vcard-name">' + escHtml(p?.name || 'Unknown') + '</div>'
      + (loc ? '<div class="cml-vcard-loc">' + escHtml(loc) + '</div>' : '')
      + ((hPill || bPill) ? '<div class="cml-vcard-pills">' + hPill + bPill + '</div>' : '');
    card.addEventListener('click', () => {
      _closeCml(); currentPlaceId = v.placeId;
      setTimeout(() => openVisitDetail(v.id), 240);
    });
    wrap.appendChild(card);
  });
}


// ═══════════════════════════════════════════
//  LOCATION STATS SHEET
// ═══════════════════════════════════════════

let _locSheetWired = false;

function openLocationStats(type, value) {
  // type: 'city' | 'state' | 'country'
  // value: the string to match
  const allPlaces = DB.places;
  const allVisits = DB.visits;

  const matchPlaces = allPlaces.filter(p => {
    if (type === 'city')    return p.city    && p.city.trim()    === value.trim();
    if (type === 'state')   return p.state   && p.state.trim()   === value.trim();
    if (type === 'country') return p.country && p.country.trim() === value.trim();
    return false;
  });

  const matchVisits = allVisits.filter(v => matchPlaces.some(p => p.id === v.placeId));

  // Metrics
  const hRatings = matchVisits.map(v => v.hunterRating).filter(r => r > 0);
  const bRatings = matchVisits.map(v => v.brandonRating).filter(r => r > 0);
  const hAvg = hRatings.length ? hRatings.reduce((a,b)=>a+b,0)/hRatings.length : 0;
  const bAvg = bRatings.length ? bRatings.reduce((a,b)=>a+b,0)/bRatings.length : 0;

  // Rating distribution (per-place averages)
  const distBuckets = {};
  for (let v=0.5; v<=5.0; v+=0.5) distBuckets[v.toFixed(1)] = 0;
  matchPlaces.forEach(p => {
    const pvs = allVisits.filter(v => v.placeId === p.id);
    const rs  = pvs.flatMap(v => [
      ...(v.hunterRating  > 0 ? [v.hunterRating]  : []),
      ...(v.brandonRating > 0 ? [v.brandonRating] : []),
    ]);
    if (rs.length) {
      const avg = rs.reduce((a,b)=>a+b,0)/rs.length;
      const k = (Math.round(avg*2)/2).toFixed(1);
      if (distBuckets[k] !== undefined) distBuckets[k]++;
    }
  });
  const maxBucket = Math.max(1, ...Object.values(distBuckets));
  const distHtml = Object.entries(distBuckets).map(([label, count]) => {
    const pct = count ? Math.max(8, (count/maxBucket)*100) : 0;
    return `<div class="rating-bar-col">
      <div class="rating-bar-track"><div class="rating-bar-fill ${count?'has-data':'no-data'}" style="height:${count?pct+'%':'3px'};" title="${label}: ${count}"></div></div>
      <div class="rating-bar-label">${label}</div>
    </div>`;
  }).join('');

  // Place rows sorted by avg rating desc
  const placeRows = matchPlaces
    .map(p => {
      const pvs = allVisits.filter(v => v.placeId === p.id);
      const rs  = pvs.flatMap(v=>[...(v.hunterRating>0?[v.hunterRating]:[]),...(v.brandonRating>0?[v.brandonRating]:[])]);
      const avg = rs.length ? rs.reduce((a,b)=>a+b,0)/rs.length : 0;
      const sub = [type!=='city'&&p.city?p.city:'', type!=='state'&&p.state?p.state:''].filter(Boolean).join(', ');
      return { p, avg, visits: pvs.length, sub };
    })
    .sort((a,b) => b.avg - a.avg || b.visits - a.visits);

  const placeRowsHtml = placeRows.map(({ p, avg, visits, sub }) =>
    `<div class="loc-place-row" data-place-id="${p.id}">
      <div>
        <div class="loc-place-row-name">${escHtml(p.name)}</div>
        ${sub ? `<div class="loc-place-row-sub">${escHtml(sub)}</div>` : ''}
      </div>
      ${avg ? `<div class="loc-place-row-rating">${avg.toFixed(1)} ★</div>` : ''}
    </div>`
  ).join('');

  const kicker = type.charAt(0).toUpperCase() + type.slice(1);

  const bodyHtml = `
    <div class="loc-sheet-metric">
      <div class="loc-sheet-mc"><div class="loc-sheet-mc-label">Places</div><div class="loc-sheet-mc-value">${matchPlaces.length}</div></div>
      <div class="loc-sheet-mc"><div class="loc-sheet-mc-label">Visits</div><div class="loc-sheet-mc-value">${matchVisits.length}</div></div>
      ${hAvg ? `<div class="loc-sheet-mc"><div class="loc-sheet-mc-label">Hunter avg</div><div class="loc-sheet-mc-value h">${hAvg.toFixed(1)}</div></div>` : ''}
      ${bAvg ? `<div class="loc-sheet-mc"><div class="loc-sheet-mc-label">Brandon avg</div><div class="loc-sheet-mc-value b">${bAvg.toFixed(1)}</div></div>` : ''}
    </div>
    ${matchPlaces.length > 1 ? `
      <div class="loc-sheet-section-label">Rating Distribution</div>
      <div class="stats-chart-card" style="margin-bottom:14px;">
        <div class="rating-bars">${distHtml}</div>
      </div>` : ''}
    <div class="loc-sheet-section-label">Places</div>
    ${placeRowsHtml}`;

  _showLocSheet(kicker, value, bodyHtml);
}

function _showLocSheet(kicker, title, bodyHtml) {
  document.getElementById('loc-sheet-kicker').textContent = kicker;
  document.getElementById('loc-sheet-title').textContent  = title;
  document.getElementById('loc-sheet-body').innerHTML     = bodyHtml;

  document.getElementById('loc-sheet-body').querySelectorAll('[data-place-id]').forEach(el => {
    el.addEventListener('click', () => { closeLocSheet(); setTimeout(() => openPlaceDetail(el.dataset.placeId), 240); });
  });

  if (!_locSheetWired) {
    _locSheetWired = true;
    document.getElementById('loc-sheet-close').addEventListener('click', closeLocSheet);
    document.getElementById('modal-loc-stats').addEventListener('click', e => {
      if (e.target.id === 'modal-loc-stats') closeLocSheet();
    });
  }
  document.getElementById('modal-loc-stats').classList.add('open');
  document.getElementById('loc-sheet-inner').scrollTop = 0;
}

function closeLocSheet() {
  document.getElementById('modal-loc-stats').classList.remove('open');
}



// ═══════════════════════════════════════════
//  PLAN A TRIP — ITINERARY BUILDER ENGINE
// ═══════════════════════════════════════════

// ── Adaptive weights (persisted, updated after trips) ──────────
const PlanWeights = {
  _key: 'pd_plan_weights',
  defaults() {
    return { geo: 0.30, satisfaction: 0.20, companion: 0.15, season: 0.15, vibe: 0.10, novelty: 0.10 };
  },
  get() {
    try { return { ...this.defaults(), ...JSON.parse(localStorage.getItem(this._key)||'{}') }; }
    catch(e) { return this.defaults(); }
  },
  // After a trip completes: nudge weights based on predicted vs actual delta
  adjust(predictedAvg, actualAvg) {
    const w = this.get();
    const delta = (actualAvg - predictedAvg) / 5; // normalize to ±1
    // If reality beat prediction, increase satisfaction weight slightly
    const nudge = delta * 0.02;
    w.satisfaction = Math.max(0.10, Math.min(0.35, w.satisfaction + nudge));
    // Rebalance so weights sum to 1
    const sum = Object.values(w).reduce((a,b)=>a+b,0);
    Object.keys(w).forEach(k => w[k] = Math.round((w[k]/sum)*100)/100);
    localStorage.setItem(this._key, JSON.stringify(w));
  },
};

// ── Helpers ──────────────────────────────────────────────────────
function _planGetSeason(ds) {
  const m = parseInt((ds||'').slice(5,7)||'0');
  if (m>=3&&m<=5) return 'spring';
  if (m>=6&&m<=8) return 'summer';
  if (m>=9&&m<=11) return 'autumn';
  return 'winter';
}

function _planDist(a, b) {
  // Haversine in miles (reuse haversineMiles if available, else inline)
  if (!a?.lat||!a?.lng||!b?.lat||!b?.lng) return 9999;
  return haversineMiles(a, b) || 9999;
}

// Category → vibe mapping
const CAT_VIBE = {
  'Restaurant': 'culinary', 'Café': 'culinary', 'Bar': 'culinary',
  'Bakery': 'culinary', 'Food Market': 'culinary',
  'Museum': 'cultural', 'Gallery': 'cultural', 'Monument': 'cultural',
  'Theatre': 'cultural', 'Historic Site': 'cultural', 'Library': 'cultural',
  'Park': 'nature', 'Beach': 'nature', 'Mountain': 'nature',
  'Trail': 'nature', 'Garden': 'nature', 'Lake': 'nature',
  'Hotel / Lodging': 'urban', 'Shop': 'urban', 'Market': 'urban',
  'Neighborhood': 'urban', 'Viewpoint': 'urban', 'Entertainment': 'urban',
  'Experience': 'culinary', 'Sporting Experience': 'nature', 'Golf': 'nature',
};
function _catVibe(cat) { return CAT_VIBE[cat] || 'mixed'; }

// ── Per-place historical satisfaction score ─────────────────────
// Based on how similar places (same category + altitude range) performed
function _predictedSatisfaction(wishItem, optimizeFor) {
  const allVisits = DB.visits;
  const allPlaces = DB.places;
  const cat = wishItem.category;
  const alt = wishItem.altitude||0;
  const altRange = alt > 6000 ? 'high' : alt > 2000 ? 'mid' : 'low';

  const similar = allPlaces.filter(p =>
    p.category === cat &&
    ((p.altitude||0) > 6000 ? 'high' : (p.altitude||0) > 2000 ? 'mid' : 'low') === altRange
  );
  const simVisits = allVisits.filter(v => similar.some(p=>p.id===v.placeId));
  if (!simVisits.length) return 3.5; // neutral default

  let ratings;
  if      (optimizeFor === 'hunter')  ratings = simVisits.map(v=>v.hunterRating).filter(r=>r>0);
  else if (optimizeFor === 'brandon') ratings = simVisits.map(v=>v.brandonRating).filter(r=>r>0);
  else                                ratings = simVisits.flatMap(v=>[v.hunterRating,v.brandonRating].filter(r=>r>0));
  return ratings.length ? ratings.reduce((a,b)=>a+b,0)/ratings.length : 3.5;
}

// ── Companion alignment score ───────────────────────────────────
function _companionScore(wishItem, companions) {
  if (!companions.length) return 0.5; // neutral
  const allVisits = DB.visits;
  const allPlaces = DB.places;
  // Places of same category visited with these companions
  const sameCatPlaces = allPlaces.filter(p=>p.category===wishItem.category).map(p=>p.id);
  const companionVisits = allVisits.filter(v =>
    sameCatPlaces.includes(v.placeId) &&
    companions.some(c => (v.visitedWith||[]).includes(c))
  );
  const ratings = companionVisits.flatMap(v=>[v.hunterRating,v.brandonRating].filter(r=>r>0));
  const avg = ratings.length ? ratings.reduce((a,b)=>a+b,0)/ratings.length : 3.5;
  return avg / 5; // normalize to 0-1
}

// ── Season success score ────────────────────────────────────────
function _seasonScore(wishItem, targetSeason) {
  if (!targetSeason) return 0.5; // no preference
  const allVisits = DB.visits;
  const allPlaces = DB.places;
  const sameCat = allPlaces.filter(p=>p.category===wishItem.category).map(p=>p.id);
  const seasonVisits = allVisits.filter(v =>
    sameCat.includes(v.placeId) &&
    _planGetSeason(v.startDate||v.date) === targetSeason
  );
  const ratings = seasonVisits.flatMap(v=>[v.hunterRating,v.brandonRating].filter(r=>r>0));
  if (!ratings.length) return 0.5;
  return ratings.reduce((a,b)=>a+b,0)/ratings.length / 5;
}

// ── Vibe alignment ──────────────────────────────────────────────
function _vibeScore(wishItem, vibe) {
  if (vibe === 'mixed') return 0.7;
  const wv = _catVibe(wishItem.category);
  return wv === vibe ? 1.0 : 0.3;
}

// ── Novelty score ───────────────────────────────────────────────
// High if place's region/country has few past visits
function _noveltyScore(wishItem, surpriseMode) {
  const allPlaces = DB.places;
  const country = wishItem.country;
  const visitedCountries = new Set(allPlaces.map(p=>p.country).filter(Boolean));
  const base = !visitedCountries.has(country) ? 1.0 : 0.3;
  return surpriseMode ? Math.min(1, base + 0.4) : base;
}

// ── Geographic proximity score ──────────────────────────────────
// Score each wish item by how close it is to others in the selected set
function _geoEfficiency(wishItem, allSelected) {
  if (allSelected.length <= 1) return 1.0;
  const others = allSelected.filter(w => w.id !== wishItem.id);
  const dists = others.map(o => _planDist(wishItem, o)).filter(d=>d<9999);
  if (!dists.length) return 0.5;
  const avgDist = dists.reduce((a,b)=>a+b,0)/dists.length;
  // <100mi = great, >1000mi = poor
  return Math.max(0, 1 - (avgDist / 1000));
}

// ── Master place scoring ────────────────────────────────────────
function scorePlaceForPlan(wishItem, allSelected, params, surpriseMode) {
  const w = PlanWeights.get();
  const geo   = _geoEfficiency(wishItem, allSelected);
  const sat   = _predictedSatisfaction(wishItem, params.optimizeFor) / 5;
  const comp  = _companionScore(wishItem, params.companions);
  const seas  = _seasonScore(wishItem, params.season);
  const vibe  = _vibeScore(wishItem, params.vibe);
  const novel = _noveltyScore(wishItem, surpriseMode);
  return (
    w.geo * geo +
    w.satisfaction * sat +
    w.companion * comp +
    w.season * seas +
    w.vibe * vibe +
    w.novelty * novel
  );
}

// ── Geographic clustering ───────────────────────────────────────
// Simple single-linkage: group nearby items, pick best-scoring cluster
function clusterWishlist(selected, params, tripDays, surpriseMode) {
  if (!selected.length) return selected;

  // Score every item
  const scored = selected.map(w => ({
    w,
    score: scorePlaceForPlan(w, selected, params, surpriseMode),
  })).sort((a,b) => b.score - a.score);

  // Build clusters by chaining items within ~200mi of each other
  const clusters = [];
  const used = new Set();

  for (const item of scored) {
    if (used.has(item.w.id)) continue;
    const cluster = [item.w];
    used.add(item.w.id);
    for (const other of scored) {
      if (used.has(other.w.id)) continue;
      if (cluster.some(c => _planDist(c, other.w) < 300)) {
        cluster.push(other.w);
        used.add(other.w.id);
      }
    }
    clusters.push(cluster);
  }

  // If there's a wildcard for surprise mode, inject one from outside top cluster
  if (surpriseMode && clusters.length > 1) {
    const wildcard = clusters[1][0];
    if (wildcard) clusters[0].push(wildcard);
  }

  // Pick the cluster that fits trip length best
  const pacePlaces = { slow: 1.5, balanced: 2.5, dense: 3.5 };
  const ideal = Math.round(tripDays * (pacePlaces[params.pace]||2.5));
  clusters.sort((a,b) => Math.abs(a.length - ideal) - Math.abs(b.length - ideal));
  return clusters[0] || selected;
}

// ── Itinerary construction ──────────────────────────────────────
function buildItinerary(cluster, params, tripDays) {
  const { pace, vibe } = params;
  const placesPerDay = pace === 'slow' ? [1,2] : pace === 'dense' ? [3,4] : [2,3];
  const minPPD = placesPerDay[0], maxPPD = placesPerDay[1];

  // Sort cluster by geo flow: nearest-neighbor from centroid
  const sorted = _geoSort(cluster);

  // Assign places to days, balancing category variety
  const days = [];
  let remaining = [...sorted];
  for (let d = 0; d < tripDays && remaining.length; d++) {
    const count = Math.min(
      remaining.length,
      minPPD + Math.floor(Math.random() * (maxPPD - minPPD + 1))
    );
    const dayPlaces = [];
    // Hotels go first in a day if present
    const hotelIdx = remaining.findIndex(w => w.category === 'Hotel / Lodging');
    if (hotelIdx >= 0) { dayPlaces.push(remaining.splice(hotelIdx,1)[0]); }
    // Fill remaining slots with category variety
    const usedCats = new Set(dayPlaces.map(p=>p.category));
    let added = 0;
    for (let i = 0; i < remaining.length && dayPlaces.length < count; i++) {
      if (!usedCats.has(remaining[i].category) || dayPlaces.length < count - 1) {
        usedCats.add(remaining[i].category);
        dayPlaces.push(remaining.splice(i,1)[0]);
        i--;
        added++;
      }
    }
    // Fill any remaining slots
    while (dayPlaces.length < count && remaining.length) {
      dayPlaces.push(remaining.shift());
    }
    days.push(dayPlaces);
  }
  // Any leftovers go in last day
  if (remaining.length && days.length) {
    days[days.length-1].push(...remaining);
  }
  return days;
}

// Nearest-neighbor geo sort from geographic center
function _geoSort(places) {
  if (places.length <= 1) return places;
  const withCoords = places.filter(p=>p.lat&&p.lng);
  const noCoords   = places.filter(p=>!p.lat||!p.lng);
  if (!withCoords.length) return places;

  const cLat = withCoords.reduce((s,p)=>s+p.lat,0)/withCoords.length;
  const cLng = withCoords.reduce((s,p)=>s+p.lng,0)/withCoords.length;
  const centroid = { lat:cLat, lng:cLng };

  const sorted = [];
  const rem = [...withCoords];
  // Start from place closest to centroid
  rem.sort((a,b)=>_planDist(centroid,a)-_planDist(centroid,b));
  sorted.push(rem.shift());
  while (rem.length) {
    const last = sorted[sorted.length-1];
    rem.sort((a,b)=>_planDist(last,a)-_planDist(last,b));
    sorted.push(rem.shift());
  }
  return [...sorted, ...noCoords];
}

// ── Scoring panel ───────────────────────────────────────────────
function scoreItinerary(days, params) {
  const allPlaces = DB.places;
  const allVisits = DB.visits;
  const flat = days.flat();

  // Predicted ratings from historical similar
  let hPreds=[], bPreds=[];
  flat.forEach(w => {
    const sat = _predictedSatisfaction(w, 'hunter');
    const satB = _predictedSatisfaction(w, 'brandon');
    hPreds.push(sat); bPreds.push(satB);
  });
  const predH = hPreds.length ? hPreds.reduce((a,b)=>a+b,0)/hPreds.length : 0;
  const predB = bPreds.length ? bPreds.reduce((a,b)=>a+b,0)/bPreds.length : 0;

  // Density score
  const avgPPD = flat.length / Math.max(days.length,1);
  const density = _clamp((avgPPD / 4) * 100);

  // Category diversity = depth potential
  const cats = new Set(flat.map(w=>w.category).filter(Boolean));
  const depth = _clamp((cats.size / Math.max(flat.length,1)) * 100);

  // Novelty ratio
  const visitedCountries = new Set(allPlaces.map(p=>p.country).filter(Boolean));
  const novel = flat.filter(w=>!visitedCountries.has(w.country)).length;
  const noveltyRatio = flat.length ? novel/flat.length : 0;

  // Companion compatibility
  const compScores = flat.map(w => _companionScore(w, params.companions));
  const compScore = compScores.length ? compScores.reduce((a,b)=>a+b,0)/compScores.length : 0.5;

  return { predH, predB, density, depth, noveltyRatio, compScore };
}

// ── AI narrative synthesis ──────────────────────────────────────
function generateNarrative(days, params, scores, surpriseMode) {
  const flat = days.flat();
  const cats = [...new Set(flat.map(w=>w.category).filter(Boolean))];
  const countries = [...new Set(flat.map(w=>w.country).filter(Boolean))];
  const cities = [...new Set(flat.map(w=>w.city).filter(Boolean))];

  const paceWord = { slow:'unhurried', balanced:'balanced', dense:'high-density' }[params.pace]||'balanced';
  const vibeWord = params.vibe === 'mixed' ? 'varied' : params.vibe;
  const dayCount = days.length;
  const placeCount = flat.length;

  let sentences = [];

  // Opening: what this trip optimizes for
  if (params.optimizeFor === 'hunter') sentences.push(`This itinerary is optimized for Hunter's taste profile, prioritizing ${vibeWord} experiences across ${dayCount} days.`);
  else if (params.optimizeFor === 'brandon') sentences.push(`Built around Brandon's preferences, this ${paceWord} itinerary spans ${dayCount} days with a focus on ${vibeWord} destinations.`);
  else sentences.push(`This ${paceWord} ${dayCount}-day itinerary balances both taste profiles across ${placeCount} selected destinations.`);

  // Geography
  if (countries.length === 1) sentences.push(`All stops are within ${countries[0]}, keeping travel distances manageable.`);
  else if (countries.length > 1) sentences.push(`The route spans ${countries.slice(0,-1).join(', ')} and ${countries[countries.length-1]}.`);
  if (cities.length > 0) sentences.push(`Key stops include ${cities.slice(0,3).join(', ')}${cities.length>3?' and more':''}.`);

  // Categories
  if (cats.length >= 3) sentences.push(`Category variety is strong — ${cats.slice(0,3).join(', ')} — supporting the ${vibeWord} vibe.`);
  else if (cats.length > 0) sentences.push(`The trip leans heavily into ${cats.join(' and ')} experiences.`);

  // Scores
  if (scores.predH > 4.0 || scores.predB > 4.0) sentences.push(`Historical data suggests high predicted satisfaction for this category mix.`);
  if (scores.noveltyRatio > 0.5) sentences.push(`More than half of these destinations are in regions you haven't visited before, making this a high-novelty trip.`);
  if (params.season) sentences.push(`Selections are weighted toward ${params.season} performance patterns.`);
  if (surpriseMode) sentences.push(`One wildcard destination has been added outside your typical travel pattern.`);

  return sentences.join(' ');
}

// ── State ────────────────────────────────────────────────────────
let _planSelectedIds  = new Set();
let _planDays         = [];   // array of array of wishlist items
let _planParams       = {};
let _planScores       = {};
let _planSurpriseMode = false;
let _planTripDays     = 5;
let _planDayPickerDay = null; // which day is the add-to-day picker open for

// ── Open plan modal ──────────────────────────────────────────────
function openPlanTrip() {
  _planSelectedIds = new Set();
  _planDays = [];
  _planSurpriseMode = false;
  _planGoToStep(0);
  _planPopulateWishGrid();
  openModal('modal-plan-trip');
}

function _planGoToStep(step) {
  document.querySelectorAll('.plan-step').forEach((el,i)=>{
    el.classList.toggle('active', i===step);
  });
  document.querySelectorAll('.plan-phase-dot').forEach((el,i)=>{
    el.classList.toggle('active', i===step);
    el.classList.toggle('done', i<step);
  });
  const footer = document.getElementById('plan-footer');
  footer.style.display = step===0 ? 'none' : 'flex';
  document.getElementById('plan-back-btn').style.display   = step===1 ? 'flex' : 'none';
  document.getElementById('plan-regen-btn').style.display  = step===1 ? 'flex' : 'none';
  document.getElementById('plan-save-btn').textContent     = step===2 ? 'Save Trip' : 'Save Trip';
}

// ── Wishlist grid (step 0) ────────────────────────────────────────
function _planPopulateWishGrid() {
  const wish = DB.wishlist;
  const grid = document.getElementById('plan-wish-grid');
  grid.innerHTML = '';

  if (!wish.length) {
    grid.innerHTML = '<div style="font-size:12px;color:var(--text-light);padding:8px 0;">Your wishlist is empty. Add places first.</div>';
    return;
  }

  const checkSvg = `<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>`;

  wish.forEach(w => {
    const item = document.createElement('div');
    item.className = 'plan-wish-item' + (_planSelectedIds.has(w.id) ? ' selected' : '');
    item.dataset.id = w.id;
    item.innerHTML = `
      <div class="plan-wish-item-check">${checkSvg}</div>
      <div style="flex:1;min-width:0;">
        <div class="plan-wish-item-name">${escHtml(w.name)}</div>
        <div class="plan-wish-item-loc">${[w.city,w.country].filter(Boolean).join(', ')}</div>
      </div>
      ${w.category ? `<span class="plan-wish-item-cat">${escHtml(w.category)}</span>` : ''}`;
    item.addEventListener('click', () => {
      if (_planSelectedIds.has(w.id)) _planSelectedIds.delete(w.id);
      else _planSelectedIds.add(w.id);
      item.classList.toggle('selected', _planSelectedIds.has(w.id));
    });
    grid.appendChild(item);
  });
}

// ── Read params from UI ──────────────────────────────────────────
function _planReadParams() {
  const getToggle = id => {
    const active = document.querySelector(`#${id} .plan-toggle.active`);
    return active?.dataset.val || '';
  };
  return {
    pace:        getToggle('plan-pace-row')     || 'balanced',
    vibe:        getToggle('plan-vibe-row')     || 'mixed',
    energy:      getToggle('plan-energy-row')   || 'moderate',
    season:      getToggle('plan-season-row')   || '',
    optimizeFor: getToggle('plan-optimize-row') || 'both',
    companions:  [], // future: parse companion tags input
  };
}

// ── Generate ──────────────────────────────────────────────────────
function _planGenerate(surpriseMode) {
  _planSurpriseMode = surpriseMode;
  const params = _planReadParams();
  _planParams = params;

  const selected = DB.wishlist.filter(w => _planSelectedIds.has(w.id));
  if (!selected.length) {
    toast('Select at least one wishlist place first.');
    return;
  }

  // Cluster + build
  const cluster = clusterWishlist(selected, params, _planTripDays, surpriseMode);
  _planDays = buildItinerary(cluster, params, _planTripDays);
  _planScores = scoreItinerary(_planDays, params);

  _planRenderItinerary();
  _planGoToStep(1);
}

// ── Render itinerary (step 1) ────────────────────────────────────
function _planRenderItinerary() {
  // Narrative
  const narEl = document.getElementById('plan-narrative');
  narEl.style.display = 'block';
  narEl.textContent = generateNarrative(_planDays, _planParams, _planScores, _planSurpriseMode);

  // Score grid
  const sg = document.getElementById('plan-score-grid');
  const s = _planScores;
  sg.innerHTML = [
    { label:'Pred. Hunter',  val: s.predH > 0 ? s.predH.toFixed(1) : '—',    pct: (s.predH/5)*100 },
    { label:'Pred. Brandon', val: s.predB > 0 ? s.predB.toFixed(1) : '—',    pct: (s.predB/5)*100 },
    { label:'Density',       val: Math.round(s.density),                       pct: s.density },
    { label:'Depth Potential', val: Math.round(s.depth),                       pct: s.depth },
    { label:'Novelty',       val: Math.round(s.noveltyRatio*100) + '%',        pct: s.noveltyRatio*100 },
    { label:'Companion Fit', val: Math.round(s.compScore*100) + '%',           pct: s.compScore*100 },
  ].map(c => `
    <div class="plan-score-card">
      <div class="plan-score-label">${c.label}</div>
      <div class="plan-score-val">${c.val}</div>
      <div class="plan-score-bar-track"><div class="plan-score-bar-fill" style="width:${Math.min(100,c.pct||0)}%"></div></div>
    </div>`).join('');

  // Day blocks
  const daysEl = document.getElementById('plan-itinerary-days');
  daysEl.innerHTML = '';

  _planDays.forEach((dayPlaces, dayIdx) => {
    const block = document.createElement('div');
    block.className = 'plan-day-block';
    block.dataset.dayIdx = dayIdx;

    // Day header with mile estimate
    const stops = dayPlaces.filter(w=>w.lat&&w.lng);
    let milesStr = '';
    if (stops.length >= 2) {
      let total = 0;
      for (let i=0;i<stops.length-1;i++) total += _planDist(stops[i],stops[i+1]);
      milesStr = `~${Math.round(total)} mi`;
    }

    block.innerHTML = `
      <div class="plan-day-header">
        <div class="plan-day-label">Day ${dayIdx + 1}</div>
        ${milesStr ? `<div class="plan-day-miles">${milesStr}</div>` : ''}
      </div>`;

    dayPlaces.forEach((w, placeIdx) => {
      block.appendChild(_planMakePlaceCard(w, dayIdx, placeIdx));
    });

    // Add to day button
    const addBtn = document.createElement('button');
    addBtn.className = 'plan-add-to-day';
    addBtn.textContent = '+ Add a place';
    addBtn.addEventListener('click', () => _planOpenDayPicker(dayIdx));
    block.appendChild(addBtn);

    daysEl.appendChild(block);
  });

  _planWireDrag();
}

// ── Place card (draggable) ────────────────────────────────────────
function _planMakePlaceCard(w, dayIdx, placeIdx) {
  const card = document.createElement('div');
  card.className = 'plan-place-card';
  card.draggable = true;
  card.dataset.dayIdx   = dayIdx;
  card.dataset.placeIdx = placeIdx;
  card.dataset.wishId   = w.id;

  const dragHandle = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="9" cy="6" r="1.5" fill="currentColor"/><circle cx="15" cy="6" r="1.5" fill="currentColor"/><circle cx="9" cy="12" r="1.5" fill="currentColor"/><circle cx="15" cy="12" r="1.5" fill="currentColor"/><circle cx="9" cy="18" r="1.5" fill="currentColor"/><circle cx="15" cy="18" r="1.5" fill="currentColor"/></svg>`;

  card.innerHTML = `
    <div class="plan-place-drag">${dragHandle}</div>
    <div class="plan-place-body">
      <div class="plan-place-name">${escHtml(w.name)}</div>
      <div class="plan-place-loc">${[w.city, w.country].filter(Boolean).join(', ')}</div>
      ${w.category ? `<span class="plan-place-cat">${escHtml(w.category)}</span>` : ''}
    </div>
    <button class="plan-place-remove" title="Remove">×</button>`;

  card.querySelector('.plan-place-remove').addEventListener('click', e => {
    e.stopPropagation();
    _planDays[dayIdx].splice(placeIdx, 1);
    if (_planDays[dayIdx].length === 0) _planDays.splice(dayIdx, 1);
    _planScores = scoreItinerary(_planDays, _planParams);
    _planRenderItinerary();
  });

  return card;
}

// ── Drag and drop between/within days ────────────────────────────
function _planWireDrag() {
  let dragSrc = null; // { dayIdx, placeIdx }

  document.querySelectorAll('.plan-place-card').forEach(card => {
    card.addEventListener('dragstart', e => {
      dragSrc = { dayIdx: parseInt(card.dataset.dayIdx), placeIdx: parseInt(card.dataset.placeIdx) };
      card.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    });
    card.addEventListener('dragend', () => {
      card.classList.remove('dragging');
      document.querySelectorAll('.plan-place-card').forEach(c => c.classList.remove('drag-over'));
    });
    card.addEventListener('dragover', e => {
      e.preventDefault();
      card.classList.add('drag-over');
    });
    card.addEventListener('dragleave', () => card.classList.remove('drag-over'));
    card.addEventListener('drop', e => {
      e.preventDefault();
      if (!dragSrc) return;
      const destDay   = parseInt(card.dataset.dayIdx);
      const destPlace = parseInt(card.dataset.placeIdx);
      if (dragSrc.dayIdx === destDay && dragSrc.placeIdx === destPlace) return;

      const item = _planDays[dragSrc.dayIdx].splice(dragSrc.placeIdx, 1)[0];
      // If source day is now empty, remove it
      if (_planDays[dragSrc.dayIdx].length === 0) {
        _planDays.splice(dragSrc.dayIdx, 1);
        // Adjust dest if necessary
        if (destDay > dragSrc.dayIdx) _planDays[destDay-1]?.splice(destPlace, 0, item);
        else _planDays[destDay]?.splice(destPlace, 0, item);
      } else {
        _planDays[destDay]?.splice(destPlace, 0, item);
      }
      _planScores = scoreItinerary(_planDays, _planParams);
      _planRenderItinerary();
      dragSrc = null;
    });
  });
}

// ── Day picker (add wishlist item to a day) ───────────────────────
function _planOpenDayPicker(dayIdx) {
  _planDayPickerDay = dayIdx;
  // Remove existing picker
  document.querySelectorAll('.plan-day-picker').forEach(el=>el.remove());

  const alreadyIn = new Set(_planDays.flat().map(w=>w.id));
  const available = DB.wishlist.filter(w => !alreadyIn.has(w.id));

  const picker = document.createElement('div');
  picker.className = 'plan-day-picker';
  picker.innerHTML = `
    <button class="plan-day-picker-close" id="plan-picker-close">×</button>
    <div class="plan-day-picker-title">Add to Day ${dayIdx+1}</div>`;

  if (!available.length) {
    picker.innerHTML += '<div style="font-size:12px;color:var(--text-light);">All wishlist places are already in the itinerary.</div>';
  } else {
    available.forEach(w => {
      const row = document.createElement('div');
      row.className = 'plan-wish-item';
      row.style.cssText = 'margin-bottom:6px;';
      row.innerHTML = `
        <div class="plan-wish-item-body" style="flex:1;min-width:0;">
          <div class="plan-wish-item-name">${escHtml(w.name)}</div>
          <div class="plan-wish-item-loc">${[w.city,w.country].filter(Boolean).join(', ')}</div>
        </div>
        ${w.category?`<span class="plan-wish-item-cat">${escHtml(w.category)}</span>`:''}`;
      row.addEventListener('click', () => {
        _planDays[_planDayPickerDay] = _planDays[_planDayPickerDay] || [];
        _planDays[_planDayPickerDay].push(w);
        _planScores = scoreItinerary(_planDays, _planParams);
        picker.remove();
        _planRenderItinerary();
      });
      picker.appendChild(row);
    });
  }

  document.getElementById('modal-plan-trip').querySelector('.modal').appendChild(picker);
  picker.querySelector('#plan-picker-close').addEventListener('click', () => picker.remove());
}

// ── Save trip ──────────────────────────────────────────────────────
function _planSaveTrip() {
  const name = document.getElementById('plan-trip-name').value.trim() || 'Planned Trip';
  const startDate = document.getElementById('plan-start-date').value;
  const endDate   = document.getElementById('plan-end-date').value;

  const tripId = uid();
  const trip = {
    id: tripId,
    name,
    startDate: startDate || '',
    endDate:   endDate   || '',
    notes: `Generated by Plan a Trip. Style: ${_planParams.pace} pace, ${_planParams.vibe} vibe.`,
    tags: [],
    generatedFrom: 'plan',
    wishlistIds: _planDays.flat().map(w=>w.id),
    scoreSnapshot: _planScores,
  };
  saveTrip(trip);
  toast(`Trip "${name}" saved!`);
  closeModal('modal-plan-trip');
  openTripDetail(tripId);
}

// ── Confirm step rendering (step 2) ──────────────────────────────
function _planRenderConfirm() {
  const flat = _planDays.flat();
  const days = _planDays.length;
  const summary = document.getElementById('plan-confirm-summary');
  summary.innerHTML = `
    <div class="plan-card">
      <div class="plan-card-title">Summary</div>
      <div style="font-size:13px;color:var(--text-muted);line-height:1.7;">
        ${days} day${days!==1?'s':''} · ${flat.length} place${flat.length!==1?'s':''}<br>
        ${[...(new Set(flat.map(w=>w.country).filter(Boolean)))].join(', ')}<br>
        Pace: <strong>${_planParams.pace}</strong> &nbsp;·&nbsp; Vibe: <strong>${_planParams.vibe}</strong>
      </div>
    </div>`;
}

// ── Wire all plan UI events ───────────────────────────────────────
(function _wirePlanUI() {
  // Close
  document.getElementById('plan-trip-close').addEventListener('click', () => closeModal('modal-plan-trip'));

  // Days stepper
  document.getElementById('plan-days-minus').addEventListener('click', () => {
    _planTripDays = Math.max(1, _planTripDays-1);
    document.getElementById('plan-days-num').textContent = _planTripDays;
  });
  document.getElementById('plan-days-plus').addEventListener('click', () => {
    _planTripDays = Math.min(30, _planTripDays+1);
    document.getElementById('plan-days-num').textContent = _planTripDays;
  });

  // Toggle groups (single-select)
  document.querySelectorAll('.plan-toggle-row').forEach(row => {
    row.querySelectorAll('.plan-toggle').forEach(btn => {
      btn.addEventListener('click', () => {
        row.querySelectorAll('.plan-toggle').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
      });
    });
  });

  // Select all wishlist
  document.getElementById('plan-select-all').addEventListener('click', () => {
    const all = DB.wishlist.map(w=>w.id);
    const allSelected = all.every(id => _planSelectedIds.has(id));
    if (allSelected) { _planSelectedIds.clear(); }
    else { all.forEach(id => _planSelectedIds.add(id)); }
    _planPopulateWishGrid();
  });

  // Generate
  document.getElementById('plan-generate-btn').addEventListener('click', () => _planGenerate(false));
  document.getElementById('plan-surprise-btn').addEventListener('click', () => {
    // Select all for surprise mode if nothing selected
    if (!_planSelectedIds.size) {
      DB.wishlist.forEach(w => _planSelectedIds.add(w.id));
    }
    _planGenerate(true);
  });

  // Footer: back, regen, save
  document.getElementById('plan-back-btn').addEventListener('click', () => _planGoToStep(0));
  document.getElementById('plan-regen-btn').addEventListener('click', () => {
    _planGenerate(_planSurpriseMode);
  });
  document.getElementById('plan-save-btn').addEventListener('click', () => {
    const currentStep = [...document.querySelectorAll('.plan-step')].findIndex(el=>el.classList.contains('active'));
    if (currentStep === 1) {
      _planRenderConfirm();
      _planGoToStep(2);
    } else {
      _planSaveTrip();
    }
  });

  // Open plan trip from wishlist header button
  const planBtn = document.getElementById('plan-trip-btn');
  if (planBtn) planBtn.addEventListener('click', openPlanTrip);
})();

// ── Feedback loop: compare predicted vs actual after trip ────────
// Called when opening a completed trip detail if it was generated
function _planCheckFeedback(tripId) {
  const t = DB.trips.find(x=>x.id===tripId);
  if (!t?.scoreSnapshot || t._feedbackApplied) return;
  const visits = DB.visits.filter(v=>v.tripId===tripId);
  const ratings = visits.flatMap(v=>[v.hunterRating,v.brandonRating].filter(r=>r>0));
  if (!ratings.length) return;
  const actualAvg = ratings.reduce((a,b)=>a+b,0)/ratings.length;
  const predAvg = (t.scoreSnapshot.predH + t.scoreSnapshot.predB) / 2;
  PlanWeights.adjust(predAvg, actualAvg);
  // Mark as applied so we don't adjust twice
  const trips = DB.trips;
  const idx = trips.findIndex(x=>x.id===tripId);
  if (idx>=0) { trips[idx]._feedbackApplied = true; DB.trips = trips; }
}



// ═══════════════════════════════════════════════════════════════
//  TRAVEL WRAPPED — MONTHLY REVIEW ENGINE
// ═══════════════════════════════════════════════════════════════

// ── Home base config ────────────────────────────────────────────
const HOME_BASE = {
  name: 'Dallas',
  city: 'Dallas',
  state: 'Texas',
  lat: 32.7767,
  lng: -96.7970,
  metroRadiusMiles: 40,    // places within 40mi of downtown Dallas = "metro"
};

// ── Cache ────────────────────────────────────────────────────────
const WRAPPED_CACHE_KEY = 'pd_wrapped_cache';
function _wrGetCache() {
  try { return JSON.parse(localStorage.getItem(WRAPPED_CACHE_KEY) || '{}'); } catch(e){ return {}; }
}
function _wrSetCache(key, data) {
  const c = _wrGetCache(); c[key] = data;
  try { localStorage.setItem(WRAPPED_CACHE_KEY, JSON.stringify(c)); } catch(e){}
}
function _wrCacheKey(year, month) { return `${year}-${String(month+1).padStart(2,'0')}_${dataHash()}`; }

// ── Location helpers ─────────────────────────────────────────────
function _isHometown(place) {
  if (!place) return false;
  // City/state name match
  if ((place.city||'').toLowerCase().includes(HOME_BASE.city.toLowerCase()) ||
      (place.state||'').toLowerCase().includes(HOME_BASE.state.toLowerCase()) ||
      (place.city||'').toLowerCase().includes('fort worth') ||
      (place.city||'').toLowerCase().includes('plano') ||
      (place.city||'').toLowerCase().includes('frisco') ||
      (place.city||'').toLowerCase().includes('irving') ||
      (place.city||'').toLowerCase().includes('arlington')) {
    return true;
  }
  // Radius fallback if coords available
  if (place.lat && place.lng) {
    return haversineMiles(place, HOME_BASE) <= HOME_BASE.metroRadiusMiles;
  }
  return false;
}

// Classify month into 'hometown' | 'mixed' | 'travel'
function _classifyMonth(monthVisits, monthPlaces) {
  if (!monthVisits.length) return 'travel';
  const hometownVisits = monthVisits.filter(v => {
    const p = monthPlaces.find(x => x.id === v.placeId);
    return p && _isHometown(p);
  });
  const pct = hometownVisits.length / monthVisits.length;
  if (pct >= 0.85) return 'hometown';
  if (pct >= 0.25) return 'mixed';
  return 'travel';
}

// Miles from Dallas to a place
function _milesFromHome(place) {
  if (!place || !place.lat || !place.lng) return null;
  return haversineMiles(HOME_BASE, place);
}

// ── Month data builder ───────────────────────────────────────────
function buildWrappedData(year, month) {
  const cKey = _wrCacheKey(year, month);
  const cache = _wrGetCache();
  if (cache[cKey]) return cache[cKey];

  const allPlaces = DB.places;
  const allVisits = DB.visits;
  const allWishlist = DB.wishlist;
  const MM = String(month + 1).padStart(2, '0');
  const prefix = `${year}-${MM}`;

  // Month visits (startDate || date)
  const monthVisits = allVisits.filter(v => {
    const d = v.startDate || v.date || '';
    return d.startsWith(prefix);
  });
  const monthPlaceIds = [...new Set(monthVisits.map(v => v.placeId))];
  const monthPlaces = monthPlaceIds.map(id => allPlaces.find(p => p.id === id)).filter(Boolean);

  if (!monthVisits.length) return null;

  // ── Classification ───────────────────────────────────────────
  const mode = _classifyMonth(monthVisits, monthPlaces);

  // ── Rating stats ─────────────────────────────────────────────
  const hRatings = monthVisits.map(v => v.hunterRating).filter(r => r > 0);
  const bRatings = monthVisits.map(v => v.brandonRating).filter(r => r > 0);
  const allRatings = [...hRatings, ...bRatings];
  const hAvg = hRatings.length ? hRatings.reduce((a,b)=>a+b,0)/hRatings.length : 0;
  const bAvg = bRatings.length ? bRatings.reduce((a,b)=>a+b,0)/bRatings.length : 0;
  const avgRating = allRatings.length ? allRatings.reduce((a,b)=>a+b,0)/allRatings.length : 0;

  // ── Category breakdown ───────────────────────────────────────
  const catCounts = {};
  monthPlaces.forEach(p => { if (p.category) catCounts[p.category] = (catCounts[p.category]||0)+1; });
  const topCats = Object.entries(catCounts).sort((a,b)=>b[1]-a[1]);

  // ── Notes ────────────────────────────────────────────────────
  const monthNotes = monthPlaces.flatMap(p => (p.notes||[]).filter(n => {
    return n.ts && n.ts.startsWith(prefix);
  }));
  const totalNoteChars = monthNotes.reduce((s,n)=>s+(n.text||'').length, 0);
  const avgNoteLen = monthNotes.length ? totalNoteChars / monthNotes.length : 0;

  // ── Geography ────────────────────────────────────────────────
  const countries  = [...new Set(monthPlaces.map(p=>p.country).filter(Boolean))];
  const states     = [...new Set(monthPlaces.map(p=>p.state).filter(Boolean))];
  const cities     = [...new Set(monthPlaces.map(p=>p.city).filter(Boolean))];
  const milesArr   = monthPlaces.map(_milesFromHome).filter(Boolean);
  const avgMiles   = milesArr.length ? milesArr.reduce((a,b)=>a+b,0)/milesArr.length : 0;
  const maxMiles   = milesArr.length ? Math.max(...milesArr) : 0;
  const furthestPlace = milesArr.length
    ? monthPlaces.reduce((best, p) => {
        const d = _milesFromHome(p) || 0;
        return d > (_milesFromHome(best) || 0) ? p : best;
      }, monthPlaces[0])
    : null;

  // ── Hometown-specific ────────────────────────────────────────
  const homePlaces = monthPlaces.filter(_isHometown);
  const travelPlaces = monthPlaces.filter(p => !_isHometown(p));
  const homeVisits = monthVisits.filter(v => homePlaces.some(p=>p.id===v.placeId));

  // Repeat rate (places visited more than once this month)
  const visitPerPlace = {};
  monthVisits.forEach(v => { visitPerPlace[v.placeId] = (visitPerPlace[v.placeId]||0)+1; });
  const repeatCount = Object.values(visitPerPlace).filter(c=>c>1).length;
  const repeatRatio = monthPlaces.length ? repeatCount/monthPlaces.length : 0;

  // New places vs known (not visited before this month)
  const newPlaces = monthPlaces.filter(p => {
    const allVisitsToPlace = allVisits.filter(v => v.placeId === p.id);
    const firstVisitDate = allVisitsToPlace.map(v=>v.startDate||v.date||'').sort()[0]||'';
    return firstVisitDate.startsWith(prefix);
  });

  // Home ratings vs lifetime home ratings
  const lifeHomeVisits = allVisits.filter(v => {
    const p = allPlaces.find(x=>x.id===v.placeId);
    return p && _isHometown(p);
  });
  const lifeHomeRatings = lifeHomeVisits.flatMap(v=>[v.hunterRating,v.brandonRating].filter(r=>r>0));
  const lifeHomeAvg = lifeHomeRatings.length ? lifeHomeRatings.reduce((a,b)=>a+b,0)/lifeHomeRatings.length : 0;
  const monthHomeRatings = homeVisits.flatMap(v=>[v.hunterRating,v.brandonRating].filter(r=>r>0));
  const monthHomeAvg = monthHomeRatings.length ? monthHomeRatings.reduce((a,b)=>a+b,0)/monthHomeRatings.length : 0;

  // ── Trip length proxy ─────────────────────────────────────────
  const activeDays = new Set(monthVisits.map(v=>(v.startDate||v.date||'').slice(0,10))).size;
  const placesPerDay = activeDays > 0 ? monthPlaces.length / activeDays : 0;

  // ── Density & depth (reuse analytics engine) ─────────────────
  const tripLen = activeDays || 1;
  const noteDensity = monthNotes.length / tripLen;
  const dNoteDensity = _clamp((noteDensity / 5) * 100);
  const dNoteLen = _clamp((avgNoteLen / 200) * 100);
  const dRepeat = repeatRatio * 100;
  const dCatDiv = topCats.length / Math.max(monthPlaces.length, 1) * 100;
  const dStability = _clamp(100 - (_variance(allRatings) / 3) * 100);
  const depthScore = _clamp(dNoteDensity*0.25 + dNoteLen*0.20 + dRepeat*0.20 + dCatDiv*0.20 + dStability*0.15);

  const nPPD = _clamp((placesPerDay / 4) * 100);
  const densityScore = _clamp(nPPD * 0.60 + dCatDiv * 0.25 + _clamp((monthPlaces.length/tripLen/3)*100) * 0.15);

  // ── Identity label ────────────────────────────────────────────
  let identity, identityMode;
  if (mode === 'hometown') {
    identityMode = 'hometown';
    if (repeatRatio > 0.5 && depthScore > 60)       identity = 'Comfort & Consistency';
    else if (newPlaces.length >= 3 && densityScore > 50) identity = 'Neighborhood Explorer';
    else if (depthScore > 65)                        identity = 'Local Deep Dive';
    else if (densityScore > 55)                      identity = 'Dallas Reimagined';
    else                                             identity = 'The Hometown Era';
  } else if (mode === 'mixed') {
    identityMode = 'mixed';
    identity = depthScore > densityScore ? 'Rooted but Roaming' : 'Balanced Ground';
  } else {
    identityMode = 'travel';
    if (countries.length > 1)            identity = 'International Chapter';
    else if (states.length > 2)          identity = 'Out of State Era';
    else if (densityScore > 60)          identity = 'Map Expander';
    else                                 identity = 'Map Expander';
  }

  // ── Surprise insight ──────────────────────────────────────────
  let insight = '';
  if (mode === 'hometown') {
    if (monthHomeAvg > 0 && lifeHomeAvg > 0) {
      const delta = monthHomeAvg - lifeHomeAvg;
      if (Math.abs(delta) >= 0.2) {
        insight = delta > 0
          ? `Dallas visits this month averaged ${delta.toFixed(1)} stars above your lifetime Dallas average.`
          : `Dallas visits this month trended ${Math.abs(delta).toFixed(1)} below your usual home-ground scores.`;
      }
    }
    if (!insight && repeatRatio > 0.3) {
      insight = `Repeat spots in Dallas averaged your strongest local ratings — depth over breadth paid off.`;
    }
    if (!insight && avgNoteLen > 120) {
      insight = `Local exploration produced your longest notes this month — a sign of genuine engagement.`;
    }
    if (!insight) {
      insight = `Dallas culinary and neighborhood visits drove the most consistent emotional documentation.`;
    }
  } else if (mode === 'travel') {
    if (maxMiles > 5000) {
      insight = `Your furthest stop was ${maxMiles.toFixed(0)} miles from Dallas — a serious map expansion.`;
    } else if (depthScore < 40 && densityScore > 60) {
      insight = `High-density travel with light documentation — you covered ground faster than you reflected on it.`;
    } else if (repeatRatio === 0 && newPlaces.length >= 4) {
      insight = `Every single place this month was brand new — maximum novelty, zero repetition.`;
    } else {
      insight = `Travel outside Texas generated some of your highest-stakes moments in the journal.`;
    }
  } else {
    // mixed
    if (monthHomeAvg > 0 && avgRating > 0 && Math.abs(monthHomeAvg - avgRating) > 0.3) {
      const which = monthHomeAvg > avgRating ? 'Dallas spots' : 'travel destinations';
      insight = `${which} outperformed the overall average this month by ${Math.abs(monthHomeAvg - avgRating).toFixed(1)} stars.`;
    } else {
      insight = `The blend of local and travel visits produced one of the more varied months in the journal.`;
    }
  }

  // ── Wishlist nudge ────────────────────────────────────────────
  const wishCats = {};
  allWishlist.forEach(w => { if(w.category) wishCats[w.category]=(wishCats[w.category]||0)+1; });
  const topWishCat = Object.entries(wishCats).sort((a,b)=>b[1]-a[1])[0]?.[0]||null;
  const wishCountries = [...new Set(allWishlist.map(w=>w.country).filter(Boolean))];
  const wishNudge = mode === 'hometown'
    ? (wishCountries.length >= 2 ? `Next month, ${wishCountries.slice(0,2).join(' or ')} might be calling.` : 'The wishlist is waiting for its moment.')
    : (topWishCat ? `The wishlist is leaning toward ${topWishCat.toLowerCase()} experiences.` : 'A few high-priority items are ready to plan.');

  // ── Top-rated places this month ───────────────────────────────
  const ratedThisMonth = monthPlaces.map(p => {
    const pvs = monthVisits.filter(v=>v.placeId===p.id);
    const rs = pvs.flatMap(v=>[v.hunterRating,v.brandonRating].filter(r=>r>0));
    const avg = rs.length ? rs.reduce((a,b)=>a+b,0)/rs.length : 0;
    return { p, avg };
  }).filter(x=>x.avg>0).sort((a,b)=>b.avg-a.avg);

  // ── Visited-with breakdown ────────────────────────────────────
  const companions = {};
  monthVisits.forEach(v=>(v.visitedWith||[]).forEach(c=>{ companions[c]=(companions[c]||0)+1; }));
  const topCompanions = Object.entries(companions).sort((a,b)=>b[1]-a[1]).slice(0,3);

  const data = {
    year, month, mode, identity, identityMode,
    insight, wishNudge,
    totalPlaces: monthPlaces.length,
    totalVisits: monthVisits.length,
    newPlaces: newPlaces.length,
    activeDays,
    hAvg, bAvg, avgRating,
    topCats, countries, states, cities,
    avgMiles, maxMiles, furthestPlace,
    repeatRatio, repeatCount,
    homePlaces: homePlaces.length,
    travelPlaces: travelPlaces.length,
    monthHomeAvg, lifeHomeAvg,
    depthScore, densityScore,
    noteDensity, avgNoteLen, monthNotes: monthNotes.length,
    ratedThisMonth: ratedThisMonth.slice(0,5),
    topCompanions,
    wishNudge, topWishCat,
  };

  _wrSetCache(cKey, data);
  return data;
}

// ── Slide builder ────────────────────────────────────────────────
const MONTHS_LONG = ['January','February','March','April','May','June',
                     'July','August','September','October','November','December'];

function _orb(cls, top, left, w) {
  return `<div class="wr-orb ${cls}" style="width:${w}px;height:${w}px;top:${top}%;left:${left}%;"></div>`;
}

function buildWrappedSlides(d) {
  const mn = MONTHS_LONG[d.month];
  const bgMode = d.mode === 'hometown' ? 'wr-bg-hometown' : d.mode === 'travel' ? 'wr-bg-travel' : 'wr-bg-mixed';
  const slides = [];

  // ── SLIDE 0: Opening / Overview ───────────────────────────────
  const headline0 = d.mode === 'hometown'
    ? 'Your<br>Hometown Era'
    : d.mode === 'mixed'
    ? 'Rooted &<br>Roaming'
    : `Beyond<br>Dallas`;

  const sub0 = d.mode === 'hometown'
    ? `${mn} stayed close to home — but that doesn't mean it stayed still.`
    : d.mode === 'travel'
    ? `${mn} took you away from Dallas and into new territory.`
    : `${mn} mixed local comfort with fresh ground.`;

  slides.push(`
    <div class="wr-slide-bg ${bgMode}">
      ${_orb('wr-orb-green',10,60,240)} ${_orb('wr-orb-blue',55,-10,180)}
    </div>
    <div class="wr-slide-content">
      <div class="wr-kicker">${mn} ${d.year}</div>
      <div class="wr-headline">${headline0}</div>
      <div class="wr-subline">${sub0}</div>
    </div>`);

  // ── SLIDE 1: Stats snapshot ───────────────────────────────────
  slides.push(`
    <div class="wr-slide-bg wr-bg-stat">
      ${_orb('wr-orb-teal',20,50,200)} ${_orb('wr-orb-green',-5,-10,160)}
    </div>
    <div class="wr-slide-content">
      <div class="wr-kicker">By the numbers</div>
      <div class="wr-headline sm" style="margin-bottom:18px;">${mn} <span style="color:rgba(255,255,255,0.3);">${d.year}</span></div>
      <div class="wr-stat-row">
        <div class="wr-stat-block">
          <div class="wr-stat-val lg">${d.totalPlaces}</div>
          <div class="wr-stat-lbl">Places</div>
        </div>
        <div class="wr-stat-block">
          <div class="wr-stat-val lg">${d.totalVisits}</div>
          <div class="wr-stat-lbl">Visits</div>
        </div>
        <div class="wr-stat-block">
          <div class="wr-stat-val lg">${d.activeDays}</div>
          <div class="wr-stat-lbl">Active Days</div>
        </div>
      </div>
      <div class="wr-stat-row">
        ${d.newPlaces > 0 ? `<div class="wr-stat-block"><div class="wr-stat-val">${d.newPlaces}</div><div class="wr-stat-lbl">New Places</div></div>` : ''}
        ${d.repeatCount > 0 ? `<div class="wr-stat-block"><div class="wr-stat-val">${Math.round(d.repeatRatio*100)}%</div><div class="wr-stat-lbl">Revisit Rate</div></div>` : ''}
        ${d.monthNotes > 0 ? `<div class="wr-stat-block"><div class="wr-stat-val">${d.monthNotes}</div><div class="wr-stat-lbl">Notes Written</div></div>` : ''}
      </div>
      <div class="wr-subline">${d.activeDays} days of documented experience across ${d.totalPlaces} place${d.totalPlaces!==1?'s':''}.</div>
    </div>`);

  // ── SLIDE 2: Geography ────────────────────────────────────────
  let geoContent = '';
  if (d.mode === 'hometown') {
    const topCat = d.topCats[0]?.[0] || 'a variety of spots';
    const topCatCount = d.topCats[0]?.[1] || 0;
    geoContent = `
      <div class="wr-kicker">Your territory</div>
      <div class="wr-headline sm">You treated Dallas<br>like a destination.</div>
      <div class="wr-bar-set">
        ${d.topCats.slice(0,4).map(([cat,count]) => `
          <div class="wr-bar-row">
            <div class="wr-bar-meta">
              <span class="wr-bar-label">${escHtml(cat)}</span>
              <span class="wr-bar-num">${count}</span>
            </div>
            <div class="wr-bar-track"><div class="wr-bar-fill" style="width:${Math.round((count/d.topCats[0][1])*100)}%"></div></div>
          </div>`).join('')}
      </div>
      <div class="wr-subline">${d.cities.length} Dallas-area neighborhood${d.cities.length!==1?'s':''} explored. ${d.homePlaces} total home-ground spots.</div>`;
  } else {
    const distNote = d.avgMiles > 0 ? `${Math.round(d.avgMiles).toLocaleString()} miles from home on average.` : '';
    geoContent = `
      <div class="wr-kicker">Where you went</div>
      <div class="wr-headline sm">${d.countries.length > 1 ? `${d.countries.length} countries.` : d.states.length > 1 ? `${d.states.length} states.` : d.cities.length + ' cities.'}<br><span class="wr-accent-word">All new ground.</span></div>
      ${d.countries.length ? `
        <div class="wr-bar-set">
          ${d.countries.slice(0,4).map(c=>`<div class="wr-bar-row">
            <div class="wr-bar-meta"><span class="wr-bar-label">${escHtml(c)}</span></div>
            <div class="wr-bar-track"><div class="wr-bar-fill" style="width:100%"></div></div>
          </div>`).join('')}
        </div>` : ''}
      <div class="wr-subline">${distNote}${d.furthestPlace ? ` Furthest stop: ${escHtml(d.furthestPlace.name)}${d.maxMiles > 0 ? ' (' + Math.round(d.maxMiles).toLocaleString() + ' mi)' : ''}.` : ''}</div>`;
  }
  slides.push(`
    <div class="wr-slide-bg ${bgMode}">
      ${_orb('wr-orb-blue',5,40,220)} ${_orb('wr-orb-teal',60,-5,150)}
    </div>
    <div class="wr-slide-content">${geoContent}</div>`);

  // ── SLIDE 3: Ratings ──────────────────────────────────────────
  const ratingSlide = (d.hAvg > 0 || d.bAvg > 0) ? `
    <div class="wr-slide-bg wr-bg-rating">
      ${_orb('wr-orb-violet',15,55,200)} ${_orb('wr-orb-blue',65,-5,160)}
    </div>
    <div class="wr-slide-content">
      <div class="wr-kicker">How it landed</div>
      <div class="wr-score-pair">
        ${d.hAvg > 0 ? `<div class="wr-score-item">
          <div class="wr-score-name">Hunter</div>
          <div class="wr-score-num">${d.hAvg.toFixed(1)}</div>
          <div class="wr-score-track"><div class="wr-score-fill" style="width:${(d.hAvg/5)*100}%"></div></div>
        </div>` : ''}
        ${d.bAvg > 0 ? `<div class="wr-score-item">
          <div class="wr-score-name">Brandon</div>
          <div class="wr-score-num">${d.bAvg.toFixed(1)}</div>
          <div class="wr-score-track"><div class="wr-score-fill" style="width:${(d.bAvg/5)*100}%"></div></div>
        </div>` : ''}
      </div>
      ${d.ratedThisMonth.length ? `
        <div class="wr-list">
          ${d.ratedThisMonth.slice(0,4).map((x,i)=>`
            <div class="wr-list-item">
              <div class="wr-list-rank">${i+1}</div>
              <div class="wr-list-name">${escHtml(x.p.name)}</div>
              <div class="wr-list-val">${x.avg.toFixed(1)}</div>
            </div>`).join('')}
        </div>` : ''}
      ${d.mode === 'hometown' && d.monthHomeAvg > 0 && d.lifeHomeAvg > 0 ? `
        <div class="wr-subline">Your Dallas average this month: ${d.monthHomeAvg.toFixed(1)} vs lifetime home average: ${d.lifeHomeAvg.toFixed(1)}.</div>` : ''}
    </div>` : null;
  if (ratingSlide) slides.push(ratingSlide);

  // ── SLIDE 4: Categories ───────────────────────────────────────
  if (d.topCats.length) {
    slides.push(`
      <div class="wr-slide-bg wr-bg-stat">
        ${_orb('wr-orb-green',25,60,220)} ${_orb('wr-orb-teal',70,-5,160)}
      </div>
      <div class="wr-slide-content">
        <div class="wr-kicker">What you sought</div>
        <div class="wr-headline md"><span class="wr-accent-word">${escHtml(d.topCats[0][0])}</span><br>led the month.</div>
        <div class="wr-bar-set">
          ${d.topCats.slice(0,5).map(([cat,count])=>`
            <div class="wr-bar-row">
              <div class="wr-bar-meta">
                <span class="wr-bar-label">${escHtml(cat)}</span>
                <span class="wr-bar-num">${count}</span>
              </div>
              <div class="wr-bar-track"><div class="wr-bar-fill" style="width:${Math.round((count/d.topCats[0][1])*100)}%"></div></div>
            </div>`).join('')}
        </div>
      </div>`);
  }

  // ── SLIDE 5: Depth vs Density ─────────────────────────────────
  slides.push(`
    <div class="wr-slide-bg wr-bg-identity">
      ${_orb('wr-orb-green',10,50,200)} ${_orb('wr-orb-teal',60,10,160)}
    </div>
    <div class="wr-slide-content">
      <div class="wr-kicker">Travel character</div>
      <div class="wr-score-pair">
        <div class="wr-score-item">
          <div class="wr-score-name">Depth</div>
          <div class="wr-score-num">${Math.round(d.depthScore)}</div>
          <div class="wr-score-track"><div class="wr-score-fill" style="width:${d.depthScore}%"></div></div>
        </div>
        <div class="wr-score-item">
          <div class="wr-score-name">Density</div>
          <div class="wr-score-num">${Math.round(d.densityScore)}</div>
          <div class="wr-score-track"><div class="wr-score-fill" style="width:${d.densityScore}%"></div></div>
        </div>
      </div>
      <div class="wr-subline">${d.depthScore > d.densityScore
        ? 'You went deep this month. Fewer places, more presence.'
        : d.densityScore > d.depthScore
        ? 'You moved fast this month. High coverage, strong momentum.'
        : 'A balanced month — steady depth with good forward movement.'}</div>
    </div>`);

  // ── SLIDE 6: Identity card ─────────────────────────────────────
  slides.push(`
    <div class="wr-slide-bg wr-bg-identity">
      ${_orb('wr-orb-green',5,55,260)} ${_orb('wr-orb-blue',60,-5,180)} ${_orb('wr-orb-teal',30,80,140)}
    </div>
    <div class="wr-slide-content">
      <div class="wr-kicker">Your ${mn} identity</div>
      <div class="wr-identity-badge ${d.identityMode}">${escHtml(d.identity)}</div>
      <div class="wr-headline md">${mn}<br>${d.year}</div>
      ${d.topCompanions.length ? `
        <div class="wr-subline" style="margin-top:10px;">
          Most often with: ${d.topCompanions.map(([c])=>escHtml(c)).join(', ')}.
        </div>` : ''}
    </div>`);

  // ── SLIDE 7: Surprise insight ─────────────────────────────────
  slides.push(`
    <div class="wr-slide-bg wr-bg-surprise">
      ${_orb('wr-orb-rose',20,60,200)} ${_orb('wr-orb-violet',65,-5,150)}
    </div>
    <div class="wr-slide-content">
      <div class="wr-kicker">Something we noticed</div>
      <div class="wr-insight-pill">Data Insight</div>
      <div class="wr-headline sm">${escHtml(d.insight)}</div>
    </div>`);

  // ── SLIDE 8: Wishlist nudge ────────────────────────────────────
  slides.push(`
    <div class="wr-slide-bg wr-bg-wishlist">
      ${_orb('wr-orb-violet',15,55,200)} ${_orb('wr-orb-blue',60,-5,160)}
    </div>
    <div class="wr-slide-content">
      <div class="wr-kicker">What's next</div>
      <div class="wr-headline sm">The list<br>is ready.</div>
      <div class="wr-subline" style="margin-bottom:14px;">${escHtml(d.wishNudge)}</div>
      ${d.topWishCat ? `<div class="wr-stat-row">
        <div class="wr-stat-block">
          <div class="wr-stat-val" style="font-size:18px;line-height:1.2;">${escHtml(d.topWishCat)}</div>
          <div class="wr-stat-lbl">Top wishlist category</div>
        </div>
      </div>` : ''}
    </div>`);

  // ── SLIDE 9: Close card ────────────────────────────────────────
  const closeLine = d.mode === 'hometown'
    ? `Dallas showed up for you. You showed up for Dallas.`
    : d.mode === 'travel'
    ? `Another month of the map filled in.`
    : `Half home, half horizon. That's a good balance.`;

  slides.push(`
    <div class="wr-slide-bg wr-bg-close">
      ${_orb('wr-orb-green',10,55,260)} ${_orb('wr-orb-blue',60,-5,200)}
    </div>
    <div class="wr-slide-content">
      <div class="wr-kicker">That's a wrap</div>
      <div class="wr-headline">${mn}<br>${d.year}</div>
      <div class="wr-subline">${closeLine}</div>
    </div>`);

  return slides;
}

// ── Wrapped player ────────────────────────────────────────────────
let _wrSlides = [], _wrCurrent = 0, _wrData = null;

function openWrapped(year, month) {
  const data = buildWrappedData(year, month);
  if (!data) {
    toast(`No visits found for ${MONTHS_LONG[month]} ${year}.`);
    return;
  }
  _wrData = data;
  _wrSlides = buildWrappedSlides(data);
  _wrCurrent = 0;

  // Build progress track
  const track = document.getElementById('wr-progress-track');
  track.innerHTML = _wrSlides.map((_,i) =>
    `<div class="wr-progress-seg${i===0?' active':''}" data-idx="${i}"></div>`
  ).join('');

  // Build slides into viewport
  const vp = document.getElementById('wr-viewport');
  // Clear existing slides but keep tap zones
  vp.querySelectorAll('.wr-slide').forEach(el => el.remove());

  _wrSlides.forEach((html, i) => {
    const slide = document.createElement('div');
    slide.className = 'wr-slide' + (i === 0 ? ' active' : '');
    slide.innerHTML = html;
    vp.insertBefore(slide, vp.querySelector('.wr-tap-prev'));
  });

  document.getElementById('wr-footer').style.display = 'none';
  // Ensure the modal overlay has the right dark bg
  document.getElementById('modal-wrapped').style.background = '#0d1a14';
  openModal('modal-wrapped');
  _wrUpdateProgress();
}

function _wrGo(dir) {
  const next = _wrCurrent + dir;
  if (next < 0 || next >= _wrSlides.length) return;

  const slides = document.querySelectorAll('#wr-viewport .wr-slide');
  const outgoing = slides[_wrCurrent];
  const incoming = slides[next];

  // Outgoing: slide left (forward) or right (back)
  outgoing.classList.remove('active');
  outgoing.classList.add(dir > 0 ? 'exit' : 'enter-prev');
  setTimeout(() => { outgoing.classList.remove('exit', 'enter-prev'); }, 420);

  // Incoming: was staged off-screen in the right direction
  if (dir < 0) {
    // Going back — incoming was to the left, show from left
    incoming.style.transform = 'translateX(-64px)';
    incoming.style.opacity   = '0';
    incoming.style.transition = 'none';
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        incoming.style.transition = '';
        incoming.style.transform  = '';
        incoming.style.opacity    = '';
        incoming.classList.add('active');
      });
    });
  } else {
    incoming.classList.add('active');
  }

  _wrCurrent = next;
  _wrUpdateProgress();
}

function _wrUpdateProgress() {
  document.querySelectorAll('.wr-progress-seg').forEach((seg, i) => {
    seg.classList.toggle('done', i < _wrCurrent);
    seg.classList.toggle('active', i === _wrCurrent);
  });
  const isLast = _wrCurrent === _wrSlides.length - 1;
  document.getElementById('wr-footer').style.display = isLast ? 'block' : 'none';
}

// ── Month picker ──────────────────────────────────────────────────
function openWrappedPicker() {
  const visits = DB.visits;
  // Find all year-months with visits
  const monthSet = new Set(visits.map(v => {
    const d = v.startDate || v.date || '';
    return d.slice(0, 7); // YYYY-MM
  }).filter(Boolean));

  const months = [...monthSet].sort().reverse().slice(0, 18); // last 18 months

  const list = document.getElementById('wr-month-picker-list');
  list.innerHTML = '';

  if (!months.length) {
    list.innerHTML = '<div style="font-size:13px;color:var(--text-muted);">No visits recorded yet.</div>';
  } else {
    // Quick shortcut: current month if it has visits
    const now = new Date();
    const thisYM = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
    if (months.includes(thisYM)) {
      const shortcut = document.createElement('div');
      shortcut.style.cssText = 'font-size:11px;font-weight:700;letter-spacing:0.07em;text-transform:uppercase;color:var(--dark-sage);margin-bottom:6px;';
      shortcut.textContent = 'Current Month';
      list.appendChild(shortcut);
      const thisRow = document.createElement('div');
      thisRow.className = 'wr-month-row';
      thisRow.style.cssText = 'border-color:var(--dark-sage);background:var(--accent-light);margin-bottom:10px;';
      thisRow.innerHTML = `<div><div class="wr-month-row-label" style="color:var(--dark-sage);">${MONTHS_LONG[now.getMonth()]} ${now.getFullYear()}</div></div>
        <svg class="wr-month-row-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--dark-sage)" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg>`;
      thisRow.addEventListener('click', () => {
        closeModal('modal-wrapped-pick');
        setTimeout(() => openWrapped(now.getFullYear(), now.getMonth()), 200);
      });
      list.appendChild(thisRow);
      const divLabel = document.createElement('div');
      divLabel.style.cssText = 'font-size:11px;font-weight:700;letter-spacing:0.07em;text-transform:uppercase;color:var(--text-light);margin-bottom:6px;';
      divLabel.textContent = 'Past Months';
      list.appendChild(divLabel);
    }
    months.forEach(ym => {
      const [y, m] = ym.split('-').map(Number);
      const visits = DB.visits.filter(v => (v.startDate||v.date||'').startsWith(ym));
      const row = document.createElement('div');
      row.className = 'wr-month-row';
      row.innerHTML = `
        <div>
          <div class="wr-month-row-label">${MONTHS_LONG[m-1]} ${y}</div>
          <div class="wr-month-row-sub">${visits.length} visit${visits.length!==1?'s':''}</div>
        </div>
        <svg class="wr-month-row-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg>`;
      row.addEventListener('click', () => {
        closeModal('modal-wrapped-pick');
        setTimeout(() => openWrapped(y, m - 1), 200);
      });
      list.appendChild(row);
    });
  }

  openModal('modal-wrapped-pick');
}

// ── Wire events ───────────────────────────────────────────────────
(function _wireWrapped() {
  document.getElementById('other-goto-wrapped').addEventListener('click', () => {
    closeOtherMenu();
    openWrappedPicker();
  });

  document.getElementById('wr-close').addEventListener('click', () => closeModal('modal-wrapped'));
  document.getElementById('wr-pick-close').addEventListener('click', () => closeModal('modal-wrapped-pick'));
  document.getElementById('wr-done-btn').addEventListener('click', () => closeModal('modal-wrapped'));

  // Tap zones
  document.getElementById('wr-tap-prev').addEventListener('click', () => _wrGo(-1));
  document.getElementById('wr-tap-next').addEventListener('click', () => _wrGo(1));

  // Keyboard navigation
  document.addEventListener('keydown', e => {
    if (!document.getElementById('modal-wrapped').classList.contains('open')) return;
    if (e.key === 'ArrowRight' || e.key === ' ') { e.preventDefault(); _wrGo(1); }
    if (e.key === 'ArrowLeft')  { e.preventDefault(); _wrGo(-1); }
    if (e.key === 'Escape') closeModal('modal-wrapped');
  });

  // Touch swipe
  let _wrTouchX = null;
  const vp = document.getElementById('wr-viewport');
  vp.addEventListener('touchstart', e => { _wrTouchX = e.touches[0].clientX; }, { passive: true });
  vp.addEventListener('touchend', e => {
    if (_wrTouchX === null) return;
    const dx = _wrTouchX - e.changedTouches[0].clientX;
    if (Math.abs(dx) > 40) _wrGo(dx > 0 ? 1 : -1);
    _wrTouchX = null;
  }, { passive: true });

})();


// ═══════════════════════════════════════════════════════════════════
//  GOOGLE DRIVE SYNC ENGINE  — pindrop
//  Local-first, cloud-mirror, offline-safe, conflict-aware
//
//  ── ONE-TIME DEVELOPER SETUP ──────────────────────────────────────
//  1. console.cloud.google.com → New project → Enable "Google Drive API"
//  2. OAuth consent screen → External → Add scope: drive.appdata
//  3. Credentials → OAuth 2.0 Client ID → Web application
//     Authorized JS origins: your deployed domain (e.g. https://yourdomain.com)
//     For localhost testing: http://localhost  or  http://localhost:XXXX
//  4. Paste the Client ID into SYNC_CLIENT_ID below (no secret needed)
//  5. The appdata scope is a hidden, app-private folder — never visible
//     in the user's regular Google Drive.
// ═══════════════════════════════════════════════════════════════════

// ── CONFIG — fill in your Client ID before deploying ─────────────
const SYNC_CLIENT_ID    = 'YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com';
const SYNC_SCOPE        = 'https://www.googleapis.com/auth/drive.appdata';
const SYNC_DB_FILE      = 'pindrop-database.json';
const SYNC_BACKUP_PFX   = 'pindrop-backup-';
const SYNC_DB_VERSION   = 2;
const SYNC_DEBOUNCE_MS  = 7000;  // wait 7 s after last write before pushing
const SYNC_BACKUP_DAYS  = 7;     // weekly auto-backup

// ── localStorage keys (never store token in sessionStorage — tab-close loss) ─
const _SK = Object.freeze({
  token:      'pd_sync_token',
  tokenExp:   'pd_sync_token_exp',
  deviceId:   'pd_sync_device_id',
  enabled:    'pd_sync_enabled',
  fileId:     'pd_sync_file_id',
  localMod:   'pd_sync_local_mod',
  lastSync:   'pd_sync_last_sync',
  lastBackup: 'pd_sync_last_backup',
  email:      'pd_sync_email',
  name:       'pd_sync_name',
});

// ── Runtime state (memory-only, never persisted) ──────────────────
const GSync = {
  status:        'off',   // 'off'|'synced'|'syncing'|'offline'|'conflict'|'error'
  statusMsg:     '',
  dirty:         false,
  debounce:      null,
  offlineQueued: false,
  conflictData:  null,    // { cloud: {}, cloudMod, localMod }
  gisLoaded:     false,
};

// ── Utility: persistent device identity ──────────────────────────
function _syncDeviceId() {
  let id = localStorage.getItem(_SK.deviceId);
  if (!id) {
    id = 'pd-' + Date.now().toString(36) + '-' + Math.random().toString(36).slice(2, 7);
    localStorage.setItem(_SK.deviceId, id);
  }
  return id;
}

// ── Token helpers ─────────────────────────────────────────────────
function _syncToken()     { return localStorage.getItem(_SK.token) || ''; }
function _syncEnabled()   { return localStorage.getItem(_SK.enabled) === '1'; }
function _syncTokenLive() {
  const exp = parseInt(localStorage.getItem(_SK.tokenExp) || '0');
  return _syncToken().length > 10 && Date.now() < exp - 90000; // 90 s grace
}
function _syncClearToken() {
  localStorage.removeItem(_SK.token);
  localStorage.removeItem(_SK.tokenExp);
}

// ── Status UI ─────────────────────────────────────────────────────
function _syncSetStatus(status, msg) {
  GSync.status    = status;
  GSync.statusMsg = msg || '';

  const label = { off:'Off', synced:'Synced', syncing:'Syncing',
                  offline:'Offline', conflict:'Conflict', error:'Error' }[status] || status;

  // Update every pill/dot on the page
  [
    ['menu-sync-pill','menu-sync-dot','menu-sync-pill-txt'],
    ['ds-sync-pill',  'ds-sync-dot',  'ds-sync-pill-txt'],
  ].forEach(([pillId, dotId, txtId]) => {
    const pill = document.getElementById(pillId);
    const dot  = document.getElementById(dotId);
    const txt  = document.getElementById(txtId);
    if (!pill) return;
    pill.className = `sync-status-pill ${status}`;
    if (dot) dot.className = `sync-dot ${status}`;
    if (txt) txt.textContent = label;
  });

  // Sub-label in other-menu
  const sub = document.getElementById('menu-sync-sub');
  if (sub) {
    const subMap = {
      off:      'Back up & sync across devices',
      synced:   _syncRelTime(localStorage.getItem(_SK.lastSync)),
      syncing:  'Syncing now…',
      offline:  'Will sync when connected',
      conflict: 'Tap to resolve',
      error:    GSync.statusMsg || 'Tap to reconnect',
    };
    sub.textContent = subMap[status] || '';
  }

  // Floating badge
  _syncBadge(status, msg);
}

function _syncRelTime(iso) {
  if (!iso) return 'Back up & sync across devices';
  const m = Math.floor((Date.now() - new Date(iso)) / 60000);
  if (m < 1)   return 'Synced just now';
  if (m < 60)  return `Synced ${m} min${m > 1 ? 's' : ''} ago`;
  const h = Math.floor(m / 60);
  if (h < 24)  return `Synced ${h} hour${h > 1 ? 's' : ''} ago`;
  return `Synced ${Math.floor(h / 24)} day${Math.floor(h/24) > 1 ? 's' : ''} ago`;
}

function _syncBadge(status, msg) {
  const badge = document.getElementById('sync-float-badge');
  if (!badge) return;
  const dot = document.getElementById('sfb-dot');
  const txt = document.getElementById('sfb-txt');
  const msgs = {
    syncing:  'Saving to cloud…',
    offline:  'Offline — will sync when connected',
    conflict: 'Cloud conflict — tap More to resolve',
    error:    msg || 'Sync needs attention',
  };
  if (!msgs[status]) { badge.classList.remove('visible'); return; }
  if (dot) dot.className = `sync-dot ${status}`;
  if (txt) txt.textContent = msgs[status];
  badge.classList.add('visible');
  if (status === 'syncing') {
    clearTimeout(badge._t);
    badge._t = setTimeout(() => badge.classList.remove('visible'), 4500);
  }
}

// ── Load Google Identity Services (GIS) library lazily ───────────
function _gisLoad() {
  return new Promise((res, rej) => {
    if (window.google?.accounts?.oauth2) { res(); return; }
    if (GSync.gisLoaded) { res(); return; }
    const s = document.createElement('script');
    s.src     = 'https://accounts.google.com/gsi/client';
    s.async   = true;
    s.onload  = () => { GSync.gisLoaded = true; res(); };
    s.onerror = () => rej(new Error('Could not reach Google. Check your connection.'));
    document.head.appendChild(s);
  });
}

// ── OAuth token request (popup) ───────────────────────────────────
function _gisToken() {
  return new Promise(async (res, rej) => {
    try { await _gisLoad(); } catch(e) { rej(e); return; }
    if (!SYNC_CLIENT_ID || SYNC_CLIENT_ID.startsWith('YOUR_')) {
      rej(new Error('UNCONFIGURED')); return;
    }
    const client = google.accounts.oauth2.initTokenClient({
      client_id: SYNC_CLIENT_ID,
      scope:     SYNC_SCOPE,
      callback:  resp => {
        if (resp.error) {
          if (resp.error === 'access_denied')  { rej(new Error('DENIED')); return; }
          if (resp.error === 'popup_closed_by_user') { rej(new Error('CANCELLED')); return; }
          rej(new Error('AUTH_' + resp.error)); return;
        }
        const exp = Date.now() + (resp.expires_in || 3600) * 1000;
        localStorage.setItem(_SK.token,    resp.access_token);
        localStorage.setItem(_SK.tokenExp, String(exp));
        res(resp.access_token);
      },
      error_callback: err => rej(new Error(err?.type || 'AUTH_ERROR')),
    });
    client.requestAccessToken({ prompt: '' });
  });
}

async function _syncEnsureToken() {
  if (_syncTokenLive()) return _syncToken();
  return _gisToken(); // will prompt if needed
}

// ── Drive API thin wrapper ────────────────────────────────────────
async function _driveReq(path, opts = {}) {
  const tok = await _syncEnsureToken();
  const r = await fetch(`https://www.googleapis.com/drive/v3/${path}`, {
    ...opts,
    headers: { 'Authorization': `Bearer ${tok}`, ...(opts.headers || {}) },
  });
  if (r.status === 401) { _syncClearToken(); throw new Error('TOKEN_EXPIRED'); }
  if (r.status === 403) throw new Error('ACCESS_DENIED');
  if (!r.ok) throw new Error(`DRIVE_${r.status}`);
  const ct = r.headers.get('content-type') || '';
  return ct.includes('application/json') ? r.json() : r.text();
}

// Find the main DB file ID (cached in localStorage)
async function _driveFindDB() {
  const cached = localStorage.getItem(_SK.fileId);
  if (cached) {
    // Quick existence check
    try {
      await _driveReq(`files/${cached}?fields=id&spaces=appDataFolder`);
      return cached;
    } catch(e) { localStorage.removeItem(_SK.fileId); }
  }
  const r = await _driveReq(
    `files?spaces=appDataFolder&fields=files(id,name)&q=${encodeURIComponent(`name='${SYNC_DB_FILE}'`)}`
  );
  const f = (r.files || []).find(x => x.name === SYNC_DB_FILE);
  if (f) { localStorage.setItem(_SK.fileId, f.id); return f.id; }
  return null;
}

// Get modifiedTime only (tiny, cheap)
async function _driveFileMeta(id) {
  return _driveReq(`files/${id}?fields=modifiedTime&spaces=appDataFolder`);
}

// Multipart upload — create or update
async function _driveUpload(filename, content, existingId) {
  const tok  = await _syncEnsureToken();
  const meta = JSON.stringify({ name: filename, ...(existingId ? {} : { parents: ['appDataFolder'] }) });
  const body = new FormData();
  body.append('metadata', new Blob([meta], { type: 'application/json' }));
  body.append('file',     new Blob([content], { type: 'application/json' }));
  const url = existingId
    ? `https://www.googleapis.com/upload/drive/v3/files/${existingId}?uploadType=multipart`
    : `https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart`;
  const r = await fetch(url, {
    method: existingId ? 'PATCH' : 'POST',
    headers: { 'Authorization': `Bearer ${tok}` },
    body,
  });
  if (!r.ok) throw new Error(`UPLOAD_${r.status}`);
  const result = await r.json();
  if (!existingId) localStorage.setItem(_SK.fileId, result.id);
  return result.id;
}

// Download full content
async function _driveDownload(id) {
  return _driveReq(`files/${id}?alt=media&spaces=appDataFolder`);
}

async function _driveDelete(id) {
  const tok = await _syncEnsureToken();
  await fetch(`https://www.googleapis.com/drive/v3/files/${id}`, {
    method: 'DELETE', headers: { 'Authorization': `Bearer ${tok}` },
  });
}

// ── Build the JSON payload (raw data only, no analytics) ──────────
function _syncPayload() {
  return JSON.stringify({
    version:      SYNC_DB_VERSION,
    lastModified: new Date().toISOString(),
    deviceId:     _syncDeviceId(),
    data: {
      places:   DB.places,
      visits:   DB.visits,
      trips:    DB.trips,
      wishlist: DB.wishlist,
    },
  });
}

// ── Merge: ID-keyed, latest-timestamp-wins, notes unioned ─────────
function _syncMerge(local, cloud) {
  function mergeArr(a, b) {
    const m = new Map();
    a.forEach(x => m.set(x.id, x));
    b.forEach(x => {
      const existing = m.get(x.id);
      if (!existing) { m.set(x.id, x); return; }
      // Compare freshness using any available timestamp field
      const tA = existing.updatedAt || existing.dateAdded || existing.addedAt || '';
      const tB = x.updatedAt        || x.dateAdded        || x.addedAt        || '';
      const winner = tB > tA ? x : existing;
      // Always union notes arrays (never silently drop a note)
      if (existing.notes?.length || x.notes?.length) {
        const noteMap = new Map();
        [...(existing.notes || []), ...(x.notes || [])].forEach(n => {
          const k = n.id || n.ts || (n.text || '').slice(0, 30);
          if (!noteMap.has(k) || (n.ts || '') > (noteMap.get(k).ts || '')) noteMap.set(k, n);
        });
        winner.notes = [...noteMap.values()].sort((a,b) => (b.ts||'') > (a.ts||'') ? 1 : -1);
      }
      m.set(x.id, winner);
    });
    return [...m.values()];
  }
  return {
    places:   mergeArr(local.places   || [], cloud.places   || []),
    visits:   mergeArr(local.visits   || [], cloud.visits   || []),
    trips:    mergeArr(local.trips    || [], cloud.trips    || []),
    wishlist: mergeArr(local.wishlist || [], cloud.wishlist || []),
  };
}

// Apply a data snapshot to local DB and re-render
function _syncApply(data) {
  if (data.places)   DB.places   = data.places;
  if (data.visits)   DB.visits   = data.visits;
  if (data.trips)    DB.trips    = data.trips;
  if (data.wishlist) DB.wishlist = data.wishlist;
  invalidateMetrics();
  renderList();
}

// ── Push local → cloud ────────────────────────────────────────────
async function _syncPush() {
  _syncSetStatus('syncing');
  try {
    const payload    = _syncPayload();
    const existingId = await _driveFindDB().catch(() => null);
    const fileId     = await _driveUpload(SYNC_DB_FILE, payload, existingId);
    const now        = new Date().toISOString();
    localStorage.setItem(_SK.lastSync,  now);
    localStorage.setItem(_SK.localMod, now);
    GSync.dirty = false;
    _syncSetStatus('synced');
    _syncMaybeBackup();
  } catch(e) {
    _syncHandleError(e);
  }
}

// ── On-load: compare cloud vs local timestamps ────────────────────
async function _syncOnLoad() {
  if (!_syncEnabled() || !navigator.onLine) return;
  _syncSetStatus('syncing');
  try {
    // Silent token refresh (no prompt — use '' hint)
    if (!_syncTokenLive()) {
      await _gisToken().catch(e => {
        if (e.message !== 'CANCELLED') throw e;
        throw new Error('SILENT_FAIL');
      });
    }
    const fileId = await _driveFindDB();
    if (!fileId) {
      // First time on this device — push everything up
      await _syncPush();
      return;
    }
    const meta     = await _driveFileMeta(fileId);
    const cloudMs  = new Date(meta.modifiedTime).getTime();
    const localMs  = new Date(localStorage.getItem(_SK.localMod) || 0).getTime();

    if (cloudMs > localMs + 5000) {
      // Cloud is meaningfully newer — download and let user decide
      const raw    = await _driveDownload(fileId);
      const parsed = typeof raw === 'string' ? JSON.parse(raw) : raw;
      GSync.conflictData = {
        cloud:    parsed.data,
        cloudMod: meta.modifiedTime,
        localMod: localStorage.getItem(_SK.localMod),
      };
      _syncSetStatus('conflict');
      _syncShowConflict(meta.modifiedTime);
    } else if (GSync.dirty) {
      await _syncPush();
    } else {
      _syncSetStatus('synced');
    }
  } catch(e) {
    if (e.message === 'SILENT_FAIL' || e.message === 'CANCELLED') {
      // User closed auth popup on load — just mark as needs reconnect silently
      _syncSetStatus('error', 'Tap Cloud Sync to reconnect');
      return;
    }
    _syncHandleError(e);
  }
}

// ── Mark dirty + debounced push ───────────────────────────────────
function _syncMarkDirty() {
  if (!_syncEnabled()) return;
  GSync.dirty = true;
  localStorage.setItem(_SK.localMod, new Date().toISOString());
  clearTimeout(GSync.debounce);
  if (!navigator.onLine) {
    _syncSetStatus('offline');
    GSync.offlineQueued = true;
    return;
  }
  GSync.debounce = setTimeout(() => { if (GSync.dirty) _syncPush(); }, SYNC_DEBOUNCE_MS);
}

// ── Online / offline events ───────────────────────────────────────
window.addEventListener('online', () => {
  if (!_syncEnabled()) return;
  if (GSync.offlineQueued || GSync.dirty) {
    GSync.offlineQueued = false;
    _syncPush();
  } else {
    _syncSetStatus('synced');
  }
});
window.addEventListener('offline', () => {
  if (!_syncEnabled()) return;
  clearTimeout(GSync.debounce);
  GSync.offlineQueued = GSync.dirty;
  _syncSetStatus('offline');
});

// ── Weekly backup (keep last 3) ───────────────────────────────────
async function _syncMaybeBackup() {
  const last = parseInt(localStorage.getItem(_SK.lastBackup) || '0');
  if (Date.now() - last < SYNC_BACKUP_DAYS * 86400000) return;
  try {
    const date = new Date().toISOString().slice(0, 10);
    await _driveUpload(`${SYNC_BACKUP_PFX}${date}.json`, _syncPayload(), null);
    localStorage.setItem(_SK.lastBackup, String(Date.now()));
    // Prune old backups — keep newest 3
    const r = await _driveReq(
      `files?spaces=appDataFolder&fields=files(id,name,modifiedTime)` +
      `&q=${encodeURIComponent(`name contains '${SYNC_BACKUP_PFX}'`)}&orderBy=modifiedTime desc`
    );
    for (const f of (r.files || []).slice(3)) {
      await _driveDelete(f.id).catch(() => {});
    }
  } catch(e) { /* backup failures are non-fatal */ }
}

// ── Error handling — translate codes to human copy ───────────────
function _syncHandleError(e) {
  const msg = e?.message || '';
  if (msg === 'TOKEN_EXPIRED' || msg.startsWith('AUTH_')) {
    _syncClearToken();
    _syncSetStatus('error', 'Sync needs to reconnect to Google.');
    return;
  }
  if (msg === 'ACCESS_DENIED' || msg === 'DENIED') {
    _syncSetStatus('error', 'Google Drive permission was not granted.');
    return;
  }
  if (msg === 'UNCONFIGURED') {
    _syncSetStatus('off');
    _syncShowSetupInstructions();
    return;
  }
  if (!navigator.onLine || msg.includes('fetch') || msg.includes('network') || msg.includes('Failed')) {
    GSync.offlineQueued = GSync.dirty;
    _syncSetStatus('offline');
    return;
  }
  // Anything else — human-friendly, non-technical
  _syncSetStatus('error', 'Sync paused. Your data is safe locally.');
}

// ── Connect flow ──────────────────────────────────────────────────
async function syncConnect() {
  if (!SYNC_CLIENT_ID || SYNC_CLIENT_ID.startsWith('YOUR_')) {
    _syncShowSetupInstructions();
    return;
  }
  _syncSetStatus('syncing');
  try {
    const tok  = await _gisToken();
    localStorage.setItem(_SK.enabled, '1');
    // Fetch user info for the settings panel
    const info = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
      headers: { 'Authorization': `Bearer ${tok}` },
    }).then(r => r.ok ? r.json() : null).catch(() => null);
    if (info) {
      localStorage.setItem(_SK.email, info.email || '');
      localStorage.setItem(_SK.name,  info.name  || '');
    }
    closeModal('modal-sync-settings');
    toast('Connected — syncing your data');
    await _syncOnLoad();
    _syncRenderSettings();
  } catch(e) {
    if (e.message === 'CANCELLED') {
      _syncSetStatus('off');
      _syncRenderSettings();
      return;
    }
    _syncHandleError(e);
    _syncRenderSettings();
  }
}

// ── Disconnect ────────────────────────────────────────────────────
function syncDisconnect() {
  if (!confirm('Disconnect cloud sync? Your local data stays on this device.')) return;
  clearTimeout(GSync.debounce);
  const tok = _syncToken();
  if (tok && window.google?.accounts?.oauth2) {
    try { google.accounts.oauth2.revoke(tok, () => {}); } catch(e) {}
  }
  [_SK.token, _SK.tokenExp, _SK.enabled, _SK.email, _SK.name,
   _SK.fileId, _SK.lastSync, _SK.lastBackup].forEach(k => localStorage.removeItem(k));
  Object.assign(GSync, { status:'off', dirty:false, offlineQueued:false, conflictData:null });
  _syncSetStatus('off');
  _syncRenderSettings();
  toast('Cloud sync disconnected');
}

// ── Manual sync now ───────────────────────────────────────────────
async function syncNow() {
  if (!_syncEnabled()) { syncConnect(); return; }
  if (!navigator.onLine) { toast('No connection — will sync when back online'); return; }
  await _syncPush();
  toast('Synced to cloud');
}

// ── Conflict UI ───────────────────────────────────────────────────
function _syncShowConflict(cloudMod) {
  const el = document.getElementById('conflict-desc');
  if (el) {
    const d = new Date(cloudMod).toLocaleString([], {
      month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'
    });
    el.textContent = `A newer version of your data was found in the cloud, last saved ${d}. How would you like to proceed?`;
  }
  openModal('modal-sync-conflict');
}

function _syncResolve(choice) {
  const cd = GSync.conflictData;
  if (!cd) { closeModal('modal-sync-conflict'); return; }
  closeModal('modal-sync-conflict');
  if (choice === 'cloud') {
    _syncApply(cd.cloud);
    localStorage.setItem(_SK.localMod, cd.cloudMod);
    _syncSetStatus('synced');
    toast('Cloud version applied');
  } else if (choice === 'local') {
    GSync.dirty = true;
    _syncPush();
    toast('Your version uploaded to cloud');
  } else {
    const merged = _syncMerge(
      { places: DB.places, visits: DB.visits, trips: DB.trips, wishlist: DB.wishlist },
      cd.cloud
    );
    _syncApply(merged);
    GSync.dirty = true;
    _syncPush();
    toast('Data merged and synced');
  }
  GSync.conflictData = null;
}

// ── Settings modal renderer ───────────────────────────────────────
function _syncRenderSettings() {
  const body = document.getElementById('sync-settings-body');
  if (!body) return;
  const on    = _syncEnabled();
  const email = localStorage.getItem(_SK.email) || '';
  const name  = localStorage.getItem(_SK.name)  || '';
  const last  = localStorage.getItem(_SK.lastSync);
  const init  = name ? name.split(' ').map(w => w[0]).join('').toUpperCase().slice(0, 2) : 'G';

  if (!on) {
    // ── Disconnected view ────────────────────────────────────────
    body.innerHTML = `
      <p style="font-size:13px;color:var(--text-muted);line-height:1.7;margin-bottom:18px;">
        Connect to Google Drive to keep your travel data safe and access it on every device.
        Your data is stored in a hidden, app-private folder — it never appears in your regular Drive.
      </p>
      <button class="sync-connect-btn" id="_sync_connect_btn">
        <svg width="18" height="18" viewBox="0 0 24 24">
          <path fill="white" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
          <path fill="white" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
          <path fill="white" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z"/>
          <path fill="white" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
        </svg>
        Sign in with Google
      </button>
      <p style="font-size:11px;color:var(--text-light);text-align:center;margin-top:12px;line-height:1.5;">
        Secure, optional, and automatic once connected.
      </p>`;
    document.getElementById('_sync_connect_btn').onclick = syncConnect;
    return;
  }

  // ── Connected view ───────────────────────────────────────────────
  const stColor = { synced:'var(--dark-sage)', syncing:'var(--slate)',
                    offline:'var(--text-muted)', conflict:'var(--blush-dark)',
                    error:'var(--blush-dark)' }[GSync.status] || 'var(--text-muted)';
  const stText  = { synced:'Your travel data is safely synced.',
                    syncing:'Syncing now…',
                    offline:'Offline — changes will sync when connected.',
                    conflict:'A conflict was found. Tap Resolve below.',
                    error: GSync.statusMsg || 'Sync needs to reconnect to Google.' }[GSync.status] || '';

  body.innerHTML = `
    <div class="sync-modal-section">
      <div class="sync-modal-section-title">Account</div>
      <div class="sync-account-row">
        <div class="sync-account-avatar">${escHtml(init)}</div>
        <div>
          <div class="sync-account-name">${escHtml(name || 'Google Account')}</div>
          <div class="sync-account-email">${escHtml(email)}</div>
        </div>
      </div>
    </div>

    <div class="sync-modal-section">
      <div class="sync-modal-section-title">Status</div>
      <div class="sync-meta-row">
        <span class="sync-meta-label">Status</span>
        <span class="sync-meta-val" style="color:${stColor};">${escHtml(stText)}</span>
      </div>
      <div class="sync-meta-row">
        <span class="sync-meta-label">Last synced</span>
        <span class="sync-meta-val">${last ? new Date(last).toLocaleString([], {month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}) : '—'}</span>
      </div>
      <div class="sync-meta-row">
        <span class="sync-meta-label">This device</span>
        <span class="sync-meta-val" style="font-size:10px;font-family:monospace;color:var(--text-light);">${_syncDeviceId().slice(0, 16)}…</span>
      </div>
    </div>

    <div class="sync-action-row">
      <button class="sync-action-btn" id="_sync_now_btn">Sync Now</button>
      <button class="sync-action-btn" id="_sync_export_btn">Export Backup</button>
    </div>
    ${GSync.status === 'conflict' ? `
    <button class="sync-action-btn" id="_sync_resolve_btn" style="width:100%;margin-bottom:8px;color:var(--blush-dark);border-color:var(--blush);">
      Resolve Conflict
    </button>` : ''}
    <div class="sync-action-row" style="margin-top:4px;">
      <button class="sync-action-btn danger" id="_sync_disconnect_btn">Disconnect</button>
    </div>`;

  document.getElementById('_sync_now_btn').onclick = async () => {
    closeModal('modal-sync-settings'); await syncNow();
  };
  document.getElementById('_sync_export_btn').onclick = () => {
    closeModal('modal-sync-settings'); exportData();
  };
  document.getElementById('_sync_disconnect_btn').onclick = () => {
    closeModal('modal-sync-settings'); syncDisconnect();
  };
  document.getElementById('_sync_resolve_btn')?.addEventListener('click', () => {
    closeModal('modal-sync-settings');
    if (GSync.conflictData) _syncShowConflict(GSync.conflictData.cloudMod);
  });
}

// ── Setup instructions (when Client ID not configured) ────────────
function _syncShowSetupInstructions() {
  const body = document.getElementById('sync-setup-body');
  if (body) body.innerHTML = `
    <p style="font-size:13px;color:var(--text-muted);line-height:1.7;margin-bottom:14px;">
      Cloud sync needs a Google API Client ID configured in the app source.
      This is a one-time developer step — users never need to do this.
    </p>
    <div class="sync-modal-section">
      <div class="sync-modal-section-title">Developer Setup — 5 steps</div>
      <ol style="font-size:12px;line-height:2.1;color:var(--text-muted);padding-left:18px;margin:0;">
        <li>Visit <a href="https://console.cloud.google.com" target="_blank" rel="noopener" style="color:var(--dark-sage);font-weight:600;">console.cloud.google.com</a> and create a project</li>
        <li>Enable the <strong>Google Drive API</strong> for that project</li>
        <li>OAuth consent screen → External → Add scope: <code style="font-size:10px;background:var(--surface2);padding:1px 5px;border-radius:4px;font-family:monospace;">drive.appdata</code></li>
        <li>Credentials → OAuth 2.0 Client ID → Web app → add your domain to Authorized JS Origins</li>
        <li>Copy the Client ID and replace <code style="font-size:10px;background:var(--surface2);padding:1px 5px;border-radius:4px;font-family:monospace;">YOUR_GOOGLE_CLIENT_ID</code> in the app source</li>
      </ol>
    </div>
    <div class="sync-setup-note">
      The <code style="font-size:10px;">drive.appdata</code> scope creates a hidden, app-only storage folder.
      Users' main Drive files are completely untouched.
    </div>`;
  openModal('modal-sync-setup');
}

// ── Patch save/delete functions to mark dirty after every write ───
(function _patchDB() {
  const fns = { savePlace, saveVisit, saveTrip, saveWish,
                deletePlace, deleteVisit, deleteTrip, deleteWish };
  Object.entries(fns).forEach(([name, orig]) => {
    window[name] = function(...args) { orig(...args); _syncMarkDirty(); };
  });
})();

// ── Wire UI events ────────────────────────────────────────────────
(function _wireSyncUI() {
  // Other menu → Cloud Sync opens settings modal
  document.getElementById('other-goto-sync').addEventListener('click', () => {
    closeOtherMenu();
    _syncRenderSettings();
    openModal('modal-sync-settings');
  });

  // Desktop sidebar → Cloud Sync button
  document.getElementById('ds-sync-btn')?.addEventListener('click', () => {
    _syncRenderSettings();
    openModal('modal-sync-settings');
  });

  // Modal close buttons
  document.getElementById('sync-settings-close').addEventListener('click', () => closeModal('modal-sync-settings'));
  document.getElementById('sync-setup-close').addEventListener('click',    () => closeModal('modal-sync-setup'));

  // Conflict resolution
  document.getElementById('conflict-use-cloud').addEventListener('click',  () => _syncResolve('cloud'));
  document.getElementById('conflict-keep-local').addEventListener('click', () => _syncResolve('local'));
  document.getElementById('conflict-merge').addEventListener('click',       () => _syncResolve('merge'));
})();

// ── Initialize on app boot ────────────────────────────────────────
(function _syncBoot() {
  if (!_syncEnabled()) {
    _syncSetStatus('off');
    return;
  }
  // Immediately restore last-known synced state while we check cloud
  _syncSetStatus(navigator.onLine ? 'synced' : 'offline');
  if (!navigator.onLine) { GSync.offlineQueued = true; return; }
  // Defer 1.8 s so the app renders and feels fast on load
  setTimeout(_syncOnLoad, 1800);
})();


// ═══════════════════════════════════════════
//  DESKTOP LAYER
// ═══════════════════════════════════════════

const IS_DESKTOP = () => window.innerWidth >= 1024;

// ── Sidebar nav buttons ──────────────────────────────────────
document.querySelectorAll('#ds-sidebar .ds-nb[data-view]').forEach(btn => {
  btn.addEventListener('click', () => dsSwitchView(btn.dataset.view));
});

document.getElementById('ds-add-btn').addEventListener('click', () => openAddPlace());
document.getElementById('ds-export-btn').addEventListener('click', () => exportData());
document.getElementById('ds-import-btn').addEventListener('click', () => openImportPicker());

function dsSwitchView(view) {
  // Update sidebar active state
  document.querySelectorAll('#ds-sidebar .ds-nb').forEach(b => b.classList.remove('active'));
  const activeBtn = document.querySelector(`#ds-sidebar .ds-nb[data-view="${view}"]`);
  if (activeBtn) activeBtn.classList.add('active');
  // Use existing switchView which handles views + rendering
  switchView(view);
  // Update badges
  dsUpdateBadges();
}

// Wire trips button separately (no standalone trips view)
const dsTripsBtn = document.getElementById('ds-trips-btn');
if (dsTripsBtn) dsTripsBtn.addEventListener('click', () => {
  document.querySelectorAll('#ds-sidebar .ds-nb').forEach(b => b.classList.remove('active'));
  dsTripsBtn.classList.add('active');
  // Open the trip list via the add-trip flow or show trips panel
  openTripList();
});

function openTripList() {
  // Show trips as a modal sheet since there's no dedicated view
  // Re-use list view for now, but navigate to trips context
  switchView('list');
  document.querySelectorAll('#ds-sidebar .ds-nb').forEach(b => b.classList.remove('active'));
  if (dsTripsBtn) dsTripsBtn.classList.add('active');
}

function dsUpdateBadges() {
  const places = DB.places.length;
  const wish   = DB.wishlist.length;
  const trips  = DB.trips.length;
  const pb = document.getElementById('ds-badge-places');
  const wb = document.getElementById('ds-badge-wish');
  const tb = document.getElementById('ds-badge-trips');
  if (pb) pb.textContent = places;
  if (wb) wb.textContent = wish;
  if (tb) tb.textContent = trips;
}

// ── Dashboard rendering ──────────────────────────────────────
function renderDashboard() {
  const places  = DB.places;
  const visits  = DB.visits;
  const trips   = DB.trips;
  const wish    = DB.wishlist;

  // Greeting
  const hr = new Date().getHours();
  const greet = hr < 12 ? 'Good morning' : hr < 17 ? 'Good afternoon' : 'Good evening';
  const titleEl = document.getElementById('ds-dash-title');
  const subEl   = document.getElementById('ds-dash-sub');
  if (titleEl) titleEl.textContent = greet;
  if (subEl) {
    const today = new Date().toLocaleDateString('en-US', {weekday:'long', month:'long', day:'numeric'});
    const recentVisit = [...visits].sort((a,b) => b.date.localeCompare(a.date))[0];
    subEl.textContent = today + (recentVisit ? ` · Last visit: ${formatDate(recentVisit.date)}` : '');
  }

  // Metrics
  const allRatings = visits.flatMap(v => [v.hunterRating, v.brandonRating].filter(r => r > 0));
  const avgRating  = allRatings.length ? (allRatings.reduce((a,b) => a+b,0) / allRatings.length) : 0;
  const countries  = new Set(places.map(p => p.country).filter(Boolean));
  const hRatings   = visits.map(v => v.hunterRating).filter(r => r > 0);
  const bRatings   = visits.map(v => v.brandonRating).filter(r => r > 0);
  const hAvg       = hRatings.length ? hRatings.reduce((a,b)=>a+b,0)/hRatings.length : 0;
  const bAvg       = bRatings.length ? bRatings.reduce((a,b)=>a+b,0)/bRatings.length : 0;

  const metricsEl = document.getElementById('ds-metrics');
  if (metricsEl) metricsEl.innerHTML = [
    { lbl:'Places',    val: places.length,         sub: `${countries.size} countr${countries.size!==1?'ies':'y'}` },
    { lbl:'Visits',    val: visits.length,          sub: places.length ? `${(visits.length/places.length).toFixed(1)} per place` : '' },
    { lbl:'Trips',     val: trips.length,           sub: wish.length + ' on wishlist' },
    { lbl:'Countries', val: countries.size,         sub: [...countries].slice(0,2).join(', ') },
    { lbl:'H Avg',     val: hAvg ? hAvg.toFixed(1):'—', sub: 'Hunter rating', cls:'style="color:var(--hunter-dark)"' },
    { lbl:'B Avg',     val: bAvg ? bAvg.toFixed(1):'—', sub: 'Brandon rating', cls:'style="color:var(--brandon-dark)"' },
  ].map(m => `<div class="ds-mc">
    <div class="ds-mc-lbl">${m.lbl}</div>
    <div class="ds-mc-val" ${m.cls||''}>${m.val}</div>
    <div class="ds-mc-sub">${m.sub}</div>
  </div>`).join('');

  // Left column: recent activity
  const leftEl = document.getElementById('ds-col-left');
  if (leftEl) {
    // Activity feed: last 8 visits
    const recentVisits = [...visits].sort((a,b) => b.date.localeCompare(a.date)).slice(0, 8);
    const actRows = recentVisits.map(v => {
      const p = places.find(x => x.id === v.placeId);
      const hR = v.hunterRating, bR = v.brandonRating;
      return `<div class="ds-act" data-vid="${v.id}">
        <div class="ds-act-dot visit"></div>
        <div style="flex:1;min-width:0;">
          <div class="ds-act-name">${escHtml(p?.name || 'Unknown')}</div>
          <div class="ds-act-meta">${escHtml([p?.city, p?.state].filter(Boolean).join(', '))}${hR||bR ? ` · H:${hR||'—'} B:${bR||'—'}` : ''}</div>
        </div>
        <div class="ds-act-time">${formatVisitDate(v)}</div>
      </div>`;
    }).join('') || '<div style="padding:14px 16px;font-size:13px;color:var(--text-light);">No visits yet</div>';

    // Top rated places
    const topRated = [...places].filter(p => p.avgRating).sort((a,b) => b.avgRating - a.avgRating).slice(0, 5);
    const topRows = topRated.map(p => `<div class="ds-act" data-pid="${p.id}">
        <div class="ds-act-dot place"></div>
        <div style="flex:1;min-width:0;">
          <div class="ds-act-name">${escHtml(p.name)}</div>
          <div class="ds-act-meta">${escHtml([p.city, p.country].filter(Boolean).join(', '))} · ${p.category||''}</div>
        </div>
        <div class="ds-act-time" style="color:var(--dark-sage);font-weight:700;">${p.avgRating.toFixed(1)} ★</div>
      </div>`).join('') || '<div style="padding:14px 16px;font-size:13px;color:var(--text-light);">No rated places</div>';

    leftEl.innerHTML = `
      <div class="ds-panel">
        <div class="ds-ph">
          <div class="ds-ph-title">Recent Visits</div>
          <button class="ds-ph-link" onclick="dsSwitchView('list')">See all →</button>
        </div>
        ${actRows}
      </div>
      <div class="ds-panel">
        <div class="ds-ph">
          <div class="ds-ph-title">Top Rated Places</div>
          <button class="ds-ph-link" onclick="dsSwitchView('stats')">Stats →</button>
        </div>
        ${topRows}
      </div>`;

    leftEl.querySelectorAll('[data-vid]').forEach(el =>
      el.addEventListener('click', () => { const v=DB.visits.find(x=>x.id===el.dataset.vid); if(v){currentPlaceId=v.placeId; openVisitDetail(v.id);} }));
    leftEl.querySelectorAll('[data-pid]').forEach(el =>
      el.addEventListener('click', () => openPlaceDetail(el.dataset.pid)));
  }

  // Right column: wishlist + trips
  const rightEl = document.getElementById('ds-col-right');
  if (rightEl) {
    const topWish = [...wish].sort((a,b) => {
      const po = {high:0,medium:1,low:2};
      return (po[a.priority]||1) - (po[b.priority]||1);
    }).slice(0, 6);

    const wishRows = topWish.map(w => `<div class="ds-wi">
      <div class="ds-wi-dot ${w.priority||'medium'}"></div>
      <div class="ds-wi-name">${escHtml(w.name)}</div>
      <div class="ds-wi-loc">${escHtml(w.country||'')}</div>
    </div>`).join('') || '<div style="padding:14px 16px;font-size:13px;color:var(--text-light);">Wishlist empty</div>';

    const recentTrips = [...trips].sort((a,b) => (b.startDate||'').localeCompare(a.startDate||'')).slice(0, 4);
    const tripRows = recentTrips.map(t => {
      const tv = visits.filter(v => v.tripId === t.id);
      return `<div class="ds-act" data-tid="${t.id}">
        <div class="ds-act-dot" style="background:var(--slate)"></div>
        <div style="flex:1;min-width:0;">
          <div class="ds-act-name">${escHtml(t.name)}</div>
          <div class="ds-act-meta">${tv.length} visit${tv.length!==1?'s':''} · ${t.startDate||''}</div>
        </div>
      </div>`;
    }).join('') || '<div style="padding:14px 16px;font-size:13px;color:var(--text-light);">No trips yet</div>';

    rightEl.innerHTML = `
      <div class="ds-panel">
        <div class="ds-ph">
          <div class="ds-ph-title">Wishlist</div>
          <button class="ds-ph-link" onclick="dsSwitchView('wishlist')">See all →</button>
        </div>
        ${wishRows}
      </div>
      <div class="ds-panel">
        <div class="ds-ph">
          <div class="ds-ph-title">Trips</div>
          <button class="ds-ph-link" onclick="dsSwitchView('trips')">See all →</button>
        </div>
        ${tripRows}
      </div>`;

    rightEl.querySelectorAll('[data-tid]').forEach(el =>
      el.addEventListener('click', () => openTripDetail(el.dataset.tid)));
  }
}

// ── Keyboard shortcuts ───────────────────────────────────────
document.addEventListener('keydown', e => {
  if (!IS_DESKTOP()) return;
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) return;
  const map = { l:'list', m:'map', s:'stats', c:'calendar', w:'wishlist', d:'discover', t:'trips' };
  if (e.key === '?') {
    const kbd = document.getElementById('ds-kbd');
    if (kbd) kbd.classList.toggle('on');
    return;
  }
  if (e.key === 'Escape') {
    const kbd = document.getElementById('ds-kbd');
    if (kbd) kbd.classList.remove('on');
    document.querySelectorAll('.modal-overlay.open').forEach(m => m.classList.remove('open'));
    return;
  }
  if (e.metaKey || e.ctrlKey || e.altKey) return;
  if (map[e.key]) { e.preventDefault(); dsSwitchView(map[e.key]); }
  if (e.key === 'n') { e.preventDefault(); openAddPlace(); }
});

// ── Keyboard shortcut panel HTML (desktop only) ──────────────
const kbdEl = document.createElement('div');
kbdEl.id = 'ds-kbd';
kbdEl.innerHTML = `
  <div class="ds-kbd-title">Keyboard Shortcuts</div>
  <div class="ds-kbd-row"><span>Places</span><kbd>L</kbd></div>
  <div class="ds-kbd-row"><span>Map</span><kbd>M</kbd></div>
  <div class="ds-kbd-row"><span>Stats</span><kbd>S</kbd></div>
  <div class="ds-kbd-row"><span>Calendar</span><kbd>C</kbd></div>
  <div class="ds-kbd-row"><span>Wishlist</span><kbd>W</kbd></div>
  <div class="ds-kbd-row"><span>Discover</span><kbd>D</kbd></div>
  <div class="ds-kbd-row"><span>Trips</span><kbd>T</kbd></div>
  <div class="ds-kbd-row"><span>New place</span><kbd>N</kbd></div>
  <div class="ds-kbd-row"><span>Toggle help</span><kbd>?</kbd></div>`;
document.body.appendChild(kbdEl);

// ── Stats: restructure for desktop 2-col layout ───────────────
// Patch renderStats to wrap stats-container in ds-stats-body on desktop
const _origRenderStats = renderStats;
renderStats = function() {
  _origRenderStats();
  if (IS_DESKTOP()) {
    const viewStats = document.getElementById('view-stats');
    // Ensure stats-year-tabs move to ds-stats-hd
    let hd = document.getElementById('ds-stats-hd');
    if (!hd) {
      hd = document.createElement('div');
      hd.id = 'ds-stats-hd';
      hd.className = 'ds-stats-hd';
      hd.innerHTML = '<h2>Stats</h2>';
      const ytabsMove = document.getElementById('stats-year-tabs');
      if (ytabsMove) {
        hd.appendChild(ytabsMove);
      }
      viewStats.insertBefore(hd, viewStats.firstChild.nextSibling);
    }
    // Wrap stats-container in ds-stats-body
    const sc = document.getElementById('stats-container');
    let body = document.getElementById('ds-stats-body');
    if (!body) {
      body = document.createElement('div');
      body.id = 'ds-stats-body';
      body.className = 'ds-stats-body';
      sc.parentNode.insertBefore(body, sc);
      body.appendChild(sc);
    }
  }
};

// ── Init on load ─────────────────────────────────────────────
if (IS_DESKTOP()) {
  dsUpdateBadges();
  renderDashboard();
  // Start on list view on desktop (matches mobile default)
  dsSwitchView('list');
}

// Re-render dashboard when switching to it
const _origSwitchView = switchView;
switchView = function(view, btn) {
  _origSwitchView(view, btn);
  if (IS_DESKTOP() && view === 'dashboard') {
    renderDashboard();
  }
};

</script>

<!-- ══ MODAL: CALENDAR ══ -->
<div class="cal-modal-overlay" id="modal-calendar">
  <div class="cal-modal">
    <div class="cml-header">
      <div class="cml-nav">
        <button class="cml-nav-btn" id="cml-prev">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="m15 18-6-6 6-6"/></svg>
        </button>
        <span class="cml-month" id="cml-month-label"></span>
        <button class="cml-nav-btn" id="cml-next">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="m9 18 6-6-6-6"/></svg>
        </button>
      </div>
      <button class="cml-close" id="cml-close">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18M6 6l12 12"/></svg>
      </button>
    </div>
    <div id="cml-otd"></div>
    <div class="cml-grid-wrap">
      <div class="cml-grid" id="cml-grid"></div>
    </div>
    <div id="cml-visits" class="cml-visits-wrap"></div>
  </div>
</div>

<!-- ══ MODAL: LOCATION STATS ══ -->
<div class="loc-sheet-overlay" id="modal-loc-stats">
  <div class="loc-sheet" id="loc-sheet-inner">
    <div class="loc-sheet-header">
      <div>
        <div class="loc-sheet-kicker" id="loc-sheet-kicker"></div>
        <div class="loc-sheet-title" id="loc-sheet-title"></div>
      </div>
      <button class="loc-sheet-close" id="loc-sheet-close">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18M6 6l12 12"/></svg>
      </button>
    </div>
    <div class="loc-sheet-body" id="loc-sheet-body"></div>
  </div>
</div>


<!-- ── SYNC STATUS BADGE ── -->
<div class="sync-float-badge" id="sync-float-badge">
  <span class="sync-dot" id="sfb-dot"></span>
  <span id="sfb-txt"></span>
</div>
</body>
</html>
